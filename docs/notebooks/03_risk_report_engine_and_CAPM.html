<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>3. risk analysis and CAPM – Quantitative Finance Lab</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../notebooks/02_portfolio_optimization_MV_models.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-ed96de9b727972fe78a7b5d16c58bf87.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-2641b481724464e61c86985d8c912b6f.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating fullcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../notebooks/03_risk_report_engine_and_CAPM.html"><span class="chapter-title">3. risk analysis and CAPM</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Quantitative Finance Lab</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Home</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../overview.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Overview</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/01_yield_curve_bond_pricing_and_risk.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">1. Fixed income and yield curve construction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/02_portfolio_optimization_MV_models.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">2. Portfolio Optimization with Mean–Variance Models</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/03_risk_report_engine_and_CAPM.html" class="sidebar-item-text sidebar-link active"><span class="chapter-title">3. risk analysis and CAPM</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-title">3. risk analysis and CAPM</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>In this notebook we build a <strong>risk-focused report</strong> for a small set of “objects” (can be assets, strategies, or portfolios). the goal is not just to compute numbers, but to make the <strong>math and interpretation transparent</strong> so we can understand what each metric means and how it is calculated and how we can interpret from them.</p>
<p>in this notebook we produce</p>
<ul>
<li>tables (small, topic-specific) and plots (simple, comparable) for:
<ul>
<li>performance and basic distribution shape</li>
<li>drawdowns and drawdown episodes</li>
<li>tail risk (vaR / expected shortfall) + backtests</li>
<li>historical stress windows</li>
<li>capm factor regression</li>
<li>risk attribution and diversification diagnostics</li>
</ul></li>
</ul>
<section id="sign-conventions" class="level2">
<h2 class="anchored" data-anchor-id="sign-conventions">sign conventions</h2>
<p>many risk measures are easier to read as <strong>positive “loss magnitudes”</strong>. for example, if the 5% quantile of returns is negative, we report:</p>
<ul>
<li><span class="math inline">\(\text{vaR}_{5\%} = -q_{0.05}(r)\)</span> (positive number)</li>
<li><span class="math inline">\(\text{ES}_{5\%} = -\mathbb{e}[r \mid r \le q_{0.05}(r)]\)</span> (positive number)</li>
</ul>
<p>so bigger vaR/ES means worse tail risk.</p>
<section id="imports-and-plotting-style" class="level3">
<h3 class="anchored" data-anchor-id="imports-and-plotting-style">Imports and plotting style</h3>
<div id="77581913" class="cell" data-execution_count="31">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path <span class="im">as</span> path</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statistics <span class="im">import</span> NormalDist <span class="im">as</span> normaldist</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> textwrap</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.backends.backend_pdf <span class="im">import</span> PdfPages <span class="im">as</span> pdfpages</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> cycler <span class="im">import</span> cycler</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> chi2</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>sys.path.append(<span class="bu">str</span>(path(<span class="st">".."</span>).resolve()))</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> quantfinlab.portfolio <span class="im">as</span> pf</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>palette <span class="op">=</span> [</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#069af3"</span>, <span class="st">"#fe420f"</span>, <span class="st">"#00008b"</span>, <span class="st">"#800080"</span>,</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#008080"</span>, <span class="st">"#7bc8f6"</span>, <span class="st">"#0072b2"</span>, <span class="st">"#04d8b2"</span>,</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#cc79a7"</span>, <span class="st">"#ff8072"</span>, <span class="st">"#9614fa"</span>, <span class="st">"#dc143c"</span>,</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"axes.prop_cycle"</span>] <span class="op">=</span> cycler(color<span class="op">=</span>palette)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>plt.rcParams.update({</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"figure.dpi"</span>: <span class="dv">200</span>,</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">"savefig.dpi"</span>: <span class="dv">300</span>,</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.grid"</span>: <span class="va">True</span>,</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">"grid.alpha"</span>: <span class="fl">0.20</span>,</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.spines.top"</span>: <span class="va">False</span>,</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.spines.right"</span>: <span class="va">False</span>,</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.titlesize"</span>: <span class="dv">11</span>,</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.labelsize"</span>: <span class="dv">11</span>,</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">"xtick.labelsize"</span>: <span class="dv">9</span>,</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ytick.labelsize"</span>: <span class="dv">9</span>,</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">"legend.fontsize"</span>: <span class="dv">9</span>,</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>ann <span class="op">=</span> <span class="dv">252</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>rf_annual <span class="op">=</span> <span class="fl">0.04</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>rf_daily <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> rf_annual) <span class="op">**</span> (<span class="dv">1</span> <span class="op">/</span> ann) <span class="op">-</span> <span class="dv">1</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="data-and-returns" class="level2">
<h2 class="anchored" data-anchor-id="data-and-returns">1) data and returns</h2>
<section id="what-we-need-as-input" class="level3">
<h3 class="anchored" data-anchor-id="what-we-need-as-input">what we need as input</h3>
<p>the report needs <strong>aligned daily returns</strong> for each object:</p>
<ul>
<li>a date index <span class="math inline">\(t = 1, 2, \dots, T\)</span></li>
<li>for each object <span class="math inline">\(j\)</span>, a series <span class="math inline">\(\{r_{j,t}\}\)</span></li>
</ul>
<p>if you start from prices <span class="math inline">\(p_t\)</span>, we use <strong>simple returns</strong>:</p>
<p><span class="math display">\[
r_t = \frac{p_t}{p_{t-1}} - 1
\]</span></p>
<p>in this notebook we keep everything in simple returns because: - the nav compounding is literally <span class="math inline">\(\prod (1+r)\)</span>, - most risk metrics (vaR/ES on daily returns) are commonly shown in simple-return units.</p>
</section>
</section>
<section id="load-data-and-compute-returns" class="level2">
<h2 class="anchored" data-anchor-id="load-data-and-compute-returns">Load data and compute returns</h2>
<p>the data used in this project can be downloaded from here (<a href="https://stooq.com/db/h/">Stooq US (nasdaq) daily market data</a>)</p>
<div id="00833a40" class="cell" data-execution_count="32">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_parquet(<span class="st">"../data/nasdaq_all_close_volume.parquet"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"date"</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">"Date"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>dcol <span class="op">=</span> <span class="st">"date"</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.dropna(subset<span class="op">=</span>[dcol]).sort_values(dcol)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>close_map, vol_map <span class="op">=</span> {}, {}</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> df.columns:</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    c_str <span class="op">=</span> <span class="bu">str</span>(c)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> c_str.lower() <span class="op">==</span> dcol.lower() <span class="kw">or</span> <span class="st">"__"</span> <span class="kw">not</span> <span class="kw">in</span> c_str:</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    t, f <span class="op">=</span> c_str.rsplit(<span class="st">"__"</span>, <span class="dv">1</span>)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    f <span class="op">=</span> f.lower()</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> f <span class="op">==</span> <span class="st">"close"</span>:</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        close_map[t] <span class="op">=</span> c</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> f <span class="op">==</span> <span class="st">"volume"</span>:</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>        vol_map[t] <span class="op">=</span> c</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>tickers_all <span class="op">=</span> <span class="bu">sorted</span>(<span class="bu">set</span>(close_map).intersection(vol_map))</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>close_prices <span class="op">=</span> df[[close_map[t] <span class="cf">for</span> t <span class="kw">in</span> tickers_all]].copy()</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>volumes <span class="op">=</span> df[[vol_map[t] <span class="cf">for</span> t <span class="kw">in</span> tickers_all]].copy()</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>close_prices.columns <span class="op">=</span> tickers_all</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>volumes.columns <span class="op">=</span> tickers_all</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>close_prices.index <span class="op">=</span> pd.to_datetime(df[dcol].values)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>volumes.index <span class="op">=</span> pd.to_datetime(df[dcol].values)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>close_prices <span class="op">=</span> close_prices.<span class="bu">apply</span>(pd.to_numeric, errors<span class="op">=</span><span class="st">"coerce"</span>).replace([np.inf, <span class="op">-</span>np.inf], np.nan)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>volumes <span class="op">=</span> volumes.<span class="bu">apply</span>(pd.to_numeric, errors<span class="op">=</span><span class="st">"coerce"</span>).replace([np.inf, <span class="op">-</span>np.inf], np.nan)</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>start <span class="op">=</span> pd.Timestamp(<span class="st">"2016-01-01"</span>)</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>close_prices <span class="op">=</span> close_prices.loc[close_prices.index <span class="op">&gt;=</span> start]</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>volumes <span class="op">=</span> volumes.loc[volumes.index <span class="op">&gt;=</span> start]</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> close_prices.index.intersection(volumes.index)</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>cols <span class="op">=</span> close_prices.columns.intersection(volumes.columns)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>close_prices <span class="op">=</span> close_prices.loc[idx, cols]</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>volumes <span class="op">=</span> volumes.loc[idx, cols]</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> pf.prices_to_returns(close_prices)</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>first_date <span class="op">=</span> pd.concat([close_prices.<span class="bu">apply</span>(pd.Series.first_valid_index),</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>                         volumes.<span class="bu">apply</span>(pd.Series.first_valid_index)],axis<span class="op">=</span><span class="dv">1</span>,).<span class="bu">max</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>spy <span class="op">=</span> pd.read_csv(<span class="st">"../data/spy_yfinance.csv"</span>)</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>spy[<span class="st">"date"</span>] <span class="op">=</span> pd.to_datetime(spy[<span class="st">"Date"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>) <span class="cf">if</span> <span class="st">"date"</span> <span class="kw">in</span> [<span class="bu">str</span>(c).lower() <span class="cf">for</span> c <span class="kw">in</span> spy.columns] <span class="cf">else</span> pd.to_datetime(spy[<span class="st">"Date"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>dcol_spy <span class="op">=</span> <span class="st">"date"</span> <span class="cf">if</span> <span class="st">"date"</span> <span class="kw">in</span> spy.columns <span class="cf">else</span> <span class="st">"Date"</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>spy <span class="op">=</span> spy.dropna(subset<span class="op">=</span>[dcol_spy]).sort_values(dcol_spy).set_index(dcol_spy)</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"Adj Close"</span> <span class="kw">in</span> spy.columns:</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>    spy_px <span class="op">=</span> pd.to_numeric(spy[<span class="st">"Adj Close"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"spy_yfinance.csv missing adj close column"</span>)</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>spy_px <span class="op">=</span> spy_px.loc[spy_px.index <span class="op">&gt;=</span> start]</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>market_ret <span class="op">=</span> spy_px.pct_change().replace([np.inf, <span class="op">-</span>np.inf], np.nan)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="rebalancing-universe-selection-and-strategies" class="level2">
<h2 class="anchored" data-anchor-id="rebalancing-universe-selection-and-strategies">2) rebalancing, universe selection, and strategies</h2>
<p>In the last project we imported the same data from nasdaq and filtered the most liquid stocks for each month from 2016 to 2026 and implemented MeanVariance, MinVariance and MaxSharpe models with monthly rebalancing and backtested and compared them under real market conditions.</p>
<p>for better understanding please read the last project (<a href="https://ramtin-asadi.github.io/Quantitative-Finance-Lab/notebooks/02_portfolio_optimization_MV_models.html">2. Portfolio Optimization with Mean–Variance Models</a>)</p>
<section id="rebalancing-logic-no-look-ahead" class="level3">
<h3 class="anchored" data-anchor-id="rebalancing-logic-no-look-ahead">rebalancing logic (no look-ahead)</h3>
<p>a clean backtest timeline is:</p>
<ol type="1">
<li>at the start of day <span class="math inline">\(t\)</span>, if <span class="math inline">\(t\)</span> is a rebalance date, compute target weights <span class="math inline">\(w_t\)</span> using information up to <span class="math inline">\(t-1\)</span><br>
</li>
<li>apply transaction costs/turnover if needed<br>
</li>
<li>hold weights through the day and apply realized return <span class="math inline">\(r_{p,t+1}\)</span> next</li>
</ol>
<p>transaction cost proxy (simple linear model):</p>
<p><span class="math display">\[
\text{tc}_t = c \sum_i |w_{i,t} - w_{i,t-1}|
\]</span></p>
<p>where <span class="math inline">\(c\)</span> is a per-unit turnover cost.</p>
</section>
<section id="strategies-used-here-high-level" class="level3">
<h3 class="anchored" data-anchor-id="strategies-used-here-high-level">strategies used here (high level)</h3>
<p>In this notebook we don’t repeat the code in the last notebook and we use quantfinlab library for creating the needed strategies. for the first implementation we just use two of the best strategies from the last notebook. <strong>MV_ewma</strong> and <strong>MaxSharpe_frontier</strong>. we also use two of the stocks in our dataset for showing different results in different types of objects. We use <strong>NVIDIA</strong> and <strong>Apple</strong>. and for CAPM analysis we use <strong>SPY</strong> as our benchmmark.</p>
<p>if you later add more objects, the report works as long as: - each object is a daily return series aligned to the same date index - object names are consistent (for labeling)</p>
<div id="c5eaa2d1" class="cell" data-execution_count="33">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>rebal_dates <span class="op">=</span> pf.make_rebalance_dates(returns.index, freq<span class="op">=</span><span class="st">"ME"</span>, min_history_days<span class="op">=</span><span class="dv">252</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>cache <span class="op">=</span> {}</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> dt <span class="kw">in</span> rebal_dates:</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    tickers, adv <span class="op">=</span> pf.select_liquid_universe(dt, close_prices<span class="op">=</span>close_prices,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>                                             volumes<span class="op">=</span>volumes, top_n<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>                                             liq_lookback<span class="op">=</span><span class="dv">252</span>, min_listing_days<span class="op">=</span><span class="dv">252</span>,</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>                                             min_obs<span class="op">=</span><span class="dv">252</span>, first_date<span class="op">=</span>first_date,)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(tickers) <span class="op">&lt;</span> <span class="dv">2</span>:</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    pos <span class="op">=</span> returns.index.get_loc(dt)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(pos, <span class="bu">slice</span>):</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        pos <span class="op">=</span> pos.stop <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pos <span class="op">&lt;</span> <span class="dv">252</span>:</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    window <span class="op">=</span> (returns[tickers].iloc[pos <span class="op">-</span> <span class="dv">252</span>:pos]</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>        .dropna(axis<span class="op">=</span><span class="dv">0</span>, how<span class="op">=</span><span class="st">"any"</span>))</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> window.shape[<span class="dv">0</span>] <span class="op">&lt;</span> <span class="dv">170</span> <span class="kw">or</span> window.shape[<span class="dv">1</span>] <span class="op">&lt;</span> <span class="dv">2</span>:</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    tickers <span class="op">=</span> window.columns.tolist()</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    cov_ewma <span class="op">=</span> pf.cov_estimate(window, method<span class="op">=</span><span class="st">"ewma"</span>, annualization<span class="op">=</span>ann)</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    cov_lw <span class="op">=</span> pf.cov_estimate(window, method<span class="op">=</span><span class="st">"ledoitwolf"</span>, annualization<span class="op">=</span>ann)</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> pf.mu_momentum(window, mode<span class="op">=</span><span class="st">"6-1"</span>, rf<span class="op">=</span>rf_annual,</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>                        cov_for_scaling<span class="op">=</span>cov_lw, target_sharpe<span class="op">=</span><span class="fl">0.80</span>,</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>                        mu_cap<span class="op">=</span><span class="fl">0.30</span>)</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    cache[dt] <span class="op">=</span> {</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tickers"</span>: tickers,</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">"mu_excess_ann"</span>: np.asarray(mu, dtype<span class="op">=</span><span class="bu">float</span>),</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">"cov_ann_map"</span>: {<span class="st">"ewma"</span>: cov_ewma, <span class="st">"ledoitwolf"</span>: cov_lw},</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">"window"</span>: window,</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>rebal_dates <span class="op">=</span> pd.DatetimeIndex([d <span class="cf">for</span> d <span class="kw">in</span> rebal_dates <span class="cf">if</span> d <span class="kw">in</span> cache])</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mv_weight_fn(dt, state, w_prev):</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pf.weights_mv(mu_excess_ann<span class="op">=</span>state[<span class="st">"mu_excess_ann"</span>],</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>                         cov_ann<span class="op">=</span>state[<span class="st">"cov_ann_map"</span>][<span class="st">"ewma"</span>],</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>                         w_prev<span class="op">=</span>w_prev, w_max<span class="op">=</span><span class="fl">0.25</span>, long_only<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>                         turnover_penalty_bps<span class="op">=</span><span class="dv">10</span>, ridge<span class="op">=</span><span class="fl">1e-8</span>)</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> maxsharpe_weight_fn(dt, state, w_prev):</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pf.weights_maxsharpe_frontier_grid(</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>        mu_excess_ann<span class="op">=</span>state[<span class="st">"mu_excess_ann"</span>],</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>        cov_ann<span class="op">=</span>state[<span class="st">"cov_ann_map"</span>][<span class="st">"ledoitwolf"</span>],</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>        w_prev<span class="op">=</span>w_prev,grid_n<span class="op">=</span><span class="dv">25</span>,</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>        w_max<span class="op">=</span><span class="fl">0.25</span>, long_only<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>        turnover_penalty_bps<span class="op">=</span><span class="dv">10</span>, ridge<span class="op">=</span><span class="fl">1e-8</span>,)</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>res_mv <span class="op">=</span> pf.backtest(returns, rebal_dates, cache, </span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>                     mv_weight_fn, cost_bps<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>                     fallback<span class="op">=</span><span class="st">"equal"</span>, w_max<span class="op">=</span><span class="fl">0.25</span>,</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>                     long_only<span class="op">=</span><span class="va">True</span>, rf_daily<span class="op">=</span>rf_daily)</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>res_mx <span class="op">=</span> pf.backtest(returns, rebal_dates,</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>                     cache, maxsharpe_weight_fn,</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>                     cost_bps<span class="op">=</span><span class="dv">10</span>, fallback<span class="op">=</span><span class="st">"equal"</span>, </span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>                     w_max<span class="op">=</span><span class="fl">0.25</span>, long_only<span class="op">=</span><span class="va">True</span>, rf_daily<span class="op">=</span>rf_daily)</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>base_idx <span class="op">=</span> returns.index.intersection(res_mv.net_returns.index).intersection(res_mx.net_returns.index)</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>nvda_ret <span class="op">=</span> returns[<span class="st">"NVDA"</span>].reindex(base_idx).fillna(<span class="fl">0.0</span>) </span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>aapl_ret <span class="op">=</span> returns[<span class="st">"AAPL"</span>].reindex(base_idx).fillna(<span class="fl">0.0</span>)</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>mv_ret <span class="op">=</span> res_mv.net_returns.reindex(base_idx).fillna(<span class="fl">0.0</span>)</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>mx_ret <span class="op">=</span> res_mx.net_returns.reindex(base_idx).fillna(<span class="fl">0.0</span>)</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>market_ret <span class="op">=</span> market_ret.reindex(base_idx).fillna(<span class="fl">0.0</span>)</span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>obj <span class="op">=</span> {</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nvda"</span>: nvda_ret,</span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>    <span class="st">"aapl"</span>: aapl_ret,</span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mv_ewma"</span>: mv_ret,</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>    <span class="st">"maxsharpe_frontier"</span>: mx_ret,</span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>obj_colors <span class="op">=</span> {</span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nvda"</span>: palette[<span class="dv">0</span>],</span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>    <span class="st">"aapl"</span>: palette[<span class="dv">1</span>],</span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mv_ewma"</span>: palette[<span class="dv">2</span>],</span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>    <span class="st">"maxsharpe_frontier"</span>: palette[<span class="dv">3</span>],</span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"analysis objects:"</span>, <span class="bu">list</span>(obj.keys()))</span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"date range:"</span>, base_idx.<span class="bu">min</span>().date(), <span class="st">"to"</span>, base_idx.<span class="bu">max</span>().date(), <span class="st">", n:"</span>, <span class="bu">len</span>(base_idx))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>analysis objects: ['nvda', 'aapl', 'mv_ewma', 'maxsharpe_frontier']
date range: 2017-01-31 to 2026-01-28 , n: 2261</code></pre>
</div>
</div>
</section>
</section>
<section id="core-risk-metrics" class="level2">
<h2 class="anchored" data-anchor-id="core-risk-metrics">3) core risk metrics</h2>
<p>In this section we build tables that summarize each object using only its own return series (We had this in the project 2 too).</p>
<section id="nav-cumulative-wealth" class="level3">
<h3 class="anchored" data-anchor-id="nav-cumulative-wealth">3.1 nav (cumulative wealth)</h3>
<p>Given daily returns <span class="math inline">\(r_t\)</span>, if returns are computed simple, we define nav as:</p>
<p><span class="math display">\[
\text{nav}_t = \prod_{u \le t} (1 + r_u)
\]</span></p>
<p>in code, this is a cumulative product of <span class="math inline">\((1+r)\)</span>.</p>
</section>
<section id="annualized-return" class="level3">
<h3 class="anchored" data-anchor-id="annualized-return">3.2 annualized return</h3>
<p>from nav, the total growth factor is <span class="math inline">\(\text{nav}_T\)</span>. to annualize over <span class="math inline">\(T\)</span> trading days (We assume 252 trading days in one year):</p>
<p><span class="math display">\[
r^{ann} = \text{nav}_T^{252/T} - 1
\]</span></p>
<p>this assumes the sample growth rate continues at the same pace (a standard convention).</p>
</section>
<section id="annualized-volatility" class="level3">
<h3 class="anchored" data-anchor-id="annualized-volatility">3.3 annualized volatility</h3>
<p>daily volatility is the sample standard deviation:</p>
<p><span class="math display">\[
\hat\sigma = \sqrt{\frac{1}{T-1}\sum_{t=1}^T (r_t - \bar r)^2}
\]</span></p>
<p>annualized volatility is:</p>
<p><span class="math display">\[
\hat\sigma^{ann} = \hat\sigma\sqrt{252}
\]</span></p>
</section>
<section id="sharpe-ratio" class="level3">
<h3 class="anchored" data-anchor-id="sharpe-ratio">3.4 sharpe ratio</h3>
<p>For sharpe we use excess returns (the returns compared to risk free rate returns) and Volatility for comparing excess-return risk-adjusted performance :</p>
<p><span class="math display">\[
\text{sharpe} = \frac{\bar r^{ex}}{\hat\sigma}\sqrt{252}
\quad\text{where}\quad
\bar r^{ex} = \frac{1}{T}\sum_{t=1}^T (r_t - r_{f,t})
\]</span></p>
<p>With sharpe we can tell how many units of excess return we gain per unit of volatility.</p>
</section>
<section id="sortino-ratio-downside-focused" class="level3">
<h3 class="anchored" data-anchor-id="sortino-ratio-downside-focused">3.5 sortino ratio (downside-focused)</h3>
<p>For sortino we replace total volatility with <strong>downside deviation</strong>. We define downside returns relative to a target <span class="math inline">\(\tau\)</span> (often <span class="math inline">\(0\)</span> or <span class="math inline">\(r_f\)</span>). So we set returns higher than risk free rate as 0 to analyze the lowest returns:</p>
<p><span class="math display">\[
d_t = \min(0, r_t - \tau)
\]</span></p>
<p>downside deviation:</p>
<p><span class="math display">\[
\sigma_d = \sqrt{\frac{1}{T-1}\sum_{t=1}^T d_t^2}
\]</span></p>
<p>sortino:</p>
<p><span class="math display">\[
\text{sortino} = \frac{\bar r - \tau}{\sigma_d}\sqrt{252}
\]</span></p>
<div id="9f15048e" class="cell" data-execution_count="34">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> nav_series(r):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> pd.Series(r).fillna(<span class="fl">0.0</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (<span class="dv">1</span> <span class="op">+</span> r).cumprod()</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sortino(r):</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> pd.Series(r).dropna()</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    ex <span class="op">=</span> x <span class="op">-</span> rf_daily</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    dn <span class="op">=</span> np.minimum(ex, <span class="dv">0</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    den <span class="op">=</span> np.sqrt((dn <span class="op">**</span> <span class="dv">2</span>).mean())</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">float</span>((ex.mean() <span class="op">/</span> den) <span class="op">*</span> np.sqrt(ann)) <span class="cf">if</span> den <span class="op">&gt;</span> <span class="fl">1e-12</span> <span class="cf">else</span> np.nan</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>perf_rows <span class="op">=</span> []</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, r <span class="kw">in</span> obj.items():</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> pd.Series(r).dropna()</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    nav <span class="op">=</span> nav_series(x)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    ann_return <span class="op">=</span> <span class="bu">float</span>(nav.iloc[<span class="op">-</span><span class="dv">1</span>] <span class="op">**</span> (ann <span class="op">/</span> <span class="bu">len</span>(x)) <span class="op">-</span> <span class="dv">1</span>) <span class="cf">if</span> <span class="bu">len</span>(x) <span class="cf">else</span> np.nan</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    daily_mean <span class="op">=</span> <span class="bu">float</span>(x.mean())</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    daily_vol <span class="op">=</span> <span class="bu">float</span>(x.std(ddof<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    ann_vol <span class="op">=</span> daily_vol <span class="op">*</span> np.sqrt(ann) <span class="cf">if</span> daily_vol <span class="op">&gt;</span> <span class="fl">1e-12</span> <span class="cf">else</span> np.nan</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    sharpe <span class="op">=</span> ((daily_mean <span class="op">-</span> rf_daily) <span class="op">/</span> daily_vol <span class="op">*</span> np.sqrt(ann)) <span class="cf">if</span> daily_vol <span class="op">&gt;</span> <span class="fl">1e-12</span> <span class="cf">else</span> np.nan</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    sortino_ratio <span class="op">=</span> sortino(x)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    perf_rows.append({</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">"object"</span>: name,</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ann_return"</span>: ann_return,</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ann_vol"</span>: ann_vol,</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sharpe"</span>: <span class="bu">float</span>(sharpe) <span class="cf">if</span> np.isfinite(sharpe) <span class="cf">else</span> np.nan,</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sortino"</span>: <span class="bu">float</span>(sortino_ratio) <span class="cf">if</span> np.isfinite(sortino_ratio) <span class="cf">else</span> np.nan,</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>perf_tbl <span class="op">=</span> pd.DataFrame(perf_rows).set_index(<span class="st">"object"</span>).sort_index()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="131af53a" class="cell" data-execution_count="35">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>display(perf_tbl.<span class="bu">round</span>(<span class="dv">4</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ann_return</th>
<th data-quarto-table-cell-role="th">ann_vol</th>
<th data-quarto-table-cell-role="th">sharpe</th>
<th data-quarto-table-cell-role="th">sortino</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">object</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">aapl</th>
<td>0.2798</td>
<td>0.2967</td>
<td>0.8478</td>
<td>1.2478</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">maxsharpe_frontier</th>
<td>0.2084</td>
<td>0.2951</td>
<td>0.6565</td>
<td>0.9390</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mv_ewma</th>
<td>0.1688</td>
<td>0.1717</td>
<td>0.7661</td>
<td>1.0921</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">nvda</th>
<td>0.6074</td>
<td>0.5016</td>
<td>1.1189</td>
<td>1.6765</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>As we can see nvidia has so much more annual returns than other objects but the annual volatility is insanely more. even with more volatility, Apple and Nvidia still have more sharpe and sortino ratio, but if we care about risk, it’s even obvious from the first metric (annual vol) that our diversification reduced the volatility succesfully. And in 2016 we wouldn’t know in 2026 nvidia would grow this much and give this much return. and even if we knew we probably wouldn’t trust this much volatility and hold it until now. the best thing we could’ve done was make a portfolio of the top 100 stocks in that time and update it each month. we now get to other metrics for comparing the risk of these 4 objects.</p>
<hr>
</section>
</section>
<section id="rolling-volatility" class="level2">
<h2 class="anchored" data-anchor-id="rolling-volatility">4) rolling volatility</h2>
<p>volatility is not constant. a single full-sample <span class="math inline">\(\sigma\)</span> hides regime changes. with rolling volatility we can analyze the volatility overtime and see different volatility of an asset in different times.</p>
<section id="rolling-statistics" class="level3">
<h3 class="anchored" data-anchor-id="rolling-statistics">rolling statistics</h3>
<p>a rolling volatility over window length <span class="math inline">\(w\)</span> (for example 60 days) is:</p>
<p><span class="math display">\[
\hat\sigma_{t,w} = \sqrt{\frac{1}{w-1}\sum_{u=t-w+1}^t (r_u - \bar r_{t,w})^2}
\]</span></p>
<p>and annualized rolling vol is:</p>
<p><span class="math display">\[
\hat\sigma_{t,w}^{ann} = \hat\sigma_{t,w}\sqrt{252}
\]</span></p>
<p>we plot multiple windows (e.g., 20/60/252 days) because: - short windows react quickly and are more noisy (good for risk control) - long windows are smoother (good for long-horizon intuition)</p>
<div id="d62166b9" class="cell" data-execution_count="36">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>windows <span class="op">=</span> [<span class="dv">20</span>, <span class="dv">60</span>, <span class="dv">252</span>]</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">11</span>, <span class="dv">7</span>), sharex<span class="op">=</span><span class="va">True</span>, sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> axes.ravel()</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (name, r) <span class="kw">in</span> <span class="bu">enumerate</span>(obj.items()):</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> axes[i]</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> pd.Series(r).dropna()</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> w <span class="kw">in</span> windows:</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        rv <span class="op">=</span> x.rolling(w).std(ddof<span class="op">=</span><span class="dv">1</span>) <span class="op">*</span> np.sqrt(ann)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        ax.plot(rv.index, rv.values, lw<span class="op">=</span><span class="fl">1.5</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>w<span class="sc">}</span><span class="ss">d"</span>)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f"rolling vol — </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">"ann vol"</span>)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    ax.legend()</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03_risk_report_engine_and_CAPM_files/figure-html/cell-7-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>As we can see all of our objects have been more volatile in 2020 due to Covid crash. but the difference is that our two stocks have experienced more volatility in crash times and our diversified portfolios were able to manage the volatility in those times better and had lower effect from crashes. And as we can see Nvidia has the most noise and movement and high volatility overtime and our MeanVariance model with ewma covariance managed to control volatility overtime better than all the other objects.</p>
<hr>
</section>
</section>
<section id="distribution-shape-and-tail-diagnostics" class="level2">
<h2 class="anchored" data-anchor-id="distribution-shape-and-tail-diagnostics">4) distribution shape and tail diagnostics</h2>
<p>performance ratios (sharpe/sortino) do <strong>not</strong> tell you what the return distribution looks like. in the metrics that we analyzed we only work with variance and mean. not the real shape and behavior of distribution. two strategies can have the same sharpe but very different crash behavior.</p>
<section id="skewness" class="level3">
<h3 class="anchored" data-anchor-id="skewness">4.1 skewness</h3>
<p>skewness measures asymmetry. using centered moments:</p>
<p><span class="math display">\[
\text{skew} = \frac{\mathbb{e}[(r-\mu)^3]}{\sigma^3}
\]</span></p>
<ul>
<li>negative skew can mean occasional large negative days (crash)</li>
<li>positive skew can mean occasional large positive days (lottery-like)</li>
</ul>
</section>
<section id="excess-kurtosis" class="level3">
<h3 class="anchored" data-anchor-id="excess-kurtosis">excess kurtosis</h3>
<p>kurtosis measures tail heaviness relative to normal:</p>
<p><span class="math display">\[
\text{kurt} = \frac{\mathbb{e}[(r-\mu)^4]}{\sigma^4} - 3
\]</span></p>
<p>the “<span class="math inline">\(-3\)</span>” makes normal distribution kurtosis equal to <span class="math inline">\(0\)</span> (“excess kurtosis”).</p>
</section>
<section id="tail-ratio-quantile-based" class="level3">
<h3 class="anchored" data-anchor-id="tail-ratio-quantile-based">tail ratio (quantile-based)</h3>
<p>a simple, robust tail comparison is:</p>
<p><span class="math display">\[
\text{tail ratio} = \left|\frac{q_{0.95}}{q_{0.05}}\right|
\]</span></p>
<p>where <span class="math inline">\(q_p\)</span> is the <span class="math inline">\(p\)</span>-quantile of daily returns. if the left tail is much larger in magnitude than the right tail, the ratio drops. If we have bigger left tail than right tail, it means we have more extreme negative returns than extreme possitive which can be a sign of risk.</p>
</section>
<section id="worst-day-averages" class="level3">
<h3 class="anchored" data-anchor-id="worst-day-averages">worst-day averages</h3>
<p>another tail measure that can be used is:</p>
<ul>
<li>worst 1-day return: <span class="math inline">\(\min_t r_t\)</span></li>
<li>average of worst 5 days: mean of the 5 smallest returns</li>
<li>average of worst 10 days: mean of the 10 smallest returns</li>
</ul>
<p>these are easy for users to understand what does a bad week look like without introducing a full scenario model.</p>
<p>in below we get to more advanced models for these types of risk with VaR.</p>
<div id="420f0fb6" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>shape_rows <span class="op">=</span> []</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, r <span class="kw">in</span> obj.items():</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> pd.Series(r).dropna()</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    q05 <span class="op">=</span> <span class="bu">float</span>(x.quantile(<span class="fl">0.05</span>))</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    q95 <span class="op">=</span> <span class="bu">float</span>(x.quantile(<span class="fl">0.95</span>))</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    tail_ratio <span class="op">=</span> <span class="bu">float</span>(<span class="bu">abs</span>(q95 <span class="op">/</span> q05)) <span class="cf">if</span> <span class="bu">abs</span>(q05) <span class="op">&gt;</span> <span class="fl">1e-12</span> <span class="cf">else</span> np.nan</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    worst_1d <span class="op">=</span> <span class="bu">float</span>(x.<span class="bu">min</span>()) <span class="cf">if</span> <span class="bu">len</span>(x) <span class="cf">else</span> np.nan</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    worst_5d_avg <span class="op">=</span> <span class="bu">float</span>(x.nsmallest(<span class="dv">5</span>).mean()) <span class="cf">if</span> <span class="bu">len</span>(x) <span class="op">&gt;=</span> <span class="dv">5</span> <span class="cf">else</span> np.nan</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    worst_10d_avg <span class="op">=</span> <span class="bu">float</span>(x.nsmallest(<span class="dv">10</span>).mean()) <span class="cf">if</span> <span class="bu">len</span>(x) <span class="op">&gt;=</span> <span class="dv">10</span> <span class="cf">else</span> np.nan</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    shape_rows.append({</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"object"</span>: name,</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"skew"</span>: <span class="bu">float</span>(x.skew()) <span class="cf">if</span> <span class="bu">len</span>(x) <span class="cf">else</span> np.nan,</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"excess_kurtosis"</span>: <span class="bu">float</span>(x.kurt()) <span class="cf">if</span> <span class="bu">len</span>(x) <span class="cf">else</span> np.nan,  </span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># pandas returns excess kurtosis so we don't have to subtract 3</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tail_ratio_95_05"</span>: tail_ratio,</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"worst_1d"</span>: worst_1d,</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"worst_5d_avg"</span>: worst_5d_avg,</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"worst_10d_avg"</span>: worst_10d_avg,</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>shape_tbl <span class="op">=</span> pd.DataFrame(shape_rows).set_index(<span class="st">"object"</span>).sort_index()</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>display(shape_tbl.<span class="bu">round</span>(<span class="dv">4</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">skew</th>
<th data-quarto-table-cell-role="th">excess_kurtosis</th>
<th data-quarto-table-cell-role="th">tail_ratio_95_05</th>
<th data-quarto-table-cell-role="th">worst_1d</th>
<th data-quarto-table-cell-role="th">worst_5d_avg</th>
<th data-quarto-table-cell-role="th">worst_10d_avg</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">object</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">aapl</th>
<td>0.1655</td>
<td>6.8540</td>
<td>0.9931</td>
<td>-0.1286</td>
<td>-0.0999</td>
<td>-0.0850</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">maxsharpe_frontier</th>
<td>-0.1096</td>
<td>6.9413</td>
<td>0.9987</td>
<td>-0.1208</td>
<td>-0.1070</td>
<td>-0.0907</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mv_ewma</th>
<td>-0.4052</td>
<td>12.5224</td>
<td>1.0800</td>
<td>-0.1050</td>
<td>-0.0767</td>
<td>-0.0602</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">nvda</th>
<td>0.1793</td>
<td>5.2051</td>
<td>1.0930</td>
<td>-0.1875</td>
<td>-0.1605</td>
<td>-0.1310</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Looks like MV_ewma doesn’t have the best shape if we use skew and kurt, but this is because it’s distribution is closer to 0 and every little extreme loss can drive the skew and kurt to bad situation. based on kurtosis, all of the objects are fat tailed but the amount of losses that we take from tail is different for each object. When it comes to see how much loss we take in worst days we again see that MV_ewma has lower loss and nvidia again has the most loss. and from these measure our maxsharpe and apple are very close to eachother.</p>
<hr>
</section>
</section>
<section id="cumulative-performance-and-drawdown" class="level2">
<h2 class="anchored" data-anchor-id="cumulative-performance-and-drawdown">5) cumulative performance and drawdown</h2>
<section id="drawdown" class="level3">
<h3 class="anchored" data-anchor-id="drawdown">5.1 drawdown</h3>
<p>drawdown measures how far we get below the previous peak and how much time does it take to get back to peak.</p>
<p>we define peak nav as:</p>
<p><span class="math display">\[
\text{peak}_t = \max_{u \le t} \text{nav}_u
\]</span></p>
<p>then drawdown is:</p>
<p><span class="math display">\[
\text{dd}_t = \frac{\text{nav}_t}{\text{peak}_t} - 1
\]</span></p>
<p>so drawdown is <span class="math inline">\(0\)</span> at peaks and negative otherwise.</p>
<p>drawdown analysis answers: - how deep are losses during stress? - how long does it take to recover? - are drawdowns frequent but shallow, or rare but huge?</p>
<div id="2a0b1168" class="cell" data-execution_count="37">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dd_series(r):</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    nav <span class="op">=</span> nav_series(r)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> nav <span class="op">/</span> nav.cummax() <span class="op">-</span> <span class="fl">1.0</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, r <span class="kw">in</span> obj.items():</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    nav <span class="op">=</span> nav_series(r)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    ax[<span class="dv">0</span>].plot(nav.index, nav.values, lw<span class="op">=</span><span class="fl">2.0</span>, color<span class="op">=</span>obj_colors[name], label<span class="op">=</span>name)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_title(<span class="st">"cumulative nav"</span>)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_ylabel(<span class="st">"nav"</span>)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].legend(ncol<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, r <span class="kw">in</span> obj.items():</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    dd <span class="op">=</span> dd_series(r)</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    ax[<span class="dv">1</span>].plot(dd.index, dd.values, lw<span class="op">=</span><span class="fl">1.6</span>, color<span class="op">=</span>obj_colors[name], label<span class="op">=</span>name)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].axhline(<span class="fl">0.0</span>, color<span class="op">=</span><span class="st">"#444"</span>, lw<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_title(<span class="st">"drawdown"</span>)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_ylabel(<span class="st">"drawdown"</span>)</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_xlabel(<span class="st">"date"</span>)</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].legend(ncol<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03_risk_report_engine_and_CAPM_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="drawdown-episode" class="level3">
<h3 class="anchored" data-anchor-id="drawdown-episode">5.2 drawdown episode</h3>
<p>the drawdown time-series is great visually, but a user also needs <strong>events</strong>. we want to know exactly what were the worst drawdowns, when did they start, and how long did they last</p>
<p>an episode starts when drawdown becomes negative and ends when nav reaches the last peak (drawdown returns to <span class="math inline">\(0\)</span>).</p>
<p>for each episode <span class="math inline">\(k\)</span> we record: - start date <span class="math inline">\(t_k^{start}\)</span> - end date <span class="math inline">\(t_k^{end}\)</span> - depth: <span class="math inline">\(\min_{t \in [t_k^{start}, t_k^{end}]} \text{dd}_t\)</span> - duration: number of trading days in the episode</p>
<div id="bd5188e0" class="cell" data-execution_count="38">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> drawdown_episodes(r):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    dd <span class="op">=</span> dd_series(r)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    in_dd <span class="op">=</span> <span class="va">False</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    start_i <span class="op">=</span> <span class="va">None</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> []</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, v <span class="kw">in</span> <span class="bu">enumerate</span>(dd.values):</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> v <span class="op">&lt;</span> <span class="dv">0</span> <span class="kw">and</span> <span class="kw">not</span> in_dd:</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>            in_dd <span class="op">=</span> <span class="va">True</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>            start_i <span class="op">=</span> i</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> v <span class="op">==</span> <span class="dv">0</span> <span class="kw">and</span> in_dd:</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>            end_i <span class="op">=</span> i</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>            seg <span class="op">=</span> dd.iloc[start_i:end_i]</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>            out.append((seg.index[<span class="dv">0</span>], seg.index[<span class="op">-</span><span class="dv">1</span>], <span class="bu">float</span>(seg.<span class="bu">min</span>()), <span class="bu">int</span>(<span class="bu">len</span>(seg))))</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>            in_dd <span class="op">=</span> <span class="va">False</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> in_dd:</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>        seg <span class="op">=</span> dd.iloc[start_i:]</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        out.append((seg.index[<span class="dv">0</span>], seg.index[<span class="op">-</span><span class="dv">1</span>], <span class="bu">float</span>(seg.<span class="bu">min</span>()), <span class="bu">int</span>(<span class="bu">len</span>(seg))))</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(out, columns<span class="op">=</span>[<span class="st">"start"</span>, <span class="st">"end"</span>, <span class="st">"depth"</span>, <span class="st">"duration"</span>])</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> avg_recovery_time(r):</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    nav <span class="op">=</span> nav_series(r)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    peak <span class="op">=</span> nav.cummax()</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    dd <span class="op">=</span> nav <span class="op">/</span> peak <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    rec_times <span class="op">=</span> []</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    in_dd <span class="op">=</span> <span class="va">False</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    t0 <span class="op">=</span> <span class="va">None</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, v <span class="kw">in</span> <span class="bu">enumerate</span>(dd.values):</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> v <span class="op">&lt;</span> <span class="dv">0</span> <span class="kw">and</span> <span class="kw">not</span> in_dd:</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>            in_dd <span class="op">=</span> <span class="va">True</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>            t0 <span class="op">=</span> i</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> v <span class="op">==</span> <span class="dv">0</span> <span class="kw">and</span> in_dd:</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>            rec_times.append(i <span class="op">-</span> t0)</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>            in_dd <span class="op">=</span> <span class="va">False</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">float</span>(np.mean(rec_times)) <span class="cf">if</span> <span class="bu">len</span>(rec_times) <span class="cf">else</span> np.nan</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>dd_rows <span class="op">=</span> []</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, r <span class="kw">in</span> obj.items():</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> pd.Series(r).dropna()</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>    dd <span class="op">=</span> dd_series(x)</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>    ep <span class="op">=</span> drawdown_episodes(x)</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>    longest_dd_days <span class="op">=</span> <span class="bu">int</span>(ep[<span class="st">"duration"</span>].<span class="bu">max</span>()) <span class="cf">if</span> <span class="bu">len</span>(ep) <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>    dd_rows.append({</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">"object"</span>: name,</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">"max_dd"</span>: <span class="bu">float</span>(dd.<span class="bu">min</span>()) <span class="cf">if</span> <span class="bu">len</span>(dd) <span class="cf">else</span> np.nan,</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">"longest_dd_days"</span>: longest_dd_days,</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>        <span class="st">"avg_recovery_days"</span>: avg_recovery_time(x),</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>dd_summary_tbl <span class="op">=</span> pd.DataFrame(dd_rows).set_index(<span class="st">"object"</span>).sort_index()</span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>display(dd_summary_tbl.<span class="bu">round</span>(<span class="dv">4</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">max_dd</th>
<th data-quarto-table-cell-role="th">longest_dd_days</th>
<th data-quarto-table-cell-role="th">avg_recovery_days</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">object</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">aapl</th>
<td>-0.3852</td>
<td>354</td>
<td>21.2234</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">maxsharpe_frontier</th>
<td>-0.4772</td>
<td>1238</td>
<td>30.5217</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mv_ewma</th>
<td>-0.2954</td>
<td>679</td>
<td>16.8803</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">nvda</th>
<td>-0.6634</td>
<td>373</td>
<td>18.4019</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="132327d8" class="cell" data-execution_count="39">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>episodes_rows <span class="op">=</span> []</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, r <span class="kw">in</span> obj.items():</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    ep <span class="op">=</span> drawdown_episodes(r).sort_values(<span class="st">"depth"</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    ep <span class="op">=</span> ep.head(<span class="dv">2</span>).copy()</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    ep.insert(<span class="dv">0</span>, <span class="st">"object"</span>, name)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    episodes_rows.append(ep)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>episodes_tbl <span class="op">=</span> pd.concat(episodes_rows, axis<span class="op">=</span><span class="dv">0</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>display(episodes_tbl)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">object</th>
<th data-quarto-table-cell-role="th">start</th>
<th data-quarto-table-cell-role="th">end</th>
<th data-quarto-table-cell-role="th">depth</th>
<th data-quarto-table-cell-role="th">duration</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>nvda</td>
<td>2021-11-30</td>
<td>2023-05-24</td>
<td>-0.663351</td>
<td>373</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>nvda</td>
<td>2018-10-02</td>
<td>2020-02-13</td>
<td>-0.560400</td>
<td>344</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>aapl</td>
<td>2018-10-04</td>
<td>2019-10-09</td>
<td>-0.385177</td>
<td>255</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>aapl</td>
<td>2024-12-27</td>
<td>2025-10-17</td>
<td>-0.333607</td>
<td>202</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>mv_ewma</td>
<td>2020-02-21</td>
<td>2020-05-13</td>
<td>-0.295405</td>
<td>58</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>mv_ewma</td>
<td>2021-03-23</td>
<td>2023-11-30</td>
<td>-0.251735</td>
<td>679</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>maxsharpe_frontier</td>
<td>2021-02-16</td>
<td>2026-01-20</td>
<td>-0.477211</td>
<td>1238</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>maxsharpe_frontier</td>
<td>2020-02-20</td>
<td>2020-05-08</td>
<td>-0.282402</td>
<td>56</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>From the plot, we have the most drawdown in Nvidia. it means in around 2022 we reached our peak in nvidia and then it came down around 66% in 2022 before going up and reaching it’s last peak again. this is the part that makes keeping nvidia stocks hard. you would have earned a lot of money from Nvidia <strong>Only if</strong> you kept it through the 50-60% loss in 2019 and 2022. Apple seems to have better performance than maxsharpe in drawdown. and MV_ewma has the most stable performance and the least max drawdown. below we get to more details about drawdown.</p>
<p>looks like Maxsharpe diversification isn’t as good for reducing drawdown and negative effects of crashes like covid, but in some times like 2019 that both stocks have huge drawdown that can be a market effect, it doesn’t have that much drawdown.</p>
<hr>
</section>
</section>
<section id="value-at-risk-var-and-expected-shortfall-es-or-cvar" class="level2">
<h2 class="anchored" data-anchor-id="value-at-risk-var-and-expected-shortfall-es-or-cvar">6) Value-at-risk (VaR) and expected shortfall (ES or CVaR)</h2>
<p>We analyzed tail and distribution of objects for risk and average worst days to answer On bad days, how large can losses get and how severe are losses once we enter the tail</p>
<p>If daily simple returns be <span class="math inline">\(r_t\)</span> (<span class="math inline">\(r_t=-0.02\)</span> means a <span class="math inline">\(-2\%\)</span> return in one day).<br>
We choose a tail probability <span class="math inline">\(\alpha\)</span> (common one is <span class="math inline">\(\alpha=0.05\)</span> for the <strong>worst 5%</strong> of days).</p>
<section id="left-tail-quantile" class="level3">
<h3 class="anchored" data-anchor-id="left-tail-quantile">6.1 left-tail quantile</h3>
<p>We define the left-tail quantile <span class="math inline">\(q_\alpha\)</span> of the return distribution as the threshold such that only an <span class="math inline">\(\alpha\)</span> fraction of observations fall below it:</p>
<p><span class="math display">\[
P(r \le q_\alpha(r)) = \alpha.
\]</span></p>
<p>Because this is the <strong>left</strong> tail, <span class="math inline">\(q_\alpha(r)\)</span> is typically <strong>negative</strong> (a loss).<br>
Risk reports often present tail risk as a <strong>positive loss magnitude</strong> for readability.</p>
</section>
<section id="value-at-risk-var" class="level3">
<h3 class="anchored" data-anchor-id="value-at-risk-var">6.2 value-at-risk (VaR)</h3>
<p>VaR is a threshold loss:</p>
<p>Using the quantile definition:</p>
<p><span class="math display">\[
\text{VaR}_\alpha = -q_\alpha(r).
\]</span></p>
<p>For example if <span class="math inline">\(\alpha=0.05\)</span> - If <span class="math inline">\(\text{VaR}_{0.05}=2.1\%\)</span>, then on <strong>95%</strong> of days the loss is <strong>no worse than 2.1%</strong>. - On the <strong>worst 5%</strong> of days, losses are <strong>worse than 2.1%</strong>. - This means we should except this asset to have more than 2.1% loss in the worst 5% of days. It’s rare but it happens and it’s importnant to know how much loss we except as a measure of risk.</p>
<p>The problem is that VaR tells you where the tail begins, but not how large losses are inside the tail.</p>
<hr>
</section>
<section id="expected-shortfall-es-conditional-var" class="level3">
<h3 class="anchored" data-anchor-id="expected-shortfall-es-conditional-var">6.3 expected shortfall (ES) / conditional VaR</h3>
<p>Expected Shortfall (ES) measures tail severity by averaging losses beyond VaR:</p>
<p><span class="math display">\[
\text{ES}_\alpha = -E\!\left[r \mid r \le q_\alpha(r)\right].
\]</span></p>
<p>If <span class="math inline">\(\alpha=0.05\)</span>: - If <span class="math inline">\(\text{ES}_{0.05}=3.4\%\)</span>, then among the <strong>worst 5%</strong> of days, the <strong>average loss</strong> is <strong>3.4%</strong>.</p>
<ul>
<li>VaR is a cutoff (one quantile). It tells us what the best return in the worst 5% losses are.</li>
<li>ES is a severity measure. it tells us the average loss we should except in the worst 5% of losses.</li>
</ul>
<p>ES is always bigger (or maybe equal) than VaR. If ES is much larger than VaR, the distribution has a heavier left tail (more extreme losses after crossing the threshold).</p>
<hr>
</section>
</section>
<section id="estimation-methods-used-in-this-report" class="level2">
<h2 class="anchored" data-anchor-id="estimation-methods-used-in-this-report">6.4 estimation methods used in this report</h2>
<p>We report a comparison table for <span class="math inline">\(\alpha=0.05\)</span> using two other estimators: 1) <strong>Cornish–Fisher (CF) adjusted quantiles</strong> 2) <strong>Filtered historical simulation (FHS) with EWMA volatility</strong></p>
<p>A single VaR/ES estimate can be fragile, so comparing multiple approaches helps users see a plausible range.</p>
<section id="cornishfisher-cf-non-normal-quantile-correction-using-skewness-and-kurtosis" class="level3">
<h3 class="anchored" data-anchor-id="cornishfisher-cf-non-normal-quantile-correction-using-skewness-and-kurtosis">6.4.1 cornish–fisher (CF): non-normal quantile correction using skewness and kurtosis</h3>
<p>CF starts from the <strong>normal</strong> quantile and adjusts it to reflect <strong>skewness</strong> and <strong>fat tails</strong>.</p>
</section>
<section id="a-standardize-returns" class="level3">
<h3 class="anchored" data-anchor-id="a-standardize-returns">(a) standardize returns</h3>
<p>From a sample window, estimate: - <span class="math inline">\(\mu\)</span> (sample mean) and <span class="math inline">\(\sigma\)</span> (sample standard deviation) - standardized values <span class="math inline">\(x_t = (r_t-\mu)/\sigma\)</span></p>
<p>Compute standardized <strong>skewness</strong> <span class="math inline">\(S\)</span> and <strong>excess kurtosis</strong> <span class="math inline">\(K\)</span>:</p>
<p><span class="math display">\[
S = E[X^3] \approx \frac{1}{T}\sum_{t=1}^T x_t^3,
\qquad
K = E[X^4]-3 \approx \frac{1}{T}\sum_{t=1}^T x_t^4 - 3.
\]</span></p>
</section>
<section id="b-adjust-the-normal-quantile" class="level3">
<h3 class="anchored" data-anchor-id="b-adjust-the-normal-quantile">(b) adjust the normal quantile</h3>
<p>We set <span class="math inline">\(z = z_\alpha = \Phi^{-1}(\alpha)\)</span> as the standard normal <span class="math inline">\(\alpha\)</span>-quantile.</p>
<p>A commonly used CF expansion is:</p>
<p><span class="math display">\[
z_{\text{CF}} =
z
+\frac{1}{6}(z^2-1)S
+\frac{1}{24}(z^3-3z)K
-\frac{1}{36}(2z^3-5z)S^2.
\]</span></p>
<p>Then the CF return quantile is:</p>
<p><span class="math display">\[
q_\alpha^{\text{CF}}(r) = \mu + \sigma z_{\text{CF}}.
\]</span></p>
<p>So the CF VaR is:</p>
<p><span class="math display">\[
\text{VaR}_\alpha^{\text{CF}} = -\left(\mu + \sigma z_{\text{CF}}\right).
\]</span></p>
</section>
<section id="c-cornish-fisher-es" class="level3">
<h3 class="anchored" data-anchor-id="c-cornish-fisher-es">(c) Cornish Fisher ES</h3>
<p>CF primarily provides a corrected <strong>quantile</strong> (VaR).<br>
A common practical ES approximation is to compute ES empirically using the CF cutoff:</p>
<p>We first compute <span class="math inline">\(q_\alpha^{\text{CF}}(r)\)</span><br>
and then average sample returns below that cutoff:</p>
<p><span class="math display">\[
\text{ES}_\alpha^{\text{CF}}
\approx
-\frac{1}{|\mathcal{T}_\alpha^{\text{CF}}|}\sum_{t\in \mathcal{T}_\alpha^{\text{CF}}} r_t,
\qquad
\mathcal{T}_\alpha^{\text{CF}}=\{t:r_t\le q_\alpha^{\text{CF}}(r)\}.
\]</span></p>
<p>This model incorporates skewness/kurtosis (non-normality), but approximation can be unstable if skew/kurt estimates are noisy or tails are extreme</p>
<p>negative skew (<span class="math inline">\(S&lt;0\)</span>) usually worsens left-tail quantiles positive excess kurtosis (<span class="math inline">\(K&gt;0\)</span>) deepens tail risk vs normal</p>
<hr>
</section>
<section id="historical-simulation-hs" class="level3">
<h3 class="anchored" data-anchor-id="historical-simulation-hs">6.4.2 historical simulation (HS)</h3>
<p>HS is the most direct approach: it treats the observed return window as the empirical distribution.</p>
<p>The HS quantile is the empirical quantile</p>
<p><span class="math display">\[
q_\alpha^{\text{HS}}(r) = \text{EmpQuantile}_\alpha(\{r_t\}_{t=1}^T),
\]</span></p>
<p>so</p>
<p><span class="math display">\[
\text{VaR}_\alpha^{\text{HS}} = -q_\alpha^{\text{HS}}(r).
\]</span></p>
<p>And HS ES is:</p>
<p><span class="math display">\[
\text{ES}_\alpha^{\text{HS}}
= -E[r \mid r \le q_\alpha^{\text{HS}}(r)]
\approx
-\frac{1}{|\mathcal{T}_\alpha|}\sum_{t\in \mathcal{T}_\alpha} r_t.
\]</span></p>
<p>This moodel can be sensitive to the chosen window, and to regime changes</p>
<hr>
</section>
<section id="filtered-historical-simulation-fhs-volatility-adjusted-tail-estimation" class="level3">
<h3 class="anchored" data-anchor-id="filtered-historical-simulation-fhs-volatility-adjusted-tail-estimation">6.4.3 filtered historical simulation (FHS): volatility-adjusted tail estimation</h3>
<p>HS assumes the return distribution is stable across time.<br>
In reality, returns show <strong>volatility clustering</strong> (calm vs turbulent periods).<br>
With FHS we address this by filtering out time-varying volatility before sampling the tail.</p>
</section>
<section id="ewma-volatility-filter" class="level3">
<h3 class="anchored" data-anchor-id="ewma-volatility-filter">EWMA volatility filter</h3>
<p>There are many ways for filtering. In this project we use this approach:</p>
<p>We estimate conditional variance using EWMA:</p>
<p><span class="math display">\[
\sigma_t^2 = \lambda \sigma_{t-1}^2 + (1-\lambda)r_{t-1}^2,
\]</span></p>
<p>where <span class="math inline">\(\lambda\in(0,1)\)</span> is the decay parameter (we set as <span class="math inline">\(\lambda\approx 0.94\)</span>).</p>
</section>
<section id="fhs-expected-shortfall" class="level3">
<h3 class="anchored" data-anchor-id="fhs-expected-shortfall">FHS expected shortfall</h3>
<p><span class="math display">\[
\text{ES}_{\alpha,t+1}^{\text{FHS}} =
-\left(\mu_{t+1} + \sigma_{t+1} \, E[\varepsilon \mid \varepsilon \le q_\alpha(\varepsilon)]\right).
\]</span></p>
<p>Empirically:</p>
<p><span class="math display">\[
E[\varepsilon \mid \varepsilon \le q_\alpha(\varepsilon)]
\approx
\frac{1}{|\mathcal{T}_\alpha^\varepsilon|}
\sum_{t\in \mathcal{T}_\alpha^\varepsilon}\varepsilon_t.
\]</span></p>
<p>So:</p>
<p><span class="math display">\[
\text{ES}_{\alpha,t+1}^{\text{FHS}}
\approx
-\left(\mu_{t+1} + \sigma_{t+1}
\frac{1}{|\mathcal{T}_\alpha^\varepsilon|}
\sum_{t\in \mathcal{T}_alpha^\varepsilon}\varepsilon_t\right).
\]</span></p>
<p>This model adapts to volatility regimes and has better behavior when today’s volatility differs from the historical average of volatility, but it depends what model we use and can be different</p>
<div id="106e6335" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hist_var_es(r, alpha<span class="op">=</span><span class="fl">0.05</span>):</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> pd.Series(r).dropna()</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    q <span class="op">=</span> x.quantile(alpha)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    es <span class="op">=</span> x[x <span class="op">&lt;=</span> q].mean()</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span><span class="bu">float</span>(q), <span class="op">-</span><span class="bu">float</span>(es)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cf_var_es(r, alpha<span class="op">=</span><span class="fl">0.05</span>, n_sim<span class="op">=</span><span class="dv">70000</span>, seed<span class="op">=</span><span class="dv">7</span>):</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> pd.Series(r).dropna()</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> <span class="bu">float</span>(x.mean())</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    sd <span class="op">=</span> <span class="bu">float</span>(x.std(ddof<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> sd <span class="op">&lt;=</span> <span class="fl">1e-12</span>:</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.nan, np.nan</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> <span class="bu">float</span>(x.skew())</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    k <span class="op">=</span> <span class="bu">float</span>(x.kurt())</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> normaldist().inv_cdf(alpha)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    zc <span class="op">=</span> z <span class="op">+</span> (z<span class="op">**</span><span class="dv">2</span> <span class="op">-</span> <span class="dv">1</span>)<span class="op">*</span>s<span class="op">/</span><span class="dv">6</span> <span class="op">+</span> (z<span class="op">**</span><span class="dv">3</span> <span class="op">-</span> <span class="dv">3</span><span class="op">*</span>z)<span class="op">*</span>k<span class="op">/</span><span class="dv">24</span> <span class="op">-</span> (<span class="dv">2</span><span class="op">*</span>z<span class="op">**</span><span class="dv">3</span> <span class="op">-</span> <span class="dv">5</span><span class="op">*</span>z)<span class="op">*</span>(s<span class="op">**</span><span class="dv">2</span>)<span class="op">/</span><span class="dv">36</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    q <span class="op">=</span> mu <span class="op">+</span> sd <span class="op">*</span> zc</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    rng <span class="op">=</span> np.random.default_rng(seed)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    zs <span class="op">=</span> rng.standard_normal(n_sim)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    za <span class="op">=</span> zs <span class="op">+</span> (zs<span class="op">**</span><span class="dv">2</span> <span class="op">-</span> <span class="dv">1</span>)<span class="op">*</span>s<span class="op">/</span><span class="dv">6</span> <span class="op">+</span> (zs<span class="op">**</span><span class="dv">3</span> <span class="op">-</span> <span class="dv">3</span><span class="op">*</span>zs)<span class="op">*</span>k<span class="op">/</span><span class="dv">24</span> <span class="op">-</span> (<span class="dv">2</span><span class="op">*</span>zs<span class="op">**</span><span class="dv">3</span> <span class="op">-</span> <span class="dv">5</span><span class="op">*</span>zs)<span class="op">*</span>(s<span class="op">**</span><span class="dv">2</span>)<span class="op">/</span><span class="dv">36</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    rs <span class="op">=</span> mu <span class="op">+</span> sd <span class="op">*</span> za</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    es <span class="op">=</span> rs[rs <span class="op">&lt;=</span> q].mean()</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span><span class="bu">float</span>(q), <span class="op">-</span><span class="bu">float</span>(es)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fhs_var_es(r, alpha<span class="op">=</span><span class="fl">0.05</span>, lam<span class="op">=</span><span class="fl">0.94</span>):</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> pd.Series(r).dropna().astype(<span class="bu">float</span>)</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> <span class="bu">float</span>(x.mean())</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    e <span class="op">=</span> x <span class="op">-</span> mu</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    sig <span class="op">=</span> np.zeros(<span class="bu">len</span>(e), dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    sig[<span class="dv">0</span>] <span class="op">=</span> <span class="bu">max</span>(<span class="bu">float</span>(e.std(ddof<span class="op">=</span><span class="dv">1</span>)), <span class="fl">1e-6</span>)</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(e)):</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>        sig[t] <span class="op">=</span> np.sqrt(lam <span class="op">*</span> sig[t <span class="op">-</span> <span class="dv">1</span>]<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> lam) <span class="op">*</span> e.iloc[t <span class="op">-</span> <span class="dv">1</span>]<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> e.to_numpy() <span class="op">/</span> np.where(sig <span class="op">&gt;</span> <span class="fl">1e-12</span>, sig, np.nan)</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> z[np.isfinite(z)]</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    qz <span class="op">=</span> np.quantile(z, alpha)</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>    ez <span class="op">=</span> z[z <span class="op">&lt;=</span> qz].mean()</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>    sn <span class="op">=</span> sig[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">float</span>(<span class="op">-</span>(mu <span class="op">+</span> sn <span class="op">*</span> qz)), <span class="bu">float</span>(<span class="op">-</span>(mu <span class="op">+</span> sn <span class="op">*</span> ez))</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>var_rows <span class="op">=</span> []</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, r <span class="kw">in</span> obj.items():</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> pd.Series(r).dropna()</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>    hv, he <span class="op">=</span> hist_var_es(x, <span class="fl">0.05</span>)</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>    cv, ce <span class="op">=</span> cf_var_es(x, <span class="fl">0.05</span>)</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>    fv, fe <span class="op">=</span> fhs_var_es(x, <span class="fl">0.05</span>)</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>    var_rows.append({</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>        <span class="st">"object"</span>: name,</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>        <span class="st">"hist_var5"</span>: hv,</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>        <span class="st">"hist_es5"</span>: he,</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>        <span class="st">"cf_var5"</span>: cv,</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>        <span class="st">"cf_es5"</span>: ce,</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>        <span class="st">"fhs_var5"</span>: fv,</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>        <span class="st">"fhs_es5"</span>: fe,</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>var_tbl <span class="op">=</span> pd.DataFrame(var_rows).set_index(<span class="st">"object"</span>).sort_index()</span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>display(var_tbl.<span class="bu">round</span>(<span class="dv">4</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">hist_var5</th>
<th data-quarto-table-cell-role="th">hist_es5</th>
<th data-quarto-table-cell-role="th">cf_var5</th>
<th data-quarto-table-cell-role="th">cf_es5</th>
<th data-quarto-table-cell-role="th">fhs_var5</th>
<th data-quarto-table-cell-role="th">fhs_es5</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">object</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">aapl</th>
<td>0.0287</td>
<td>0.0425</td>
<td>0.0261</td>
<td>0.0547</td>
<td>0.0205</td>
<td>0.0299</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">maxsharpe_frontier</th>
<td>0.0283</td>
<td>0.0447</td>
<td>0.0276</td>
<td>0.0578</td>
<td>0.0455</td>
<td>0.0679</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mv_ewma</th>
<td>0.0149</td>
<td>0.0245</td>
<td>0.0156</td>
<td>0.0439</td>
<td>0.0136</td>
<td>0.0207</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">nvda</th>
<td>0.0466</td>
<td>0.0691</td>
<td>0.0446</td>
<td>0.0839</td>
<td>0.0286</td>
<td>0.0409</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="121c670f" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> axes.ravel()</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (name, r) <span class="kw">in</span> <span class="bu">enumerate</span>(obj.items()):</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> axes[i]</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> pd.Series(r).dropna()</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    hv, he <span class="op">=</span> hist_var_es(x, <span class="fl">0.05</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    ax.hist(x.values, bins<span class="op">=</span><span class="dv">60</span>, density<span class="op">=</span><span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.75</span>)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    ax.axvline(<span class="op">-</span>hv, lw<span class="op">=</span><span class="fl">2.0</span>, ls<span class="op">=</span><span class="st">"--"</span>, color<span class="op">=</span>obj_colors[name], label<span class="op">=</span><span class="st">"vaR 5% (hist)"</span>)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    ax.axvline(<span class="op">-</span>he, lw<span class="op">=</span><span class="fl">2.0</span>, ls<span class="op">=</span><span class="st">":"</span>, color<span class="op">=</span>obj_colors[name], label<span class="op">=</span><span class="st">"es 5% (hist)"</span>)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f"return distribution — </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    ax.legend()</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03_risk_report_engine_and_CAPM_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can see from the table that models give us different results. If we only cosider Historic VaR, We might think that Apple is more risky than MaxSharpe, but other models show otherwise. again we see that the loss of Nvidia is the most in most of the models. and MV_ewma has controlled the risk the best way.</p>
</section>
</section>
<section id="var-backtesting-model-risk" class="level2">
<h2 class="anchored" data-anchor-id="var-backtesting-model-risk">7) VaR backtesting (Model risk)</h2>
<p>A VaR model makes a testable promise. For a 5% VaR, Losses should exceed the VaR threshold about 5% of the time.</p>
<p>Backtesting checks whether that promise holds in realized data.</p>
<section id="breach-indicator-what-counts-as-a-var-failure" class="level3">
<h3 class="anchored" data-anchor-id="breach-indicator-what-counts-as-a-var-failure">7.1 breach indicator (what counts as a VaR failure)</h3>
<p>A VaR breach occurs when the realized return is worse than the VaR threshold:</p>
<p><span class="math display">\[
r_t &lt; -\text{VaR}_{\alpha,t}.
\]</span></p>
<p>We define the breach indicator:</p>
<p><span class="math display">\[
b_t = \mathbb{1}\!\left[r_t &lt; -\text{VaR}_{\alpha,t}\right],
\]</span></p>
<p>where <span class="math inline">\(b_t=1\)</span> means a breach happened, and <span class="math inline">\(b_t=0\)</span> otherwise.</p>
<p>We summarize breaches using: - <strong>breach count:</strong> <span class="math inline">\(x = \sum_{t=1}^n b_t\)</span> - <strong>breach rate:</strong> <span class="math inline">\(\hat p = x/n\)</span> - <strong>longest breach streak:</strong> <span class="math inline">\(\max\)</span> number of consecutive <span class="math inline">\(b_t=1\)</span> (a simple clustering diagnostic)</p>
<p>If the VaR model is correct, we expect <span class="math inline">\(\hat p \approx \alpha\)</span> over a long sample. If breaches happen in streaks, the model may be underreacting to volatility regime changes (clustering risk).</p>
<hr>
</section>
<section id="kupiec-test-unconditional-coverage-frequency" class="level3">
<h3 class="anchored" data-anchor-id="kupiec-test-unconditional-coverage-frequency">7.2 Kupiec test: unconditional coverage (frequency)</h3>
<p>The <strong>Kupiec (POF)</strong> test checks whether breaches occur with the correct long-run frequency.</p>
<p>If we have: - <span class="math inline">\(n\)</span> = number of test days - <span class="math inline">\(x\)</span> = number of breaches - <span class="math inline">\(\hat p = x/n\)</span> = observed breach rate - <span class="math inline">\(p = \alpha\)</span> = model-implied breach probability (5%)</p>
<p>Kupiec’s likelihood ratio statistic is:</p>
<p>The log-likelihood under the null (correct coverage) is:</p>
<p><span class="math display">\[
\ell_0 = (n-x)\log(1-p) + x\log(p).
\]</span></p>
<p>The log-likelihood under the alternative (best-fitting rate) is:</p>
<p><span class="math display">\[
\ell_1 = (n-x)\log(1-\hat p) + x\log(\hat p).
\]</span></p>
<p>Kupiec’s likelihood-ratio statistic is:</p>
<p><span class="math display">\[
\text{LR}_{uc} = -2(\ell_0-\ell_1),
\qquad
\text{LR}_{uc}\sim \chi^2(1)\ \text{under }H_0.
\]</span></p>
<p>it means: - <strong>large</strong> <span class="math inline">\(\text{LR}_{uc}\)</span> (small p-value) means the breach frequency is wrong: - too many breaches means VaR is too small (underestimates risk) - too few breaches means VaR is too conservative</p>
<hr>
</section>
<section id="christoffersen-test-independence-clustering" class="level3">
<h3 class="anchored" data-anchor-id="christoffersen-test-independence-clustering">7.3 Christoffersen test: independence / clustering</h3>
<p>Correct frequency alone is not enough, breaches should also be independent over time.<br>
If breaches have clustering, the VaR model may fail during volatility spikes or regime shifts. se we test independence</p>
<p>The Christoffersen independence test treats the breach sequence <span class="math inline">\(b_t\)</span> as a two-state process (0 = no breach, 1 = breach) and checks whether transitions depend on the previous day.</p>
<p>Count transitions: - <span class="math inline">\(n_{00}\)</span>: number of times <span class="math inline">\(b_{t-1}=0 \to b_t=0\)</span> - <span class="math inline">\(n_{01}\)</span>: number of times <span class="math inline">\(b_{t-1}=0 \to b_t=1\)</span> - <span class="math inline">\(n_{10}\)</span>: number of times <span class="math inline">\(b_{t-1}=1 \to b_t=0\)</span> - <span class="math inline">\(n_{11}\)</span>: number of times <span class="math inline">\(b_{t-1}=1 \to b_t=1\)</span></p>
<p>Estimate transition probabilities:</p>
<p><span class="math display">\[
\pi_{01} = \frac{n_{01}}{n_{00}+n_{01}}, \qquad
\pi_{11} = \frac{n_{11}}{n_{10}+n_{11}}.
\]</span></p>
<p>If breaches are independent, the probability of a breach tomorrow does not depend on whether there was a breach today, so:</p>
<p><span class="math display">\[
H_0: \pi_{01} = \pi_{11}.
\]</span></p>
<p>Log-likelihood under independence: <span class="math display">\[
\ell_0 = (n_{00}+n_{10})\log(1-\pi) + (n_{01}+n_{11})\log(\pi).
\]</span></p>
<p>Log-likelihood under dependence (two transition probabilities): <span class="math display">\[
\ell_1 =
n_{00}\log(1-\pi_{01}) + n_{01}\log(\pi_{01})
+
n_{10}\log(1-\pi_{11}) + n_{11}\log(\pi_{11}).
\]</span></p>
<p>The test statistic is: <span class="math display">\[
\text{LR}_{ind} = -2(\ell_0-\ell_1),
\qquad
\text{LR}_{ind}\sim \chi^2(1)\ \text{under }H_0.
\]</span></p>
<p>We define likelihoods: - under independence (Bernoulli with constant probability <span class="math inline">\(\hat p\)</span>):</p>
<p><span class="math display">\[
L_0 =
(1-\hat p)^{n_{00}+n_{10}}
\hat p^{n_{01}+n_{11}}
\]</span></p>
<ul>
<li>under first-order dependence (different transition probabilities):</li>
</ul>
<p><span class="math display">\[
L_1 =
(1-\pi_{01})^{n_{00}}
\pi_{01}^{n_{01}}
(1-\pi_{11})^{n_{10}}
\pi_{11}^{n_{11}}.
\]</span></p>
<p>Christoffersen’s likelihood ratio statistic:</p>
<p><span class="math display">\[
\text{LR}_{ind} = -2\ln\left(\frac{L_0}{L_1}\right)
\qquad
\text{LR}_{ind}\sim \chi^2(1) \text{ under } H_0.
\]</span></p>
<p>small p-value means breaches are clustered (depend on previous breach status) clustering is a common sign that the VaR model is not adapting fast enough to changing volatility</p>
<p>We report p-values for:</p>
<ul>
<li><strong>Kupiec (coverage)</strong>: is breach frequency close to <span class="math inline">\(\alpha\)</span></li>
<li><strong>Christoffersen (independence)</strong>: are breaches unclustered</li>
</ul>
<p>A well-specified VaR model typically has: - coverage p-value not too small (frequency is plausible) - independence p-value not too small (no strong clustering)</p>
<p>Small p-values suggest misspecification: wrong level of risk, volatility dynamics not captured, or regime changes.</p>
<div id="b0e4f64e" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>alpha <span class="op">=</span> <span class="fl">0.05</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>lookback <span class="op">=</span> <span class="dv">252</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>bt_methods <span class="op">=</span> [<span class="st">"hist"</span>, <span class="st">"cf"</span>, <span class="st">"fhs"</span>]</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> chi2_sf(x, df):</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">float</span>(chi2.sf(x, df))</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rolling_var_quantile(r, alpha<span class="op">=</span><span class="fl">0.05</span>, lookback<span class="op">=</span><span class="dv">252</span>, method<span class="op">=</span><span class="st">"hist"</span>, cf_n_sim<span class="op">=</span><span class="dv">15000</span>, cf_seed<span class="op">=</span><span class="dv">7</span>, fhs_lambda<span class="op">=</span><span class="fl">0.94</span>):</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> pd.Series(r).dropna().astype(<span class="bu">float</span>)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(x) <span class="op">&lt;</span> lookback <span class="op">+</span> <span class="dv">1</span>:</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series(dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> <span class="bu">str</span>(method).strip().lower()</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    q <span class="op">=</span> pd.Series(np.nan, index<span class="op">=</span>x.index, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(lookback, <span class="bu">len</span>(x)):</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>        w <span class="op">=</span> x.iloc[i <span class="op">-</span> lookback:i]</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> m <span class="op">==</span> <span class="st">"hist"</span>:</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>            v, _ <span class="op">=</span> hist_var_es(w, alpha<span class="op">=</span>alpha)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> m <span class="op">==</span> <span class="st">"cf"</span>:</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>            v, _ <span class="op">=</span> cf_var_es(w, alpha<span class="op">=</span>alpha, n_sim<span class="op">=</span>cf_n_sim, seed<span class="op">=</span>cf_seed)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> m <span class="op">==</span> <span class="st">"fhs"</span>:</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>            v, _ <span class="op">=</span> fhs_var_es(w, alpha<span class="op">=</span>alpha, lam<span class="op">=</span>fhs_lambda)</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"method must be one of {'hist', 'cf', 'fhs'}"</span>)</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>        q.iloc[i] <span class="op">=</span> <span class="op">-</span><span class="bu">float</span>(v) <span class="cf">if</span> np.isfinite(v) <span class="cf">else</span> np.nan</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> q</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> longest_true_streak(mask):</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> np.asarray(mask, dtype<span class="op">=</span><span class="bu">bool</span>)</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>    best <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>    cur <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> v <span class="kw">in</span> m:</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> v:</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>            cur <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>            best <span class="op">=</span> <span class="bu">max</span>(best, cur)</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>            cur <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">int</span>(best)</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> kupiec_test(breach, alpha<span class="op">=</span><span class="fl">0.05</span>):</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>    b <span class="op">=</span> np.asarray(breach, dtype<span class="op">=</span><span class="bu">bool</span>)</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">int</span>(b.size)</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="bu">int</span>(b.<span class="bu">sum</span>())</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.nan, np.nan</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> <span class="bu">float</span>(alpha)</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>    eps <span class="op">=</span> <span class="fl">1e-12</span></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>    ph <span class="op">=</span> x <span class="op">/</span> n</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>    ph <span class="op">=</span> <span class="bu">min</span>(<span class="bu">max</span>(ph, eps), <span class="fl">1.0</span> <span class="op">-</span> eps)</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>    ll0 <span class="op">=</span> (n <span class="op">-</span> x) <span class="op">*</span> np.log1p(<span class="op">-</span>p) <span class="op">+</span> x <span class="op">*</span> np.log(p)</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>    ll1 <span class="op">=</span> (n <span class="op">-</span> x) <span class="op">*</span> np.log1p(<span class="op">-</span>ph) <span class="op">+</span> x <span class="op">*</span> np.log(ph)</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>    lr <span class="op">=</span> <span class="bu">float</span>(<span class="op">-</span><span class="fl">2.0</span> <span class="op">*</span> (ll0 <span class="op">-</span> ll1))</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>    pv <span class="op">=</span> chi2_sf(lr, df<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> lr, pv</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> christoffersen_independence(breach):</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>    b <span class="op">=</span> np.asarray(breach, dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> b.size <span class="op">&lt;</span> <span class="dv">3</span>:</span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.nan, np.nan</span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>    b0 <span class="op">=</span> b[:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>    b1 <span class="op">=</span> b[<span class="dv">1</span>:]</span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>    n00 <span class="op">=</span> <span class="bu">int</span>(((b0 <span class="op">==</span> <span class="dv">0</span>) <span class="op">&amp;</span> (b1 <span class="op">==</span> <span class="dv">0</span>)).<span class="bu">sum</span>())</span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>    n01 <span class="op">=</span> <span class="bu">int</span>(((b0 <span class="op">==</span> <span class="dv">0</span>) <span class="op">&amp;</span> (b1 <span class="op">==</span> <span class="dv">1</span>)).<span class="bu">sum</span>())</span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>    n10 <span class="op">=</span> <span class="bu">int</span>(((b0 <span class="op">==</span> <span class="dv">1</span>) <span class="op">&amp;</span> (b1 <span class="op">==</span> <span class="dv">0</span>)).<span class="bu">sum</span>())</span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>    n11 <span class="op">=</span> <span class="bu">int</span>(((b0 <span class="op">==</span> <span class="dv">1</span>) <span class="op">&amp;</span> (b1 <span class="op">==</span> <span class="dv">1</span>)).<span class="bu">sum</span>())</span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>    eps <span class="op">=</span> <span class="fl">1e-12</span></span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>    pi01 <span class="op">=</span> n01 <span class="op">/</span> (n00 <span class="op">+</span> n01 <span class="op">+</span> eps)</span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>    pi11 <span class="op">=</span> n11 <span class="op">/</span> (n10 <span class="op">+</span> n11 <span class="op">+</span> eps)</span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>    pi <span class="op">=</span> (n01 <span class="op">+</span> n11) <span class="op">/</span> (n00 <span class="op">+</span> n01 <span class="op">+</span> n10 <span class="op">+</span> n11 <span class="op">+</span> eps)</span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>    pi01 <span class="op">=</span> <span class="bu">min</span>(<span class="bu">max</span>(pi01, eps), <span class="fl">1.0</span> <span class="op">-</span> eps)</span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>    pi11 <span class="op">=</span> <span class="bu">min</span>(<span class="bu">max</span>(pi11, eps), <span class="fl">1.0</span> <span class="op">-</span> eps)</span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a>    pi <span class="op">=</span> <span class="bu">min</span>(<span class="bu">max</span>(pi, eps), <span class="fl">1.0</span> <span class="op">-</span> eps)</span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a>    ll0 <span class="op">=</span> (n00 <span class="op">+</span> n10) <span class="op">*</span> np.log1p(<span class="op">-</span>pi) <span class="op">+</span> (n01 <span class="op">+</span> n11) <span class="op">*</span> np.log(pi)</span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>    ll1 <span class="op">=</span> (</span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a>        n00 <span class="op">*</span> np.log1p(<span class="op">-</span>pi01) <span class="op">+</span> n01 <span class="op">*</span> np.log(pi01)</span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> n10 <span class="op">*</span> np.log1p(<span class="op">-</span>pi11) <span class="op">+</span> n11 <span class="op">*</span> np.log(pi11)</span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a>    lr <span class="op">=</span> <span class="bu">float</span>(<span class="op">-</span><span class="fl">2.0</span> <span class="op">*</span> (ll0 <span class="op">-</span> ll1))</span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a>    pv <span class="op">=</span> chi2_sf(lr, df<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> lr, pv</span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> quantile_loss(ret, q, alpha<span class="op">=</span><span class="fl">0.05</span>):</span>
<span id="cb14-98"><a href="#cb14-98" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> pd.concat([pd.Series(ret).rename(<span class="st">"ret"</span>), pd.Series(q).rename(<span class="st">"q"</span>)], axis<span class="op">=</span><span class="dv">1</span>).dropna()</span>
<span id="cb14-99"><a href="#cb14-99" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(z) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb14-100"><a href="#cb14-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.nan</span>
<span id="cb14-101"><a href="#cb14-101" aria-hidden="true" tabindex="-1"></a>    e <span class="op">=</span> z[<span class="st">"ret"</span>] <span class="op">-</span> z[<span class="st">"q"</span>]</span>
<span id="cb14-102"><a href="#cb14-102" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> e <span class="op">*</span> (alpha <span class="op">-</span> (e <span class="op">&lt;</span> <span class="dv">0</span>).astype(<span class="bu">float</span>))</span>
<span id="cb14-103"><a href="#cb14-103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">float</span>(loss.mean())</span>
<span id="cb14-104"><a href="#cb14-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-105"><a href="#cb14-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-106"><a href="#cb14-106" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> breach_stats(r, alpha<span class="op">=</span><span class="fl">0.05</span>, lookback<span class="op">=</span><span class="dv">252</span>, method<span class="op">=</span><span class="st">"hist"</span>):</span>
<span id="cb14-107"><a href="#cb14-107" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> pd.Series(r).dropna().astype(<span class="bu">float</span>)</span>
<span id="cb14-108"><a href="#cb14-108" aria-hidden="true" tabindex="-1"></a>    q <span class="op">=</span> rolling_var_quantile(x, alpha<span class="op">=</span>alpha, lookback<span class="op">=</span>lookback, method<span class="op">=</span>method)</span>
<span id="cb14-109"><a href="#cb14-109" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> pd.concat([x.rename(<span class="st">"ret"</span>), q.rename(<span class="st">"var_q"</span>)], axis<span class="op">=</span><span class="dv">1</span>).dropna()</span>
<span id="cb14-110"><a href="#cb14-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-111"><a href="#cb14-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-112"><a href="#cb14-112" aria-hidden="true" tabindex="-1"></a>    br <span class="op">=</span> z[<span class="st">"ret"</span>] <span class="op">&lt;</span> z[<span class="st">"var_q"</span>]</span>
<span id="cb14-113"><a href="#cb14-113" aria-hidden="true" tabindex="-1"></a>    lr_uc, pv_uc <span class="op">=</span> kupiec_test(br, alpha<span class="op">=</span>alpha)</span>
<span id="cb14-114"><a href="#cb14-114" aria-hidden="true" tabindex="-1"></a>    lr_ind, pv_ind <span class="op">=</span> christoffersen_independence(br)</span>
<span id="cb14-115"><a href="#cb14-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-116"><a href="#cb14-116" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> np.flatnonzero(br.to_numpy())</span>
<span id="cb14-117"><a href="#cb14-117" aria-hidden="true" tabindex="-1"></a>    gaps <span class="op">=</span> np.diff(idx) <span class="cf">if</span> idx.size <span class="op">&gt;=</span> <span class="dv">2</span> <span class="cf">else</span> np.array([])</span>
<span id="cb14-118"><a href="#cb14-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-119"><a href="#cb14-119" aria-hidden="true" tabindex="-1"></a>    rate <span class="op">=</span> <span class="bu">float</span>(br.mean())</span>
<span id="cb14-120"><a href="#cb14-120" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb14-121"><a href="#cb14-121" aria-hidden="true" tabindex="-1"></a>        <span class="st">"series"</span>: z,</span>
<span id="cb14-122"><a href="#cb14-122" aria-hidden="true" tabindex="-1"></a>        <span class="st">"breach"</span>: br,</span>
<span id="cb14-123"><a href="#cb14-123" aria-hidden="true" tabindex="-1"></a>        <span class="st">"count"</span>: <span class="bu">int</span>(br.<span class="bu">sum</span>()),</span>
<span id="cb14-124"><a href="#cb14-124" aria-hidden="true" tabindex="-1"></a>        <span class="st">"rate"</span>: rate,</span>
<span id="cb14-125"><a href="#cb14-125" aria-hidden="true" tabindex="-1"></a>        <span class="st">"coverage_error"</span>: <span class="bu">float</span>(rate <span class="op">-</span> alpha),</span>
<span id="cb14-126"><a href="#cb14-126" aria-hidden="true" tabindex="-1"></a>        <span class="st">"abs_coverage_error"</span>: <span class="bu">float</span>(<span class="bu">abs</span>(rate <span class="op">-</span> alpha)),</span>
<span id="cb14-127"><a href="#cb14-127" aria-hidden="true" tabindex="-1"></a>        <span class="st">"longest_streak"</span>: longest_true_streak(br.to_numpy()),</span>
<span id="cb14-128"><a href="#cb14-128" aria-hidden="true" tabindex="-1"></a>        <span class="st">"avg_gap"</span>: <span class="bu">float</span>(np.mean(gaps)) <span class="cf">if</span> gaps.size <span class="cf">else</span> np.nan,</span>
<span id="cb14-129"><a href="#cb14-129" aria-hidden="true" tabindex="-1"></a>        <span class="st">"med_gap"</span>: <span class="bu">float</span>(np.median(gaps)) <span class="cf">if</span> gaps.size <span class="cf">else</span> np.nan,</span>
<span id="cb14-130"><a href="#cb14-130" aria-hidden="true" tabindex="-1"></a>        <span class="st">"kupiec_lr"</span>: lr_uc,</span>
<span id="cb14-131"><a href="#cb14-131" aria-hidden="true" tabindex="-1"></a>        <span class="st">"kupiec_p"</span>: pv_uc,</span>
<span id="cb14-132"><a href="#cb14-132" aria-hidden="true" tabindex="-1"></a>        <span class="st">"christ_lr"</span>: lr_ind,</span>
<span id="cb14-133"><a href="#cb14-133" aria-hidden="true" tabindex="-1"></a>        <span class="st">"christ_p"</span>: pv_ind,</span>
<span id="cb14-134"><a href="#cb14-134" aria-hidden="true" tabindex="-1"></a>        <span class="st">"quantile_loss"</span>: quantile_loss(z[<span class="st">"ret"</span>], z[<span class="st">"var_q"</span>], alpha<span class="op">=</span>alpha),</span>
<span id="cb14-135"><a href="#cb14-135" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-136"><a href="#cb14-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-137"><a href="#cb14-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-138"><a href="#cb14-138" aria-hidden="true" tabindex="-1"></a>rows <span class="op">=</span> []</span>
<span id="cb14-139"><a href="#cb14-139" aria-hidden="true" tabindex="-1"></a>stats_map <span class="op">=</span> {}</span>
<span id="cb14-140"><a href="#cb14-140" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, r <span class="kw">in</span> obj.items():</span>
<span id="cb14-141"><a href="#cb14-141" aria-hidden="true" tabindex="-1"></a>    stats_map[name] <span class="op">=</span> {}</span>
<span id="cb14-142"><a href="#cb14-142" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> m <span class="kw">in</span> bt_methods:</span>
<span id="cb14-143"><a href="#cb14-143" aria-hidden="true" tabindex="-1"></a>        st <span class="op">=</span> breach_stats(r, alpha<span class="op">=</span>alpha, lookback<span class="op">=</span>lookback, method<span class="op">=</span>m)</span>
<span id="cb14-144"><a href="#cb14-144" aria-hidden="true" tabindex="-1"></a>        stats_map[name][m] <span class="op">=</span> st</span>
<span id="cb14-145"><a href="#cb14-145" aria-hidden="true" tabindex="-1"></a>        rows.append({</span>
<span id="cb14-146"><a href="#cb14-146" aria-hidden="true" tabindex="-1"></a>            <span class="st">"object"</span>: name,</span>
<span id="cb14-147"><a href="#cb14-147" aria-hidden="true" tabindex="-1"></a>            <span class="st">"method"</span>: m,</span>
<span id="cb14-148"><a href="#cb14-148" aria-hidden="true" tabindex="-1"></a>            <span class="st">"breach_count"</span>: st[<span class="st">"count"</span>],</span>
<span id="cb14-149"><a href="#cb14-149" aria-hidden="true" tabindex="-1"></a>            <span class="st">"breach_rate"</span>: st[<span class="st">"rate"</span>],</span>
<span id="cb14-150"><a href="#cb14-150" aria-hidden="true" tabindex="-1"></a>            <span class="st">"coverage_error"</span>: st[<span class="st">"coverage_error"</span>],</span>
<span id="cb14-151"><a href="#cb14-151" aria-hidden="true" tabindex="-1"></a>            <span class="st">"abs_coverage_error"</span>: st[<span class="st">"abs_coverage_error"</span>],</span>
<span id="cb14-152"><a href="#cb14-152" aria-hidden="true" tabindex="-1"></a>            <span class="st">"longest_breach_streak"</span>: st[<span class="st">"longest_streak"</span>],</span>
<span id="cb14-153"><a href="#cb14-153" aria-hidden="true" tabindex="-1"></a>            <span class="st">"avg_gap_days"</span>: st[<span class="st">"avg_gap"</span>],</span>
<span id="cb14-154"><a href="#cb14-154" aria-hidden="true" tabindex="-1"></a>            <span class="st">"kupiec_p"</span>: st[<span class="st">"kupiec_p"</span>],</span>
<span id="cb14-155"><a href="#cb14-155" aria-hidden="true" tabindex="-1"></a>            <span class="st">"christoffersen_p"</span>: st[<span class="st">"christ_p"</span>],</span>
<span id="cb14-156"><a href="#cb14-156" aria-hidden="true" tabindex="-1"></a>            <span class="st">"quantile_loss"</span>: st[<span class="st">"quantile_loss"</span>],</span>
<span id="cb14-157"><a href="#cb14-157" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb14-158"><a href="#cb14-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-159"><a href="#cb14-159" aria-hidden="true" tabindex="-1"></a>var_bt_tbl <span class="op">=</span> pd.DataFrame(rows).set_index([<span class="st">"object"</span>, <span class="st">"method"</span>]).sort_index()</span>
<span id="cb14-160"><a href="#cb14-160" aria-hidden="true" tabindex="-1"></a>var_bt_tbl[<span class="st">"accuracy_rank"</span>] <span class="op">=</span> np.nan</span>
<span id="cb14-161"><a href="#cb14-161" aria-hidden="true" tabindex="-1"></a>var_bt_tbl[<span class="st">"accuracy_score"</span>] <span class="op">=</span> np.nan</span>
<span id="cb14-162"><a href="#cb14-162" aria-hidden="true" tabindex="-1"></a>var_bt_tbl[<span class="st">"is_best"</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb14-163"><a href="#cb14-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-164"><a href="#cb14-164" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, g <span class="kw">in</span> var_bt_tbl.groupby(level<span class="op">=</span><span class="dv">0</span>, sort<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb14-165"><a href="#cb14-165" aria-hidden="true" tabindex="-1"></a>    abs_cov <span class="op">=</span> g[<span class="st">"abs_coverage_error"</span>]</span>
<span id="cb14-166"><a href="#cb14-166" aria-hidden="true" tabindex="-1"></a>    qloss <span class="op">=</span> g[<span class="st">"quantile_loss"</span>]</span>
<span id="cb14-167"><a href="#cb14-167" aria-hidden="true" tabindex="-1"></a>    kup <span class="op">=</span> g[<span class="st">"kupiec_p"</span>].fillna(<span class="op">-</span>np.inf)</span>
<span id="cb14-168"><a href="#cb14-168" aria-hidden="true" tabindex="-1"></a>    chrp <span class="op">=</span> g[<span class="st">"christoffersen_p"</span>].fillna(<span class="op">-</span>np.inf)</span>
<span id="cb14-169"><a href="#cb14-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-170"><a href="#cb14-170" aria-hidden="true" tabindex="-1"></a>    r_abs <span class="op">=</span> abs_cov.rank(ascending<span class="op">=</span><span class="va">True</span>, method<span class="op">=</span><span class="st">"min"</span>, na_option<span class="op">=</span><span class="st">"bottom"</span>)</span>
<span id="cb14-171"><a href="#cb14-171" aria-hidden="true" tabindex="-1"></a>    r_ql <span class="op">=</span> qloss.rank(ascending<span class="op">=</span><span class="va">True</span>, method<span class="op">=</span><span class="st">"min"</span>, na_option<span class="op">=</span><span class="st">"bottom"</span>)</span>
<span id="cb14-172"><a href="#cb14-172" aria-hidden="true" tabindex="-1"></a>    r_k <span class="op">=</span> kup.rank(ascending<span class="op">=</span><span class="va">False</span>, method<span class="op">=</span><span class="st">"min"</span>)</span>
<span id="cb14-173"><a href="#cb14-173" aria-hidden="true" tabindex="-1"></a>    r_c <span class="op">=</span> chrp.rank(ascending<span class="op">=</span><span class="va">False</span>, method<span class="op">=</span><span class="st">"min"</span>)</span>
<span id="cb14-174"><a href="#cb14-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-175"><a href="#cb14-175" aria-hidden="true" tabindex="-1"></a>    rank_sum <span class="op">=</span> (r_abs <span class="op">+</span> r_ql <span class="op">+</span> r_k <span class="op">+</span> r_c).astype(<span class="bu">float</span>)</span>
<span id="cb14-176"><a href="#cb14-176" aria-hidden="true" tabindex="-1"></a>    acc_rank <span class="op">=</span> rank_sum.rank(ascending<span class="op">=</span><span class="va">True</span>, method<span class="op">=</span><span class="st">"min"</span>)</span>
<span id="cb14-177"><a href="#cb14-177" aria-hidden="true" tabindex="-1"></a>    acc_score <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> (<span class="fl">1.0</span> <span class="op">+</span> rank_sum)</span>
<span id="cb14-178"><a href="#cb14-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-179"><a href="#cb14-179" aria-hidden="true" tabindex="-1"></a>    var_bt_tbl.loc[g.index, <span class="st">"accuracy_rank"</span>] <span class="op">=</span> acc_rank.to_numpy(dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb14-180"><a href="#cb14-180" aria-hidden="true" tabindex="-1"></a>    var_bt_tbl.loc[g.index, <span class="st">"accuracy_score"</span>] <span class="op">=</span> acc_score.to_numpy(dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb14-181"><a href="#cb14-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-182"><a href="#cb14-182" aria-hidden="true" tabindex="-1"></a>    best_idx <span class="op">=</span> pd.DataFrame(</span>
<span id="cb14-183"><a href="#cb14-183" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb14-184"><a href="#cb14-184" aria-hidden="true" tabindex="-1"></a>            <span class="st">"rank_sum"</span>: rank_sum,</span>
<span id="cb14-185"><a href="#cb14-185" aria-hidden="true" tabindex="-1"></a>            <span class="st">"abs_cov"</span>: abs_cov,</span>
<span id="cb14-186"><a href="#cb14-186" aria-hidden="true" tabindex="-1"></a>            <span class="st">"qloss"</span>: qloss,</span>
<span id="cb14-187"><a href="#cb14-187" aria-hidden="true" tabindex="-1"></a>            <span class="st">"kupiec"</span>: kup,</span>
<span id="cb14-188"><a href="#cb14-188" aria-hidden="true" tabindex="-1"></a>            <span class="st">"christ"</span>: chrp,</span>
<span id="cb14-189"><a href="#cb14-189" aria-hidden="true" tabindex="-1"></a>            <span class="st">"method_name"</span>: [idx[<span class="dv">1</span>] <span class="cf">for</span> idx <span class="kw">in</span> g.index],</span>
<span id="cb14-190"><a href="#cb14-190" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb14-191"><a href="#cb14-191" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span>g.index,</span>
<span id="cb14-192"><a href="#cb14-192" aria-hidden="true" tabindex="-1"></a>    ).sort_values(</span>
<span id="cb14-193"><a href="#cb14-193" aria-hidden="true" tabindex="-1"></a>        by<span class="op">=</span>[<span class="st">"rank_sum"</span>, <span class="st">"abs_cov"</span>, <span class="st">"qloss"</span>, <span class="st">"kupiec"</span>, <span class="st">"christ"</span>, <span class="st">"method_name"</span>],</span>
<span id="cb14-194"><a href="#cb14-194" aria-hidden="true" tabindex="-1"></a>        ascending<span class="op">=</span>[<span class="va">True</span>, <span class="va">True</span>, <span class="va">True</span>, <span class="va">False</span>, <span class="va">False</span>, <span class="va">True</span>],</span>
<span id="cb14-195"><a href="#cb14-195" aria-hidden="true" tabindex="-1"></a>    ).index[<span class="dv">0</span>]</span>
<span id="cb14-196"><a href="#cb14-196" aria-hidden="true" tabindex="-1"></a>    var_bt_tbl.loc[best_idx, <span class="st">"is_best"</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb14-197"><a href="#cb14-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-198"><a href="#cb14-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-199"><a href="#cb14-199" aria-hidden="true" tabindex="-1"></a>display(var_bt_tbl.<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb14-200"><a href="#cb14-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-201"><a href="#cb14-201" aria-hidden="true" tabindex="-1"></a>best_method_map <span class="op">=</span> {obj_name: method <span class="cf">for</span> obj_name, method <span class="kw">in</span> var_bt_tbl[var_bt_tbl[<span class="st">"is_best"</span>]].index}</span>
<span id="cb14-202"><a href="#cb14-202" aria-hidden="true" tabindex="-1"></a>breach_map <span class="op">=</span> {}</span>
<span id="cb14-203"><a href="#cb14-203" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, r <span class="kw">in</span> obj.items():</span>
<span id="cb14-204"><a href="#cb14-204" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> best_method_map.get(name, <span class="st">"hist"</span>)</span>
<span id="cb14-205"><a href="#cb14-205" aria-hidden="true" tabindex="-1"></a>    st <span class="op">=</span> stats_map[name][m]</span>
<span id="cb14-206"><a href="#cb14-206" aria-hidden="true" tabindex="-1"></a>    st[<span class="st">"method"</span>] <span class="op">=</span> m</span>
<span id="cb14-207"><a href="#cb14-207" aria-hidden="true" tabindex="-1"></a>    breach_map[name] <span class="op">=</span> st</span>
<span id="cb14-208"><a href="#cb14-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-209"><a href="#cb14-209" aria-hidden="true" tabindex="-1"></a>var_bt_tbl_pdf <span class="op">=</span> var_bt_tbl.rename(columns<span class="op">=</span>{</span>
<span id="cb14-210"><a href="#cb14-210" aria-hidden="true" tabindex="-1"></a>    <span class="st">"breach_count"</span>: <span class="st">"breaches"</span>,</span>
<span id="cb14-211"><a href="#cb14-211" aria-hidden="true" tabindex="-1"></a>    <span class="st">"breach_rate"</span>: <span class="st">"rate"</span>,</span>
<span id="cb14-212"><a href="#cb14-212" aria-hidden="true" tabindex="-1"></a>    <span class="st">"longest_breach_streak"</span>: <span class="st">"max_streak"</span>,</span>
<span id="cb14-213"><a href="#cb14-213" aria-hidden="true" tabindex="-1"></a>    <span class="st">"avg_gap_days"</span>: <span class="st">"avg_gap_d"</span>,</span>
<span id="cb14-214"><a href="#cb14-214" aria-hidden="true" tabindex="-1"></a>    <span class="st">"kupiec_p"</span>: <span class="st">"kupiec_p"</span>,</span>
<span id="cb14-215"><a href="#cb14-215" aria-hidden="true" tabindex="-1"></a>    <span class="st">"christoffersen_p"</span>: <span class="st">"christoffersen_p"</span>,</span>
<span id="cb14-216"><a href="#cb14-216" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">breach_count</th>
<th data-quarto-table-cell-role="th">breach_rate</th>
<th data-quarto-table-cell-role="th">coverage_error</th>
<th data-quarto-table-cell-role="th">abs_coverage_error</th>
<th data-quarto-table-cell-role="th">longest_breach_streak</th>
<th data-quarto-table-cell-role="th">avg_gap_days</th>
<th data-quarto-table-cell-role="th">kupiec_p</th>
<th data-quarto-table-cell-role="th">christoffersen_p</th>
<th data-quarto-table-cell-role="th">quantile_loss</th>
<th data-quarto-table-cell-role="th">accuracy_rank</th>
<th data-quarto-table-cell-role="th">accuracy_score</th>
<th data-quarto-table-cell-role="th">is_best</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">object</th>
<th data-quarto-table-cell-role="th">method</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th rowspan="3" data-quarto-table-cell-role="th" data-valign="top">aapl</th>
<th data-quarto-table-cell-role="th">cf</th>
<td>135</td>
<td>0.0672</td>
<td>0.0172</td>
<td>0.0172</td>
<td>4</td>
<td>14.9254</td>
<td>0.0008</td>
<td>0.0002</td>
<td>0.0023</td>
<td>2.0</td>
<td>0.0909</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">fhs</th>
<td>105</td>
<td>0.0523</td>
<td>0.0023</td>
<td>0.0023</td>
<td>3</td>
<td>19.2308</td>
<td>0.6437</td>
<td>0.0011</td>
<td>0.0022</td>
<td>1.0</td>
<td>0.2000</td>
<td>True</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">hist</th>
<td>124</td>
<td>0.0617</td>
<td>0.0117</td>
<td>0.0117</td>
<td>4</td>
<td>16.2602</td>
<td>0.0198</td>
<td>0.0002</td>
<td>0.0023</td>
<td>2.0</td>
<td>0.0909</td>
<td>False</td>
</tr>
<tr class="even">
<th rowspan="3" data-quarto-table-cell-role="th" data-valign="top">maxsharpe_frontier</th>
<th data-quarto-table-cell-role="th">cf</th>
<td>119</td>
<td>0.0592</td>
<td>0.0092</td>
<td>0.0092</td>
<td>3</td>
<td>16.7712</td>
<td>0.0647</td>
<td>0.0017</td>
<td>0.0023</td>
<td>3.0</td>
<td>0.0909</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">fhs</th>
<td>107</td>
<td>0.0533</td>
<td>0.0033</td>
<td>0.0033</td>
<td>2</td>
<td>18.6415</td>
<td>0.5068</td>
<td>0.0016</td>
<td>0.0021</td>
<td>1.0</td>
<td>0.1667</td>
<td>True</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">hist</th>
<td>117</td>
<td>0.0582</td>
<td>0.0082</td>
<td>0.0082</td>
<td>3</td>
<td>17.0603</td>
<td>0.0983</td>
<td>0.0004</td>
<td>0.0023</td>
<td>2.0</td>
<td>0.1000</td>
<td>False</td>
</tr>
<tr class="odd">
<th rowspan="3" data-quarto-table-cell-role="th" data-valign="top">mv_ewma</th>
<th data-quarto-table-cell-role="th">cf</th>
<td>103</td>
<td>0.0513</td>
<td>0.0013</td>
<td>0.0013</td>
<td>2</td>
<td>19.1961</td>
<td>0.7949</td>
<td>0.0023</td>
<td>0.0014</td>
<td>1.0</td>
<td>0.1429</td>
<td>True</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">fhs</th>
<td>112</td>
<td>0.0557</td>
<td>0.0057</td>
<td>0.0057</td>
<td>2</td>
<td>17.6396</td>
<td>0.2453</td>
<td>0.0001</td>
<td>0.0013</td>
<td>3.0</td>
<td>0.0909</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">hist</th>
<td>109</td>
<td>0.0543</td>
<td>0.0043</td>
<td>0.0043</td>
<td>3</td>
<td>17.4537</td>
<td>0.3877</td>
<td>0.0002</td>
<td>0.0013</td>
<td>2.0</td>
<td>0.1111</td>
<td>False</td>
</tr>
<tr class="even">
<th rowspan="3" data-quarto-table-cell-role="th" data-valign="top">nvda</th>
<th data-quarto-table-cell-role="th">cf</th>
<td>170</td>
<td>0.0846</td>
<td>0.0346</td>
<td>0.0346</td>
<td>3</td>
<td>11.8343</td>
<td>0.0000</td>
<td>0.0009</td>
<td>0.0039</td>
<td>3.0</td>
<td>0.0769</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">fhs</th>
<td>116</td>
<td>0.0577</td>
<td>0.0077</td>
<td>0.0077</td>
<td>2</td>
<td>17.3913</td>
<td>0.1199</td>
<td>0.2037</td>
<td>0.0035</td>
<td>1.0</td>
<td>0.2000</td>
<td>True</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">hist</th>
<td>126</td>
<td>0.0627</td>
<td>0.0127</td>
<td>0.0127</td>
<td>3</td>
<td>15.9920</td>
<td>0.0117</td>
<td>0.0344</td>
<td>0.0037</td>
<td>2.0</td>
<td>0.1111</td>
<td>False</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="e9109d03" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>), sharex<span class="op">=</span><span class="va">True</span>, sharey<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> axes.ravel()</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, name <span class="kw">in</span> <span class="bu">enumerate</span>(obj.keys()):</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> axes[i]</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> breach_map[name][<span class="st">"series"</span>]</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    br <span class="op">=</span> breach_map[name][<span class="st">"breach"</span>]</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> breach_map[name].get(<span class="st">"method"</span>, <span class="st">"hist"</span>)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    ax.plot(z.index, z[<span class="st">"ret"</span>].values, lw<span class="op">=</span><span class="fl">0.9</span>, alpha<span class="op">=</span><span class="fl">0.85</span>, label<span class="op">=</span><span class="st">"return"</span>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    ax.plot(z.index, z[<span class="st">"var_q"</span>].values, lw<span class="op">=</span><span class="fl">2.0</span>, label<span class="op">=</span><span class="ss">f"rolling vaR q(5%) [</span><span class="sc">{</span>m<span class="sc">}</span><span class="ss">]"</span>)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    ax.scatter(z.index[br], z.loc[br, <span class="st">"ret"</span>].values, s<span class="op">=</span><span class="dv">12</span>, marker<span class="op">=</span><span class="st">"x"</span>, label<span class="op">=</span><span class="st">"breach"</span>)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f"rolling vaR + breaches (best model) - </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">"daily return"</span>)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    ax.legend()</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03_risk_report_engine_and_CAPM_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can see both CF and FHS models have performed better and more accurate than the Historic VaR estimating. and for 3 of our objects FHS has performed better and for MV_ewma, CF ended up with more accuracy</p>
<hr>
</section>
</section>
<section id="historical-stress-windows-scenario-slices" class="level2">
<h2 class="anchored" data-anchor-id="historical-stress-windows-scenario-slices">8) historical stress windows (scenario slices)</h2>
<p>instead of hypothetical shocks, we can look at real historical periods like covid crash and see how did each object behave during that exact window, what was the max drawdown inside the window and how much loss we would take in that period if we held these objects.</p>
<p>for this project we use three periods: - the 4th quarter of 2018 - the Covid crash in the first months of 2020 - inflation of 2022</p>
<div id="abe4625f" class="cell" data-execution_count="40">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>stress_windows <span class="op">=</span> {</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"2018_q4"</span>: (<span class="st">"2018-10-01"</span>, <span class="st">"2018-12-31"</span>),</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"2020_covid"</span>: (<span class="st">"2020-02-20"</span>, <span class="st">"2020-04-30"</span>),</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"2022_inflation"</span>: (<span class="st">"2022-01-03"</span>, <span class="st">"2022-10-31"</span>),</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>stress_rows <span class="op">=</span> []</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> wname, (s, e) <span class="kw">in</span> stress_windows.items():</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> pd.Timestamp(s)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    e <span class="op">=</span> pd.Timestamp(e)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, r <span class="kw">in</span> obj.items():</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> pd.Series(r).loc[(pd.Series(r).index <span class="op">&gt;=</span> s) <span class="op">&amp;</span> (pd.Series(r).index <span class="op">&lt;=</span> e)].dropna()</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(x) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>        nav <span class="op">=</span> nav_series(x)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>        dd <span class="op">=</span> nav <span class="op">/</span> nav.cummax() <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>        worst_week <span class="op">=</span> x.resample(<span class="st">"W-FRI"</span>).<span class="bu">sum</span>().<span class="bu">min</span>() <span class="cf">if</span> <span class="bu">len</span>(x) <span class="op">&gt;</span> <span class="dv">5</span> <span class="cf">else</span> np.nan</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>        stress_rows.append({</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"window"</span>: wname,</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">"object"</span>: name,</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">"cum_return"</span>: <span class="bu">float</span>(nav.iloc[<span class="op">-</span><span class="dv">1</span>] <span class="op">-</span> <span class="dv">1</span>),</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">"max_dd"</span>: <span class="bu">float</span>(dd.<span class="bu">min</span>()),</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">"worst_day"</span>: <span class="bu">float</span>(x.<span class="bu">min</span>()),</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">"worst_week"</span>: <span class="bu">float</span>(worst_week) <span class="cf">if</span> np.isfinite(worst_week) <span class="cf">else</span> np.nan,</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>stress_tbl <span class="op">=</span> pd.DataFrame(stress_rows).sort_values([<span class="st">"window"</span>, <span class="st">"object"</span>]).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="3582f6f2" class="cell" data-execution_count="41">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>display(stress_tbl.<span class="bu">round</span>(<span class="dv">4</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">window</th>
<th data-quarto-table-cell-role="th">object</th>
<th data-quarto-table-cell-role="th">cum_return</th>
<th data-quarto-table-cell-role="th">max_dd</th>
<th data-quarto-table-cell-role="th">worst_day</th>
<th data-quarto-table-cell-role="th">worst_week</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2018_q4</td>
<td>aapl</td>
<td>-0.2988</td>
<td>-0.3651</td>
<td>-0.0663</td>
<td>-0.1140</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2018_q4</td>
<td>maxsharpe_frontier</td>
<td>-0.1036</td>
<td>-0.1442</td>
<td>-0.0375</td>
<td>-0.0506</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2018_q4</td>
<td>mv_ewma</td>
<td>-0.1150</td>
<td>-0.1495</td>
<td>-0.0296</td>
<td>-0.0535</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2018_q4</td>
<td>nvda</td>
<td>-0.5245</td>
<td>-0.5604</td>
<td>-0.1875</td>
<td>-0.1988</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>2020_covid</td>
<td>aapl</td>
<td>-0.0921</td>
<td>-0.2995</td>
<td>-0.1286</td>
<td>-0.1803</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>2020_covid</td>
<td>maxsharpe_frontier</td>
<td>-0.0848</td>
<td>-0.2770</td>
<td>-0.1208</td>
<td>-0.1448</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>2020_covid</td>
<td>mv_ewma</td>
<td>-0.0461</td>
<td>-0.2954</td>
<td>-0.1050</td>
<td>-0.1666</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>2020_covid</td>
<td>nvda</td>
<td>-0.0707</td>
<td>-0.3634</td>
<td>-0.1846</td>
<td>-0.1286</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>2022_inflation</td>
<td>aapl</td>
<td>-0.1329</td>
<td>-0.2834</td>
<td>-0.0587</td>
<td>-0.0830</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>2022_inflation</td>
<td>maxsharpe_frontier</td>
<td>-0.1842</td>
<td>-0.2827</td>
<td>-0.0649</td>
<td>-0.0999</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td>2022_inflation</td>
<td>mv_ewma</td>
<td>-0.0138</td>
<td>-0.1623</td>
<td>-0.0396</td>
<td>-0.0566</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">11</th>
<td>2022_inflation</td>
<td>nvda</td>
<td>-0.5408</td>
<td>-0.6270</td>
<td>-0.0947</td>
<td>-0.1709</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="b472cd22" class="cell" data-execution_count="42">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.dates <span class="im">as</span> mdates</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="bu">len</span>(stress_windows), figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="fl">3.5</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(stress_windows) <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    axes <span class="op">=</span> [axes]</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, (wname, (s, e)) <span class="kw">in</span> <span class="bu">zip</span>(axes, stress_windows.items()):</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> pd.Timestamp(s)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    e <span class="op">=</span> pd.Timestamp(e)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    mid <span class="op">=</span> s <span class="op">+</span> (e <span class="op">-</span> s) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, r <span class="kw">in</span> obj.items():</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> pd.Series(r).loc[(pd.Series(r).index <span class="op">&gt;=</span> s) <span class="op">&amp;</span> (pd.Series(r).index <span class="op">&lt;=</span> e)].dropna()</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(x) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>        nav <span class="op">=</span> nav_series(x)</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>        nav <span class="op">=</span> nav <span class="op">/</span> nav.iloc[<span class="dv">0</span>]</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>        ax.plot(nav.index, nav.values, lw<span class="op">=</span><span class="fl">1.8</span>, color<span class="op">=</span>obj_colors[name], label<span class="op">=</span>name)</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    ax.set_title(wname)</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">"date"</span>)</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    ax.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Force exactly 3 x-ticks to avoid overlap: start, mid, end.</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    ticks <span class="op">=</span> [s, mid, e]</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    ax.set_xticks(ticks)</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_major_formatter(mdates.DateFormatter(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st">"</span>))</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">"x"</span>, labelrotation<span class="op">=</span><span class="dv">0</span>, labelsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">"nav (rebased to 1)"</span>)</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend(ncol<span class="op">=</span><span class="dv">1</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03_risk_report_engine_and_CAPM_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>When it comes to these periods, companies get effected directly and these events cause more drops and negative returns in stock prices and diversification seems to be the safer choice. this is one of the rare measures that we can see MaxSharpe performed better than apple.</p>
<hr>
</section>
<section id="capm-market-factor-decomposition" class="level2">
<h2 class="anchored" data-anchor-id="capm-market-factor-decomposition">9) CAPM / market factor decomposition</h2>
<p>capm explains returns using a single market factor. here, we use spy data that we imported as our market proxy (S&amp;P 500 ETF).</p>
<p>With this model we assume that any return more than risk free rate of our objects can be explained by market returns and market risk effects on these returns.</p>
<p>From this relationship we can interpret how much each object’s risk is dependent to market risk and we can see if each object has any returns more than market returns that can’t be explained with market risk.</p>
<section id="capm-model-daily" class="level3">
<h3 class="anchored" data-anchor-id="capm-model-daily">9.1 capm model (daily)</h3>
<p>using excess returns:</p>
<p><span class="math display">\[
r^{ex}_{j,t} = \alpha_j + \beta_j\, r^{ex}_{m,t} + \varepsilon_{j,t}
\]</span></p>
<p>where: - <span class="math inline">\(r^{ex}_{j,t} = r_{j,t} - r_{f,t}\)</span> (excess return of the object) - <span class="math inline">\(r^{ex}_{m,t} = r_{m,t} - r_{f,t}\)</span> (market = spy) - <span class="math inline">\(\alpha_j\)</span> is “alpha” (average unexplained excess return) - <span class="math inline">\(\beta_j\)</span> is market sensitivity - <span class="math inline">\(\varepsilon\)</span> is the residual</p>
</section>
<section id="estimation-ols-via-sklearn" class="level3">
<h3 class="anchored" data-anchor-id="estimation-ols-via-sklearn">estimation (ols via sklearn)</h3>
<p>OLS (ordinary least squares) is a model for minimizing the square of residuals between the prediction and the real data for fitting a linear regression on our data.</p>
<p><span class="math display">\[
\min_{\alpha,\beta} \sum_t \left(r^{ex}_{j,t} - \alpha - \beta r^{ex}_{m,t}\right)^2
\]</span></p>
<p>the fitted values are:</p>
<p><span class="math display">\[
\hat r^{ex}_{j,t} = \hat\alpha + \hat\beta r^{ex}_{m,t}
\]</span></p>
<p>and <span class="math inline">\(r^2\)</span> is:</p>
<p><span class="math display">\[
r^2 = 1 - \frac{\sum_t (r^{ex}_{j,t} - \hat r^{ex}_{j,t})^2}{\sum_t (r^{ex}_{j,t} - \bar r^{ex}_j)^2}
\]</span></p>
</section>
<section id="active-risk-vs-benchmark-tracking-error-and-information-ratio" class="level3">
<h3 class="anchored" data-anchor-id="active-risk-vs-benchmark-tracking-error-and-information-ratio">9.2 Active risk vs benchmark (tracking error and information ratio)</h3>
<p>We define active return as performance relative to the benchmark:</p>
<p><span class="math display">\[
a_t = r_t - m_t
\]</span></p>
<p>Then Tracking error (annualized):</p>
<p><span class="math display">\[
TE = \sqrt{ann}\;\sigma(a_t)
\]</span></p>
<p>Information ratio (annualized): <span class="math display">\[
IR = \sqrt{ann}\;\frac{E[a_t]}{\sigma(a_t)}
\]</span></p>
<ul>
<li>high TE: we deviate a lot from the benchmark (high active risk)</li>
<li>high IR: we’re rewarded well per unit of active risk</li>
</ul>
</section>
<section id="up-capture-and-down-capture" class="level3">
<h3 class="anchored" data-anchor-id="up-capture-and-down-capture">9.3 Up capture and down capture</h3>
<p>These measure how the object behaves when the market is up vs down.</p>
<p>Let: - <span class="math inline">\(\mathcal{U}=\{t: m_t&gt;0\}\)</span> (up-market days) - <span class="math inline">\(\mathcal{D}=\{t: m_t&lt;0\}\)</span> (down-market days)</p>
<p>Then:</p>
<p><span class="math display">\[
\text{UpCapture}=\frac{E[r_t\mid t\in\mathcal{U}]}{E[m_t\mid t\in\mathcal{U}]},
\qquad
\text{DownCapture}=\frac{E[r_t\mid t\in\mathcal{D}]}{E[m_t\mid t\in\mathcal{D}]}
\]</span></p>
<ul>
<li>UpCapture &gt; 1: stronger upside participation than the benchmark</li>
<li>DownCapture &gt; 1: worse downside participation than the benchmark</li>
<li>&lt; 1 means more calm moves than the benchmark in that regime</li>
</ul>
</section>
<section id="systematic-variance-share" class="level3">
<h3 class="anchored" data-anchor-id="systematic-variance-share">9.4 Systematic variance share</h3>
<p>we want to see how much of an object’s risk is market risk. A simple CAPM-based approximation of the market-driven share of variance:</p>
<p><span class="math display">\[
\text{SystematicVarShare} \approx \frac{\beta^2\,\text{Var}(m^{ex})}{\text{Var}(r^{ex})}
\]</span></p>
<ul>
<li>near 1: most risk comes from the market</li>
<li>near 0: most risk is idiosyncratic (strategy/asset-specific)</li>
</ul>
</section>
<section id="the-regression-scatter-plot" class="level3">
<h3 class="anchored" data-anchor-id="the-regression-scatter-plot">the regression scatter plot</h3>
<ul>
<li>each dot is a day (<span class="math inline">\(x\)</span> = market excess return, <span class="math inline">\(y\)</span> = object excess return)</li>
<li>the fitted line slope is <span class="math inline">\(\beta\)</span></li>
<li>the intercept is <span class="math inline">\(\alpha\)</span></li>
</ul>
<div id="8ada809c" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>capm_rows <span class="op">=</span> []</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>roll_store <span class="op">=</span> {}</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>m_ex <span class="op">=</span> pd.Series(market_ret, index<span class="op">=</span>base_idx) <span class="op">-</span> rf_daily</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> capm_ols(y, x):</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    xy <span class="op">=</span> pd.concat([pd.Series(y), pd.Series(x)], axis<span class="op">=</span><span class="dv">1</span>).dropna()</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    yv <span class="op">=</span> xy.iloc[:, <span class="dv">0</span>].to_numpy(<span class="bu">float</span>)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    xv <span class="op">=</span> xy.iloc[:, <span class="dv">1</span>].to_numpy(<span class="bu">float</span>)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    xmat <span class="op">=</span> np.column_stack([np.ones(<span class="bu">len</span>(xv)), xv])</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    coef <span class="op">=</span> np.linalg.lstsq(xmat, yv, rcond<span class="op">=</span><span class="va">None</span>)[<span class="dv">0</span>]</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    alpha <span class="op">=</span> <span class="bu">float</span>(coef[<span class="dv">0</span>])</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    beta <span class="op">=</span> <span class="bu">float</span>(coef[<span class="dv">1</span>])</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    yhat <span class="op">=</span> xmat <span class="op">@</span> coef</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    ssr <span class="op">=</span> <span class="bu">float</span>(((yv <span class="op">-</span> yhat) <span class="op">**</span> <span class="dv">2</span>).<span class="bu">sum</span>())</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    sst <span class="op">=</span> <span class="bu">float</span>(((yv <span class="op">-</span> yv.mean()) <span class="op">**</span> <span class="dv">2</span>).<span class="bu">sum</span>())</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    r2 <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> ssr <span class="op">/</span> sst <span class="cf">if</span> sst <span class="op">&gt;</span> <span class="fl">1e-12</span> <span class="cf">else</span> np.nan</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> alpha, beta, r2</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rolling_beta_corr(r, m, w):</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> pd.concat([pd.Series(r), pd.Series(m)], axis<span class="op">=</span><span class="dv">1</span>).dropna()</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    rp <span class="op">=</span> x.iloc[:, <span class="dv">0</span>]</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    rm <span class="op">=</span> x.iloc[:, <span class="dv">1</span>]</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    beta <span class="op">=</span> rp.rolling(w).cov(rm) <span class="op">/</span> rm.rolling(w).var()</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    corr <span class="op">=</span> rp.rolling(w).corr(rm)</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    beta.name <span class="op">=</span> <span class="ss">f"beta_</span><span class="sc">{</span>w<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    corr.name <span class="op">=</span> <span class="ss">f"corr_</span><span class="sc">{</span>w<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> beta, corr</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, r <span class="kw">in</span> obj.items():</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>    y_ex <span class="op">=</span> pd.Series(r, index<span class="op">=</span>base_idx) <span class="op">-</span> rf_daily</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>    xy_ex <span class="op">=</span> pd.concat([m_ex, y_ex], axis<span class="op">=</span><span class="dv">1</span>).dropna()</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(xy_ex) <span class="op">&gt;=</span> <span class="dv">30</span>:</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>        x_reg <span class="op">=</span> xy_ex.iloc[:, <span class="dv">0</span>].to_numpy(<span class="bu">float</span>).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>        y_reg <span class="op">=</span> xy_ex.iloc[:, <span class="dv">1</span>].to_numpy(<span class="bu">float</span>)</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>        reg <span class="op">=</span> LinearRegression().fit(x_reg, y_reg)</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>        alpha <span class="op">=</span> <span class="bu">float</span>(reg.intercept_)</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>        beta <span class="op">=</span> <span class="bu">float</span>(reg.coef_[<span class="dv">0</span>])</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>        r2 <span class="op">=</span> <span class="bu">float</span>(reg.score(x_reg, y_reg))</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>        alpha, beta, r2 <span class="op">=</span> np.nan, np.nan, np.nan</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>    alpha_ann <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> alpha) <span class="op">**</span> ann <span class="op">-</span> <span class="dv">1</span> <span class="cf">if</span> alpha <span class="op">&gt;</span> <span class="op">-</span><span class="fl">0.999</span> <span class="cf">else</span> np.nan</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>    active <span class="op">=</span> (pd.Series(r, index<span class="op">=</span>base_idx) <span class="op">-</span> pd.Series(market_ret, index<span class="op">=</span>base_idx)).dropna()</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>    te <span class="op">=</span> <span class="bu">float</span>(active.std(ddof<span class="op">=</span><span class="dv">1</span>) <span class="op">*</span> np.sqrt(ann))</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>    ir <span class="op">=</span> <span class="bu">float</span>(active.mean() <span class="op">/</span> active.std(ddof<span class="op">=</span><span class="dv">1</span>) <span class="op">*</span> np.sqrt(ann))</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> pd.Series(market_ret, index<span class="op">=</span>base_idx).dropna()</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> pd.Series(r, index<span class="op">=</span>base_idx).dropna()</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>    xy <span class="op">=</span> pd.concat([y, m], axis<span class="op">=</span><span class="dv">1</span>).dropna()</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>    y_aligned <span class="op">=</span> xy.iloc[:, <span class="dv">0</span>].to_numpy(<span class="bu">float</span>)</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>    m_aligned <span class="op">=</span> xy.iloc[:, <span class="dv">1</span>].to_numpy(<span class="bu">float</span>)</span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>    up_m <span class="op">=</span> m_aligned <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>    dn_m <span class="op">=</span> m_aligned <span class="op">&lt;</span> <span class="dv">0</span></span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a>    up_cap <span class="op">=</span> (np.mean(y_aligned[up_m]) <span class="op">/</span> np.mean(m_aligned[up_m]))</span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a>    dn_cap <span class="op">=</span> (np.mean(y_aligned[dn_m]) <span class="op">/</span> np.mean(m_aligned[dn_m]))</span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>    var_m <span class="op">=</span> <span class="bu">float</span>(np.var(m_ex.dropna().to_numpy(<span class="bu">float</span>), ddof<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>    var_y <span class="op">=</span> <span class="bu">float</span>(np.var(y_ex.dropna().to_numpy(<span class="bu">float</span>), ddof<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>    sys_share <span class="op">=</span> (beta <span class="op">**</span> <span class="dv">2</span>) <span class="op">*</span> var_m <span class="op">/</span> var_y</span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a>    capm_rows.append({</span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>        <span class="st">"object"</span>: name,</span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>        <span class="st">"alpha_daily"</span>: alpha,</span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a>        <span class="st">"alpha_ann"</span>: alpha_ann,</span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a>        <span class="st">"beta"</span>: beta,</span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a>        <span class="st">"r2"</span>: r2,</span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tracking_error"</span>: te,</span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a>        <span class="st">"information_ratio"</span>: ir,</span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a>        <span class="st">"up_capture"</span>: up_cap,</span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a>        <span class="st">"down_capture"</span>: dn_cap,</span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a>        <span class="st">"systematic_var_share"</span>: sys_share,</span>
<span id="cb19-81"><a href="#cb19-81" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb19-82"><a href="#cb19-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-83"><a href="#cb19-83" aria-hidden="true" tabindex="-1"></a>    b126, c126 <span class="op">=</span> rolling_beta_corr(y_ex, m_ex, <span class="dv">126</span>)</span>
<span id="cb19-84"><a href="#cb19-84" aria-hidden="true" tabindex="-1"></a>    b252, c252 <span class="op">=</span> rolling_beta_corr(y_ex, m_ex, <span class="dv">252</span>)</span>
<span id="cb19-85"><a href="#cb19-85" aria-hidden="true" tabindex="-1"></a>    roll_store[name] <span class="op">=</span> {<span class="st">"beta_126"</span>: b126, <span class="st">"corr_126"</span>: c126, <span class="st">"beta_252"</span>: b252, <span class="st">"corr_252"</span>: c252}</span>
<span id="cb19-86"><a href="#cb19-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-87"><a href="#cb19-87" aria-hidden="true" tabindex="-1"></a>capm_tbl <span class="op">=</span> pd.DataFrame(capm_rows).set_index(<span class="st">"object"</span>).sort_index()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="a63d7010" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>display(capm_tbl.<span class="bu">round</span>(<span class="dv">4</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">alpha_daily</th>
<th data-quarto-table-cell-role="th">alpha_ann</th>
<th data-quarto-table-cell-role="th">beta</th>
<th data-quarto-table-cell-role="th">r2</th>
<th data-quarto-table-cell-role="th">tracking_error</th>
<th data-quarto-table-cell-role="th">information_ratio</th>
<th data-quarto-table-cell-role="th">up_capture</th>
<th data-quarto-table-cell-role="th">down_capture</th>
<th data-quarto-table-cell-role="th">systematic_var_share</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">object</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">aapl</th>
<td>0.0004</td>
<td>0.1117</td>
<td>1.2284</td>
<td>0.5866</td>
<td>0.1954</td>
<td>0.6806</td>
<td>1.2905</td>
<td>1.1891</td>
<td>0.5866</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">maxsharpe_frontier</th>
<td>0.0003</td>
<td>0.0829</td>
<td>0.9622</td>
<td>0.3637</td>
<td>0.2355</td>
<td>0.3193</td>
<td>1.0845</td>
<td>1.0116</td>
<td>0.3637</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mv_ewma</th>
<td>0.0002</td>
<td>0.0458</td>
<td>0.7316</td>
<td>0.6213</td>
<td>0.1167</td>
<td>0.1114</td>
<td>0.7570</td>
<td>0.6969</td>
<td>0.6213</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">nvda</th>
<td>0.0014</td>
<td>0.4093</td>
<td>1.8388</td>
<td>0.4598</td>
<td>0.4000</td>
<td>1.1068</td>
<td>2.1876</td>
<td>1.8877</td>
<td>0.4598</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="3d63dc7f" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">11</span>, <span class="dv">7</span>), sharex<span class="op">=</span><span class="va">True</span>, sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> axes.ravel()</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, name <span class="kw">in</span> <span class="bu">enumerate</span>(obj.keys()):</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> axes[i]</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    y_ex <span class="op">=</span> (pd.Series(obj[name], index<span class="op">=</span>base_idx) <span class="op">-</span> rf_daily).dropna()</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    m_ex <span class="op">=</span> (pd.Series(market_ret, index<span class="op">=</span>base_idx) <span class="op">-</span> rf_daily).dropna()</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    xy <span class="op">=</span> pd.concat([m_ex, y_ex], axis<span class="op">=</span><span class="dv">1</span>).dropna()</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> xy.iloc[:, <span class="dv">0</span>].to_numpy(<span class="bu">float</span>)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> xy.iloc[:, <span class="dv">1</span>].to_numpy(<span class="bu">float</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    alpha <span class="op">=</span> capm_tbl.loc[name, <span class="st">"alpha_daily"</span>]</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    beta <span class="op">=</span> capm_tbl.loc[name, <span class="st">"beta"</span>]</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    r2 <span class="op">=</span> capm_tbl.loc[name, <span class="st">"r2"</span>]</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    ax.scatter(x, y, s<span class="op">=</span><span class="dv">10</span>, alpha<span class="op">=</span><span class="fl">0.15</span>, color<span class="op">=</span>palette[<span class="dv">5</span>])</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    xs <span class="op">=</span> np.linspace(np.percentile(x, <span class="dv">1</span>), np.percentile(x, <span class="dv">99</span>), <span class="dv">200</span>)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    ys <span class="op">=</span> alpha <span class="op">+</span> beta <span class="op">*</span> xs</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    ax.plot(xs, ys, lw<span class="op">=</span><span class="fl">2.2</span>, color<span class="op">=</span>obj_colors[name])</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    ax.axhline(<span class="fl">0.0</span>, color<span class="op">=</span><span class="st">"#444"</span>, lw<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    ax.axvline(<span class="fl">0.0</span>, color<span class="op">=</span><span class="st">"#444"</span>, lw<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f"capm fit — </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">"market excess return"</span>)</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">"asset excess return"</span>)</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    ax.text(</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>        <span class="fl">0.02</span>, <span class="fl">0.98</span>,</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"alpha(d): </span><span class="sc">{</span>alpha<span class="sc">:.4f}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"beta: </span><span class="sc">{</span>beta<span class="sc">:.3f}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"r2: </span><span class="sc">{</span>r2<span class="sc">:.3f}</span><span class="ss">"</span>,</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>        transform<span class="op">=</span>ax.transAxes,</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>        va<span class="op">=</span><span class="st">"top"</span>,</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>        fontsize<span class="op">=</span><span class="dv">9</span>,</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>        bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">"round"</span>, facecolor<span class="op">=</span><span class="st">"white"</span>, alpha<span class="op">=</span><span class="fl">0.75</span>),</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03_risk_report_engine_and_CAPM_files/figure-html/cell-21-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="2fe7a8a5" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">11</span>, <span class="dv">6</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> obj.keys():</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].plot(roll_store[name][<span class="st">"beta_126"</span>], lw<span class="op">=</span><span class="fl">1.2</span>, color<span class="op">=</span>obj_colors[name], label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> 126d"</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].plot(roll_store[name][<span class="st">"beta_252"</span>], lw<span class="op">=</span><span class="fl">2.0</span>, color<span class="op">=</span>obj_colors[name], alpha<span class="op">=</span><span class="fl">0.6</span>, ls<span class="op">=</span><span class="st">"--"</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> 252d"</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axhline(<span class="fl">1.0</span>, color<span class="op">=</span><span class="st">"#444"</span>, lw<span class="op">=</span><span class="dv">1</span>, ls<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">"rolling beta to market (spy)"</span>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">"beta"</span>)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend(ncol<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> obj.keys():</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].plot(roll_store[name][<span class="st">"corr_126"</span>], lw<span class="op">=</span><span class="fl">1.2</span>, color<span class="op">=</span>obj_colors[name], label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> 126d"</span>)</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].plot(roll_store[name][<span class="st">"corr_252"</span>], lw<span class="op">=</span><span class="fl">2.0</span>, color<span class="op">=</span>obj_colors[name], alpha<span class="op">=</span><span class="fl">0.6</span>, ls<span class="op">=</span><span class="st">"--"</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> 252d"</span>)</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].axhline(<span class="fl">0.0</span>, color<span class="op">=</span><span class="st">"#444"</span>, lw<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">"rolling correlation to market (spy)"</span>)</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">"corr"</span>)</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">"date"</span>)</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].legend(ncol<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03_risk_report_engine_and_CAPM_files/figure-html/cell-22-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Now we can see the difference between our models and our picked stocks. both of our models have beta under 1 and both the stocks have over 1 beta. this means that the risk of these stocks are more dependent on market risk than the diversified portfolios. all the 4 objects have positive alpha which means they all have more returns that can’t be explained by market return and can be interpreted as outperformance of these objects relative to S&amp;P 500. correlation of all the objects to SPY are high through time and MaxSharpe has some times that has higher than 1 beta, but MV_ewma has less than 1 beta almost all the time and is the only object with less than one up and down capture, but this object moves with market a lot due to correlation and R2 and var share.</p>
<hr>
</section>
</section>
<section id="risk-attribution" class="level2">
<h2 class="anchored" data-anchor-id="risk-attribution">10) risk attribution</h2>
<p>We explained this in last notebook. now we repeat it and add another part. for our portfolios we are looking for the assets that have the most share of portfolios risk.</p>
<section id="volatility-attribution-covariance-based" class="level3">
<h3 class="anchored" data-anchor-id="volatility-attribution-covariance-based">10.1 volatility attribution (covariance-based)</h3>
<p>If portfolio weights are <span class="math inline">\(w\)</span> and covariance matrix is <span class="math inline">\(\Sigma\)</span>. portfolio volatility is:</p>
<p><span class="math display">\[
\sigma_p = \sqrt{w^\top \Sigma w}
\]</span></p>
<p>the marginal contribution to risk (mrc) of asset <span class="math inline">\(i\)</span> is:</p>
<p><span class="math display">\[
\text{mrc}_i = \frac{(\Sigma w)_i}{\sigma_p}
\]</span></p>
<p>the component contribution is:</p>
<p><span class="math display">\[
\text{rc}_i = w_i\,\text{mrc}_i
\]</span></p>
<p>and the contributions sum to total volatility:</p>
<p><span class="math display">\[
\sum_i \text{rc}_i = \sigma_p
\]</span></p>
<p>this tells us which names drive most of the volatility.</p>
</section>
<section id="es-attribution" class="level3">
<h3 class="anchored" data-anchor-id="es-attribution">10.2 es attribution</h3>
<p>for expected shortfall at level <span class="math inline">\(\alpha\)</span>, identify the set of tail days:</p>
<p><span class="math display">\[
\mathcal{t}_\alpha = \{t : r_{p,t} \le q_\alpha(r_p)\}
\]</span></p>
<p>a simple scenario-based contribution approximation is:</p>
<p><span class="math display">\[
\text{es contrib}_i \approx -\frac{1}{|\mathcal{t}_\alpha|}\sum_{t \in \mathcal{t}_\alpha} w_i r_{i,t}
\]</span></p>
<p>so the largest contributors are the positions that lose the most on the worst portfolio days.</p>
<div id="8fe66ede" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>port_info <span class="op">=</span> {</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mv_ewma"</span>: (res_mv, <span class="st">"ewma"</span>),</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"maxsharpe_frontier"</span>: (res_mx, <span class="st">"ledoitwolf"</span>)}</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>vol_contrib <span class="op">=</span> {}</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>es_contrib <span class="op">=</span> {}</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>overlap_rows <span class="op">=</span> []</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> pname, (res, cov_key) <span class="kw">in</span> port_info.items():</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    dt <span class="op">=</span> res.weights.index[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    st <span class="op">=</span> cache[dt]</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    tickers <span class="op">=</span> st[<span class="st">"tickers"</span>]</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> res.weights.loc[dt].reindex(tickers).fillna(<span class="fl">0.0</span>).to_numpy(<span class="bu">float</span>)</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> w <span class="op">/</span> w.<span class="bu">sum</span>()</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    cov <span class="op">=</span> st[<span class="st">"cov_ann_map"</span>][cov_key]</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    port_vol <span class="op">=</span> np.sqrt(<span class="bu">float</span>(w <span class="op">@</span> cov <span class="op">@</span> w))</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> cov <span class="op">@</span> w</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    rc <span class="op">=</span> pd.Series(w <span class="op">*</span> m <span class="op">/</span> port_vol, index<span class="op">=</span>tickers).sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    vol_contrib[pname] <span class="op">=</span> rc</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> st[<span class="st">"window"</span>][tickers].to_numpy(<span class="bu">float</span>)</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>    rp <span class="op">=</span> x <span class="op">@</span> w</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>    q <span class="op">=</span> np.quantile(rp, <span class="fl">0.05</span>)</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> rp <span class="op">&lt;=</span> q</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    esc <span class="op">=</span> pd.Series(<span class="op">-</span>(x[mask] <span class="op">*</span> w).mean(axis<span class="op">=</span><span class="dv">0</span>), index<span class="op">=</span>tickers).sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    es_contrib[pname] <span class="op">=</span> esc</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>    ov <span class="op">=</span> <span class="bu">len</span>(<span class="bu">set</span>(rc.head(<span class="dv">10</span>).index).intersection(<span class="bu">set</span>(esc.head(<span class="dv">10</span>).index)))</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>    overlap_rows.append({<span class="st">"portfolio"</span>: pname, <span class="st">"top10_overlap_count"</span>: ov})</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>overlap_tbl <span class="op">=</span> pd.DataFrame(overlap_rows).set_index(<span class="st">"portfolio"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="7b1b5583" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>display(overlap_tbl)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">top10_overlap_count</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">portfolio</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">mv_ewma</th>
<td>9</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">maxsharpe_frontier</th>
<td>9</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>for both strategies, 9 of top 10 contributions seem to be the same in Volatility and ES contributions. but the order might be different.</p>
<div id="39a415b6" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="fl">3.5</span>))</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, pname <span class="kw">in</span> <span class="bu">zip</span>(axes, port_info.keys()):</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    top <span class="op">=</span> vol_contrib[pname].head(<span class="dv">10</span>).sort_values()</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    ax.barh(top.index, top.values)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f"top 10 volatility contributors — </span><span class="sc">{</span>pname<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">"component contribution (ann vol)"</span>)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03_risk_report_engine_and_CAPM_files/figure-html/cell-25-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="9336e7f2" class="cell" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="fl">3.5</span>))</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, pname <span class="kw">in</span> <span class="bu">zip</span>(axes, port_info.keys()):</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    top <span class="op">=</span> es_contrib[pname].head(<span class="dv">10</span>).sort_values()</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    ax.barh(top.index, top.values)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f"top 10 es contributors — </span><span class="sc">{</span>pname<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">"scenario-based contribution (daily loss)"</span>)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03_risk_report_engine_and_CAPM_files/figure-html/cell-26-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="correlation-and-diversification-object-to-object" class="level2">
<h2 class="anchored" data-anchor-id="correlation-and-diversification-object-to-object">13) correlation and diversification (object-to-object)</h2>
<p>correlation is a core ingredient of diversification. for two return series <span class="math inline">\(x_t\)</span> and <span class="math inline">\(y_t\)</span>:</p>
<p><span class="math display">\[
\rho_{x,y} = \frac{\text{cov}(x,y)}{\sigma_x\sigma_y}
\]</span></p>
<p>we compute the correlation matrix across objects and visualize it as a heatmap.</p>
<ul>
<li><span class="math inline">\(\rho \approx 1\)</span>: objects move together (low diversification benefit)</li>
<li><span class="math inline">\(\rho \approx 0\)</span>: movements are mostly independent</li>
<li><span class="math inline">\(\rho &lt; 0\)</span>: objects move in opposite direction, and we can hedge the other in some regimes (so rare in stock market)</li>
</ul>
<div id="428ab690" class="cell" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>corr <span class="op">=</span> pd.DataFrame({k: pd.Series(v) <span class="cf">for</span> k, v <span class="kw">in</span> obj.items()}).dropna().corr()</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="fl">6.5</span>, <span class="fl">5.5</span>))</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>im <span class="op">=</span> ax.imshow(corr.values, vmin<span class="op">=-</span><span class="dv">1</span>, vmax<span class="op">=</span><span class="dv">1</span>, cmap<span class="op">=</span> <span class="st">"Spectral"</span>)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(<span class="bu">range</span>(<span class="bu">len</span>(corr.columns)))</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>ax.set_yticks(<span class="bu">range</span>(<span class="bu">len</span>(corr.index)))</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels(corr.columns, rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">"right"</span>)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>ax.set_yticklabels(corr.index)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"correlation matrix (daily returns)"</span>)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(corr.shape[<span class="dv">0</span>]):</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(corr.shape[<span class="dv">1</span>]):</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>        ax.text(j, i, <span class="ss">f"</span><span class="sc">{</span>corr<span class="sc">.</span>values[i, j]<span class="sc">:.2f}</span><span class="ss">"</span>, ha<span class="op">=</span><span class="st">"center"</span>, va<span class="op">=</span><span class="st">"center"</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>fig.colorbar(im, ax<span class="op">=</span>ax, fraction<span class="op">=</span><span class="fl">0.046</span>, pad<span class="op">=</span><span class="fl">0.04</span>)</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03_risk_report_engine_and_CAPM_files/figure-html/cell-27-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="implementation-with-quantfinlab" class="level2">
<h2 class="anchored" data-anchor-id="implementation-with-quantfinlab">Implementation with Quantfinlab</h2>
<p>We can implement this whole project in two ways with our library:</p>
<p>in this notebook we show both implementation on US market and Hong Kong market</p>
<p>now we compare all of our portfolios in the last project based on these risk measures.</p>
</section>
<section id="using-mannual-functions-for-risk-measures-and-plots-us-data" class="level2">
<h2 class="anchored" data-anchor-id="using-mannual-functions-for-risk-measures-and-plots-us-data">1) Using mannual functions for risk measures and plots (US data)</h2>
<div id="1831ee3e" class="cell" data-execution_count="29">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> quantfinlab.portfolio <span class="im">as</span> pf</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> quantfinlab.risk <span class="im">as</span> rk</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> quantfinlab.plots <span class="im">as</span> pl</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>rf_annual <span class="op">=</span> <span class="fl">0.04</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>rf_daily <span class="op">=</span> (<span class="fl">1.0</span> <span class="op">+</span> rf_annual) <span class="op">**</span> (<span class="fl">1.0</span> <span class="op">/</span> <span class="fl">252.0</span>) <span class="op">-</span> <span class="fl">1.0</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_parquet(<span class="st">"../data/nasdaq_all_close_volume.parquet"</span>)</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"date"</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">"Date"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.dropna(subset<span class="op">=</span>[<span class="st">"date"</span>]).sort_values(<span class="st">"date"</span>)</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>close_map, vol_map <span class="op">=</span> {}, {}</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> df.columns:</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    c_str <span class="op">=</span> <span class="bu">str</span>(c)</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> c_str.lower() <span class="op">==</span> <span class="st">"date"</span> <span class="kw">or</span> <span class="st">"__"</span> <span class="kw">not</span> <span class="kw">in</span> c_str:</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    t, f <span class="op">=</span> c_str.rsplit(<span class="st">"__"</span>, <span class="dv">1</span>)</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>    fl <span class="op">=</span> f.lower()</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> fl <span class="op">==</span> <span class="st">"close"</span>:</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>        close_map[t] <span class="op">=</span> c</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> fl <span class="op">==</span> <span class="st">"volume"</span>:</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>        vol_map[t] <span class="op">=</span> c</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>tickers_all <span class="op">=</span> <span class="bu">sorted</span>(<span class="bu">set</span>(close_map).intersection(vol_map))</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(tickers_all) <span class="op">&lt;</span> <span class="dv">2</span>:</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Not enough ticker__close/ticker__volume pairs in NASDAQ parquet."</span>)</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>close_prices <span class="op">=</span> df[[close_map[t] <span class="cf">for</span> t <span class="kw">in</span> tickers_all]].copy()</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>volumes <span class="op">=</span> df[[vol_map[t] <span class="cf">for</span> t <span class="kw">in</span> tickers_all]].copy()</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>close_prices.columns <span class="op">=</span> tickers_all</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>volumes.columns <span class="op">=</span> tickers_all</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>close_prices.index <span class="op">=</span> pd.to_datetime(df[<span class="st">"date"</span>].values)</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>volumes.index <span class="op">=</span> pd.to_datetime(df[<span class="st">"date"</span>].values)</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>stack <span class="op">=</span> pf.build_all_portfolio_strategies(</span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>    close_prices,</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>    volumes,</span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>    start<span class="op">=</span><span class="st">"2016-01-01"</span>,</span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>    rf_annual<span class="op">=</span>rf_annual,</span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>    rf_daily<span class="op">=</span>rf_daily,</span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> <span class="bu">dict</span>(stack.results)</span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a>cache <span class="op">=</span> <span class="bu">dict</span>(stack.cache)</span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a>cov_key_for_rc <span class="op">=</span> <span class="bu">dict</span>(stack.cov_key_for_rc)</span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a>common_idx <span class="op">=</span> <span class="va">None</span></span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> res <span class="kw">in</span> results.values():</span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a>    idx_res <span class="op">=</span> pd.DatetimeIndex(res.net_returns.index)</span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a>    common_idx <span class="op">=</span> idx_res <span class="cf">if</span> common_idx <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> common_idx.intersection(idx_res)</span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> common_idx <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> <span class="bu">len</span>(common_idx) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"No overlapping index across strategy returns."</span>)</span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a>objects <span class="op">=</span> {name: res.net_returns.reindex(common_idx).fillna(<span class="fl">0.0</span>) <span class="cf">for</span> name, res <span class="kw">in</span> results.items()}</span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a>obj_colors <span class="op">=</span> pl.make_color_map(objects.keys(), pl.LAB_COLORS)</span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a>spy <span class="op">=</span> pd.read_csv(<span class="st">"../data/spy_yfinance.csv"</span>)</span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a>spy[<span class="st">"date"</span>] <span class="op">=</span> pd.to_datetime(spy[<span class="st">"Date"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a>spy <span class="op">=</span> spy.dropna(subset<span class="op">=</span>[<span class="st">"date"</span>]).sort_values(<span class="st">"date"</span>).set_index(<span class="st">"date"</span>)</span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"Adj Close"</span> <span class="kw">in</span> spy.columns:</span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a>    spy_px <span class="op">=</span> pd.to_numeric(spy[<span class="st">"Adj Close"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a><span class="cf">elif</span> <span class="st">"Close"</span> <span class="kw">in</span> spy.columns:</span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a>    spy_px <span class="op">=</span> pd.to_numeric(spy[<span class="st">"Close"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"spy_yfinance.csv missing close/adj close column"</span>)</span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a>market_ret <span class="op">=</span> spy_px.pct_change(fill_method<span class="op">=</span><span class="va">None</span>).reindex(common_idx).fillna(<span class="fl">0.0</span>)</span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-78"><a href="#cb28-78" aria-hidden="true" tabindex="-1"></a>portfolios <span class="op">=</span> {</span>
<span id="cb28-79"><a href="#cb28-79" aria-hidden="true" tabindex="-1"></a>    name: {</span>
<span id="cb28-80"><a href="#cb28-80" aria-hidden="true" tabindex="-1"></a>        <span class="st">"backtest"</span>: results[name],</span>
<span id="cb28-81"><a href="#cb28-81" aria-hidden="true" tabindex="-1"></a>        <span class="st">"state_cache"</span>: cache,</span>
<span id="cb28-82"><a href="#cb28-82" aria-hidden="true" tabindex="-1"></a>        <span class="st">"cov_key"</span>: cov_key_for_rc[name],</span>
<span id="cb28-83"><a href="#cb28-83" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-84"><a href="#cb28-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> results.keys()</span>
<span id="cb28-85"><a href="#cb28-85" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-86"><a href="#cb28-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-87"><a href="#cb28-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-88"><a href="#cb28-88" aria-hidden="true" tabindex="-1"></a>perf_tbl <span class="op">=</span> rk.performance_table(objects, rf_daily<span class="op">=</span>rf_daily, annualization<span class="op">=</span><span class="dv">252</span>)</span>
<span id="cb28-89"><a href="#cb28-89" aria-hidden="true" tabindex="-1"></a>shape_tbl <span class="op">=</span> rk.tail_shape_table(objects)</span>
<span id="cb28-90"><a href="#cb28-90" aria-hidden="true" tabindex="-1"></a>dd_summary_tbl <span class="op">=</span> rk.drawdown_summary_table(objects)</span>
<span id="cb28-91"><a href="#cb28-91" aria-hidden="true" tabindex="-1"></a>dd_episodes_tbl <span class="op">=</span> rk.drawdown_episodes_table(objects, top_n<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb28-92"><a href="#cb28-92" aria-hidden="true" tabindex="-1"></a>var_es_tbl <span class="op">=</span> rk.var_es_table(objects, alpha<span class="op">=</span><span class="fl">0.05</span>, methods<span class="op">=</span>[<span class="st">"hist"</span>, <span class="st">"cf"</span>, <span class="st">"fhs"</span>])</span>
<span id="cb28-93"><a href="#cb28-93" aria-hidden="true" tabindex="-1"></a>var_bt_methods <span class="op">=</span> [<span class="st">"hist"</span>, <span class="st">"cf"</span>, <span class="st">"fhs"</span>]</span>
<span id="cb28-94"><a href="#cb28-94" aria-hidden="true" tabindex="-1"></a>var_bt_tbl <span class="op">=</span> rk.var_backtest_table(objects, alpha<span class="op">=</span><span class="fl">0.05</span>, methods<span class="op">=</span>var_bt_methods, lookback<span class="op">=</span><span class="dv">252</span>)</span>
<span id="cb28-95"><a href="#cb28-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-96"><a href="#cb28-96" aria-hidden="true" tabindex="-1"></a>stress_windows <span class="op">=</span> {</span>
<span id="cb28-97"><a href="#cb28-97" aria-hidden="true" tabindex="-1"></a>    <span class="st">"2018_q4"</span>: (<span class="st">"2018-10-01"</span>, <span class="st">"2018-12-31"</span>),</span>
<span id="cb28-98"><a href="#cb28-98" aria-hidden="true" tabindex="-1"></a>    <span class="st">"2020_covid"</span>: (<span class="st">"2020-02-20"</span>, <span class="st">"2020-04-30"</span>),</span>
<span id="cb28-99"><a href="#cb28-99" aria-hidden="true" tabindex="-1"></a>    <span class="st">"2022_inflation"</span>: (<span class="st">"2022-01-03"</span>, <span class="st">"2022-10-31"</span>),</span>
<span id="cb28-100"><a href="#cb28-100" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-101"><a href="#cb28-101" aria-hidden="true" tabindex="-1"></a>stress_tbl <span class="op">=</span> rk.stress_table(objects, windows<span class="op">=</span>stress_windows, worst_only<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb28-102"><a href="#cb28-102" aria-hidden="true" tabindex="-1"></a>stress_tbl_full <span class="op">=</span> rk.stress_table(objects, windows<span class="op">=</span>stress_windows, worst_only<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb28-103"><a href="#cb28-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-104"><a href="#cb28-104" aria-hidden="true" tabindex="-1"></a>capm_tbl, capm_roll <span class="op">=</span> rk.capm_table(objects, market_ret<span class="op">=</span>market_ret, rf_daily<span class="op">=</span>rf_daily, rolling<span class="op">=</span>[<span class="dv">126</span>, <span class="dv">252</span>])</span>
<span id="cb28-105"><a href="#cb28-105" aria-hidden="true" tabindex="-1"></a>corr <span class="op">=</span> rk.corr_matrix(objects)</span>
<span id="cb28-106"><a href="#cb28-106" aria-hidden="true" tabindex="-1"></a>vol_rc_tbl, es_rc_tbl, overlap_tbl <span class="op">=</span> rk.attribution_tables(portfolios, es_alpha<span class="op">=</span><span class="fl">0.05</span>, top_k<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb28-107"><a href="#cb28-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-108"><a href="#cb28-108" aria-hidden="true" tabindex="-1"></a>display(perf_tbl.<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb28-109"><a href="#cb28-109" aria-hidden="true" tabindex="-1"></a>display(shape_tbl.<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb28-110"><a href="#cb28-110" aria-hidden="true" tabindex="-1"></a>display(dd_summary_tbl.<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb28-111"><a href="#cb28-111" aria-hidden="true" tabindex="-1"></a>display(var_es_tbl.<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb28-112"><a href="#cb28-112" aria-hidden="true" tabindex="-1"></a>display(var_bt_tbl.<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb28-113"><a href="#cb28-113" aria-hidden="true" tabindex="-1"></a>display(capm_tbl.<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb28-114"><a href="#cb28-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-115"><a href="#cb28-115" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">11</span>, <span class="dv">7</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb28-116"><a href="#cb28-116" aria-hidden="true" tabindex="-1"></a>pl.plot_nav_compare(ax[<span class="dv">0</span>], objects, colors<span class="op">=</span>obj_colors, title<span class="op">=</span><span class="st">"Cumulative NAV (all portfolio strategies)"</span>)</span>
<span id="cb28-117"><a href="#cb28-117" aria-hidden="true" tabindex="-1"></a>pl.plot_drawdown_compare_objects(ax[<span class="dv">1</span>], objects, colors<span class="op">=</span>obj_colors, title<span class="op">=</span><span class="st">"Drawdown (all portfolio strategies)"</span>)</span>
<span id="cb28-118"><a href="#cb28-118" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb28-119"><a href="#cb28-119" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb28-120"><a href="#cb28-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-121"><a href="#cb28-121" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> pl.auto_grid(<span class="bu">len</span>(objects), ncols<span class="op">=</span><span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">13</span>, <span class="dv">8</span>), sharex<span class="op">=</span><span class="va">True</span>, sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb28-122"><a href="#cb28-122" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> a, (name, r) <span class="kw">in</span> <span class="bu">zip</span>(axes, objects.items()):</span>
<span id="cb28-123"><a href="#cb28-123" aria-hidden="true" tabindex="-1"></a>    pl.plot_rolling_vol(a, r, windows<span class="op">=</span>[<span class="dv">20</span>, <span class="dv">60</span>, <span class="dv">252</span>], name<span class="op">=</span>name)</span>
<span id="cb28-124"><a href="#cb28-124" aria-hidden="true" tabindex="-1"></a>pl.turn_off_unused_axes(axes, used<span class="op">=</span><span class="bu">len</span>(objects))</span>
<span id="cb28-125"><a href="#cb28-125" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb28-126"><a href="#cb28-126" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb28-127"><a href="#cb28-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-128"><a href="#cb28-128" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> pl.auto_grid(<span class="bu">len</span>(objects), ncols<span class="op">=</span><span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">13</span>, <span class="dv">8</span>), sharex<span class="op">=</span><span class="va">True</span>, sharey<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb28-129"><a href="#cb28-129" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> a, (name, r) <span class="kw">in</span> <span class="bu">zip</span>(axes, objects.items()):</span>
<span id="cb28-130"><a href="#cb28-130" aria-hidden="true" tabindex="-1"></a>    pl.plot_var_backtest(a, r, alpha<span class="op">=</span><span class="fl">0.05</span>, lookback<span class="op">=</span><span class="dv">252</span>, method<span class="op">=</span><span class="st">"best"</span>, methods<span class="op">=</span>var_bt_methods, name<span class="op">=</span>name)</span>
<span id="cb28-131"><a href="#cb28-131" aria-hidden="true" tabindex="-1"></a>pl.turn_off_unused_axes(axes, used<span class="op">=</span><span class="bu">len</span>(objects))</span>
<span id="cb28-132"><a href="#cb28-132" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb28-133"><a href="#cb28-133" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb28-134"><a href="#cb28-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-135"><a href="#cb28-135" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> pl.auto_grid(stress_tbl_full.index.nunique(), ncols<span class="op">=</span><span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb28-136"><a href="#cb28-136" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> a, w <span class="kw">in</span> <span class="bu">zip</span>(axes, stress_tbl_full.index.unique()):</span>
<span id="cb28-137"><a href="#cb28-137" aria-hidden="true" tabindex="-1"></a>    pl.plot_stress_bar(a, stress_tbl_full, window<span class="op">=</span>w)</span>
<span id="cb28-138"><a href="#cb28-138" aria-hidden="true" tabindex="-1"></a>pl.turn_off_unused_axes(axes, used<span class="op">=</span>stress_tbl_full.index.nunique())</span>
<span id="cb28-139"><a href="#cb28-139" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb28-140"><a href="#cb28-140" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb28-141"><a href="#cb28-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-142"><a href="#cb28-142" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> pl.auto_grid(<span class="bu">len</span>(objects), ncols<span class="op">=</span><span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">13</span>, <span class="dv">8</span>), sharex<span class="op">=</span><span class="va">True</span>, sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb28-143"><a href="#cb28-143" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> a, (name, r) <span class="kw">in</span> <span class="bu">zip</span>(axes, objects.items()):</span>
<span id="cb28-144"><a href="#cb28-144" aria-hidden="true" tabindex="-1"></a>    pl.plot_capm_scatter(a, r, market_ret, rf_daily<span class="op">=</span>rf_daily, name<span class="op">=</span>name, color<span class="op">=</span>obj_colors[name])</span>
<span id="cb28-145"><a href="#cb28-145" aria-hidden="true" tabindex="-1"></a>pl.turn_off_unused_axes(axes, used<span class="op">=</span><span class="bu">len</span>(objects))</span>
<span id="cb28-146"><a href="#cb28-146" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb28-147"><a href="#cb28-147" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb28-148"><a href="#cb28-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-149"><a href="#cb28-149" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb28-150"><a href="#cb28-150" aria-hidden="true" tabindex="-1"></a>pl.plot_rolling_beta_compare(ax[<span class="dv">0</span>], capm_roll, window<span class="op">=</span><span class="dv">126</span>)</span>
<span id="cb28-151"><a href="#cb28-151" aria-hidden="true" tabindex="-1"></a>pl.plot_rolling_beta_compare(ax[<span class="dv">1</span>], capm_roll, window<span class="op">=</span><span class="dv">252</span>)</span>
<span id="cb28-152"><a href="#cb28-152" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb28-153"><a href="#cb28-153" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb28-154"><a href="#cb28-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-155"><a href="#cb28-155" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb28-156"><a href="#cb28-156" aria-hidden="true" tabindex="-1"></a>pl.plot_corr_heatmap(ax, corr)</span>
<span id="cb28-157"><a href="#cb28-157" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb28-158"><a href="#cb28-158" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb28-159"><a href="#cb28-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-160"><a href="#cb28-160" aria-hidden="true" tabindex="-1"></a>names <span class="op">=</span> <span class="bu">list</span>(portfolios.keys())</span>
<span id="cb28-161"><a href="#cb28-161" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="bu">len</span>(names), figsize<span class="op">=</span>(<span class="fl">3.8</span> <span class="op">*</span> <span class="bu">len</span>(names), <span class="dv">7</span>))</span>
<span id="cb28-162"><a href="#cb28-162" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(names) <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb28-163"><a href="#cb28-163" aria-hidden="true" tabindex="-1"></a>    axes <span class="op">=</span> axes.reshape(<span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb28-164"><a href="#cb28-164" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> j, pname <span class="kw">in</span> <span class="bu">enumerate</span>(names):</span>
<span id="cb28-165"><a href="#cb28-165" aria-hidden="true" tabindex="-1"></a>    pl.plot_top_contrib(axes[<span class="dv">0</span>, j], vol_rc_tbl.loc[pname], title<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>pname<span class="sc">}</span><span class="ss"> - top vol rc"</span>, k<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb28-166"><a href="#cb28-166" aria-hidden="true" tabindex="-1"></a>    pl.plot_top_contrib(axes[<span class="dv">1</span>, j], es_rc_tbl.loc[pname], title<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>pname<span class="sc">}</span><span class="ss"> - top es rc"</span>, k<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb28-167"><a href="#cb28-167" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb28-168"><a href="#cb28-168" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ann_return</th>
<th data-quarto-table-cell-role="th">ann_vol</th>
<th data-quarto-table-cell-role="th">sharpe</th>
<th data-quarto-table-cell-role="th">sortino</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">object</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">ew</th>
<td>0.1464</td>
<td>0.2530</td>
<td>0.5119</td>
<td>0.7195</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">maxsharpe_frontier</th>
<td>0.2092</td>
<td>0.2949</td>
<td>0.6590</td>
<td>0.9431</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">maxsharpe_slsqp</th>
<td>0.2024</td>
<td>0.3161</td>
<td>0.6175</td>
<td>0.8760</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">minvar_ewma</th>
<td>0.1332</td>
<td>0.1477</td>
<td>0.6552</td>
<td>0.9331</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">minvar_lw</th>
<td>0.1329</td>
<td>0.1535</td>
<td>0.6344</td>
<td>0.9059</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">minvar_oas</th>
<td>0.1423</td>
<td>0.1530</td>
<td>0.6903</td>
<td>0.9910</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">minvar_sample</th>
<td>0.1520</td>
<td>0.1512</td>
<td>0.7524</td>
<td>1.0898</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">mv_ewma</th>
<td>0.1708</td>
<td>0.1830</td>
<td>0.7393</td>
<td>1.0615</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mv_lw</th>
<td>0.1462</td>
<td>0.2001</td>
<td>0.5864</td>
<td>0.8235</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">mv_oas</th>
<td>0.1413</td>
<td>0.1971</td>
<td>0.5703</td>
<td>0.8035</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mv_sample</th>
<td>0.1484</td>
<td>0.1935</td>
<td>0.6096</td>
<td>0.8608</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ridge_mv</th>
<td>0.1382</td>
<td>0.1980</td>
<td>0.5553</td>
<td>0.7769</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">skew</th>
<th data-quarto-table-cell-role="th">excess_kurtosis</th>
<th data-quarto-table-cell-role="th">tail_ratio_95_05</th>
<th data-quarto-table-cell-role="th">worst_1d</th>
<th data-quarto-table-cell-role="th">worst_5d_avg</th>
<th data-quarto-table-cell-role="th">worst_10d_avg</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">object</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">ew</th>
<td>-0.1442</td>
<td>6.5229</td>
<td>0.8626</td>
<td>-0.1239</td>
<td>-0.0852</td>
<td>-0.0729</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">maxsharpe_frontier</th>
<td>-0.1042</td>
<td>6.9172</td>
<td>1.0044</td>
<td>-0.1203</td>
<td>-0.1067</td>
<td>-0.0904</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">maxsharpe_slsqp</th>
<td>-0.1347</td>
<td>5.6136</td>
<td>0.9442</td>
<td>-0.1403</td>
<td>-0.1056</td>
<td>-0.0903</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">minvar_ewma</th>
<td>-0.2237</td>
<td>15.7958</td>
<td>1.0361</td>
<td>-0.0879</td>
<td>-0.0686</td>
<td>-0.0549</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">minvar_lw</th>
<td>-0.2048</td>
<td>20.0543</td>
<td>1.0072</td>
<td>-0.1031</td>
<td>-0.0717</td>
<td>-0.0569</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">minvar_oas</th>
<td>-0.1550</td>
<td>20.2887</td>
<td>1.0248</td>
<td>-0.1021</td>
<td>-0.0717</td>
<td>-0.0568</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">minvar_sample</th>
<td>-0.0546</td>
<td>19.5492</td>
<td>1.0468</td>
<td>-0.0962</td>
<td>-0.0708</td>
<td>-0.0561</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">mv_ewma</th>
<td>-0.1893</td>
<td>11.7377</td>
<td>1.0380</td>
<td>-0.1067</td>
<td>-0.0762</td>
<td>-0.0613</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mv_lw</th>
<td>-0.2516</td>
<td>11.2377</td>
<td>0.9091</td>
<td>-0.1194</td>
<td>-0.0776</td>
<td>-0.0639</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">mv_oas</th>
<td>-0.1621</td>
<td>11.4696</td>
<td>0.9020</td>
<td>-0.1151</td>
<td>-0.0757</td>
<td>-0.0629</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mv_sample</th>
<td>-0.2380</td>
<td>10.9302</td>
<td>0.9371</td>
<td>-0.1144</td>
<td>-0.0742</td>
<td>-0.0625</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ridge_mv</th>
<td>-0.2658</td>
<td>11.2937</td>
<td>0.8839</td>
<td>-0.1177</td>
<td>-0.0776</td>
<td>-0.0626</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">max_dd</th>
<th data-quarto-table-cell-role="th">longest_dd_days</th>
<th data-quarto-table-cell-role="th">avg_recovery_days</th>
<th data-quarto-table-cell-role="th">ulcer_index</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">object</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">ew</th>
<td>-0.4608</td>
<td>771</td>
<td>18.1759</td>
<td>0.1689</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">maxsharpe_frontier</th>
<td>-0.4764</td>
<td>1238</td>
<td>30.5072</td>
<td>0.2400</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">maxsharpe_slsqp</th>
<td>-0.5730</td>
<td>1153</td>
<td>28.5616</td>
<td>0.2750</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">minvar_ewma</th>
<td>-0.2339</td>
<td>613</td>
<td>15.0547</td>
<td>0.0518</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">minvar_lw</th>
<td>-0.2791</td>
<td>312</td>
<td>14.6493</td>
<td>0.0495</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">minvar_oas</th>
<td>-0.2787</td>
<td>288</td>
<td>13.5208</td>
<td>0.0456</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">minvar_sample</th>
<td>-0.2797</td>
<td>304</td>
<td>12.0562</td>
<td>0.0459</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">mv_ewma</th>
<td>-0.3087</td>
<td>701</td>
<td>15.1034</td>
<td>0.0822</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mv_lw</th>
<td>-0.3128</td>
<td>695</td>
<td>16.5981</td>
<td>0.1080</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">mv_oas</th>
<td>-0.3063</td>
<td>620</td>
<td>16.5981</td>
<td>0.0994</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mv_sample</th>
<td>-0.3098</td>
<td>609</td>
<td>17.9910</td>
<td>0.0937</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ridge_mv</th>
<td>-0.3116</td>
<td>621</td>
<td>16.8019</td>
<td>0.1024</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">hist_var5</th>
<th data-quarto-table-cell-role="th">hist_es5</th>
<th data-quarto-table-cell-role="th">cf_var5</th>
<th data-quarto-table-cell-role="th">cf_es5</th>
<th data-quarto-table-cell-role="th">fhs_var5</th>
<th data-quarto-table-cell-role="th">fhs_es5</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">object</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">ew</th>
<td>0.0267</td>
<td>0.0377</td>
<td>0.0241</td>
<td>0.0490</td>
<td>0.0197</td>
<td>0.0281</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">maxsharpe_frontier</th>
<td>0.0281</td>
<td>0.0446</td>
<td>0.0276</td>
<td>0.0577</td>
<td>0.0453</td>
<td>0.0679</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">maxsharpe_slsqp</th>
<td>0.0317</td>
<td>0.0480</td>
<td>0.0303</td>
<td>0.0583</td>
<td>0.0389</td>
<td>0.0537</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">minvar_ewma</th>
<td>0.0126</td>
<td>0.0213</td>
<td>0.0124</td>
<td>0.0417</td>
<td>0.0068</td>
<td>0.0109</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">minvar_lw</th>
<td>0.0129</td>
<td>0.0218</td>
<td>0.0120</td>
<td>0.0494</td>
<td>0.0083</td>
<td>0.0123</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">minvar_oas</th>
<td>0.0127</td>
<td>0.0215</td>
<td>0.0117</td>
<td>0.0493</td>
<td>0.0088</td>
<td>0.0128</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">minvar_sample</th>
<td>0.0124</td>
<td>0.0210</td>
<td>0.0114</td>
<td>0.0471</td>
<td>0.0088</td>
<td>0.0132</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">mv_ewma</th>
<td>0.0161</td>
<td>0.0262</td>
<td>0.0162</td>
<td>0.0444</td>
<td>0.0133</td>
<td>0.0200</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mv_lw</th>
<td>0.0192</td>
<td>0.0306</td>
<td>0.0181</td>
<td>0.0481</td>
<td>0.0102</td>
<td>0.0147</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">mv_oas</th>
<td>0.0191</td>
<td>0.0300</td>
<td>0.0175</td>
<td>0.0474</td>
<td>0.0099</td>
<td>0.0144</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mv_sample</th>
<td>0.0182</td>
<td>0.0289</td>
<td>0.0175</td>
<td>0.0459</td>
<td>0.0099</td>
<td>0.0143</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ridge_mv</th>
<td>0.0190</td>
<td>0.0305</td>
<td>0.0180</td>
<td>0.0478</td>
<td>0.0097</td>
<td>0.0142</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">breach_count</th>
<th data-quarto-table-cell-role="th">breach_rate</th>
<th data-quarto-table-cell-role="th">coverage_error</th>
<th data-quarto-table-cell-role="th">abs_coverage_error</th>
<th data-quarto-table-cell-role="th">longest_breach_streak</th>
<th data-quarto-table-cell-role="th">avg_gap_days</th>
<th data-quarto-table-cell-role="th">kupiec_p</th>
<th data-quarto-table-cell-role="th">christoffersen_p</th>
<th data-quarto-table-cell-role="th">quantile_loss</th>
<th data-quarto-table-cell-role="th">accuracy_rank</th>
<th data-quarto-table-cell-role="th">accuracy_score</th>
<th data-quarto-table-cell-role="th">is_best</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">object</th>
<th data-quarto-table-cell-role="th">method</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th rowspan="3" data-quarto-table-cell-role="th" data-valign="top">ew</th>
<th data-quarto-table-cell-role="th">cf</th>
<td>133</td>
<td>0.0662</td>
<td>0.0162</td>
<td>0.0162</td>
<td>3</td>
<td>15.1515</td>
<td>0.0015</td>
<td>0.0030</td>
<td>0.0020</td>
<td>3.0</td>
<td>0.0769</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">fhs</th>
<td>118</td>
<td>0.0587</td>
<td>0.0087</td>
<td>0.0087</td>
<td>3</td>
<td>17.0940</td>
<td>0.0801</td>
<td>0.0268</td>
<td>0.0018</td>
<td>1.0</td>
<td>0.2000</td>
<td>True</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">hist</th>
<td>128</td>
<td>0.0637</td>
<td>0.0137</td>
<td>0.0137</td>
<td>3</td>
<td>15.4409</td>
<td>0.0067</td>
<td>0.0033</td>
<td>0.0020</td>
<td>2.0</td>
<td>0.1111</td>
<td>False</td>
</tr>
<tr class="even">
<th rowspan="3" data-quarto-table-cell-role="th" data-valign="top">maxsharpe_frontier</th>
<th data-quarto-table-cell-role="th">cf</th>
<td>120</td>
<td>0.0597</td>
<td>0.0097</td>
<td>0.0097</td>
<td>3</td>
<td>16.6303</td>
<td>0.0519</td>
<td>0.0021</td>
<td>0.0023</td>
<td>3.0</td>
<td>0.0909</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">fhs</th>
<td>106</td>
<td>0.0528</td>
<td>0.0028</td>
<td>0.0028</td>
<td>2</td>
<td>18.8190</td>
<td>0.5732</td>
<td>0.0013</td>
<td>0.0021</td>
<td>1.0</td>
<td>0.1667</td>
<td>True</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">hist</th>
<td>116</td>
<td>0.0577</td>
<td>0.0077</td>
<td>0.0077</td>
<td>3</td>
<td>17.2087</td>
<td>0.1199</td>
<td>0.0003</td>
<td>0.0023</td>
<td>2.0</td>
<td>0.1000</td>
<td>False</td>
</tr>
<tr class="odd">
<th rowspan="3" data-quarto-table-cell-role="th" data-valign="top">maxsharpe_slsqp</th>
<th data-quarto-table-cell-role="th">cf</th>
<td>138</td>
<td>0.0687</td>
<td>0.0187</td>
<td>0.0187</td>
<td>3</td>
<td>14.5547</td>
<td>0.0003</td>
<td>0.0029</td>
<td>0.0024</td>
<td>2.0</td>
<td>0.0909</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">fhs</th>
<td>113</td>
<td>0.0562</td>
<td>0.0062</td>
<td>0.0062</td>
<td>3</td>
<td>17.5179</td>
<td>0.2074</td>
<td>0.0048</td>
<td>0.0023</td>
<td>1.0</td>
<td>0.2000</td>
<td>True</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">hist</th>
<td>129</td>
<td>0.0642</td>
<td>0.0142</td>
<td>0.0142</td>
<td>3</td>
<td>15.5781</td>
<td>0.0050</td>
<td>0.0014</td>
<td>0.0024</td>
<td>2.0</td>
<td>0.0909</td>
<td>False</td>
</tr>
<tr class="even">
<th rowspan="3" data-quarto-table-cell-role="th" data-valign="top">minvar_ewma</th>
<th data-quarto-table-cell-role="th">cf</th>
<td>109</td>
<td>0.0543</td>
<td>0.0043</td>
<td>0.0043</td>
<td>3</td>
<td>17.8889</td>
<td>0.3877</td>
<td>0.0002</td>
<td>0.0012</td>
<td>2.0</td>
<td>0.1250</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">fhs</th>
<td>114</td>
<td>0.0567</td>
<td>0.0067</td>
<td>0.0067</td>
<td>3</td>
<td>17.6991</td>
<td>0.1741</td>
<td>0.0006</td>
<td>0.0011</td>
<td>1.0</td>
<td>0.1429</td>
<td>True</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">hist</th>
<td>118</td>
<td>0.0587</td>
<td>0.0087</td>
<td>0.0087</td>
<td>3</td>
<td>16.5128</td>
<td>0.0801</td>
<td>0.0000</td>
<td>0.0012</td>
<td>3.0</td>
<td>0.0833</td>
<td>False</td>
</tr>
<tr class="odd">
<th rowspan="3" data-quarto-table-cell-role="th" data-valign="top">minvar_lw</th>
<th data-quarto-table-cell-role="th">cf</th>
<td>100</td>
<td>0.0498</td>
<td>-0.0002</td>
<td>0.0002</td>
<td>2</td>
<td>19.6465</td>
<td>0.9632</td>
<td>0.0043</td>
<td>0.0012</td>
<td>2.0</td>
<td>0.1250</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">fhs</th>
<td>111</td>
<td>0.0553</td>
<td>0.0053</td>
<td>0.0053</td>
<td>2</td>
<td>18.0727</td>
<td>0.2879</td>
<td>0.0583</td>
<td>0.0011</td>
<td>1.0</td>
<td>0.1429</td>
<td>True</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">hist</th>
<td>114</td>
<td>0.0567</td>
<td>0.0067</td>
<td>0.0067</td>
<td>4</td>
<td>17.2124</td>
<td>0.1741</td>
<td>0.0000</td>
<td>0.0012</td>
<td>3.0</td>
<td>0.0833</td>
<td>False</td>
</tr>
<tr class="even">
<th rowspan="3" data-quarto-table-cell-role="th" data-valign="top">minvar_oas</th>
<th data-quarto-table-cell-role="th">cf</th>
<td>101</td>
<td>0.0503</td>
<td>0.0003</td>
<td>0.0003</td>
<td>2</td>
<td>19.4500</td>
<td>0.9551</td>
<td>0.0016</td>
<td>0.0012</td>
<td>2.0</td>
<td>0.1250</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">fhs</th>
<td>112</td>
<td>0.0557</td>
<td>0.0057</td>
<td>0.0057</td>
<td>2</td>
<td>17.9099</td>
<td>0.2453</td>
<td>0.0282</td>
<td>0.0011</td>
<td>1.0</td>
<td>0.1429</td>
<td>True</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">hist</th>
<td>116</td>
<td>0.0577</td>
<td>0.0077</td>
<td>0.0077</td>
<td>3</td>
<td>16.9130</td>
<td>0.1199</td>
<td>0.0001</td>
<td>0.0012</td>
<td>3.0</td>
<td>0.0833</td>
<td>False</td>
</tr>
<tr class="odd">
<th rowspan="3" data-quarto-table-cell-role="th" data-valign="top">minvar_sample</th>
<th data-quarto-table-cell-role="th">cf</th>
<td>104</td>
<td>0.0518</td>
<td>0.0018</td>
<td>0.0018</td>
<td>3</td>
<td>18.8835</td>
<td>0.7178</td>
<td>0.0002</td>
<td>0.0011</td>
<td>2.0</td>
<td>0.1250</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">fhs</th>
<td>108</td>
<td>0.0538</td>
<td>0.0038</td>
<td>0.0038</td>
<td>2</td>
<td>18.5794</td>
<td>0.4449</td>
<td>0.0159</td>
<td>0.0011</td>
<td>1.0</td>
<td>0.1429</td>
<td>True</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">hist</th>
<td>111</td>
<td>0.0553</td>
<td>0.0053</td>
<td>0.0053</td>
<td>4</td>
<td>17.6818</td>
<td>0.2879</td>
<td>0.0001</td>
<td>0.0011</td>
<td>3.0</td>
<td>0.0833</td>
<td>False</td>
</tr>
<tr class="even">
<th rowspan="3" data-quarto-table-cell-role="th" data-valign="top">mv_ewma</th>
<th data-quarto-table-cell-role="th">cf</th>
<td>107</td>
<td>0.0533</td>
<td>0.0033</td>
<td>0.0033</td>
<td>2</td>
<td>18.2642</td>
<td>0.5068</td>
<td>0.0001</td>
<td>0.0014</td>
<td>1.0</td>
<td>0.1429</td>
<td>True</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">fhs</th>
<td>110</td>
<td>0.0548</td>
<td>0.0048</td>
<td>0.0048</td>
<td>2</td>
<td>17.9817</td>
<td>0.3353</td>
<td>0.0028</td>
<td>0.0013</td>
<td>1.0</td>
<td>0.1429</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">hist</th>
<td>112</td>
<td>0.0557</td>
<td>0.0057</td>
<td>0.0057</td>
<td>3</td>
<td>16.9820</td>
<td>0.2453</td>
<td>0.0000</td>
<td>0.0014</td>
<td>3.0</td>
<td>0.0769</td>
<td>False</td>
</tr>
<tr class="odd">
<th rowspan="3" data-quarto-table-cell-role="th" data-valign="top">mv_lw</th>
<th data-quarto-table-cell-role="th">cf</th>
<td>115</td>
<td>0.0572</td>
<td>0.0072</td>
<td>0.0072</td>
<td>3</td>
<td>17.5439</td>
<td>0.1450</td>
<td>0.0067</td>
<td>0.0016</td>
<td>3.0</td>
<td>0.1000</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">fhs</th>
<td>110</td>
<td>0.0548</td>
<td>0.0048</td>
<td>0.0048</td>
<td>2</td>
<td>18.3486</td>
<td>0.3353</td>
<td>0.0009</td>
<td>0.0015</td>
<td>2.0</td>
<td>0.1111</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">hist</th>
<td>105</td>
<td>0.0523</td>
<td>0.0023</td>
<td>0.0023</td>
<td>3</td>
<td>17.4038</td>
<td>0.6437</td>
<td>0.0011</td>
<td>0.0016</td>
<td>1.0</td>
<td>0.1250</td>
<td>True</td>
</tr>
<tr class="even">
<th rowspan="3" data-quarto-table-cell-role="th" data-valign="top">mv_oas</th>
<th data-quarto-table-cell-role="th">cf</th>
<td>119</td>
<td>0.0592</td>
<td>0.0092</td>
<td>0.0092</td>
<td>3</td>
<td>16.9492</td>
<td>0.0647</td>
<td>0.0048</td>
<td>0.0016</td>
<td>3.0</td>
<td>0.1000</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">fhs</th>
<td>112</td>
<td>0.0557</td>
<td>0.0057</td>
<td>0.0057</td>
<td>3</td>
<td>18.0180</td>
<td>0.2453</td>
<td>0.0004</td>
<td>0.0015</td>
<td>2.0</td>
<td>0.1111</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">hist</th>
<td>103</td>
<td>0.0513</td>
<td>0.0013</td>
<td>0.0013</td>
<td>3</td>
<td>17.7451</td>
<td>0.7949</td>
<td>0.0023</td>
<td>0.0016</td>
<td>1.0</td>
<td>0.1250</td>
<td>True</td>
</tr>
<tr class="odd">
<th rowspan="3" data-quarto-table-cell-role="th" data-valign="top">mv_sample</th>
<th data-quarto-table-cell-role="th">cf</th>
<td>122</td>
<td>0.0607</td>
<td>0.0107</td>
<td>0.0107</td>
<td>4</td>
<td>16.2975</td>
<td>0.0326</td>
<td>0.0010</td>
<td>0.0015</td>
<td>3.0</td>
<td>0.0833</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">fhs</th>
<td>110</td>
<td>0.0548</td>
<td>0.0048</td>
<td>0.0048</td>
<td>3</td>
<td>18.0917</td>
<td>0.3353</td>
<td>0.0028</td>
<td>0.0014</td>
<td>1.0</td>
<td>0.2000</td>
<td>True</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">hist</th>
<td>112</td>
<td>0.0557</td>
<td>0.0057</td>
<td>0.0057</td>
<td>4</td>
<td>16.9820</td>
<td>0.2453</td>
<td>0.0013</td>
<td>0.0016</td>
<td>2.0</td>
<td>0.1000</td>
<td>False</td>
</tr>
<tr class="even">
<th rowspan="3" data-quarto-table-cell-role="th" data-valign="top">ridge_mv</th>
<th data-quarto-table-cell-role="th">cf</th>
<td>119</td>
<td>0.0592</td>
<td>0.0092</td>
<td>0.0092</td>
<td>3</td>
<td>16.9492</td>
<td>0.0647</td>
<td>0.0048</td>
<td>0.0016</td>
<td>3.0</td>
<td>0.0909</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">fhs</th>
<td>110</td>
<td>0.0548</td>
<td>0.0048</td>
<td>0.0048</td>
<td>2</td>
<td>18.3486</td>
<td>0.3353</td>
<td>0.0080</td>
<td>0.0015</td>
<td>1.0</td>
<td>0.1429</td>
<td>True</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">hist</th>
<td>106</td>
<td>0.0528</td>
<td>0.0028</td>
<td>0.0028</td>
<td>3</td>
<td>17.2381</td>
<td>0.5732</td>
<td>0.0041</td>
<td>0.0016</td>
<td>2.0</td>
<td>0.1111</td>
<td>False</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">alpha_daily</th>
<th data-quarto-table-cell-role="th">alpha_ann</th>
<th data-quarto-table-cell-role="th">beta</th>
<th data-quarto-table-cell-role="th">r2</th>
<th data-quarto-table-cell-role="th">tracking_error</th>
<th data-quarto-table-cell-role="th">information_ratio</th>
<th data-quarto-table-cell-role="th">up_capture</th>
<th data-quarto-table-cell-role="th">down_capture</th>
<th data-quarto-table-cell-role="th">systematic_var_share</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">object</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">ew</th>
<td>-0.0001</td>
<td>-0.0156</td>
<td>1.2248</td>
<td>0.8019</td>
<td>0.1200</td>
<td>0.0913</td>
<td>1.2875</td>
<td>1.3259</td>
<td>0.8019</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">maxsharpe_frontier</th>
<td>0.0003</td>
<td>0.0839</td>
<td>0.9599</td>
<td>0.3625</td>
<td>0.2356</td>
<td>0.3218</td>
<td>1.0839</td>
<td>1.0101</td>
<td>0.3625</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">maxsharpe_slsqp</th>
<td>0.0002</td>
<td>0.0632</td>
<td>1.1294</td>
<td>0.4368</td>
<td>0.2384</td>
<td>0.3215</td>
<td>1.1774</td>
<td>1.1185</td>
<td>0.4368</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">minvar_ewma</th>
<td>0.0001</td>
<td>0.0251</td>
<td>0.6072</td>
<td>0.5787</td>
<td>0.1203</td>
<td>-0.1812</td>
<td>0.5900</td>
<td>0.5404</td>
<td>0.5787</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">minvar_lw</th>
<td>0.0001</td>
<td>0.0186</td>
<td>0.6660</td>
<td>0.6442</td>
<td>0.1105</td>
<td>-0.1917</td>
<td>0.6303</td>
<td>0.5873</td>
<td>0.6442</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">minvar_oas</th>
<td>0.0001</td>
<td>0.0285</td>
<td>0.6532</td>
<td>0.6241</td>
<td>0.1136</td>
<td>-0.1142</td>
<td>0.6181</td>
<td>0.5636</td>
<td>0.6241</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">minvar_sample</th>
<td>0.0002</td>
<td>0.0398</td>
<td>0.6304</td>
<td>0.5949</td>
<td>0.1180</td>
<td>-0.0406</td>
<td>0.5989</td>
<td>0.5314</td>
<td>0.5949</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">mv_ewma</th>
<td>0.0002</td>
<td>0.0444</td>
<td>0.7751</td>
<td>0.6137</td>
<td>0.1211</td>
<td>0.1384</td>
<td>0.8011</td>
<td>0.7445</td>
<td>0.6137</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mv_lw</th>
<td>0.0000</td>
<td>0.0074</td>
<td>0.9279</td>
<td>0.7357</td>
<td>0.1038</td>
<td>-0.0115</td>
<td>0.9232</td>
<td>0.9096</td>
<td>0.7357</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">mv_oas</th>
<td>0.0000</td>
<td>0.0038</td>
<td>0.9168</td>
<td>0.7400</td>
<td>0.1017</td>
<td>-0.0602</td>
<td>0.9104</td>
<td>0.9002</td>
<td>0.7400</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mv_sample</th>
<td>0.0001</td>
<td>0.0142</td>
<td>0.8754</td>
<td>0.7007</td>
<td>0.1083</td>
<td>-0.0058</td>
<td>0.8727</td>
<td>0.8493</td>
<td>0.7007</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ridge_mv</th>
<td>-0.0000</td>
<td>-0.0020</td>
<td>0.9442</td>
<td>0.7785</td>
<td>0.0937</td>
<td>-0.0921</td>
<td>0.9392</td>
<td>0.9369</td>
<td>0.7785</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03_risk_report_engine_and_CAPM_files/figure-html/cell-28-output-7.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03_risk_report_engine_and_CAPM_files/figure-html/cell-28-output-8.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03_risk_report_engine_and_CAPM_files/figure-html/cell-28-output-9.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03_risk_report_engine_and_CAPM_files/figure-html/cell-28-output-10.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03_risk_report_engine_and_CAPM_files/figure-html/cell-28-output-11.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03_risk_report_engine_and_CAPM_files/figure-html/cell-28-output-12.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03_risk_report_engine_and_CAPM_files/figure-html/cell-28-output-13.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03_risk_report_engine_and_CAPM_files/figure-html/cell-28-output-14.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="using-risk-report-function-for-faster-results-hkex-data" class="level2">
<h2 class="anchored" data-anchor-id="using-risk-report-function-for-faster-results-hkex-data">2) Using Risk report function for faster results (HKEX data)</h2>
<p>the data used in this part can be downloaded from here (<a href="https://stooq.com/db/h/">Stooq HKEX daily market data</a>)</p>
<p>for CAPM benchmark we use Equal Weights portfolio here</p>
<div id="01393ddd" class="cell" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> quantfinlab.portfolio <span class="im">as</span> pf</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> quantfinlab.risk <span class="im">as</span> rk</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>rf_annual <span class="op">=</span> <span class="fl">0.04</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>rf_daily <span class="op">=</span> (<span class="fl">1.0</span> <span class="op">+</span> rf_annual) <span class="op">**</span> (<span class="fl">1.0</span> <span class="op">/</span> <span class="fl">252.0</span>) <span class="op">-</span> <span class="fl">1.0</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>raw <span class="op">=</span> pd.read_csv(<span class="st">"../data/hkex_selected_close_volume.csv"</span>, header<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">1</span>], low_memory<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>raw.columns <span class="op">=</span> pd.MultiIndex.from_tuples([(<span class="bu">str</span>(a).strip(), <span class="bu">str</span>(b).strip()) <span class="cf">for</span> a, b <span class="kw">in</span> raw.columns])</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>date_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> raw.columns <span class="cf">if</span> c[<span class="dv">0</span>].lower() <span class="op">==</span> <span class="st">"date"</span>]</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>close_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> raw.columns <span class="cf">if</span> c[<span class="dv">1</span>].lower() <span class="op">==</span> <span class="st">"close"</span>]</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>volume_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> raw.columns <span class="cf">if</span> c[<span class="dv">1</span>].lower() <span class="op">==</span> <span class="st">"volume"</span>]</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>dates <span class="op">=</span> pd.to_datetime(raw[date_cols[<span class="dv">0</span>]], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>close_prices_hk <span class="op">=</span> raw.loc[:, close_cols].copy()</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>volumes_hk <span class="op">=</span> raw.loc[:, volume_cols].copy()</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>close_prices_hk.columns <span class="op">=</span> [<span class="bu">str</span>(c[<span class="dv">0</span>]).strip() <span class="cf">for</span> c <span class="kw">in</span> close_cols]</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>volumes_hk.columns <span class="op">=</span> [<span class="bu">str</span>(c[<span class="dv">0</span>]).strip() <span class="cf">for</span> c <span class="kw">in</span> volume_cols]</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> close_prices_hk.columns.duplicated().<span class="bu">any</span>():</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>    close_prices_hk <span class="op">=</span> close_prices_hk.T.groupby(level<span class="op">=</span><span class="dv">0</span>).last().T</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> volumes_hk.columns.duplicated().<span class="bu">any</span>():</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>    volumes_hk <span class="op">=</span> volumes_hk.T.groupby(level<span class="op">=</span><span class="dv">0</span>).last().T</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>close_prices_hk.index <span class="op">=</span> dates</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>volumes_hk.index <span class="op">=</span> dates</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>stack_hk <span class="op">=</span> pf.build_all_portfolio_strategies(</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>    close_prices_hk,</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>    volumes_hk,</span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>    start<span class="op">=</span><span class="st">"2016-01-01"</span>,</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>    rf_annual<span class="op">=</span>rf_annual,</span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>    rf_daily<span class="op">=</span>rf_daily,</span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>results_hk <span class="op">=</span> <span class="bu">dict</span>(stack_hk.results)</span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a>cache_hk <span class="op">=</span> <span class="bu">dict</span>(stack_hk.cache)</span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a>cov_key_for_rc_hk <span class="op">=</span> <span class="bu">dict</span>(stack_hk.cov_key_for_rc)</span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a>common_idx <span class="op">=</span> <span class="va">None</span></span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> res <span class="kw">in</span> results_hk.values():</span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a>    idx_res <span class="op">=</span> pd.DatetimeIndex(res.net_returns.index)</span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a>    common_idx <span class="op">=</span> idx_res <span class="cf">if</span> common_idx <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> common_idx.intersection(idx_res)</span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> common_idx <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> <span class="bu">len</span>(common_idx) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"No overlapping index across HKEX strategy returns."</span>)</span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a>objects_hk <span class="op">=</span> {name: res.net_returns.reindex(common_idx).fillna(<span class="fl">0.0</span>) <span class="cf">for</span> name, res <span class="kw">in</span> results_hk.items()}</span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a>market_proxy <span class="op">=</span> objects_hk[<span class="st">"ew"</span>] <span class="cf">if</span> <span class="st">"ew"</span> <span class="kw">in</span> objects_hk <span class="cf">else</span> <span class="bu">next</span>(<span class="bu">iter</span>(objects_hk.values()))</span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a>portfolios_hk <span class="op">=</span> {</span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a>    name: {</span>
<span id="cb29-60"><a href="#cb29-60" aria-hidden="true" tabindex="-1"></a>        <span class="st">"backtest"</span>: results_hk[name],</span>
<span id="cb29-61"><a href="#cb29-61" aria-hidden="true" tabindex="-1"></a>        <span class="st">"state_cache"</span>: cache_hk,</span>
<span id="cb29-62"><a href="#cb29-62" aria-hidden="true" tabindex="-1"></a>        <span class="st">"cov_key"</span>: cov_key_for_rc_hk[name],</span>
<span id="cb29-63"><a href="#cb29-63" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-64"><a href="#cb29-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> results_hk.keys()</span>
<span id="cb29-65"><a href="#cb29-65" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-66"><a href="#cb29-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-67"><a href="#cb29-67" aria-hidden="true" tabindex="-1"></a>report_hk <span class="op">=</span> rk.risk_report(</span>
<span id="cb29-68"><a href="#cb29-68" aria-hidden="true" tabindex="-1"></a>    objects<span class="op">=</span>objects_hk,</span>
<span id="cb29-69"><a href="#cb29-69" aria-hidden="true" tabindex="-1"></a>    market_ret<span class="op">=</span>market_proxy,</span>
<span id="cb29-70"><a href="#cb29-70" aria-hidden="true" tabindex="-1"></a>    rf_daily<span class="op">=</span>rf_daily,</span>
<span id="cb29-71"><a href="#cb29-71" aria-hidden="true" tabindex="-1"></a>    portfolios<span class="op">=</span>portfolios_hk,</span>
<span id="cb29-72"><a href="#cb29-72" aria-hidden="true" tabindex="-1"></a>    include<span class="op">=</span>{</span>
<span id="cb29-73"><a href="#cb29-73" aria-hidden="true" tabindex="-1"></a>        <span class="st">"performance_tables"</span>: <span class="va">True</span>,</span>
<span id="cb29-74"><a href="#cb29-74" aria-hidden="true" tabindex="-1"></a>        <span class="st">"shape_tables"</span>: <span class="va">True</span>,</span>
<span id="cb29-75"><a href="#cb29-75" aria-hidden="true" tabindex="-1"></a>        <span class="st">"drawdowns"</span>: <span class="va">True</span>,</span>
<span id="cb29-76"><a href="#cb29-76" aria-hidden="true" tabindex="-1"></a>        <span class="st">"drawdown_episodes"</span>: <span class="va">True</span>,</span>
<span id="cb29-77"><a href="#cb29-77" aria-hidden="true" tabindex="-1"></a>        <span class="st">"var_es"</span>: <span class="va">True</span>,</span>
<span id="cb29-78"><a href="#cb29-78" aria-hidden="true" tabindex="-1"></a>        <span class="st">"var_backtest"</span>: <span class="va">True</span>,</span>
<span id="cb29-79"><a href="#cb29-79" aria-hidden="true" tabindex="-1"></a>        <span class="st">"stress"</span>: <span class="va">True</span>,</span>
<span id="cb29-80"><a href="#cb29-80" aria-hidden="true" tabindex="-1"></a>        <span class="st">"capm"</span>: <span class="va">True</span>,</span>
<span id="cb29-81"><a href="#cb29-81" aria-hidden="true" tabindex="-1"></a>        <span class="st">"rolling_beta"</span>: <span class="va">True</span>,</span>
<span id="cb29-82"><a href="#cb29-82" aria-hidden="true" tabindex="-1"></a>        <span class="st">"correlation"</span>: <span class="va">True</span>,</span>
<span id="cb29-83"><a href="#cb29-83" aria-hidden="true" tabindex="-1"></a>        <span class="st">"attribution"</span>: <span class="va">True</span>,</span>
<span id="cb29-84"><a href="#cb29-84" aria-hidden="true" tabindex="-1"></a>        <span class="st">"exec_bullets"</span>: <span class="va">True</span>,</span>
<span id="cb29-85"><a href="#cb29-85" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb29-86"><a href="#cb29-86" aria-hidden="true" tabindex="-1"></a>    var_settings<span class="op">=</span>{<span class="st">"alpha"</span>: <span class="fl">0.05</span>, <span class="st">"methods"</span>: [<span class="st">"hist"</span>, <span class="st">"cf"</span>, <span class="st">"fhs"</span>], <span class="st">"lookback"</span>: <span class="dv">252</span>},</span>
<span id="cb29-87"><a href="#cb29-87" aria-hidden="true" tabindex="-1"></a>    backtest_settings<span class="op">=</span>{<span class="st">"alpha"</span>: <span class="fl">0.05</span>, <span class="st">"methods"</span>: [<span class="st">"hist"</span>, <span class="st">"cf"</span>, <span class="st">"fhs"</span>], <span class="st">"lookback"</span>: <span class="dv">252</span>, <span class="st">"plot_method"</span>: <span class="st">"best"</span>},</span>
<span id="cb29-88"><a href="#cb29-88" aria-hidden="true" tabindex="-1"></a>    rolling_settings<span class="op">=</span>{<span class="st">"vol_windows"</span>: [<span class="dv">20</span>, <span class="dv">60</span>, <span class="dv">252</span>], <span class="st">"beta_windows"</span>: [<span class="dv">126</span>, <span class="dv">252</span>]},</span>
<span id="cb29-89"><a href="#cb29-89" aria-hidden="true" tabindex="-1"></a>    stress_settings<span class="op">=</span>{</span>
<span id="cb29-90"><a href="#cb29-90" aria-hidden="true" tabindex="-1"></a>        <span class="st">"windows"</span>: {</span>
<span id="cb29-91"><a href="#cb29-91" aria-hidden="true" tabindex="-1"></a>            <span class="st">"2018_q4"</span>: (<span class="st">"2018-10-01"</span>, <span class="st">"2018-12-31"</span>),</span>
<span id="cb29-92"><a href="#cb29-92" aria-hidden="true" tabindex="-1"></a>            <span class="st">"2020_covid"</span>: (<span class="st">"2020-02-20"</span>, <span class="st">"2020-04-30"</span>),</span>
<span id="cb29-93"><a href="#cb29-93" aria-hidden="true" tabindex="-1"></a>            <span class="st">"2022_inflation"</span>: (<span class="st">"2022-01-03"</span>, <span class="st">"2022-10-31"</span>),</span>
<span id="cb29-94"><a href="#cb29-94" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb29-95"><a href="#cb29-95" aria-hidden="true" tabindex="-1"></a>        <span class="st">"worst_only"</span>: <span class="va">True</span>,</span>
<span id="cb29-96"><a href="#cb29-96" aria-hidden="true" tabindex="-1"></a>        <span class="st">"worst_by"</span>: <span class="st">"cum_return"</span>,</span>
<span id="cb29-97"><a href="#cb29-97" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb29-98"><a href="#cb29-98" aria-hidden="true" tabindex="-1"></a>    attribution_settings<span class="op">=</span>{<span class="st">"es_alpha"</span>: <span class="fl">0.05</span>, <span class="st">"top_k"</span>: <span class="dv">5</span>},</span>
<span id="cb29-99"><a href="#cb29-99" aria-hidden="true" tabindex="-1"></a>    layout<span class="op">=</span>{<span class="st">"ncols"</span>: <span class="dv">4</span>, <span class="st">"sharex"</span>: <span class="va">True</span>, <span class="st">"sharey"</span>: <span class="va">True</span>},</span>
<span id="cb29-100"><a href="#cb29-100" aria-hidden="true" tabindex="-1"></a>    output<span class="op">=</span>{</span>
<span id="cb29-101"><a href="#cb29-101" aria-hidden="true" tabindex="-1"></a>        <span class="st">"round_tables"</span>: <span class="dv">4</span>,</span>
<span id="cb29-102"><a href="#cb29-102" aria-hidden="true" tabindex="-1"></a>        <span class="st">"print_exec_bullets"</span>: <span class="va">True</span>,</span>
<span id="cb29-103"><a href="#cb29-103" aria-hidden="true" tabindex="-1"></a>        <span class="st">"display_tables"</span>: <span class="va">True</span>,</span>
<span id="cb29-104"><a href="#cb29-104" aria-hidden="true" tabindex="-1"></a>        <span class="st">"hide_table_keys"</span>: [</span>
<span id="cb29-105"><a href="#cb29-105" aria-hidden="true" tabindex="-1"></a>            <span class="st">"drawdown_episodes"</span>,</span>
<span id="cb29-106"><a href="#cb29-106" aria-hidden="true" tabindex="-1"></a>            <span class="st">"stress"</span>,</span>
<span id="cb29-107"><a href="#cb29-107" aria-hidden="true" tabindex="-1"></a>            <span class="st">"corr"</span>,</span>
<span id="cb29-108"><a href="#cb29-108" aria-hidden="true" tabindex="-1"></a>            <span class="st">"attribution_overlap"</span>,</span>
<span id="cb29-109"><a href="#cb29-109" aria-hidden="true" tabindex="-1"></a>            <span class="st">"attribution_vol"</span>,</span>
<span id="cb29-110"><a href="#cb29-110" aria-hidden="true" tabindex="-1"></a>            <span class="st">"attribution_es"</span>,</span>
<span id="cb29-111"><a href="#cb29-111" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb29-112"><a href="#cb29-112" aria-hidden="true" tabindex="-1"></a>        <span class="st">"show_figures"</span>: <span class="va">True</span>,</span>
<span id="cb29-113"><a href="#cb29-113" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb29-114"><a href="#cb29-114" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-115"><a href="#cb29-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-116"><a href="#cb29-116" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"HKEX strategies in report:"</span>, <span class="bu">sorted</span>(objects_hk.keys()))</span>
<span id="cb29-117"><a href="#cb29-117" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"HKEX report tables:"</span>, <span class="bu">sorted</span>(report_hk.tables.keys()))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ann_return</th>
<th data-quarto-table-cell-role="th">ann_vol</th>
<th data-quarto-table-cell-role="th">sharpe</th>
<th data-quarto-table-cell-role="th">sortino</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">object</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">ew</th>
<td>0.0766</td>
<td>0.2136</td>
<td>0.2690</td>
<td>0.3744</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">maxsharpe_frontier</th>
<td>0.1726</td>
<td>0.2530</td>
<td>0.6028</td>
<td>0.8270</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">maxsharpe_slsqp</th>
<td>0.1334</td>
<td>0.2558</td>
<td>0.4649</td>
<td>0.6455</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">minvar_ewma</th>
<td>0.0807</td>
<td>0.1325</td>
<td>0.3561</td>
<td>0.4822</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">minvar_lw</th>
<td>0.0672</td>
<td>0.1266</td>
<td>0.2672</td>
<td>0.3616</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">minvar_oas</th>
<td>0.0681</td>
<td>0.1261</td>
<td>0.2747</td>
<td>0.3720</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">minvar_sample</th>
<td>0.0702</td>
<td>0.1260</td>
<td>0.2902</td>
<td>0.3936</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">mv_ewma</th>
<td>0.0478</td>
<td>0.1552</td>
<td>0.1262</td>
<td>0.1704</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mv_lw</th>
<td>0.0597</td>
<td>0.1744</td>
<td>0.1952</td>
<td>0.2679</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">mv_oas</th>
<td>0.0602</td>
<td>0.1727</td>
<td>0.1978</td>
<td>0.2712</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mv_sample</th>
<td>0.0560</td>
<td>0.1700</td>
<td>0.1753</td>
<td>0.2401</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ridge_mv</th>
<td>0.0592</td>
<td>0.1769</td>
<td>0.1919</td>
<td>0.2638</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">skew</th>
<th data-quarto-table-cell-role="th">excess_kurtosis</th>
<th data-quarto-table-cell-role="th">tail_ratio_95_05</th>
<th data-quarto-table-cell-role="th">worst_1d</th>
<th data-quarto-table-cell-role="th">worst_5d_avg</th>
<th data-quarto-table-cell-role="th">worst_10d_avg</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">object</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">ew</th>
<td>-0.4398</td>
<td>7.1888</td>
<td>0.9910</td>
<td>-0.1245</td>
<td>-0.0801</td>
<td>-0.0647</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">maxsharpe_frontier</th>
<td>-1.2429</td>
<td>15.7970</td>
<td>1.0581</td>
<td>-0.2106</td>
<td>-0.1013</td>
<td>-0.0803</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">maxsharpe_slsqp</th>
<td>-0.6185</td>
<td>5.5660</td>
<td>1.0212</td>
<td>-0.1575</td>
<td>-0.0868</td>
<td>-0.0738</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">minvar_ewma</th>
<td>-0.9958</td>
<td>9.1113</td>
<td>1.1044</td>
<td>-0.0780</td>
<td>-0.0601</td>
<td>-0.0487</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">minvar_lw</th>
<td>-0.8338</td>
<td>6.6360</td>
<td>1.0077</td>
<td>-0.0685</td>
<td>-0.0532</td>
<td>-0.0438</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">minvar_oas</th>
<td>-0.8208</td>
<td>6.5202</td>
<td>1.0117</td>
<td>-0.0667</td>
<td>-0.0527</td>
<td>-0.0436</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">minvar_sample</th>
<td>-0.8168</td>
<td>6.5715</td>
<td>1.0203</td>
<td>-0.0659</td>
<td>-0.0524</td>
<td>-0.0436</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">mv_ewma</th>
<td>-0.6173</td>
<td>4.4727</td>
<td>0.9296</td>
<td>-0.0804</td>
<td>-0.0533</td>
<td>-0.0472</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mv_lw</th>
<td>-0.4660</td>
<td>4.4792</td>
<td>0.9760</td>
<td>-0.0862</td>
<td>-0.0625</td>
<td>-0.0530</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">mv_oas</th>
<td>-0.4705</td>
<td>4.3553</td>
<td>0.9708</td>
<td>-0.0840</td>
<td>-0.0618</td>
<td>-0.0525</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mv_sample</th>
<td>-0.4746</td>
<td>4.2779</td>
<td>0.9699</td>
<td>-0.0810</td>
<td>-0.0610</td>
<td>-0.0520</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ridge_mv</th>
<td>-0.4230</td>
<td>4.3373</td>
<td>0.9688</td>
<td>-0.0825</td>
<td>-0.0627</td>
<td>-0.0535</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">max_dd</th>
<th data-quarto-table-cell-role="th">longest_dd_days</th>
<th data-quarto-table-cell-role="th">avg_recovery_days</th>
<th data-quarto-table-cell-role="th">ulcer_index</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">object</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">ew</th>
<td>-0.4001</td>
<td>992</td>
<td>45.5870</td>
<td>0.1557</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">maxsharpe_frontier</th>
<td>-0.3966</td>
<td>1027</td>
<td>30.5294</td>
<td>0.1539</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">maxsharpe_slsqp</th>
<td>-0.3886</td>
<td>833</td>
<td>30.0455</td>
<td>0.1761</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">minvar_ewma</th>
<td>-0.2709</td>
<td>1058</td>
<td>23.6512</td>
<td>0.0865</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">minvar_lw</th>
<td>-0.3201</td>
<td>1376</td>
<td>31.2121</td>
<td>0.1212</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">minvar_oas</th>
<td>-0.3203</td>
<td>1369</td>
<td>30.7761</td>
<td>0.1200</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">minvar_sample</th>
<td>-0.3156</td>
<td>1341</td>
<td>26.9605</td>
<td>0.1147</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">mv_ewma</th>
<td>-0.4324</td>
<td>1824</td>
<td>64.3333</td>
<td>0.2044</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mv_lw</th>
<td>-0.3501</td>
<td>1006</td>
<td>50.2143</td>
<td>0.1433</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">mv_oas</th>
<td>-0.3496</td>
<td>989</td>
<td>50.1905</td>
<td>0.1429</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mv_sample</th>
<td>-0.3517</td>
<td>1009</td>
<td>51.4878</td>
<td>0.1437</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ridge_mv</th>
<td>-0.3434</td>
<td>1021</td>
<td>51.5122</td>
<td>0.1364</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">hist_var5</th>
<th data-quarto-table-cell-role="th">hist_es5</th>
<th data-quarto-table-cell-role="th">cf_var5</th>
<th data-quarto-table-cell-role="th">cf_es5</th>
<th data-quarto-table-cell-role="th">fhs_var5</th>
<th data-quarto-table-cell-role="th">fhs_es5</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">object</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">ew</th>
<td>0.0203</td>
<td>0.0299</td>
<td>0.0214</td>
<td>0.0445</td>
<td>0.0123</td>
<td>0.0179</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">maxsharpe_frontier</th>
<td>0.0241</td>
<td>0.0374</td>
<td>0.0255</td>
<td>0.0747</td>
<td>0.0263</td>
<td>0.0384</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">maxsharpe_slsqp</th>
<td>0.0248</td>
<td>0.0368</td>
<td>0.0268</td>
<td>0.0501</td>
<td>0.0199</td>
<td>0.0279</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">minvar_ewma</th>
<td>0.0117</td>
<td>0.0194</td>
<td>0.0141</td>
<td>0.0308</td>
<td>0.0083</td>
<td>0.0123</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">minvar_lw</th>
<td>0.0121</td>
<td>0.0186</td>
<td>0.0135</td>
<td>0.0264</td>
<td>0.0084</td>
<td>0.0127</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">minvar_oas</th>
<td>0.0119</td>
<td>0.0186</td>
<td>0.0135</td>
<td>0.0262</td>
<td>0.0078</td>
<td>0.0120</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">minvar_sample</th>
<td>0.0117</td>
<td>0.0185</td>
<td>0.0134</td>
<td>0.0262</td>
<td>0.0078</td>
<td>0.0117</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">mv_ewma</th>
<td>0.0157</td>
<td>0.0234</td>
<td>0.0166</td>
<td>0.0289</td>
<td>0.0089</td>
<td>0.0129</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mv_lw</th>
<td>0.0170</td>
<td>0.0252</td>
<td>0.0182</td>
<td>0.0320</td>
<td>0.0100</td>
<td>0.0147</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">mv_oas</th>
<td>0.0170</td>
<td>0.0250</td>
<td>0.0181</td>
<td>0.0315</td>
<td>0.0101</td>
<td>0.0147</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mv_sample</th>
<td>0.0167</td>
<td>0.0246</td>
<td>0.0178</td>
<td>0.0309</td>
<td>0.0102</td>
<td>0.0148</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ridge_mv</th>
<td>0.0173</td>
<td>0.0256</td>
<td>0.0184</td>
<td>0.0321</td>
<td>0.0101</td>
<td>0.0147</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">breach_count</th>
<th data-quarto-table-cell-role="th">breach_rate</th>
<th data-quarto-table-cell-role="th">coverage_error</th>
<th data-quarto-table-cell-role="th">abs_coverage_error</th>
<th data-quarto-table-cell-role="th">longest_breach_streak</th>
<th data-quarto-table-cell-role="th">avg_gap_days</th>
<th data-quarto-table-cell-role="th">kupiec_p</th>
<th data-quarto-table-cell-role="th">christoffersen_p</th>
<th data-quarto-table-cell-role="th">quantile_loss</th>
<th data-quarto-table-cell-role="th">accuracy_rank</th>
<th data-quarto-table-cell-role="th">accuracy_score</th>
<th data-quarto-table-cell-role="th">is_best</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">object</th>
<th data-quarto-table-cell-role="th">method</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th rowspan="3" data-quarto-table-cell-role="th" data-valign="top">ew</th>
<th data-quarto-table-cell-role="th">cf</th>
<td>91</td>
<td>0.0464</td>
<td>-0.0036</td>
<td>0.0036</td>
<td>2</td>
<td>21.3000</td>
<td>0.4537</td>
<td>0.0295</td>
<td>0.0016</td>
<td>2.0</td>
<td>0.1000</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">fhs</th>
<td>98</td>
<td>0.0499</td>
<td>-0.0001</td>
<td>0.0001</td>
<td>3</td>
<td>19.9278</td>
<td>0.9876</td>
<td>0.0769</td>
<td>0.0016</td>
<td>1.0</td>
<td>0.2000</td>
<td>True</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">hist</th>
<td>109</td>
<td>0.0555</td>
<td>0.0055</td>
<td>0.0055</td>
<td>2</td>
<td>17.9074</td>
<td>0.2692</td>
<td>0.0205</td>
<td>0.0016</td>
<td>3.0</td>
<td>0.0833</td>
<td>False</td>
</tr>
<tr class="even">
<th rowspan="3" data-quarto-table-cell-role="th" data-valign="top">maxsharpe_frontier</th>
<th data-quarto-table-cell-role="th">cf</th>
<td>106</td>
<td>0.0540</td>
<td>0.0040</td>
<td>0.0040</td>
<td>3</td>
<td>18.2476</td>
<td>0.4220</td>
<td>0.3404</td>
<td>0.0019</td>
<td>2.0</td>
<td>0.1250</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">fhs</th>
<td>107</td>
<td>0.0545</td>
<td>0.0045</td>
<td>0.0045</td>
<td>3</td>
<td>18.0755</td>
<td>0.3660</td>
<td>0.3667</td>
<td>0.0019</td>
<td>1.0</td>
<td>0.1429</td>
<td>True</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">hist</th>
<td>121</td>
<td>0.0616</td>
<td>0.0116</td>
<td>0.0116</td>
<td>2</td>
<td>15.9667</td>
<td>0.0222</td>
<td>0.3102</td>
<td>0.0019</td>
<td>3.0</td>
<td>0.0833</td>
<td>False</td>
</tr>
<tr class="odd">
<th rowspan="3" data-quarto-table-cell-role="th" data-valign="top">maxsharpe_slsqp</th>
<th data-quarto-table-cell-role="th">cf</th>
<td>94</td>
<td>0.0479</td>
<td>-0.0021</td>
<td>0.0021</td>
<td>2</td>
<td>20.3441</td>
<td>0.6652</td>
<td>0.1150</td>
<td>0.0019</td>
<td>1.0</td>
<td>0.1111</td>
<td>True</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">fhs</th>
<td>109</td>
<td>0.0555</td>
<td>0.0055</td>
<td>0.0055</td>
<td>2</td>
<td>17.8981</td>
<td>0.2692</td>
<td>0.4228</td>
<td>0.0019</td>
<td>1.0</td>
<td>0.1111</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">hist</th>
<td>104</td>
<td>0.0530</td>
<td>0.0030</td>
<td>0.0030</td>
<td>3</td>
<td>18.7670</td>
<td>0.5483</td>
<td>0.1468</td>
<td>0.0019</td>
<td>1.0</td>
<td>0.1111</td>
<td>False</td>
</tr>
<tr class="even">
<th rowspan="3" data-quarto-table-cell-role="th" data-valign="top">minvar_ewma</th>
<th data-quarto-table-cell-role="th">cf</th>
<td>90</td>
<td>0.0458</td>
<td>-0.0042</td>
<td>0.0042</td>
<td>3</td>
<td>21.7303</td>
<td>0.3923</td>
<td>0.0025</td>
<td>0.0011</td>
<td>1.0</td>
<td>0.1429</td>
<td>True</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">fhs</th>
<td>112</td>
<td>0.0571</td>
<td>0.0071</td>
<td>0.0071</td>
<td>4</td>
<td>17.4234</td>
<td>0.1603</td>
<td>0.0005</td>
<td>0.0010</td>
<td>2.0</td>
<td>0.1000</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">hist</th>
<td>108</td>
<td>0.0550</td>
<td>0.0050</td>
<td>0.0050</td>
<td>3</td>
<td>18.0748</td>
<td>0.3151</td>
<td>0.0001</td>
<td>0.0011</td>
<td>2.0</td>
<td>0.1000</td>
<td>False</td>
</tr>
<tr class="odd">
<th rowspan="3" data-quarto-table-cell-role="th" data-valign="top">minvar_lw</th>
<th data-quarto-table-cell-role="th">cf</th>
<td>96</td>
<td>0.0489</td>
<td>-0.0011</td>
<td>0.0011</td>
<td>3</td>
<td>20.3579</td>
<td>0.8232</td>
<td>0.0570</td>
<td>0.0010</td>
<td>1.0</td>
<td>0.1429</td>
<td>True</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">fhs</th>
<td>112</td>
<td>0.0571</td>
<td>0.0071</td>
<td>0.0071</td>
<td>3</td>
<td>17.4234</td>
<td>0.1603</td>
<td>0.0313</td>
<td>0.0010</td>
<td>3.0</td>
<td>0.0909</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">hist</th>
<td>111</td>
<td>0.0565</td>
<td>0.0065</td>
<td>0.0065</td>
<td>3</td>
<td>17.5818</td>
<td>0.1920</td>
<td>0.0106</td>
<td>0.0010</td>
<td>2.0</td>
<td>0.1111</td>
<td>False</td>
</tr>
<tr class="even">
<th rowspan="3" data-quarto-table-cell-role="th" data-valign="top">minvar_oas</th>
<th data-quarto-table-cell-role="th">cf</th>
<td>94</td>
<td>0.0479</td>
<td>-0.0021</td>
<td>0.0021</td>
<td>3</td>
<td>20.7312</td>
<td>0.6652</td>
<td>0.0442</td>
<td>0.0010</td>
<td>1.0</td>
<td>0.1250</td>
<td>True</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">fhs</th>
<td>111</td>
<td>0.0565</td>
<td>0.0065</td>
<td>0.0065</td>
<td>3</td>
<td>17.5818</td>
<td>0.1920</td>
<td>0.0638</td>
<td>0.0010</td>
<td>3.0</td>
<td>0.1000</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">hist</th>
<td>103</td>
<td>0.0525</td>
<td>0.0025</td>
<td>0.0025</td>
<td>3</td>
<td>18.9608</td>
<td>0.6182</td>
<td>0.0221</td>
<td>0.0010</td>
<td>2.0</td>
<td>0.1111</td>
<td>False</td>
</tr>
<tr class="odd">
<th rowspan="3" data-quarto-table-cell-role="th" data-valign="top">minvar_sample</th>
<th data-quarto-table-cell-role="th">cf</th>
<td>94</td>
<td>0.0479</td>
<td>-0.0021</td>
<td>0.0021</td>
<td>3</td>
<td>20.7312</td>
<td>0.6652</td>
<td>0.0442</td>
<td>0.0010</td>
<td>3.0</td>
<td>0.0909</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">fhs</th>
<td>113</td>
<td>0.0576</td>
<td>0.0076</td>
<td>0.0076</td>
<td>3</td>
<td>17.2679</td>
<td>0.1328</td>
<td>0.1662</td>
<td>0.0010</td>
<td>2.0</td>
<td>0.1000</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">hist</th>
<td>99</td>
<td>0.0504</td>
<td>0.0004</td>
<td>0.0004</td>
<td>3</td>
<td>19.7347</td>
<td>0.9300</td>
<td>0.0815</td>
<td>0.0010</td>
<td>1.0</td>
<td>0.1667</td>
<td>True</td>
</tr>
<tr class="even">
<th rowspan="3" data-quarto-table-cell-role="th" data-valign="top">mv_ewma</th>
<th data-quarto-table-cell-role="th">cf</th>
<td>92</td>
<td>0.0469</td>
<td>-0.0031</td>
<td>0.0031</td>
<td>2</td>
<td>21.1868</td>
<td>0.5200</td>
<td>0.0338</td>
<td>0.0012</td>
<td>3.0</td>
<td>0.0769</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">fhs</th>
<td>101</td>
<td>0.0515</td>
<td>0.0015</td>
<td>0.0015</td>
<td>2</td>
<td>19.3300</td>
<td>0.7689</td>
<td>0.1076</td>
<td>0.0012</td>
<td>2.0</td>
<td>0.1250</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">hist</th>
<td>98</td>
<td>0.0499</td>
<td>-0.0001</td>
<td>0.0001</td>
<td>2</td>
<td>19.9278</td>
<td>0.9876</td>
<td>0.1721</td>
<td>0.0012</td>
<td>1.0</td>
<td>0.1667</td>
<td>True</td>
</tr>
<tr class="odd">
<th rowspan="3" data-quarto-table-cell-role="th" data-valign="top">mv_lw</th>
<th data-quarto-table-cell-role="th">cf</th>
<td>88</td>
<td>0.0448</td>
<td>-0.0052</td>
<td>0.0052</td>
<td>2</td>
<td>22.1494</td>
<td>0.2850</td>
<td>0.1430</td>
<td>0.0013</td>
<td>3.0</td>
<td>0.0833</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">fhs</th>
<td>102</td>
<td>0.0520</td>
<td>0.0020</td>
<td>0.0020</td>
<td>2</td>
<td>19.1386</td>
<td>0.6919</td>
<td>0.0522</td>
<td>0.0013</td>
<td>1.0</td>
<td>0.1429</td>
<td>True</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">hist</th>
<td>108</td>
<td>0.0550</td>
<td>0.0050</td>
<td>0.0050</td>
<td>2</td>
<td>18.0654</td>
<td>0.3151</td>
<td>0.3942</td>
<td>0.0013</td>
<td>2.0</td>
<td>0.1250</td>
<td>False</td>
</tr>
<tr class="even">
<th rowspan="3" data-quarto-table-cell-role="th" data-valign="top">mv_oas</th>
<th data-quarto-table-cell-role="th">cf</th>
<td>88</td>
<td>0.0448</td>
<td>-0.0052</td>
<td>0.0052</td>
<td>2</td>
<td>22.1494</td>
<td>0.2850</td>
<td>0.1430</td>
<td>0.0013</td>
<td>3.0</td>
<td>0.0833</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">fhs</th>
<td>102</td>
<td>0.0520</td>
<td>0.0020</td>
<td>0.0020</td>
<td>2</td>
<td>19.1386</td>
<td>0.6919</td>
<td>0.1197</td>
<td>0.0013</td>
<td>1.0</td>
<td>0.1429</td>
<td>True</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">hist</th>
<td>107</td>
<td>0.0545</td>
<td>0.0045</td>
<td>0.0045</td>
<td>2</td>
<td>18.2358</td>
<td>0.3660</td>
<td>0.3667</td>
<td>0.0013</td>
<td>2.0</td>
<td>0.1250</td>
<td>False</td>
</tr>
<tr class="odd">
<th rowspan="3" data-quarto-table-cell-role="th" data-valign="top">mv_sample</th>
<th data-quarto-table-cell-role="th">cf</th>
<td>92</td>
<td>0.0469</td>
<td>-0.0031</td>
<td>0.0031</td>
<td>2</td>
<td>21.1868</td>
<td>0.5200</td>
<td>0.0874</td>
<td>0.0013</td>
<td>2.0</td>
<td>0.1000</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">fhs</th>
<td>104</td>
<td>0.0530</td>
<td>0.0030</td>
<td>0.0030</td>
<td>2</td>
<td>18.7670</td>
<td>0.5483</td>
<td>0.0667</td>
<td>0.0013</td>
<td>1.0</td>
<td>0.1429</td>
<td>True</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">hist</th>
<td>105</td>
<td>0.0535</td>
<td>0.0035</td>
<td>0.0035</td>
<td>2</td>
<td>18.5865</td>
<td>0.4828</td>
<td>0.3152</td>
<td>0.0013</td>
<td>2.0</td>
<td>0.1000</td>
<td>False</td>
</tr>
<tr class="even">
<th rowspan="3" data-quarto-table-cell-role="th" data-valign="top">ridge_mv</th>
<th data-quarto-table-cell-role="th">cf</th>
<td>91</td>
<td>0.0464</td>
<td>-0.0036</td>
<td>0.0036</td>
<td>2</td>
<td>21.4111</td>
<td>0.4537</td>
<td>0.0825</td>
<td>0.0014</td>
<td>2.0</td>
<td>0.1000</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">fhs</th>
<td>104</td>
<td>0.0530</td>
<td>0.0030</td>
<td>0.0030</td>
<td>2</td>
<td>18.7670</td>
<td>0.5483</td>
<td>0.0667</td>
<td>0.0013</td>
<td>1.0</td>
<td>0.1429</td>
<td>True</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">hist</th>
<td>107</td>
<td>0.0545</td>
<td>0.0045</td>
<td>0.0045</td>
<td>2</td>
<td>18.2358</td>
<td>0.3660</td>
<td>0.3667</td>
<td>0.0014</td>
<td>2.0</td>
<td>0.1000</td>
<td>False</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">alpha_daily</th>
<th data-quarto-table-cell-role="th">alpha_ann</th>
<th data-quarto-table-cell-role="th">beta</th>
<th data-quarto-table-cell-role="th">r2</th>
<th data-quarto-table-cell-role="th">tracking_error</th>
<th data-quarto-table-cell-role="th">information_ratio</th>
<th data-quarto-table-cell-role="th">up_capture</th>
<th data-quarto-table-cell-role="th">down_capture</th>
<th data-quarto-table-cell-role="th">systematic_var_share</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">object</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">ew</th>
<td>0.0000</td>
<td>0.0000</td>
<td>1.0000</td>
<td>1.0000</td>
<td>NaN</td>
<td>NaN</td>
<td>1.0000</td>
<td>1.0000</td>
<td>1.0000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">maxsharpe_frontier</th>
<td>0.0004</td>
<td>0.1107</td>
<td>0.8266</td>
<td>0.4869</td>
<td>0.1850</td>
<td>0.5140</td>
<td>0.9263</td>
<td>0.8392</td>
<td>0.4869</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">maxsharpe_slsqp</th>
<td>0.0003</td>
<td>0.0661</td>
<td>0.9564</td>
<td>0.6377</td>
<td>0.1542</td>
<td>0.3985</td>
<td>1.0391</td>
<td>0.9900</td>
<td>0.6377</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">minvar_ewma</th>
<td>0.0001</td>
<td>0.0209</td>
<td>0.4606</td>
<td>0.5514</td>
<td>0.1454</td>
<td>-0.0707</td>
<td>0.4837</td>
<td>0.4499</td>
<td>0.5514</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">minvar_lw</th>
<td>0.0000</td>
<td>0.0072</td>
<td>0.4642</td>
<td>0.6134</td>
<td>0.1389</td>
<td>-0.1701</td>
<td>0.4800</td>
<td>0.4573</td>
<td>0.6134</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">minvar_oas</th>
<td>0.0000</td>
<td>0.0086</td>
<td>0.4545</td>
<td>0.5922</td>
<td>0.1416</td>
<td>-0.1610</td>
<td>0.4709</td>
<td>0.4467</td>
<td>0.5922</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">minvar_sample</th>
<td>0.0000</td>
<td>0.0112</td>
<td>0.4432</td>
<td>0.5648</td>
<td>0.1451</td>
<td>-0.1440</td>
<td>0.4590</td>
<td>0.4322</td>
<td>0.5648</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">mv_ewma</th>
<td>-0.0001</td>
<td>-0.0163</td>
<td>0.6262</td>
<td>0.7430</td>
<td>0.1121</td>
<td>-0.3379</td>
<td>0.6507</td>
<td>0.6542</td>
<td>0.7430</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mv_lw</th>
<td>-0.0000</td>
<td>-0.0092</td>
<td>0.7542</td>
<td>0.8529</td>
<td>0.0850</td>
<td>-0.2752</td>
<td>0.7767</td>
<td>0.7783</td>
<td>0.8529</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">mv_oas</th>
<td>-0.0000</td>
<td>-0.0085</td>
<td>0.7439</td>
<td>0.8459</td>
<td>0.0871</td>
<td>-0.2674</td>
<td>0.7677</td>
<td>0.7684</td>
<td>0.8459</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mv_sample</th>
<td>-0.0000</td>
<td>-0.0121</td>
<td>0.7312</td>
<td>0.8439</td>
<td>0.0884</td>
<td>-0.3129</td>
<td>0.7542</td>
<td>0.7575</td>
<td>0.8439</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ridge_mv</th>
<td>-0.0000</td>
<td>-0.0104</td>
<td>0.7729</td>
<td>0.8708</td>
<td>0.0800</td>
<td>-0.2939</td>
<td>0.7918</td>
<td>0.7947</td>
<td>0.8708</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>- maxsharpe_frontier has the highest realized Sharpe ratio.
- Least severe maximum drawdown: minvar_ewma (-27.09%).
- Lower historical ES tail risk: minvar_sample (1.85%).
- Highest market beta: ew (1.00); lowest: minvar_sample (0.44).
- Potential VaR model instability (p&lt;0.05): minvar_ewma, minvar_oas.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03_risk_report_engine_and_CAPM_files/figure-html/cell-29-output-8.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03_risk_report_engine_and_CAPM_files/figure-html/cell-29-output-9.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03_risk_report_engine_and_CAPM_files/figure-html/cell-29-output-10.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03_risk_report_engine_and_CAPM_files/figure-html/cell-29-output-11.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03_risk_report_engine_and_CAPM_files/figure-html/cell-29-output-12.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03_risk_report_engine_and_CAPM_files/figure-html/cell-29-output-13.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03_risk_report_engine_and_CAPM_files/figure-html/cell-29-output-14.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03_risk_report_engine_and_CAPM_files/figure-html/cell-29-output-15.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="03_risk_report_engine_and_CAPM_files/figure-html/cell-29-output-16.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>HKEX strategies in report: ['ew', 'maxsharpe_frontier', 'maxsharpe_slsqp', 'minvar_ewma', 'minvar_lw', 'minvar_oas', 'minvar_sample', 'mv_ewma', 'mv_lw', 'mv_oas', 'mv_sample', 'ridge_mv']
HKEX report tables: ['attribution_es', 'attribution_overlap', 'attribution_vol', 'capm', 'corr', 'drawdown_episodes', 'drawdown_summary', 'performance', 'shape', 'stress', 'var_backtest', 'var_es']</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../notebooks/02_portfolio_optimization_MV_models.html" class="pagination-link" aria-label="2. Portfolio Optimization with Mean–Variance Models">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-title">2. Portfolio Optimization with Mean–Variance Models</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->




</body></html>