<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>1. Fixed income and yield curve construction – Quantitative Finance Lab</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../notebooks/02_portfolio_optimization_MV_models.html" rel="next">
<link href="../overview.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-ed96de9b727972fe78a7b5d16c58bf87.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-2641b481724464e61c86985d8c912b6f.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating fullcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../notebooks/01_yield_curve_bond_pricing_and_risk.html"><span class="chapter-title">1. Fixed income and yield curve construction</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Quantitative Finance Lab</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Quantitative-Finance-Lab</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../overview.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Overview</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/01_yield_curve_bond_pricing_and_risk.html" class="sidebar-item-text sidebar-link active"><span class="chapter-title">1. Fixed income and yield curve construction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/02_portfolio_optimization_MV_models.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">2. Portfolio Optimization with Mean–Variance Models</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-title">1. Fixed income and yield curve construction</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>In this project we will implement</p>
<ul>
<li>building yield curve from par yields for US and japan data with 4 different methods and comparison</li>
<li>creating a rolling synthetic portfolio of bonds</li>
<li>analysis and pricing of the bonds in portfolio</li>
<li>risk and sensitivity measures of bonds</li>
</ul>
<section id="bonds-coupons-treasuries-and-par-yields" class="level2">
<h2 class="anchored" data-anchor-id="bonds-coupons-treasuries-and-par-yields">1) Bonds, Coupons, Treasuries, and Par Yields</h2>
<section id="fixed-coupon-bond-cashflows" class="level3">
<h3 class="anchored" data-anchor-id="fixed-coupon-bond-cashflows">1.1 Fixed-coupon bond cashflows</h3>
<p>A standard coupon bond is defined by: - notional <span class="math inline">\(N\)</span> (principal. the money that you get back) - annual coupon rate <span class="math inline">\(c\)</span> (the interest rate of the bond) - maturity <span class="math inline">\(T\)</span> (the time that bond ends and you get back principal and interest) - coupon frequency <span class="math inline">\(f\)</span> (the amount of payments per year)</p>
<p>Coupon payment each period is <span class="math inline">\(\dfrac{c}{f}N\)</span>.</p>
<p>Payment times are <span class="math inline">\(t_i=\dfrac{i}{f}\)</span> for <span class="math inline">\(i=1,2,\dots,n\)</span> &nbsp;&nbsp;&nbsp;&nbsp; where <span class="math inline">\(n=fT\)</span></p>
<p>Cashflows for each period <span class="math inline">\(i\)</span> is <span class="math inline">\(CF_i=\dfrac{c}{f}N\)</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="math inline">\(i=1,\dots,n-1\)</span></p>
<p>final cash flow: <span class="math inline">\(CF_n=\dfrac{c}{f}N+N\)</span></p>
<hr>
</section>
<section id="price-from-discount-factors" class="level3">
<h3 class="anchored" data-anchor-id="price-from-discount-factors">1.2 Price from discount factors</h3>
<p>For calculating price of a bond we need to discount all the cash flows to today value to compute the present value of the bond. for that we need to have a discount rate for every <span class="math inline">\(t\)</span> that a cash flow accurs. this comes from a continous function of time which is discount curve <span class="math inline">\(D(t)\)</span>, the price is <span class="math inline">\(P=\sum_{i=1}^{n} CF_i\,D(t_i)\)</span></p>
<hr>
</section>
<section id="year-fraction-from-dates" class="level3">
<h3 class="anchored" data-anchor-id="year-fraction-from-dates">1.3 Year fraction from dates</h3>
<p>Given dates <span class="math inline">\(d_0\)</span> and <span class="math inline">\(d_1\)</span>, a day-count year fraction is <span class="math inline">\(\tau(d_0,d_1)=\dfrac{\text{days}(d_0,d_1)}{365}\)</span></p>
<hr>
</section>
<section id="tenor-mapping" class="level3">
<h3 class="anchored" data-anchor-id="tenor-mapping">1.4 Tenor mapping</h3>
<p>Tenor labels map to maturities: - <span class="math inline">\(k\)</span> M → <span class="math inline">\(T=k/12\)</span> - <span class="math inline">\(k\)</span> Y → <span class="math inline">\(T=k\)</span></p>
<p>Collect maturities into a numeric vector: <span class="math inline">\(\mathbf{T}=(T_1,T_2,\dots,T_m)\)</span><br>
Observed market par yields: <span class="math inline">\(\mathbf{y}=(y_1,y_2,\dots,y_m)\)</span> with <span class="math inline">\(y_j=y(T_j)\)</span></p>
<hr>
</section>
<section id="what-treasury-par-yield-means" class="level3">
<h3 class="anchored" data-anchor-id="what-treasury-par-yield-means">1.5 What “Treasury par yield” means</h3>
<p>A par yield at maturity <span class="math inline">\(T\)</span> is the coupon rate <span class="math inline">\(c(T)\)</span> that makes a standard coupon bond price equal to par: <span class="math inline">\(P(T,c(T))=N\)</span> If we normalize <span class="math inline">\(N=1\)</span>, then par means <span class="math inline">\(P=1\)</span>.</p>
<p>For discounting, we use these yields but the problem is we have some of the standard maturities which may not be the same as other bonds. so that’s why we have to make this yield curve from the treasury maturities to be able to discount any time to present.</p>
<p>you can download the data used in this notebook here <a href="https://home.treasury.gov/resource-center/data-chart-center/interest-rates/daily-treasury-rate-archives">(treasury par yields from 1990 to 2026)</a></p>
<hr>
</section>
</section>
<section id="imports-and-plotting-style-and-loading-data" class="level2">
<h2 class="anchored" data-anchor-id="imports-and-plotting-style-and-loading-data">Imports and plotting style and loading data</h2>
<div id="c76fb050" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> cycler <span class="im">import</span> cycler</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">"#069AF3"</span>,<span class="st">"#FE420F"</span>, <span class="st">"#00008B"</span>, <span class="st">"#008080"</span>, <span class="st">"#7BC8F6"</span>,<span class="st">"#800080"</span>,<span class="st">"#0072B2"</span>,<span class="st">"#008000"</span>,<span class="st">"#CC79A7"</span>, <span class="st">"#DC143C"</span>, <span class="st">"#04D8B2"</span>]</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"axes.prop_cycle"</span>] <span class="op">=</span> cycler(color<span class="op">=</span>colors)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>plt.rcParams.update({</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"figure.figsize"</span>: (<span class="dv">6</span>, <span class="dv">3</span>),</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"figure.dpi"</span>: <span class="dv">300</span>,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"savefig.dpi"</span>: <span class="dv">300</span>,</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.grid"</span>: <span class="va">True</span>,</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"grid.alpha"</span>: <span class="fl">0.20</span>,</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.spines.top"</span>: <span class="va">False</span>,</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.spines.right"</span>: <span class="va">False</span>,</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.titlesize"</span>: <span class="dv">14</span>,</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.labelsize"</span>: <span class="dv">12</span>,</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"xtick.labelsize"</span>: <span class="dv">10</span>,</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ytick.labelsize"</span>: <span class="dv">10</span>,</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"legend.fontsize"</span>: <span class="dv">6</span>,</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="vs">r"E:</span><span class="dv">\d</span><span class="vs">aneshgah</span><span class="er">\</span><span class="vs">quantitative-finance-lab</span><span class="dv">\d</span><span class="vs">ata</span><span class="er">\</span><span class="vs">par-yield-curve-rates-1990-2026</span><span class="dv">.</span><span class="vs">csv"</span>)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>col_map <span class="op">=</span> {<span class="st">"date"</span>: <span class="st">"Date"</span>,<span class="st">"1 mo"</span>: <span class="st">"1M"</span>,<span class="st">"2 mo"</span>: <span class="st">"2M"</span>,<span class="st">"3 mo"</span>: <span class="st">"3M"</span>,<span class="st">"4 mo"</span>: <span class="st">"4M"</span>,<span class="st">"6 mo"</span>: <span class="st">"6M"</span>,<span class="st">"1 yr"</span>: <span class="st">"1Y"</span>,<span class="st">"2 yr"</span>: <span class="st">"2Y"</span>,<span class="st">"3 yr"</span>: <span class="st">"3Y"</span>,<span class="st">"5 yr"</span>: <span class="st">"5Y"</span>,<span class="st">"7 yr"</span>: <span class="st">"7Y"</span>,<span class="st">"10 yr"</span>: <span class="st">"10Y"</span>,<span class="st">"20 yr"</span>: <span class="st">"20Y"</span>,<span class="st">"30 yr"</span>: <span class="st">"30Y"</span>}</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.rename(columns<span class="op">=</span>{k.lower(): v <span class="cf">for</span> k, v <span class="kw">in</span> col_map.items()})</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"Date"</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">"Date"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.dropna(subset<span class="op">=</span>[<span class="st">"Date"</span>], ).set_index(<span class="st">"Date"</span>).sort_index()</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">1M</th>
<th data-quarto-table-cell-role="th">2M</th>
<th data-quarto-table-cell-role="th">3M</th>
<th data-quarto-table-cell-role="th">4M</th>
<th data-quarto-table-cell-role="th">6M</th>
<th data-quarto-table-cell-role="th">1Y</th>
<th data-quarto-table-cell-role="th">2Y</th>
<th data-quarto-table-cell-role="th">3Y</th>
<th data-quarto-table-cell-role="th">5Y</th>
<th data-quarto-table-cell-role="th">7Y</th>
<th data-quarto-table-cell-role="th">10Y</th>
<th data-quarto-table-cell-role="th">20Y</th>
<th data-quarto-table-cell-role="th">30Y</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">1990-01-02</th>
<td>NaN</td>
<td>NaN</td>
<td>7.83</td>
<td>NaN</td>
<td>7.89</td>
<td>7.81</td>
<td>7.87</td>
<td>7.90</td>
<td>7.87</td>
<td>7.98</td>
<td>7.94</td>
<td>NaN</td>
<td>8.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1990-01-03</th>
<td>NaN</td>
<td>NaN</td>
<td>7.89</td>
<td>NaN</td>
<td>7.94</td>
<td>7.85</td>
<td>7.94</td>
<td>7.96</td>
<td>7.92</td>
<td>8.04</td>
<td>7.99</td>
<td>NaN</td>
<td>8.04</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">1990-01-04</th>
<td>NaN</td>
<td>NaN</td>
<td>7.84</td>
<td>NaN</td>
<td>7.90</td>
<td>7.82</td>
<td>7.92</td>
<td>7.93</td>
<td>7.91</td>
<td>8.02</td>
<td>7.98</td>
<td>NaN</td>
<td>8.04</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1990-01-05</th>
<td>NaN</td>
<td>NaN</td>
<td>7.79</td>
<td>NaN</td>
<td>7.85</td>
<td>7.79</td>
<td>7.90</td>
<td>7.94</td>
<td>7.92</td>
<td>8.03</td>
<td>7.99</td>
<td>NaN</td>
<td>8.06</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">1990-01-08</th>
<td>NaN</td>
<td>NaN</td>
<td>7.79</td>
<td>NaN</td>
<td>7.88</td>
<td>7.81</td>
<td>7.90</td>
<td>7.95</td>
<td>7.92</td>
<td>8.05</td>
<td>8.02</td>
<td>NaN</td>
<td>8.09</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2026-01-22</th>
<td>3.79</td>
<td>3.72</td>
<td>3.71</td>
<td>3.67</td>
<td>3.61</td>
<td>3.53</td>
<td>3.61</td>
<td>3.68</td>
<td>3.85</td>
<td>4.05</td>
<td>4.26</td>
<td>4.79</td>
<td>4.84</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2026-01-23</th>
<td>3.78</td>
<td>3.72</td>
<td>3.70</td>
<td>3.67</td>
<td>3.61</td>
<td>3.53</td>
<td>3.60</td>
<td>3.67</td>
<td>3.84</td>
<td>4.03</td>
<td>4.24</td>
<td>4.78</td>
<td>4.82</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2026-01-26</th>
<td>3.77</td>
<td>3.70</td>
<td>3.67</td>
<td>3.67</td>
<td>3.62</td>
<td>3.52</td>
<td>3.56</td>
<td>3.66</td>
<td>3.82</td>
<td>4.02</td>
<td>4.22</td>
<td>4.75</td>
<td>4.80</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2026-01-27</th>
<td>3.77</td>
<td>3.70</td>
<td>3.67</td>
<td>3.66</td>
<td>3.61</td>
<td>3.50</td>
<td>3.53</td>
<td>3.65</td>
<td>3.81</td>
<td>4.03</td>
<td>4.24</td>
<td>4.79</td>
<td>4.83</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2026-01-28</th>
<td>3.76</td>
<td>3.71</td>
<td>3.68</td>
<td>3.70</td>
<td>3.63</td>
<td>3.52</td>
<td>3.56</td>
<td>3.66</td>
<td>3.83</td>
<td>4.05</td>
<td>4.26</td>
<td>4.81</td>
<td>4.85</td>
</tr>
</tbody>
</table>

<p>9024 rows × 13 columns</p>
</div>
</div>
</div>
<div id="fe483000" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>tenor_cols <span class="op">=</span> [<span class="st">"1M"</span>,<span class="st">"2M"</span>,<span class="st">"3M"</span>,<span class="st">"4M"</span>,<span class="st">"6M"</span>,<span class="st">"1Y"</span>,<span class="st">"2Y"</span>,<span class="st">"3Y"</span>,<span class="st">"5Y"</span>,<span class="st">"7Y"</span>,<span class="st">"10Y"</span>,<span class="st">"20Y"</span>,<span class="st">"30Y"</span>]</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> tenor_cols:</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    df[c] <span class="op">=</span> pd.to_numeric(df[c], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>first_valid <span class="op">=</span> df[tenor_cols].<span class="bu">apply</span>(<span class="kw">lambda</span> s: s.first_valid_index())</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>availability <span class="op">=</span> pd.DataFrame({</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tenor"</span>: tenor_cols,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"first_valid_date"</span>: [first_valid[t] <span class="cf">for</span> t <span class="kw">in</span> tenor_cols],</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>availability[<span class="st">"first_valid_date"</span>] <span class="op">=</span> pd.to_datetime(availability[<span class="st">"first_valid_date"</span>])</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>availability <span class="op">=</span> availability.sort_values(<span class="st">"first_valid_date"</span>)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Data shape:"</span>, df.shape)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Date range:"</span>, df.index.<span class="bu">min</span>().date(), <span class="st">"to"</span>, df.index.<span class="bu">max</span>().date())</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>display(df[tenor_cols].describe().T)</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> df.columns:</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    plt.plot(df.index, df[c], label<span class="op">=</span>c)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Par Yields Over Time"</span>)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Yield (%)"</span>)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>plt.legend(ncol<span class="op">=</span> <span class="dv">4</span>)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"First available date per tenor:"</span>)</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>display(availability)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Data shape: (9024, 13)
Date range: 1990-01-02 to 2026-01-28</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">count</th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">std</th>
<th data-quarto-table-cell-role="th">min</th>
<th data-quarto-table-cell-role="th">25%</th>
<th data-quarto-table-cell-role="th">50%</th>
<th data-quarto-table-cell-role="th">75%</th>
<th data-quarto-table-cell-role="th">max</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">1M</th>
<td>6124.0</td>
<td>1.669061</td>
<td>1.834318</td>
<td>0.00</td>
<td>0.08</td>
<td>0.98</td>
<td>2.700</td>
<td>6.02</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2M</th>
<td>1819.0</td>
<td>2.731045</td>
<td>2.092637</td>
<td>0.00</td>
<td>0.14</td>
<td>2.43</td>
<td>4.635</td>
<td>5.61</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">3M</th>
<td>9020.0</td>
<td>2.793844</td>
<td>2.279473</td>
<td>0.00</td>
<td>0.23</td>
<td>2.74</td>
<td>5.010</td>
<td>8.26</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">4M</th>
<td>817.0</td>
<td>4.826524</td>
<td>0.600693</td>
<td>3.58</td>
<td>4.35</td>
<td>4.77</td>
<td>5.440</td>
<td>5.64</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6M</th>
<td>9023.0</td>
<td>2.908257</td>
<td>2.296244</td>
<td>0.02</td>
<td>0.41</td>
<td>3.00</td>
<td>5.100</td>
<td>8.49</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1Y</th>
<td>9023.0</td>
<td>3.004545</td>
<td>2.274365</td>
<td>0.04</td>
<td>0.56</td>
<td>3.12</td>
<td>5.025</td>
<td>8.64</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2Y</th>
<td>9023.0</td>
<td>3.243374</td>
<td>2.267325</td>
<td>0.09</td>
<td>0.94</td>
<td>3.35</td>
<td>4.990</td>
<td>9.05</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3Y</th>
<td>9023.0</td>
<td>3.422187</td>
<td>2.212582</td>
<td>0.10</td>
<td>1.37</td>
<td>3.55</td>
<td>5.050</td>
<td>9.11</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">5Y</th>
<td>9023.0</td>
<td>3.761102</td>
<td>2.107014</td>
<td>0.19</td>
<td>1.81</td>
<td>3.73</td>
<td>5.380</td>
<td>9.10</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7Y</th>
<td>9023.0</td>
<td>4.037397</td>
<td>2.028457</td>
<td>0.36</td>
<td>2.22</td>
<td>3.93</td>
<td>5.600</td>
<td>9.12</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10Y</th>
<td>9023.0</td>
<td>4.251091</td>
<td>1.937830</td>
<td>0.52</td>
<td>2.61</td>
<td>4.17</td>
<td>5.710</td>
<td>9.09</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">20Y</th>
<td>8084.0</td>
<td>4.377290</td>
<td>1.629305</td>
<td>0.87</td>
<td>2.89</td>
<td>4.53</td>
<td>5.540</td>
<td>8.30</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">30Y</th>
<td>8029.0</td>
<td>4.735390</td>
<td>1.879145</td>
<td>0.99</td>
<td>3.08</td>
<td>4.56</td>
<td>6.130</td>
<td>9.18</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_yield_curve_bond_pricing_and_risk_files/figure-html/cell-3-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>First available date per tenor:</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">tenor</th>
<th data-quarto-table-cell-role="th">first_valid_date</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>3M</td>
<td>1990-01-02</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">4</th>
<td>6M</td>
<td>1990-01-02</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">5</th>
<td>1Y</td>
<td>1990-01-02</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">6</th>
<td>2Y</td>
<td>1990-01-02</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">7</th>
<td>3Y</td>
<td>1990-01-02</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">8</th>
<td>5Y</td>
<td>1990-01-02</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">9</th>
<td>7Y</td>
<td>1990-01-02</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">10</th>
<td>10Y</td>
<td>1990-01-02</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">12</th>
<td>30Y</td>
<td>1990-01-02</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">11</th>
<td>20Y</td>
<td>1993-10-01</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>1M</td>
<td>2001-07-31</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2M</td>
<td>2018-10-16</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">3</th>
<td>4M</td>
<td>2022-10-19</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="96e2f700" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>sample_dates <span class="op">=</span> [</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    df.index[<span class="dv">0</span>],</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    df.index[<span class="bu">len</span>(df)<span class="op">//</span><span class="dv">2</span>],</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    df.index[<span class="op">-</span><span class="dv">252</span>],</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    df.index[df.index <span class="op">&lt;=</span> pd.Timestamp(<span class="st">"2007-03-01"</span>)][<span class="op">-</span><span class="dv">1</span>],</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    df.index[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="bu">len</span>(tenor_cols))  </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> d <span class="kw">in</span> sample_dates:</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> df.loc[d, tenor_cols].astype(<span class="bu">float</span>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> np.isfinite(y.values)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    plt.plot(x[mask], y.values[mask], marker<span class="op">=</span><span class="st">"o"</span>, label<span class="op">=</span>d.strftime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st">"</span>))</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Yield Curve Snapshots (Par Yields)"</span>)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>plt.xticks(x, tenor_cols)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Yield (%)"</span>)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Tenor"</span>)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_yield_curve_bond_pricing_and_risk_files/figure-html/cell-4-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="discount-factors-zero-rates-and-forward-rates" class="level2">
<h2 class="anchored" data-anchor-id="discount-factors-zero-rates-and-forward-rates">3) Discount Factors, Zero Rates, and Forward Rates</h2>
<section id="discount-factor" class="level3">
<h3 class="anchored" data-anchor-id="discount-factor">3.1 Discount factor</h3>
<p><span class="math inline">\(D(t)\)</span> is the present value of receiving 1 unit of currency at time <span class="math inline">\(t\)</span>. For example what does 1 dollar in 20 years worth now.</p>
</section>
<section id="zero-rate-continuous-compounding" class="level3">
<h3 class="anchored" data-anchor-id="zero-rate-continuous-compounding">3.2 Zero rate (continuous compounding)</h3>
<p><span class="math inline">\(z(t)\)</span> is the constant rate that discounts a payment in <span class="math inline">\(t\)</span> to present. for example, if we want to know discount factor of 1 dollar in 20 years we need an annual rate to compute the present value. that’s zero rate.</p>
<p>Define <span class="math inline">\(z(t)\)</span> by <span class="math display">\[
D(t)=e^{-z(t)t}
\]</span> <span class="math display">\[
z(t)=-\dfrac{\ln D(t)}{t}
\]</span></p>
</section>
<section id="instantaneous-forward-rate" class="level3">
<h3 class="anchored" data-anchor-id="instantaneous-forward-rate">3.3 Instantaneous forward rate</h3>
<p><span class="math inline">\(f(t)\)</span> is the slope of <span class="math inline">\(z(t)\)</span> which tells us how much the rate of return is very close to the time of maturity. it is used because zero rate is smooth and in instant time we need to have exact forward rate</p>
<p><span class="math display">\[
f(t)=-\dfrac{d}{dt}\ln D(t)
\]</span> <span class="math display">\[
D(t)=\exp\left(-\int_0^t f(u)\,du\right)
\]</span></p>
</section>
<section id="discrete-forward-over-an-interval" class="level3">
<h3 class="anchored" data-anchor-id="discrete-forward-over-an-interval">3.4 Discrete forward over an interval</h3>
<p>For <span class="math inline">\(t_1&lt;t_2\)</span>, the continuously-compounded forward rate for the interval is <span class="math display">\[
F(t_1,t_2)=\dfrac{\ln D(t_1)-\ln D(t_2)}{t_2-t_1}
\]</span></p>
<hr>
</section>
</section>
<section id="par-yield-implied-by-a-curve" class="level2">
<h2 class="anchored" data-anchor-id="par-yield-implied-by-a-curve">4) Par Yield Implied by a Curve</h2>
<p>This is used for building yield curve and validation to see if the predicted rate is close to real rate based on curve. what is the rate that makes the price of bond (PV of cashflows) equal to 1?</p>
<p>Given a curve <span class="math inline">\(D(t)\)</span>, the par coupon rate for maturity <span class="math inline">\(T\)</span> and frequency <span class="math inline">\(f\)</span> solves</p>
<p><span class="math inline">\(1=\sum_{i=1}^{n}\dfrac{c}{f}D(t_i)+D(T)\)</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="math inline">\(t_i=i/f\)</span>, <span class="math inline">\(n=fT\)</span>.</p>
<p><span class="math inline">\(1=\dfrac{c}{f}\sum_{i=1}^{n}D(t_i)+D(T)\)</span></p>
<p>and finally we get to <span class="math inline">\(c=f\,\dfrac{1-D(T)}{\sum_{i=1}^{n}D(t_i)}\)</span></p>
<p>Short maturities (&lt;1Y) often use money-market conventions because they are mostly single payment. Two common ones: - continuous: <span class="math inline">\(y=-\dfrac{\ln D(T)}{T}\)</span> - simple: <span class="math inline">\(y=\dfrac{1/D(T)-1}{T}\)</span></p>
<hr>
</section>
<section id="bootstrapping-discount-factors-from-par-yields" class="level2">
<h2 class="anchored" data-anchor-id="bootstrapping-discount-factors-from-par-yields">5) Bootstrapping Discount Factors from Par Yields</h2>
<p>Bootstrapping constructs <span class="math inline">\(D(T)\)</span> at market tenors from observed par yields. in this way we can have a function of time to discount a payment in any maturity based on the real yields that we have.</p>
<section id="short-end-1y-convention" class="level3">
<h3 class="anchored" data-anchor-id="short-end-1y-convention">5.1 Short end (&lt;1Y) convention</h3>
<p>For <span class="math inline">\(T&lt;1\)</span> we use the money market convention again. for calculating discount factor:</p>
<ul>
<li>continuous convention: <span class="math inline">\(D(T)=e^{-y(T)T}\)</span></li>
<li>simple convention: <span class="math inline">\(D(T)=\dfrac{1}{1+y(T)T}\)</span></li>
</ul>
</section>
<section id="bootstrapping-for-coupon-tenors-t-1" class="level3">
<h3 class="anchored" data-anchor-id="bootstrapping-for-coupon-tenors-t-1">5.2 Bootstrapping for coupon tenors (T ≥ 1)</h3>
<p>Let <span class="math inline">\(c=y(T)\)</span> be the market par yield at maturity <span class="math inline">\(T\)</span> (used as coupon rate). With frequency <span class="math inline">\(f\)</span> and cashflow times <span class="math inline">\(t_i=i/f\)</span>:</p>
<p>Par condition (normalized notional 1): <span class="math display">\[
1=\sum_{i=1}^{n-1}\dfrac{c}{f}D(t_i)+\left(1+\dfrac{c}{f}\right)D(T)
\]</span></p>
<p>Solve for the new unknown <span class="math inline">\(D(T)\)</span>: <span class="math display">\[D(T)=\dfrac{1-\sum_{i=1}^{n-1}\dfrac{c}{f}D(t_i)}{1+\dfrac{c}{f}}
\]</span></p>
<p>if we have the earlier coupons discount factor, we know everything on the right side of equation. so we can solve it and get to <span class="math inline">\(D(T)\)</span></p>
<p>it’s called bootstrapping because we first compute the <span class="math inline">\(D(T&lt;1Y)\)</span> with short end convention, then we use that to compute <span class="math inline">\(D(1Y)\)</span> and then use them for <span class="math inline">\(D(2Y)\)</span> until the last maturity (30Y)</p>
</section>
<section id="interpolating-discount-factors-at-coupon-dates" class="level3">
<h3 class="anchored" data-anchor-id="interpolating-discount-factors-at-coupon-dates">5.3 Interpolating discount factors at coupon dates</h3>
<p>Bootstrapping needs <span class="math inline">\(D(t_i)\)</span> at coupon dates, but you often only have DFs at pillar maturities.</p>
<p>A robust choice is log-linear interpolation: If <span class="math inline">\(T_a&lt;t&lt;T_b\)</span>, then</p>
<p><span class="math display">\[\ln D(t)=\ln D(T_a)+\dfrac{t-T_a}{T_b-T_a}\left(\ln D(T_b)-\ln D(T_a)\right)
\]</span></p>
<p>So <span class="math display">\[D(t)=\exp\left(\ln D(t)\right)
\]</span></p>
<div id="66bfc6d0" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>df_dec <span class="op">=</span> df.copy()</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>df_dec[tenor_cols] <span class="op">=</span> df_dec[tenor_cols] <span class="op">/</span> <span class="fl">100.0</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>short_end_convention <span class="op">=</span> <span class="st">"continuous"</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>f <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>min_d <span class="op">=</span> <span class="fl">1e-12</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> labels_to_T(labels):</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    T <span class="op">=</span> []</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> lab <span class="kw">in</span> labels:</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        labu <span class="op">=</span> lab.upper().strip()</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> labu.endswith(<span class="st">"M"</span>):</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>            T.append(<span class="bu">int</span>(labu[:<span class="op">-</span><span class="dv">1</span>]) <span class="op">/</span> <span class="fl">12.0</span>)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>            T.append(<span class="bu">float</span>(<span class="bu">int</span>(labu[:<span class="op">-</span><span class="dv">1</span>])))</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.array(T, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_par_from_row(row):</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> row[tenor_cols].astype(<span class="bu">float</span>)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> np.isfinite(y.values)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    labels <span class="op">=</span> [tenor_cols[i] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(tenor_cols)) <span class="cf">if</span> mask[i]]</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(labels) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    par <span class="op">=</span> y.values[mask].astype(<span class="bu">float</span>)</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    T <span class="op">=</span> labels_to_T(labels)</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    i <span class="op">=</span> np.argsort(T)</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    T <span class="op">=</span> T[i]</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    par <span class="op">=</span> par[i]</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    labels <span class="op">=</span> [labels[i] <span class="cf">for</span> i <span class="kw">in</span> i]</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> T, par, labels</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_par_for_date(date):</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    row <span class="op">=</span> df_dec.loc[date]</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> get_par_from_row(row)</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> short_end_df(Ti, ri):</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> short_end_convention <span class="op">==</span> <span class="st">"continuous"</span>:</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> math.exp(<span class="op">-</span>ri <span class="op">*</span> Ti)</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fl">1.0</span> <span class="op">/</span> (<span class="fl">1.0</span> <span class="op">+</span> ri <span class="op">*</span> Ti)</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> price_error_loglinear(d_T, Ti, t_prev, d_prev, times_interp, c, pv_known):</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>    d_T <span class="op">=</span> <span class="bu">max</span>(<span class="bu">float</span>(d_T), min_d)</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>    pv_interp <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(times_interp) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>        w <span class="op">=</span> (times_interp <span class="op">-</span> t_prev) <span class="op">/</span> (Ti <span class="op">-</span> t_prev)</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>        log_d <span class="op">=</span> (<span class="dv">1</span> <span class="op">-</span> w) <span class="op">*</span> np.log(d_prev) <span class="op">+</span> w <span class="op">*</span> np.log(d_T)</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>        d_interp <span class="op">=</span> np.exp(log_d)</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>        pv_interp <span class="op">=</span> np.<span class="bu">sum</span>((c <span class="op">/</span> f) <span class="op">*</span> d_interp)</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pv_known <span class="op">+</span> pv_interp <span class="op">+</span> d_T <span class="op">-</span> <span class="fl">1.0</span></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> solve_df_long_end(Ti, ri, d_map):</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>    c <span class="op">=</span> <span class="bu">float</span>(ri)</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">int</span>(<span class="bu">round</span>(Ti <span class="op">*</span> f))</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>    times <span class="op">=</span> np.array([k <span class="op">/</span> f <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n <span class="op">+</span> <span class="dv">1</span>)], dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>    known_T <span class="op">=</span> np.array(<span class="bu">sorted</span>(d_map.keys()), dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>    known_D <span class="op">=</span> np.array([d_map[t] <span class="cf">for</span> t <span class="kw">in</span> known_T], dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>    known_D <span class="op">=</span> np.clip(known_D, min_d, <span class="va">None</span>)</span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>    t_prev <span class="op">=</span> known_T[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>    d_prev <span class="op">=</span> known_D[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>    times_known <span class="op">=</span> times[times <span class="op">&lt;=</span> t_prev <span class="op">+</span> <span class="fl">1e-12</span>]</span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>    times_interp <span class="op">=</span> times[times <span class="op">&gt;</span> t_prev <span class="op">+</span> <span class="fl">1e-12</span>]</span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>    pv_known <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(times_known) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>        log_known_D <span class="op">=</span> np.log(known_D)</span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>        log_df_known <span class="op">=</span> np.interp(times_known, known_T, log_known_D)</span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>        d_known <span class="op">=</span> np.exp(log_df_known)</span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>        pv_known <span class="op">=</span> np.<span class="bu">sum</span>((c <span class="op">/</span> f) <span class="op">*</span> d_known)</span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>    lo <span class="op">=</span> min_d</span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>    hi <span class="op">=</span> d_prev</span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>    f_lo <span class="op">=</span> price_error_loglinear(lo, Ti, t_prev, d_prev, times_interp, c, pv_known)</span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>    f_hi <span class="op">=</span> price_error_loglinear(hi, Ti, t_prev, d_prev, times_interp, c, pv_known)</span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> f_lo <span class="op">*</span> f_hi <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a>        log_known_D <span class="op">=</span> np.log(known_D)</span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a>        log_df_cpn <span class="op">=</span> np.interp(</span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a>            times[:<span class="op">-</span><span class="dv">1</span>],</span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a>            known_T,</span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a>            log_known_D,</span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a>            left<span class="op">=</span>log_known_D[<span class="dv">0</span>],</span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a>            right<span class="op">=</span>log_known_D[<span class="op">-</span><span class="dv">1</span>],</span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a>        d_cpn <span class="op">=</span> np.exp(log_df_cpn)</span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a>        pv_coupons <span class="op">=</span> np.<span class="bu">sum</span>((c <span class="op">/</span> f) <span class="op">*</span> d_cpn)</span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a>        d_T <span class="op">=</span> (<span class="fl">1.0</span> <span class="op">-</span> pv_coupons) <span class="op">/</span> (<span class="fl">1.0</span> <span class="op">+</span> c <span class="op">/</span> f)</span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">100</span>):</span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true" tabindex="-1"></a>            mid <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> (lo <span class="op">+</span> hi)</span>
<span id="cb6-105"><a href="#cb6-105" aria-hidden="true" tabindex="-1"></a>            f_mid <span class="op">=</span> price_error_loglinear(mid, Ti, t_prev, d_prev, times_interp, c, pv_known)</span>
<span id="cb6-106"><a href="#cb6-106" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> f_lo <span class="op">*</span> f_mid <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb6-107"><a href="#cb6-107" aria-hidden="true" tabindex="-1"></a>                hi <span class="op">=</span> mid</span>
<span id="cb6-108"><a href="#cb6-108" aria-hidden="true" tabindex="-1"></a>                f_hi <span class="op">=</span> f_mid</span>
<span id="cb6-109"><a href="#cb6-109" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb6-110"><a href="#cb6-110" aria-hidden="true" tabindex="-1"></a>                lo <span class="op">=</span> mid</span>
<span id="cb6-111"><a href="#cb6-111" aria-hidden="true" tabindex="-1"></a>                f_lo <span class="op">=</span> f_mid</span>
<span id="cb6-112"><a href="#cb6-112" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">abs</span>(hi <span class="op">-</span> lo) <span class="op">&lt;</span> <span class="fl">1e-12</span>:</span>
<span id="cb6-113"><a href="#cb6-113" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb6-114"><a href="#cb6-114" aria-hidden="true" tabindex="-1"></a>        d_T <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> (lo <span class="op">+</span> hi)</span>
<span id="cb6-115"><a href="#cb6-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-116"><a href="#cb6-116" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> d_T</span>
<span id="cb6-117"><a href="#cb6-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-118"><a href="#cb6-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-119"><a href="#cb6-119" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> bootstrap_from_inputs(T, par, labels, date<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb6-120"><a href="#cb6-120" aria-hidden="true" tabindex="-1"></a>    d_map <span class="op">=</span> {}</span>
<span id="cb6-121"><a href="#cb6-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-122"><a href="#cb6-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># short convention</span></span>
<span id="cb6-123"><a href="#cb6-123" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> Ti, ri <span class="kw">in</span> <span class="bu">zip</span>(T, par, strict<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb6-124"><a href="#cb6-124" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> Ti <span class="op">&lt;</span> <span class="fl">1.0</span>:</span>
<span id="cb6-125"><a href="#cb6-125" aria-hidden="true" tabindex="-1"></a>            d_T <span class="op">=</span> short_end_df(Ti, ri)</span>
<span id="cb6-126"><a href="#cb6-126" aria-hidden="true" tabindex="-1"></a>            d_map[Ti] <span class="op">=</span> <span class="bu">max</span>(<span class="bu">float</span>(d_T), min_d)</span>
<span id="cb6-127"><a href="#cb6-127" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb6-128"><a href="#cb6-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-129"><a href="#cb6-129" aria-hidden="true" tabindex="-1"></a>        d_T <span class="op">=</span> solve_df_long_end(Ti, ri, d_map)</span>
<span id="cb6-130"><a href="#cb6-130" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="kw">not</span> np.isfinite(d_T)) <span class="kw">or</span> (d_T <span class="op">&lt;=</span> <span class="dv">0</span>):</span>
<span id="cb6-131"><a href="#cb6-131" aria-hidden="true" tabindex="-1"></a>            d_T <span class="op">=</span> min_d</span>
<span id="cb6-132"><a href="#cb6-132" aria-hidden="true" tabindex="-1"></a>        d_map[Ti] <span class="op">=</span> <span class="bu">max</span>(<span class="bu">float</span>(d_T), min_d)</span>
<span id="cb6-133"><a href="#cb6-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-134"><a href="#cb6-134" aria-hidden="true" tabindex="-1"></a>    dfs <span class="op">=</span> np.array([d_map[t] <span class="cf">for</span> t <span class="kw">in</span> T], dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb6-135"><a href="#cb6-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-136"><a href="#cb6-136" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb6-137"><a href="#cb6-137" aria-hidden="true" tabindex="-1"></a>        <span class="st">"date"</span>: date,</span>
<span id="cb6-138"><a href="#cb6-138" aria-hidden="true" tabindex="-1"></a>        <span class="st">"T"</span>: T,</span>
<span id="cb6-139"><a href="#cb6-139" aria-hidden="true" tabindex="-1"></a>        <span class="st">"par"</span>: par,</span>
<span id="cb6-140"><a href="#cb6-140" aria-hidden="true" tabindex="-1"></a>        <span class="st">"labels"</span>: labels,</span>
<span id="cb6-141"><a href="#cb6-141" aria-hidden="true" tabindex="-1"></a>        <span class="st">"dfs"</span>: dfs,</span>
<span id="cb6-142"><a href="#cb6-142" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-143"><a href="#cb6-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-144"><a href="#cb6-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-145"><a href="#cb6-145" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> bootstrap_pillars(date):</span>
<span id="cb6-146"><a href="#cb6-146" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> get_par_for_date(date)</span>
<span id="cb6-147"><a href="#cb6-147" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb6-148"><a href="#cb6-148" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb6-149"><a href="#cb6-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-150"><a href="#cb6-150" aria-hidden="true" tabindex="-1"></a>    T, par, labels <span class="op">=</span> result</span>
<span id="cb6-151"><a href="#cb6-151" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> bootstrap_from_inputs(T, par, labels, date<span class="op">=</span>date)</span>
<span id="cb6-152"><a href="#cb6-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-153"><a href="#cb6-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-154"><a href="#cb6-154" aria-hidden="true" tabindex="-1"></a><span class="co"># we bootstrap discount factors at the last available date for now</span></span>
<span id="cb6-155"><a href="#cb6-155" aria-hidden="true" tabindex="-1"></a>base_date <span class="op">=</span> df_dec.index[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb6-156"><a href="#cb6-156" aria-hidden="true" tabindex="-1"></a>pillars <span class="op">=</span> bootstrap_pillars(base_date)</span>
<span id="cb6-157"><a href="#cb6-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-158"><a href="#cb6-158" aria-hidden="true" tabindex="-1"></a>T <span class="op">=</span> pillars[<span class="st">"T"</span>]</span>
<span id="cb6-159"><a href="#cb6-159" aria-hidden="true" tabindex="-1"></a>par <span class="op">=</span> pillars[<span class="st">"par"</span>]</span>
<span id="cb6-160"><a href="#cb6-160" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> pillars[<span class="st">"labels"</span>]</span>
<span id="cb6-161"><a href="#cb6-161" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> pillars[<span class="st">"dfs"</span>]</span>
<span id="cb6-162"><a href="#cb6-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-163"><a href="#cb6-163" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Base date:"</span>, base_date.date())</span>
<span id="cb6-164"><a href="#cb6-164" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Tenors used:"</span>, labels)</span>
<span id="cb6-165"><a href="#cb6-165" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"First 5 pillar DFs:"</span>, dfs)</span>
<span id="cb6-166"><a href="#cb6-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-167"><a href="#cb6-167" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb6-168"><a href="#cb6-168" aria-hidden="true" tabindex="-1"></a>plt.plot(T, dfs, marker<span class="op">=</span><span class="st">"o"</span>)</span>
<span id="cb6-169"><a href="#cb6-169" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Bootstrapped Discount Factors"</span>)</span>
<span id="cb6-170"><a href="#cb6-170" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Maturity T"</span>)</span>
<span id="cb6-171"><a href="#cb6-171" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Discount Factor D(t)"</span>)</span>
<span id="cb6-172"><a href="#cb6-172" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Base date: 2026-01-28
Tenors used: ['1M', '2M', '3M', '4M', '6M', '1Y', '2Y', '3Y', '5Y', '7Y', '10Y', '20Y', '30Y']
First 5 pillar DFs: [0.99687157 0.99383574 0.99084219 0.98774241 0.98201372 0.96571989
 0.93185753 0.89680276 0.82670445 0.75353422 0.65216175 0.37090153
 0.22566195]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_yield_curve_bond_pricing_and_risk_files/figure-html/cell-5-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="turning-bootstrapped-pillars-into-a-full-curve" class="level2">
<h2 class="anchored" data-anchor-id="turning-bootstrapped-pillars-into-a-full-curve">6) Turning Bootstrapped Pillars into a Full Curve</h2>
<p>After bootstrapping we have pillars <span class="math inline">\((T_j, D(T_j))\)</span> or <span class="math inline">\((T_j, z(T_j))\)</span>. Now we want to define continuous functions <span class="math inline">\(D(t)\)</span> and <span class="math inline">\(z(t)\)</span> for all <span class="math inline">\(t\)</span>.</p>
<section id="method-a-log-linear-discount-factors" class="level3">
<h3 class="anchored" data-anchor-id="method-a-log-linear-discount-factors">6.1 Method A: Log-linear discount factors</h3>
<p>Interpolate <span class="math inline">\(\ln D(t)\)</span> linearly between pillars (just like for the T we had. we do the same thing between them):</p>
<p><span class="math inline">\(\ln D(t)=\text{linear interp of } \{\ln D(T_j)\}\)</span></p>
<p>Then <span class="math inline">\(D(t)=\exp(\ln D(t))\)</span></p>
<p>and <span class="math inline">\(z(t)=-\dfrac{\ln D(t)}{t}\)</span></p>
<div id="db56b670" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> loglinear_curve(T, dfs):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    loglinear_log_dfs <span class="op">=</span> np.log(dfs)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    loglinear_grid <span class="op">=</span> np.linspace(<span class="bu">max</span>(<span class="dv">1</span> <span class="op">/</span> <span class="dv">12</span>, T.<span class="bu">min</span>()), <span class="fl">30.0</span>, <span class="dv">1000</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    loglinear_log_df_grid <span class="op">=</span> np.interp(</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>        loglinear_grid,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        T,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        loglinear_log_dfs,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        left<span class="op">=</span>loglinear_log_dfs[<span class="dv">0</span>],</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        right<span class="op">=</span>loglinear_log_dfs[<span class="op">-</span><span class="dv">1</span>],</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    loglinear_df_grid <span class="op">=</span> np.exp(loglinear_log_df_grid)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># zero rate</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    loglinear_z_grid <span class="op">=</span> <span class="op">-</span>np.log(loglinear_df_grid) <span class="op">/</span> loglinear_grid</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># instantaneous forward rate</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    loglinear_fwd_grid <span class="op">=</span> <span class="op">-</span>np.gradient(np.log(loglinear_df_grid), loglinear_grid)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> loglinear_df_func(t):</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>        t <span class="op">=</span> np.array(t, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        log_df <span class="op">=</span> np.interp(</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>            t,</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>            T,</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>            loglinear_log_dfs,</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>            left<span class="op">=</span>loglinear_log_dfs[<span class="dv">0</span>],</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>            right<span class="op">=</span>loglinear_log_dfs[<span class="op">-</span><span class="dv">1</span>],</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.exp(log_df)</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">"name"</span>: <span class="st">"Log-linear DF"</span>,</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">"grid"</span>: loglinear_grid,</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">"df_grid"</span>: loglinear_df_grid,</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">"z_grid"</span>: loglinear_z_grid,</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">"fwd_grid"</span>: loglinear_fwd_grid,</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">"df_func"</span>: loglinear_df_func,</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">"log_dfs"</span>: loglinear_log_dfs,</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>loglinear_curve_data <span class="op">=</span> loglinear_curve(T, dfs)</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>loglinear_grid <span class="op">=</span> loglinear_curve_data[<span class="st">"grid"</span>]</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>loglinear_df_grid <span class="op">=</span> loglinear_curve_data[<span class="st">"df_grid"</span>]</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>loglinear_z_grid <span class="op">=</span> loglinear_curve_data[<span class="st">"z_grid"</span>]</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>loglinear_fwd_grid <span class="op">=</span> loglinear_curve_data[<span class="st">"fwd_grid"</span>]</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"curves"</span> <span class="kw">not</span> <span class="kw">in</span> <span class="bu">globals</span>():</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>    curves <span class="op">=</span> {}</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>curves[<span class="st">"loglinear"</span>] <span class="op">=</span> loglinear_curve_data</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>plt.plot(loglinear_grid, loglinear_z_grid <span class="op">*</span> <span class="fl">100.0</span>)</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Zero Curve (log-linear)"</span>)</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Maturity (Years)"</span>)</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Zero Rate (%)"</span>)</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>plt.plot(loglinear_grid, loglinear_fwd_grid <span class="op">*</span> <span class="fl">100.0</span>)</span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Instantaneous Forward Rate (derivative of ln(DF))"</span>)</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Maturity (Years)"</span>)</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Forward Rate (%)"</span>)</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_yield_curve_bond_pricing_and_risk_files/figure-html/cell-6-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_yield_curve_bond_pricing_and_risk_files/figure-html/cell-6-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="curve-models-using-zero-rate-smoothing" class="level2">
<h2 class="anchored" data-anchor-id="curve-models-using-zero-rate-smoothing">7) Curve Models Using Zero-Rate Smoothing</h2>
<p>Instead of interpolating <span class="math inline">\(D\)</span>, we can interpolate <span class="math inline">\(z\)</span> and recover <span class="math inline">\(D(t)=e^{-z(t)t}\)</span>.</p>
<section id="pchip-on-zero-rates-piecewise-cubic-hermite-interpolating-polynomial" class="level3">
<h3 class="anchored" data-anchor-id="pchip-on-zero-rates-piecewise-cubic-hermite-interpolating-polynomial">7.1 PCHIP on zero rates (Piecewise Cubic Hermite Interpolating Polynomial)</h3>
<p>Given nodes <span class="math inline">\(x_j=T_j\)</span> and <span class="math inline">\(y_j=z(T_j)\)</span>, PCHIP builds a piecewise cubic polynomial on each interval:</p>
<p><span class="math display">\[
p_j(t)=a_j(t-x_j)^3+b_j(t-x_j)^2+c_j(t-x_j)+d_j  \quad t\in[x_j,x_{j+1}]
\]</span></p>
<p>Constraints include: - <span class="math inline">\(p_j(x_j)=y_j\)</span> and <span class="math inline">\(p_j(x_{j+1})=y_{j+1}\)</span> - first derivatives are chosen by shape-preserving slope rules to reduce overshoot</p>
<p>we define <span class="math inline">\(z(t)=p_j(t)\)</span></p>
<p>then <span class="math inline">\(D(t)=e^{-z(t)t}\)</span></p>
<div id="b886b647" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.interpolate <span class="im">import</span> PchipInterpolator</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pchip_curve(T, dfs):</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    pchip_zeros <span class="op">=</span> <span class="op">-</span>np.log(np.clip(dfs, min_d, <span class="va">None</span>)) <span class="op">/</span> T</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    pchip_z <span class="op">=</span> PchipInterpolator(T, pchip_zeros, extrapolate<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    pchip_grid <span class="op">=</span> np.linspace(<span class="bu">max</span>(<span class="dv">1</span> <span class="op">/</span> <span class="dv">12</span>, T.<span class="bu">min</span>()), <span class="fl">30.0</span>, <span class="dv">1000</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    pchip_z_grid <span class="op">=</span> pchip_z(pchip_grid)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    pchip_df_grid <span class="op">=</span> np.exp(<span class="op">-</span>pchip_z_grid <span class="op">*</span> pchip_grid)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    pchip_fwd_grid <span class="op">=</span> <span class="op">-</span>np.gradient(</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>        np.log(np.clip(pchip_df_grid, min_d, <span class="va">None</span>)), pchip_grid</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> pchip_df_func(t):</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>        t <span class="op">=</span> np.array(t, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>        z <span class="op">=</span> pchip_z(t)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.exp(<span class="op">-</span>z <span class="op">*</span> t)</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"name"</span>: <span class="st">"PCHIP zero"</span>,</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"grid"</span>: pchip_grid,</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"df_grid"</span>: pchip_df_grid,</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"z_grid"</span>: pchip_z_grid,</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"fwd_grid"</span>: pchip_fwd_grid,</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">"df_func"</span>: pchip_df_func,</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pillar_zeros"</span>: pchip_zeros,</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>pchip_curve_data <span class="op">=</span> pchip_curve(T, dfs)</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>curves[<span class="st">"pchip"</span>] <span class="op">=</span> pchip_curve_data</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>plt.plot(T, pchip_curve_data[<span class="st">"pillar_zeros"</span>] <span class="op">*</span> <span class="fl">100.0</span>, <span class="st">"o"</span>, label<span class="op">=</span><span class="st">"pillar zeros"</span>)</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>plt.plot(pchip_curve_data[<span class="st">"grid"</span>], pchip_curve_data[<span class="st">"z_grid"</span>] <span class="op">*</span> <span class="fl">100.0</span>, <span class="st">"-"</span>, label<span class="op">=</span><span class="st">"PCHIP zero"</span>)</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Zero Curve (PCHIP)"</span>)</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Maturity"</span>)</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Zero Rate"</span>)</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>plt.plot(T, dfs, <span class="st">"o"</span>, label<span class="op">=</span><span class="st">"Pillar DFs"</span>)</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>plt.plot(pchip_curve_data[<span class="st">"grid"</span>], pchip_curve_data[<span class="st">"df_grid"</span>], <span class="st">"-"</span>, label<span class="op">=</span><span class="st">"DF from PCHIP"</span>)</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Discount Factors"</span>)</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Maturity"</span>)</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Discount Factor"</span>)</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>plt.plot(pchip_curve_data[<span class="st">"grid"</span>], pchip_curve_data[<span class="st">"fwd_grid"</span>] <span class="op">*</span> <span class="fl">100.0</span>)</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Instantaneous Forward Rate"</span>)</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Maturity"</span>)</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Forward Rate"</span>)</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_yield_curve_bond_pricing_and_risk_files/figure-html/cell-7-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_yield_curve_bond_pricing_and_risk_files/figure-html/cell-7-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_yield_curve_bond_pricing_and_risk_files/figure-html/cell-7-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="nelsonsiegelsvensson-nss-yield-curve" class="level2">
<h2 class="anchored" data-anchor-id="nelsonsiegelsvensson-nss-yield-curve">8) Nelson–Siegel–Svensson (NSS) yield curve</h2>
<p>we represent the continuous-compounded zero rate curve <span class="math inline">\(z(t)\)</span> with a small number of parameters, then derive discount factors, par yields and forwards</p>
<section id="nss-zero-rate-function" class="level3">
<h3 class="anchored" data-anchor-id="nss-zero-rate-function">8.1 NSS zero-rate function</h3>
<p>For maturity <span class="math inline">\(t&gt;0\)</span>, the NSS zero rate is:</p>
<p><span class="math display">\[
z(t)=\beta_0 +\beta_1\left(\frac{1-e^{-t/\tau_1}}{t/\tau_1}\right) +\beta_2\left(\frac{1-e^{-t/\tau_1}}{t/\tau_1}-e^{-t/\tau_1}\right) +\beta_3\left(\frac{1-e^{-t/\tau_2}}{t/\tau_2}-e^{-t/\tau_2}\right)
\]</span></p>
<p>Parameters:</p>
<ul>
<li><p><span class="math inline">\(\beta_0\)</span> = long-run “level”</p></li>
<li><p><span class="math inline">\(\beta_1\)</span> = “slope” (short-end effect)</p></li>
<li><p><span class="math inline">\(\beta_2\)</span> = medium-term “curvature” (first hump)</p></li>
<li><p><span class="math inline">\(\beta_3\)</span> = additional curvature (second hump)</p></li>
<li><p><span class="math inline">\(\tau_1,\tau_2&gt;0\)</span> control where humps occur</p></li>
</ul>
<div id="f4f26f9a" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> nss_zero(t, b0,b1,b2,b3,tau1,tau2):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> np.array(t, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    x1 <span class="op">=</span> t <span class="op">/</span> tau1</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    x2 <span class="op">=</span> t <span class="op">/</span> tau2</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    L1 <span class="op">=</span> (<span class="fl">1.0</span> <span class="op">-</span> np.exp(<span class="op">-</span>x1)) <span class="op">/</span> x1</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    C1 <span class="op">=</span> L1 <span class="op">-</span> np.exp(<span class="op">-</span>x1)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    C2 <span class="op">=</span> (<span class="fl">1.0</span> <span class="op">-</span> np.exp(<span class="op">-</span>x2)) <span class="op">/</span> x2 <span class="op">-</span> np.exp(<span class="op">-</span>x2)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> b0 <span class="op">+</span> b1<span class="op">*</span>L1 <span class="op">+</span> b2<span class="op">*</span>C1 <span class="op">+</span> b3<span class="op">*</span>C2</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="par-yield-implied-by-nss" class="level3">
<h3 class="anchored" data-anchor-id="par-yield-implied-by-nss">8.3 Par yield implied by NSS</h3>
<p>For a coupon bond with maturity <span class="math inline">\(T\)</span> and coupon frequency <span class="math inline">\(f\)</span>, coupon rate <span class="math inline">\(c(T)\)</span> is the rate that makes the bond price equal to par (normalize notional to 1):</p>
<p><span class="math display">\[
1=\sum_{i=1}^{n}\frac{c(T)}{f}D(t_i)+D(T)
\]</span></p>
<p>Solve for <span class="math inline">\(c(T)\)</span>:</p>
<p><span class="math display">\[
c(T)=f\cdot\frac{1-D(T)}{\sum_{i=1}^{n}D(t_i)}
\]</span></p>
<p>For short maturities (money-market style), a common mapping is:</p>
<p>continuous: <span class="math inline">\(y(T)=-\ln D(T)/T\)</span></p>
<p>simple: <span class="math inline">\(y(T)=(1/D(T)-1)/T\)</span></p>
<p>but first we have to have <span class="math inline">\(D(t)\)</span></p>
<div id="e4aa8609" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> par_from_d(df_func, T_list, f<span class="op">=</span><span class="dv">2</span>):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    T_arr <span class="op">=</span> np.asarray(T_list, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> np.full_like(T_arr, np.nan, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    step <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> <span class="bu">float</span>(f)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k, Tk <span class="kw">in</span> <span class="bu">enumerate</span>(T_arr):</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> np.isfinite(Tk) <span class="kw">or</span> Tk <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>        D_T <span class="op">=</span> <span class="bu">float</span>(np.asarray(df_func([Tk],), dtype<span class="op">=</span><span class="bu">float</span>)[<span class="dv">0</span>])</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        D_T <span class="op">=</span> <span class="bu">max</span>(D_T, min_d)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> Tk <span class="op">&lt;</span> <span class="fl">1.0</span>:</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> short_end_convention <span class="op">==</span> <span class="st">"simple"</span>:</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>                out[k] <span class="op">=</span> (<span class="fl">1.0</span> <span class="op">/</span> D_T <span class="op">-</span> <span class="fl">1.0</span>) <span class="op">/</span> Tk</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>                out[k] <span class="op">=</span> <span class="op">-</span>np.log(D_T) <span class="op">/</span> Tk</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>        n_full <span class="op">=</span> <span class="bu">int</span>(np.floor(Tk <span class="op">*</span> f <span class="op">+</span> <span class="fl">1e-12</span>))</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        times <span class="op">=</span> np.arange(step, n_full <span class="op">*</span> step <span class="op">+</span> <span class="fl">1e-12</span>, step)</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(times) <span class="op">==</span> <span class="dv">0</span> <span class="kw">or</span> <span class="bu">abs</span>(times[<span class="op">-</span><span class="dv">1</span>] <span class="op">-</span> Tk) <span class="op">&gt;</span> <span class="fl">1e-10</span>:</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>            times <span class="op">=</span> np.append(times, Tk)</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>        accr <span class="op">=</span> np.diff(np.concatenate([[<span class="fl">0.0</span>], times]))</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>        dfs <span class="op">=</span> np.asarray(df_func(times), dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>        dfs <span class="op">=</span> np.clip(dfs, min_d, <span class="va">None</span>)</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        denom <span class="op">=</span> <span class="bu">float</span>(np.<span class="bu">sum</span>(accr <span class="op">*</span> dfs))</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>        out[k] <span class="op">=</span> (<span class="fl">1.0</span> <span class="op">-</span> dfs[<span class="op">-</span><span class="dv">1</span>]) <span class="op">/</span> denom <span class="cf">if</span> denom <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> out</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="discount-factor-and-forward-from-nss" class="level3">
<h3 class="anchored" data-anchor-id="discount-factor-and-forward-from-nss">8.2 Discount factor and forward from NSS</h3>
<p>Once we have <span class="math inline">\(z(t)\)</span>, using continuous compounding:</p>
<p><span class="math inline">\(D(t)=e^{-z(t)t}\)</span></p>
<p>and the instantaneous forward rate is:</p>
<p><span class="math inline">\(f(t)=-\frac{d}{dt}\ln D(t)\)</span></p>
<p>With NSS you often compute <span class="math inline">\(f(t)\)</span> numerically on a grid: <span class="math display">\[f(t_i)\approx -\frac{\ln D(t_{i+1})-\ln D(t_{i-1})}{t_{i+1}-t_{i-1}}
\]</span></p>
<hr>
</section>
<section id="calibrating-nss-to-market-par-yields" class="level3">
<h3 class="anchored" data-anchor-id="calibrating-nss-to-market-par-yields">8.4 Calibrating NSS to market par yields</h3>
<p>Given observed par yields <span class="math inline">\(y^{mkt}(T_j)\)</span> at tenors <span class="math inline">\(T_j\)</span>, we choose parameters <span class="math inline">\(\theta=(\beta_0,\beta_1,\beta_2,\beta_3,\tau_1,\tau_2)\)</span> to minimize a least-squares objective:</p>
<p><span class="math display">\[\min_{\theta}\sum_{j}\left(c^{model}(T_j;\theta)-y^{mkt}(T_j)\right)^2
\]</span></p>
<p>Optionally add regularization to discourage extreme shapes: <span class="math inline">\(\lambda\sum_j (z''(t_j))^2\)</span> or bounds on parameters.</p>
<div id="edfbf229" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.optimize <span class="im">import</span> minimize</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> nss_curve(T, par):</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> obj(theta):</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        b0, b1, b2, b3, tau1, tau2 <span class="op">=</span> theta</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        z <span class="op">=</span> nss_zero(T, b0, b1, b2, b3, tau1, tau2)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        dfs <span class="op">=</span> np.exp(<span class="op">-</span>z <span class="op">*</span> T)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># we use log-linear DF interpolation on pillars for keeping it positive</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        log_dfs <span class="op">=</span> np.log(np.clip(dfs, min_d, <span class="va">None</span>))</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> df_func(t):</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>            t <span class="op">=</span> np.array(t, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>            log_df <span class="op">=</span> np.interp(t, T, log_dfs, left<span class="op">=</span>log_dfs[<span class="dv">0</span>], right<span class="op">=</span>log_dfs[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.exp(log_df)</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>        par_model <span class="op">=</span> par_from_d(df_func, T)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>        err <span class="op">=</span> par_model <span class="op">-</span> par</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">float</span>(np.mean(err<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># initializing with a first guess. for long run level we need something like the long-run yield level. that's why we use long term yields as guess</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    b0_0 <span class="op">=</span> <span class="bu">float</span>(np.nanmedian(par[<span class="op">-</span><span class="dv">3</span>:])) <span class="cf">if</span> <span class="bu">len</span>(par) <span class="op">&gt;=</span> <span class="dv">3</span> <span class="cf">else</span> <span class="bu">float</span>(np.nanmedian(par))</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    x0 <span class="op">=</span> np.array([b0_0, <span class="op">-</span><span class="fl">0.02</span>, <span class="fl">0.02</span>, <span class="fl">0.01</span>, <span class="fl">1.5</span>, <span class="fl">5.0</span>], dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we use a type of quasi-Newton method for nonlinear optimization of parameters</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    pred <span class="op">=</span> minimize(obj, x0, method<span class="op">=</span><span class="st">"L-BFGS-B"</span>)</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    theta <span class="op">=</span> pred.x</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    nss_grid <span class="op">=</span> np.linspace(<span class="bu">max</span>(<span class="dv">1</span> <span class="op">/</span> <span class="dv">12</span>, T.<span class="bu">min</span>()), <span class="fl">30.0</span>, <span class="dv">1000</span>)</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    nss_z_grid <span class="op">=</span> nss_zero(nss_grid, <span class="op">*</span>theta)</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    nss_df_grid <span class="op">=</span> np.exp(<span class="op">-</span>nss_z_grid <span class="op">*</span> nss_grid)</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    nss_fwd_grid <span class="op">=</span> <span class="op">-</span>np.gradient(</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>        np.log(np.clip(nss_df_grid, min_d, <span class="va">None</span>)), nss_grid</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> nss_df_func(t):</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>        t <span class="op">=</span> np.array(t, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.exp(<span class="op">-</span>nss_zero(t, <span class="op">*</span>theta) <span class="op">*</span> t)</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>    curve <span class="op">=</span> {</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">"name"</span>: <span class="st">"NSS"</span>,</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">"grid"</span>: nss_grid,</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>        <span class="st">"df_grid"</span>: nss_df_grid,</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>        <span class="st">"z_grid"</span>: nss_z_grid,</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">"fwd_grid"</span>: nss_fwd_grid,</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">"df_func"</span>: nss_df_func,</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">"theta"</span>: theta,</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>    z_p <span class="op">=</span> nss_zero(T, <span class="op">*</span>theta)</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>    d_p <span class="op">=</span> np.exp(<span class="op">-</span>z_p <span class="op">*</span> T)</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>    log_d_p <span class="op">=</span> np.log(np.clip(d_p, min_d, <span class="va">None</span>))</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> df_func_p(tt):</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.exp(</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>            np.interp(np.array(tt, <span class="bu">float</span>), T, log_d_p, left<span class="op">=</span>log_d_p[<span class="dv">0</span>], right<span class="op">=</span>log_d_p[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>    par_fit <span class="op">=</span> par_from_d(df_func_p, T)</span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> curve, par_fit, pred</span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>nss_curve_data, par_fit, pred <span class="op">=</span> nss_curve(T, par)</span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>theta <span class="op">=</span> nss_curve_data[<span class="st">"theta"</span>]</span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"curves"</span> <span class="kw">not</span> <span class="kw">in</span> <span class="bu">globals</span>():</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>    curves <span class="op">=</span> {}</span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>curves[<span class="st">"nss"</span>] <span class="op">=</span> nss_curve_data</span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"final MSE:"</span>, pred.fun)</span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"theta = [b0,b1,b2,b3,tau1,tau2] ="</span>, np.<span class="bu">round</span>(theta, <span class="dv">6</span>))</span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a>plt.plot(T, par <span class="op">*</span> <span class="fl">100.0</span>, <span class="st">"o"</span>, label<span class="op">=</span><span class="st">"Market par"</span>)</span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a>plt.plot(T, par_fit <span class="op">*</span> <span class="fl">100.0</span>, <span class="st">"-o"</span>, label<span class="op">=</span><span class="st">"NSS implied par"</span>)</span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"NSS Fit to Par Yields"</span>)</span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Maturity"</span>)</span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Par Yield"</span>)</span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a>plt.plot(nss_curve_data[<span class="st">"grid"</span>], nss_curve_data[<span class="st">"z_grid"</span>] <span class="op">*</span> <span class="fl">100.0</span>)</span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"NSS Zero Curve"</span>)</span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Maturity"</span>)</span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Zero Rate"</span>)</span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a>plt.plot(nss_curve_data[<span class="st">"grid"</span>], nss_curve_data[<span class="st">"fwd_grid"</span>] <span class="op">*</span> <span class="fl">100.0</span>)</span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"NSS Forward"</span>)</span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Maturity"</span>)</span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Forward Rate"</span>)</span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>final MSE: 3.5093289069366877e-07
theta = [b0,b1,b2,b3,tau1,tau2] = [ 0.053115 -0.014698 -0.031572 -0.007968  1.500251  5.000021]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_yield_curve_bond_pricing_and_risk_files/figure-html/cell-10-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_yield_curve_bond_pricing_and_risk_files/figure-html/cell-10-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_yield_curve_bond_pricing_and_risk_files/figure-html/cell-10-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="qp-curve-smooth-discount-factors-under-exact-par-bond-fit" class="level2">
<h2 class="anchored" data-anchor-id="qp-curve-smooth-discount-factors-under-exact-par-bond-fit">9) QP curve: smooth discount factors under exact par-bond fit</h2>
<p>Another approach for building a yield curve that:</p>
<ul>
<li><p>matches par-bond pricing equations exactly (like bootstrapping) or near-exactly (like NSS),</p></li>
<li><p>is smooth,</p></li>
<li><p>will result in a positive and increasing DF curve.</p></li>
</ul>
<p>can come from a Quadratic Program (QP) if the variables are discount factors on a grid and constraints are linear.</p>
<section id="variables" class="level3">
<h3 class="anchored" data-anchor-id="variables">9.1 Variables</h3>
<p>We Pick a grid of cashflow times (like semiannual up to 30Y): <span class="math inline">\(t_1,t_2,\dots,t_M\)</span></p>
<p>we want to get to $ = (D(t_1),,D(t_M)) $</p>
</section>
<section id="constraints" class="level3">
<h3 class="anchored" data-anchor-id="constraints">9.2 constraints</h3>
<p>For a maturity <span class="math inline">\(T\)</span> (present on the grid), par yield <span class="math inline">\(c\)</span> and frequency <span class="math inline">\(f\)</span>:</p>
<p><span class="math inline">\(1=\sum_{i=1}^{n}\frac{c}{f}D(t_i)+D(T)\)</span></p>
<p>This is linear in <span class="math inline">\(D(\cdot)\)</span>, so it becomes one row of: <span class="math inline">\(A\mathbf{d}=\mathbf{1}\)</span></p>
<p>Positivity: <span class="math inline">\(D(t_k)\ge D_{min}\)</span></p>
<p>Monotone decreasing: <span class="math inline">\(D(t_{k+1})\le D(t_k)\)</span></p>
<p>These are linear inequalities, so the problem stays convex and QP-solvable.</p>
<div id="e7a07a0f" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cvxpy <span class="im">as</span> cp</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> qp_build_t_grid(T_obs, f):</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    T_max <span class="op">=</span> <span class="bu">float</span>(np.<span class="bu">max</span>(T_obs))</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    n_grid <span class="op">=</span> <span class="bu">int</span>(<span class="bu">round</span>(T_max <span class="op">*</span> f))</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    t_grid <span class="op">=</span> np.unique(</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>        np.concatenate(</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>            [</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>                np.array([i <span class="op">/</span> f <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n_grid <span class="op">+</span> <span class="dv">1</span>)], dtype<span class="op">=</span><span class="bu">float</span>),</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>                T_obs,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    t_grid <span class="op">=</span> np.array(<span class="bu">sorted</span>(t_grid), dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    grid_index <span class="op">=</span> {<span class="bu">float</span>(np.<span class="bu">round</span>(t, <span class="dv">10</span>)): i <span class="cf">for</span> i, t <span class="kw">in</span> <span class="bu">enumerate</span>(t_grid)}</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> t_grid, grid_index</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> qp_build_constraints(t_grid, grid_index, T_obs, par_mkt, f, min_d):</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span> cp.Variable(<span class="bu">len</span>(t_grid))</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    constraints <span class="op">=</span> []</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    constraints <span class="op">+=</span> [d <span class="op">&gt;=</span> min_d]</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    constraints <span class="op">+=</span> [d[<span class="dv">1</span>:] <span class="op">&lt;=</span> d[:<span class="op">-</span><span class="dv">1</span>]]</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> Tk, yk <span class="kw">in</span> <span class="bu">zip</span>(T_obs, par_mkt, strict<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> Tk <span class="op">&lt;</span> <span class="fl">1.0</span>:</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>            key <span class="op">=</span> <span class="bu">float</span>(np.<span class="bu">round</span>(Tk, <span class="dv">10</span>))</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> key <span class="kw">in</span> grid_index:</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>                i <span class="op">=</span> grid_index[key]</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>                df_target <span class="op">=</span> <span class="bu">float</span>(np.exp(<span class="op">-</span>yk <span class="op">*</span> Tk))</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>                constraints <span class="op">+=</span> [d[i] <span class="op">==</span> df_target]</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> Tk, ck <span class="kw">in</span> <span class="bu">zip</span>(T_obs, par_mkt, strict<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> Tk <span class="op">&lt;</span> <span class="fl">1.0</span>:</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>        keyT <span class="op">=</span> <span class="bu">float</span>(np.<span class="bu">round</span>(Tk, <span class="dv">10</span>))</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> keyT <span class="kw">not</span> <span class="kw">in</span> grid_index:</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>        iT <span class="op">=</span> grid_index[keyT]</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>        n <span class="op">=</span> <span class="bu">int</span>(<span class="bu">round</span>(Tk <span class="op">*</span> f))</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>        coupon_idx <span class="op">=</span> []</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>            key <span class="op">=</span> <span class="bu">float</span>(np.<span class="bu">round</span>(j <span class="op">/</span> f, <span class="dv">10</span>))</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>            coupon_idx.append(grid_index[key])</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>        constraints <span class="op">+=</span> [cp.<span class="bu">sum</span>((ck <span class="op">/</span> f) <span class="op">*</span> d[coupon_idx]) <span class="op">+</span> d[iT] <span class="op">==</span> <span class="fl">1.0</span>]</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> d, constraints</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="smoothness-objective-quadratic" class="level3">
<h3 class="anchored" data-anchor-id="smoothness-objective-quadratic">9.3 Smoothness objective (quadratic)</h3>
<p>A simple convex smoothness penalty is the squared second difference of Discount Factors:</p>
<p><span class="math inline">\(\min_{\mathbf{d}} \ |\Delta^2\mathbf{d}|_2^2\)</span></p>
<p>where <span class="math inline">\(\Delta^2 d_k = d_{k+2}-2d_{k+1}+d_k\)</span>. (Discrete version)</p>
<p>This makes the optimizer prefer sequences of discount factors that have small curvature everywhere, which results a smooth DF curve with fewer oscillations and jumps.</p>
<p>we can also add a mild “keep close to a prior curve” penalty: <span class="math inline">\(\epsilon|\mathbf{d}-\mathbf{d}^{prior}|_2^2\)</span></p>
<p>Total objective: <span class="math inline">\(\min_{\mathbf{d}} \ \lambda|\Delta^2\mathbf{d}|_2^2 + \epsilon|\mathbf{d}-\mathbf{d}^{prior}|_2^2\)</span></p>
</section>
<section id="zero-and-forward-curves" class="level3">
<h3 class="anchored" data-anchor-id="zero-and-forward-curves">9.4 zero and forward curves</h3>
<p>Once we have <span class="math inline">\(D(t)\)</span> on a grid:</p>
<p><span class="math inline">\(z(t_k)=-\ln D(t_k)/t_k\)</span></p>
<p><span class="math inline">\(f(t_k)\approx -\dfrac{\ln D(t_{k+1})-\ln D(t_k)}{t_{k+1}-t_k}\)</span></p>
<div id="102a4fab" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> qp_solve(t_grid, d, constraints, par_mkt, f, min_d):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    lam <span class="op">=</span> <span class="fl">1e4</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    eps <span class="op">=</span> <span class="fl">1e-4</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    prior_rate <span class="op">=</span> (</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">float</span>(np.nanmedian(par_mkt[<span class="op">-</span><span class="dv">3</span>:])) <span class="cf">if</span> <span class="bu">len</span>(par_mkt) <span class="op">&gt;=</span> <span class="dv">3</span> <span class="cf">else</span> <span class="bu">float</span>(np.nanmedian(par_mkt))</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    d_prior <span class="op">=</span> np.exp(<span class="op">-</span>prior_rate <span class="op">*</span> t_grid)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    d2 <span class="op">=</span> d[<span class="dv">2</span>:] <span class="op">-</span> <span class="dv">2</span> <span class="op">*</span> d[<span class="dv">1</span>:<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span> d[:<span class="op">-</span><span class="dv">2</span>]</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    obj <span class="op">=</span> cp.Minimize(lam <span class="op">*</span> cp.sum_squares(d2) <span class="op">+</span> eps <span class="op">*</span> cp.sum_squares(d <span class="op">-</span> d_prior))</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    prog <span class="op">=</span> cp.Problem(obj, constraints)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    prog.solve(solver<span class="op">=</span>cp.OSQP)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    d_sol <span class="op">=</span> np.array(d.value).astype(<span class="bu">float</span>)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    d_sol <span class="op">=</span> np.clip(d_sol, min_d, <span class="va">None</span>)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> d_sol, prog.status, prog.value</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> qp_build_curve(t_grid, d_sol):</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    qp_grid <span class="op">=</span> np.linspace(<span class="bu">max</span>(<span class="dv">1</span> <span class="op">/</span> <span class="dv">12</span>, t_grid.<span class="bu">min</span>()), <span class="fl">30.0</span>, <span class="dv">1000</span>)</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    qp_log_d <span class="op">=</span> np.log(d_sol)</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    qp_log_df_grid <span class="op">=</span> np.interp(qp_grid, t_grid, qp_log_d, left<span class="op">=</span>qp_log_d[<span class="dv">0</span>], right<span class="op">=</span>qp_log_d[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    qp_df_grid <span class="op">=</span> np.exp(qp_log_df_grid)</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    qp_z_grid <span class="op">=</span> <span class="op">-</span>np.log(qp_df_grid) <span class="op">/</span> np.maximum(qp_grid, <span class="fl">1e-8</span>)</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    qp_fwd_grid <span class="op">=</span> <span class="op">-</span>np.gradient(np.log(qp_df_grid), qp_grid)</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> qp_df_func(t):</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>        t <span class="op">=</span> np.array(t, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>        log_df <span class="op">=</span> np.interp(t, t_grid, qp_log_d, left<span class="op">=</span>qp_log_d[<span class="dv">0</span>], right<span class="op">=</span>qp_log_d[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.exp(log_df)</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>    curve <span class="op">=</span> {</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">"name"</span>: <span class="st">"QP DF"</span>,</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">"grid"</span>: qp_grid,</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">"df_grid"</span>: qp_df_grid,</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">"z_grid"</span>: qp_z_grid,</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">"fwd_grid"</span>: qp_fwd_grid,</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">"df_func"</span>: qp_df_func,</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> curve</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> qp_curve(labels, par_mkt, f<span class="op">=</span><span class="dv">2</span>, min_d<span class="op">=</span><span class="fl">1e-10</span>):</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>    T_obs <span class="op">=</span> []</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> lab <span class="kw">in</span> labels:</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>        labu <span class="op">=</span> lab.upper().strip()</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>        T_obs.append(<span class="bu">int</span>(labu[:<span class="op">-</span><span class="dv">1</span>]) <span class="op">/</span> <span class="fl">12.0</span> <span class="cf">if</span> labu.endswith(<span class="st">"M"</span>) <span class="cf">else</span> <span class="bu">float</span>(<span class="bu">int</span>(labu[:<span class="op">-</span><span class="dv">1</span>])))</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>    T_obs <span class="op">=</span> np.array(T_obs, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> np.argsort(T_obs)</span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>    T_obs <span class="op">=</span> T_obs[idx]</span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>    par_mkt <span class="op">=</span> par_mkt[idx]</span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>    labels <span class="op">=</span> [labels[i] <span class="cf">for</span> i <span class="kw">in</span> idx]</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>    t_grid, grid_index <span class="op">=</span> qp_build_t_grid(T_obs, f)</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>    d, constraints <span class="op">=</span> qp_build_constraints(t_grid, grid_index, T_obs, par_mkt, f, min_d)</span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>    d_sol, status, value <span class="op">=</span> qp_solve(t_grid, d, constraints, par_mkt, f, min_d)</span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>    curve <span class="op">=</span> qp_build_curve(t_grid, d_sol)</span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>    state <span class="op">=</span> {</span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t_grid"</span>: t_grid,</span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>        <span class="st">"d_sol"</span>: d_sol,</span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>        <span class="st">"constraints"</span>: constraints,</span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a>        <span class="st">"status"</span>: status,</span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a>        <span class="st">"value"</span>: value,</span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> curve, state</span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-76"><a href="#cb15-76" aria-hidden="true" tabindex="-1"></a>qp_curve_data, qp_state <span class="op">=</span> qp_curve(labels, par)</span>
<span id="cb15-77"><a href="#cb15-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-78"><a href="#cb15-78" aria-hidden="true" tabindex="-1"></a>curves[<span class="st">"qp"</span>] <span class="op">=</span> qp_curve_data</span>
<span id="cb15-79"><a href="#cb15-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-80"><a href="#cb15-80" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"status:"</span>, qp_state[<span class="st">"status"</span>], <span class="st">",  value:"</span>, qp_state[<span class="st">"value"</span>])</span>
<span id="cb15-81"><a href="#cb15-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-82"><a href="#cb15-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-83"><a href="#cb15-83" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb15-84"><a href="#cb15-84" aria-hidden="true" tabindex="-1"></a>plt.plot(qp_state[<span class="st">"t_grid"</span>], qp_state[<span class="st">"d_sol"</span>], <span class="st">"o"</span>, markersize<span class="op">=</span><span class="dv">3</span>, label<span class="op">=</span><span class="st">"QP DF"</span>)</span>
<span id="cb15-85"><a href="#cb15-85" aria-hidden="true" tabindex="-1"></a>plt.plot(qp_curve_data[<span class="st">"grid"</span>], qp_curve_data[<span class="st">"df_grid"</span>], <span class="st">"-"</span>, label<span class="op">=</span><span class="st">"Discount Factor (log-linear)"</span>)</span>
<span id="cb15-86"><a href="#cb15-86" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"QP Discount Factors"</span>)</span>
<span id="cb15-87"><a href="#cb15-87" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Maturity"</span>)</span>
<span id="cb15-88"><a href="#cb15-88" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Discount Factor"</span>)</span>
<span id="cb15-89"><a href="#cb15-89" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb15-90"><a href="#cb15-90" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb15-91"><a href="#cb15-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-92"><a href="#cb15-92" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb15-93"><a href="#cb15-93" aria-hidden="true" tabindex="-1"></a>plt.plot(qp_curve_data[<span class="st">"grid"</span>], qp_curve_data[<span class="st">"z_grid"</span>] <span class="op">*</span> <span class="fl">100.0</span>)</span>
<span id="cb15-94"><a href="#cb15-94" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"QP Zero Curve"</span>)</span>
<span id="cb15-95"><a href="#cb15-95" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Maturity"</span>)</span>
<span id="cb15-96"><a href="#cb15-96" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Zero Rate"</span>)</span>
<span id="cb15-97"><a href="#cb15-97" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb15-98"><a href="#cb15-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-99"><a href="#cb15-99" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb15-100"><a href="#cb15-100" aria-hidden="true" tabindex="-1"></a>plt.plot(qp_curve_data[<span class="st">"grid"</span>], qp_curve_data[<span class="st">"fwd_grid"</span>] <span class="op">*</span> <span class="fl">100.0</span>)</span>
<span id="cb15-101"><a href="#cb15-101" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"QP Instantaneous Forward"</span>)</span>
<span id="cb15-102"><a href="#cb15-102" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Maturity"</span>)</span>
<span id="cb15-103"><a href="#cb15-103" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Forward Rate"</span>)</span>
<span id="cb15-104"><a href="#cb15-104" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>status: optimal ,  value: 1.2368745747617473</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_yield_curve_bond_pricing_and_risk_files/figure-html/cell-12-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_yield_curve_bond_pricing_and_risk_files/figure-html/cell-12-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_yield_curve_bond_pricing_and_risk_files/figure-html/cell-12-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="curve-fit-comparison-and-rmse-to-observed-par-yields" class="level1">
<h1>10. Curve fit comparison and RMSE to observed par yields</h1>
<p>We compute curve-implied par yields <span class="math inline">\(\hat y(T_j)\)</span> and compare to market <span class="math inline">\(y(T_j)\)</span>: <span class="math inline">\(RMSE=\sqrt{\dfrac{1}{m}\sum_{j=1}^m (\hat y(T_j)-y(T_j))^2}\)</span></p>
<p>for showing the performance, we use some of the tenors as in sample data for our models and some of them as out of sample to see the accuracy of predicting them.</p>
<div id="ed42bb6d" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_curves_for_date(date):</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    pillars_full <span class="op">=</span> bootstrap_pillars(date)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pillars_full <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    T_full <span class="op">=</span> pillars_full[<span class="st">"T"</span>]</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    par_full <span class="op">=</span> pillars_full[<span class="st">"par"</span>]</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    labels_full <span class="op">=</span> pillars_full[<span class="st">"labels"</span>]</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    holdouts <span class="op">=</span> [<span class="st">"6M"</span>, <span class="st">"2Y"</span>, <span class="st">"7Y"</span>, <span class="st">"20Y"</span>]</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    holdout_idx <span class="op">=</span> [labels_full.index(h) <span class="cf">for</span> h <span class="kw">in</span> holdouts <span class="cf">if</span> h <span class="kw">in</span> labels_full]</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    holdout_idx <span class="op">=</span> <span class="bu">sorted</span>(<span class="bu">set</span>([i <span class="cf">for</span> i <span class="kw">in</span> holdout_idx <span class="cf">if</span> <span class="dv">0</span> <span class="op">&lt;</span> i <span class="op">&lt;</span> <span class="bu">len</span>(labels_full) <span class="op">-</span> <span class="dv">1</span>]))</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    min_train <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(T_full) <span class="op">-</span> <span class="bu">len</span>(holdout_idx) <span class="op">&lt;</span> min_train:</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>        holdout_idx <span class="op">=</span> []</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(holdout_idx) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>        mask_train <span class="op">=</span> np.ones(<span class="bu">len</span>(T_full), dtype<span class="op">=</span><span class="bu">bool</span>)</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>        mask_train[holdout_idx] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>        T_tr <span class="op">=</span> T_full[mask_train]</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>        par_tr <span class="op">=</span> par_full[mask_train]</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>        labels_tr <span class="op">=</span> [labels_full[i] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(labels_full)) <span class="cf">if</span> mask_train[i]]</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>        pillars <span class="op">=</span> bootstrap_from_inputs(T_tr, par_tr, labels_tr, date<span class="op">=</span>date)</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>        T_te <span class="op">=</span> T_full[<span class="op">~</span>mask_train]</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>        par_te <span class="op">=</span> par_full[<span class="op">~</span>mask_train]</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>        labels_te <span class="op">=</span> [labels_full[i] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(labels_full)) <span class="cf">if</span> <span class="kw">not</span> mask_train[i]]</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>        pillars <span class="op">=</span> pillars_full</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>        T_te <span class="op">=</span> np.array([], dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>        par_te <span class="op">=</span> np.array([], dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>        labels_te <span class="op">=</span> []</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>    pillars[<span class="st">"T_test"</span>] <span class="op">=</span> T_te</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>    pillars[<span class="st">"par_test"</span>] <span class="op">=</span> par_te</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>    pillars[<span class="st">"labels_test"</span>] <span class="op">=</span> labels_te</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>    T_d <span class="op">=</span> pillars[<span class="st">"T"</span>]</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>    par_d <span class="op">=</span> pillars[<span class="st">"par"</span>]</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>    labels_d <span class="op">=</span> pillars[<span class="st">"labels"</span>]</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>    dfs_d <span class="op">=</span> pillars[<span class="st">"dfs"</span>]</span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>    curves_d <span class="op">=</span> {}</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>    errors <span class="op">=</span> []</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>        curves_d[<span class="st">"loglinear"</span>] <span class="op">=</span> loglinear_curve(T_d, dfs_d)</span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>        errors.append({<span class="st">"date"</span>: date, <span class="st">"method"</span>: <span class="st">"loglinear"</span>, <span class="st">"error"</span>: <span class="bu">str</span>(e)})</span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>        curves_d[<span class="st">"pchip"</span>] <span class="op">=</span> pchip_curve(T_d, dfs_d)</span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>        errors.append({<span class="st">"date"</span>: date, <span class="st">"method"</span>: <span class="st">"pchip"</span>, <span class="st">"error"</span>: <span class="bu">str</span>(e)})</span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>        curves_d[<span class="st">"nss"</span>] <span class="op">=</span> nss_curve(T_d, par_d)[<span class="dv">0</span>]</span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>        errors.append({<span class="st">"date"</span>: date, <span class="st">"method"</span>: <span class="st">"nss"</span>, <span class="st">"error"</span>: <span class="bu">str</span>(e)})</span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a>        curves_d[<span class="st">"qp"</span>] <span class="op">=</span> qp_curve(labels_d, par_d)[<span class="dv">0</span>]</span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a>        errors.append({<span class="st">"date"</span>: date, <span class="st">"method"</span>: <span class="st">"qp"</span>, <span class="st">"error"</span>: <span class="bu">str</span>(e)})</span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pillars, curves_d, errors</span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a>curve_order <span class="op">=</span> [<span class="st">"loglinear"</span>, <span class="st">"pchip"</span>, <span class="st">"nss"</span>, <span class="st">"qp"</span>]</span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a>rmse_sse <span class="op">=</span> {k: <span class="fl">0.0</span> <span class="cf">for</span> k <span class="kw">in</span> curve_order}</span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a>rmse_count <span class="op">=</span> {k: <span class="dv">0</span> <span class="cf">for</span> k <span class="kw">in</span> curve_order}</span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a>rmse_dates <span class="op">=</span> {k: <span class="dv">0</span> <span class="cf">for</span> k <span class="kw">in</span> curve_order}</span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a>rmse_sse_oos <span class="op">=</span> {k: <span class="fl">0.0</span> <span class="cf">for</span> k <span class="kw">in</span> curve_order}</span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a>rmse_count_oos <span class="op">=</span> {k: <span class="dv">0</span> <span class="cf">for</span> k <span class="kw">in</span> curve_order}</span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a>rmse_dates_oos <span class="op">=</span> {k: <span class="dv">0</span> <span class="cf">for</span> k <span class="kw">in</span> curve_order}</span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-85"><a href="#cb17-85" aria-hidden="true" tabindex="-1"></a>failed <span class="op">=</span> []</span>
<span id="cb17-86"><a href="#cb17-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-87"><a href="#cb17-87" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> date <span class="kw">in</span> df_dec.index[<span class="op">-</span><span class="dv">100</span>:]:</span>
<span id="cb17-88"><a href="#cb17-88" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> build_curves_for_date(date)</span>
<span id="cb17-89"><a href="#cb17-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> out <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb17-90"><a href="#cb17-90" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb17-91"><a href="#cb17-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-92"><a href="#cb17-92" aria-hidden="true" tabindex="-1"></a>    pillars_d, curves_d, errors <span class="op">=</span> out</span>
<span id="cb17-93"><a href="#cb17-93" aria-hidden="true" tabindex="-1"></a>    failed.extend(errors)</span>
<span id="cb17-94"><a href="#cb17-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-95"><a href="#cb17-95" aria-hidden="true" tabindex="-1"></a>    T_tr <span class="op">=</span> pillars_d[<span class="st">"T"</span>]</span>
<span id="cb17-96"><a href="#cb17-96" aria-hidden="true" tabindex="-1"></a>    par_tr <span class="op">=</span> pillars_d[<span class="st">"par"</span>]</span>
<span id="cb17-97"><a href="#cb17-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-98"><a href="#cb17-98" aria-hidden="true" tabindex="-1"></a>    T_te <span class="op">=</span> pillars_d[<span class="st">"T_test"</span>]</span>
<span id="cb17-99"><a href="#cb17-99" aria-hidden="true" tabindex="-1"></a>    par_te <span class="op">=</span> pillars_d[<span class="st">"par_test"</span>]</span>
<span id="cb17-100"><a href="#cb17-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-101"><a href="#cb17-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k <span class="kw">in</span> curve_order:</span>
<span id="cb17-102"><a href="#cb17-102" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> k <span class="kw">not</span> <span class="kw">in</span> curves_d:</span>
<span id="cb17-103"><a href="#cb17-103" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb17-104"><a href="#cb17-104" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb17-105"><a href="#cb17-105" aria-hidden="true" tabindex="-1"></a>            c <span class="op">=</span> curves_d[k]</span>
<span id="cb17-106"><a href="#cb17-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-107"><a href="#cb17-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-108"><a href="#cb17-108" aria-hidden="true" tabindex="-1"></a>            par_fit_tr <span class="op">=</span> par_from_d(c[<span class="st">"df_func"</span>], T_tr)</span>
<span id="cb17-109"><a href="#cb17-109" aria-hidden="true" tabindex="-1"></a>            err_tr <span class="op">=</span> par_fit_tr <span class="op">-</span> par_tr</span>
<span id="cb17-110"><a href="#cb17-110" aria-hidden="true" tabindex="-1"></a>            rmse_sse[k] <span class="op">+=</span> <span class="bu">float</span>(np.<span class="bu">sum</span>(err_tr<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb17-111"><a href="#cb17-111" aria-hidden="true" tabindex="-1"></a>            rmse_count[k] <span class="op">+=</span> <span class="bu">int</span>(<span class="bu">len</span>(err_tr))</span>
<span id="cb17-112"><a href="#cb17-112" aria-hidden="true" tabindex="-1"></a>            rmse_dates[k] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb17-113"><a href="#cb17-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-114"><a href="#cb17-114" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(T_te) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb17-115"><a href="#cb17-115" aria-hidden="true" tabindex="-1"></a>                par_fit_te <span class="op">=</span> par_from_d(c[<span class="st">"df_func"</span>], T_te)</span>
<span id="cb17-116"><a href="#cb17-116" aria-hidden="true" tabindex="-1"></a>                err_te <span class="op">=</span> par_fit_te <span class="op">-</span> par_te</span>
<span id="cb17-117"><a href="#cb17-117" aria-hidden="true" tabindex="-1"></a>                rmse_sse_oos[k] <span class="op">+=</span> <span class="bu">float</span>(np.<span class="bu">sum</span>(err_te<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb17-118"><a href="#cb17-118" aria-hidden="true" tabindex="-1"></a>                rmse_count_oos[k] <span class="op">+=</span> <span class="bu">int</span>(<span class="bu">len</span>(err_te))</span>
<span id="cb17-119"><a href="#cb17-119" aria-hidden="true" tabindex="-1"></a>                rmse_dates_oos[k] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb17-120"><a href="#cb17-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-121"><a href="#cb17-121" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb17-122"><a href="#cb17-122" aria-hidden="true" tabindex="-1"></a>            failed.append({<span class="st">"date"</span>: date, <span class="st">"method"</span>: k, <span class="st">"error"</span>: <span class="bu">str</span>(e)})</span>
<span id="cb17-123"><a href="#cb17-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-124"><a href="#cb17-124" aria-hidden="true" tabindex="-1"></a>rmse_rows <span class="op">=</span> []</span>
<span id="cb17-125"><a href="#cb17-125" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k <span class="kw">in</span> curve_order:</span>
<span id="cb17-126"><a href="#cb17-126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> rmse_count[k] <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb17-127"><a href="#cb17-127" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb17-128"><a href="#cb17-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-129"><a href="#cb17-129" aria-hidden="true" tabindex="-1"></a>    rmse_in <span class="op">=</span> math.sqrt(rmse_sse[k] <span class="op">/</span> rmse_count[k])</span>
<span id="cb17-130"><a href="#cb17-130" aria-hidden="true" tabindex="-1"></a>    rmse_out <span class="op">=</span> (</span>
<span id="cb17-131"><a href="#cb17-131" aria-hidden="true" tabindex="-1"></a>        math.sqrt(rmse_sse_oos[k] <span class="op">/</span> rmse_count_oos[k])</span>
<span id="cb17-132"><a href="#cb17-132" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> rmse_count_oos[k] <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb17-133"><a href="#cb17-133" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="bu">float</span>(<span class="st">"nan"</span>)</span>
<span id="cb17-134"><a href="#cb17-134" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-135"><a href="#cb17-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-136"><a href="#cb17-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-137"><a href="#cb17-137" aria-hidden="true" tabindex="-1"></a>    name_val <span class="op">=</span> curves[k][<span class="st">"name"</span>] <span class="cf">if</span> (<span class="st">"curves"</span> <span class="kw">in</span> <span class="bu">globals</span>() <span class="kw">and</span> k <span class="kw">in</span> curves) <span class="cf">else</span> k</span>
<span id="cb17-138"><a href="#cb17-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-139"><a href="#cb17-139" aria-hidden="true" tabindex="-1"></a>    rmse_rows.append({<span class="st">"method"</span>: k, <span class="st">"name"</span>: name_val, <span class="st">"rmse"</span>: rmse_in, <span class="st">"rmse_oos"</span>: rmse_out,</span>
<span id="cb17-140"><a href="#cb17-140" aria-hidden="true" tabindex="-1"></a>            <span class="st">"n_obs"</span>: rmse_count[k], <span class="st">"n_obs_oos"</span>: rmse_count_oos[k], <span class="st">"n_dates"</span>: rmse_dates[k], <span class="st">"n_dates_oos"</span>: rmse_dates_oos[k],})</span>
<span id="cb17-141"><a href="#cb17-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-142"><a href="#cb17-142" aria-hidden="true" tabindex="-1"></a>rmse_df <span class="op">=</span> pd.DataFrame(rmse_rows).set_index(<span class="st">"method"</span>)</span>
<span id="cb17-143"><a href="#cb17-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-144"><a href="#cb17-144" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(failed) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb17-145"><a href="#cb17-145" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Failed date-method pairs: </span><span class="sc">{</span><span class="bu">len</span>(failed)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-146"><a href="#cb17-146" aria-hidden="true" tabindex="-1"></a>    display(pd.DataFrame(failed).head())</span>
<span id="cb17-147"><a href="#cb17-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-148"><a href="#cb17-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-149"><a href="#cb17-149" aria-hidden="true" tabindex="-1"></a>plot_grid <span class="op">=</span> np.linspace(<span class="bu">max</span>(<span class="dv">1</span> <span class="op">/</span> <span class="dv">12</span>, T.<span class="bu">min</span>()), T.<span class="bu">max</span>(), <span class="dv">200</span>)</span>
<span id="cb17-150"><a href="#cb17-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-151"><a href="#cb17-151" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb17-152"><a href="#cb17-152" aria-hidden="true" tabindex="-1"></a>plt.plot(T, par <span class="op">*</span> <span class="fl">100.0</span>, <span class="st">"o"</span>, markersize<span class="op">=</span><span class="dv">5</span>, markeredgecolor<span class="op">=</span><span class="st">"black"</span>, markerfacecolor<span class="op">=</span><span class="st">"white"</span>, label<span class="op">=</span><span class="st">"Market par"</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb17-153"><a href="#cb17-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-154"><a href="#cb17-154" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k <span class="kw">in</span> curve_order:</span>
<span id="cb17-155"><a href="#cb17-155" aria-hidden="true" tabindex="-1"></a>    c <span class="op">=</span> curves[k]</span>
<span id="cb17-156"><a href="#cb17-156" aria-hidden="true" tabindex="-1"></a>    par_grid <span class="op">=</span> par_from_d(c[<span class="st">"df_func"</span>], plot_grid)</span>
<span id="cb17-157"><a href="#cb17-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-158"><a href="#cb17-158" aria-hidden="true" tabindex="-1"></a>    rmse_in <span class="op">=</span> rmse_df.loc[k, <span class="st">"rmse"</span>] <span class="cf">if</span> k <span class="kw">in</span> rmse_df.index <span class="cf">else</span> <span class="bu">float</span>(<span class="st">"nan"</span>)</span>
<span id="cb17-159"><a href="#cb17-159" aria-hidden="true" tabindex="-1"></a>    rmse_out <span class="op">=</span> rmse_df.loc[k, <span class="st">"rmse_oos"</span>] <span class="cf">if</span> k <span class="kw">in</span> rmse_df.index <span class="cf">else</span> <span class="bu">float</span>(<span class="st">"nan"</span>)</span>
<span id="cb17-160"><a href="#cb17-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-161"><a href="#cb17-161" aria-hidden="true" tabindex="-1"></a>    plt.plot(plot_grid, par_grid <span class="op">*</span> <span class="fl">100.0</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>c[<span class="st">'name'</span>]<span class="sc">}</span><span class="ss"> (IS </span><span class="sc">{</span>rmse_in<span class="sc">:.6f}</span><span class="ss">, OOS </span><span class="sc">{</span>rmse_out<span class="sc">:.6f}</span><span class="ss">)"</span>)</span>
<span id="cb17-162"><a href="#cb17-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-163"><a href="#cb17-163" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Par Yield Curves: Method Comparison (Last Date)"</span>)</span>
<span id="cb17-164"><a href="#cb17-164" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Maturity"</span>)</span>
<span id="cb17-165"><a href="#cb17-165" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Par Yield"</span>)</span>
<span id="cb17-166"><a href="#cb17-166" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb17-167"><a href="#cb17-167" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb17-168"><a href="#cb17-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-169"><a href="#cb17-169" aria-hidden="true" tabindex="-1"></a>rmse_df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_yield_curve_bond_pricing_and_risk_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display" data-execution_count="13">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">rmse</th>
<th data-quarto-table-cell-role="th">rmse_oos</th>
<th data-quarto-table-cell-role="th">n_obs</th>
<th data-quarto-table-cell-role="th">n_obs_oos</th>
<th data-quarto-table-cell-role="th">n_dates</th>
<th data-quarto-table-cell-role="th">n_dates_oos</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">method</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">loglinear</th>
<td>Log-linear DF</td>
<td>9.937239e-14</td>
<td>0.000649</td>
<td>900</td>
<td>400</td>
<td>100</td>
<td>100</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">pchip</th>
<td>PCHIP zero</td>
<td>7.233596e-05</td>
<td>0.000822</td>
<td>900</td>
<td>400</td>
<td>100</td>
<td>100</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">nss</th>
<td>NSS</td>
<td>2.895659e-04</td>
<td>0.000922</td>
<td>900</td>
<td>400</td>
<td>100</td>
<td>100</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">qp</th>
<td>QP DF</td>
<td>1.782548e-07</td>
<td>0.003682</td>
<td>900</td>
<td>400</td>
<td>100</td>
<td>100</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<section id="synthetic-bond-issuance-issued-at-par" class="level2">
<h2 class="anchored" data-anchor-id="synthetic-bond-issuance-issued-at-par">11) Synthetic Bond Issuance (Issued at Par)</h2>
<p>because we don’t have official data for this part, We simulate a monthly issuance program using par yields to create a rolling book of bonds so we can analyze our models and implement the next topics. Each month, we pretend the Treasury issues new par bonds at a few maturities (like 2Y, 5Y, 10Y, 30Y). The coupon of each new bond is set to that month’s par yield at that maturity (from the dataset). Because coupon = par yield at issuance, each new bond starts at price approximately equal to 1 (par).</p>
<section id="details-of-the-bond" class="level3">
<h3 class="anchored" data-anchor-id="details-of-the-bond">Details of the bond</h3>
<ul>
<li>for each month <span class="math inline">\(t_0\)</span> we create a new bond with maturity <span class="math inline">\(T\)</span> and frequency <span class="math inline">\(f\)</span></li>
<li><span class="math inline">\(f\)</span> = semiannual</li>
<li><span class="math inline">\(T = {2Y, 5Y, 10Y, 30Y}\)</span></li>
<li>coupon: <span class="math inline">\(c_d(T)=y_d(T)\)</span> (the market par yield at that date and maturity)</li>
<li>notional <span class="math inline">\(N=1\)</span></li>
</ul>
<p>Basically we buy bonds with 4 different maturities every month and keep it and get interest every month until maturity of those bonds. so we have 4 books for 4 different bonds (maturities). and our portfolio is based on these four books.</p>
<p>So each month the outgoing cashflow is buying the bonds and ingoing is all the interest and maybe principal of all the bonds that we have bought.</p>
<div id="e8091d22" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>issue_maturities <span class="op">=</span> [<span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">30</span>]</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>issue_labels <span class="op">=</span> {<span class="dv">2</span>: <span class="st">"2Y"</span>, <span class="dv">5</span>: <span class="st">"5Y"</span>, <span class="dv">10</span>: <span class="st">"10Y"</span>, <span class="dv">30</span>: <span class="st">"30Y"</span>}</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>month_end_curve <span class="op">=</span> df_dec[tenor_cols].resample(<span class="st">"ME"</span>).last()</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>issue_dates <span class="op">=</span> month_end_curve.index</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> yearfrac(t0, t1):</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (t1 <span class="op">-</span> t0).days <span class="op">/</span> <span class="dv">365</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> bond_cashflows(c, T, f<span class="op">=</span><span class="dv">2</span>):</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    times <span class="op">=</span> np.arange(<span class="dv">1</span> <span class="op">/</span> f, T <span class="op">+</span> <span class="fl">1e-9</span>, <span class="dv">1</span> <span class="op">/</span> f)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    cfs <span class="op">=</span> np.full_like(times, c <span class="op">/</span> f)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    cfs[<span class="op">-</span><span class="dv">1</span>] <span class="op">+=</span> <span class="fl">1.0</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> times, cfs</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> price_bond(df_func, times, cfs, delta):</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> times <span class="op">&gt;</span> delta <span class="op">+</span> <span class="fl">1e-12</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> np.<span class="bu">any</span>(mask):</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.0</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>    t_rem <span class="op">=</span> times[mask] <span class="op">-</span> delta</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    cf_rem <span class="op">=</span> cfs[mask]</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">float</span>(np.<span class="bu">sum</span>(cf_rem <span class="op">*</span> df_func(t_rem)))</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>issuance_book <span class="op">=</span> {T: [] <span class="cf">for</span> T <span class="kw">in</span> issue_maturities}</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> d <span class="kw">in</span> issue_dates:</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>    row <span class="op">=</span> month_end_curve.loc[d]</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> T <span class="kw">in</span> issue_maturities:</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>        label <span class="op">=</span> issue_labels[T]</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>        c <span class="op">=</span> <span class="bu">float</span>(row.get(label, np.nan))</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> np.isfinite(c):</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>        times, cfs <span class="op">=</span> bond_cashflows(c, T, f)</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>        issuance_book[T].append({</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>            <span class="st">"issue_date"</span>: d,</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>            <span class="st">"coupon"</span>: c,</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>            <span class="st">"times"</span>: times,</span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>            <span class="st">"cfs"</span>: cfs,</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>issuance_summary <span class="op">=</span> pd.DataFrame({</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_bonds"</span>: {T: <span class="bu">len</span>(issuance_book[T]) <span class="cf">for</span> T <span class="kw">in</span> issue_maturities},</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">"first_issue"</span>: {T: issuance_book[T][<span class="dv">0</span>][<span class="st">"issue_date"</span>] <span class="cf">if</span> <span class="bu">len</span>(issuance_book[T]) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> pd.NaT <span class="cf">for</span> T <span class="kw">in</span> issue_maturities},</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">"last_issue"</span>: {T: issuance_book[T][<span class="op">-</span><span class="dv">1</span>][<span class="st">"issue_date"</span>] <span class="cf">if</span> <span class="bu">len</span>(issuance_book[T]) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> pd.NaT <span class="cf">for</span> T <span class="kw">in</span> issue_maturities},</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Issuance summary:"</span>)</span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>display(issuance_summary)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Issuance summary:</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">n_bonds</th>
<th data-quarto-table-cell-role="th">first_issue</th>
<th data-quarto-table-cell-role="th">last_issue</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>433</td>
<td>1990-01-31</td>
<td>2026-01-31</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>433</td>
<td>1990-01-31</td>
<td>2026-01-31</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td>433</td>
<td>1990-01-31</td>
<td>2026-01-31</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">30</th>
<td>386</td>
<td>1990-01-31</td>
<td>2026-01-31</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="pricing-an-issued-bond-at-a-later-date" class="level2">
<h2 class="anchored" data-anchor-id="pricing-an-issued-bond-at-a-later-date">12) Pricing an Issued Bond at a Later Date</h2>
<p>If issue date be <span class="math inline">\(t_0\)</span> and valuation date be <span class="math inline">\(t\)</span>. Elapsed time is the amount of time that has been passed from the bond issued at <span class="math inline">\(t_0\)</span> in valuation time <span class="math inline">\(t\)</span>: <span class="math inline">\(\Delta=\tau(t_0,t)\)</span></p>
<p>reminder: <span class="math inline">\(\tau(t_0,t_1)=\dfrac{\text{days}(t_0,t_1)}{365}\)</span></p>
<p>Original scheduled payment times from issue are <span class="math inline">\(t_i=i/f\)</span>. we only price the bonds that <span class="math inline">\(t_i&gt;\Delta\)</span> because these are the cashflows that have accured up until time <span class="math inline">\(t\)</span> and the remaining time to payment from valuation date for each cashflow is: <span class="math inline">\(\tau_i(t)=t_i-\Delta\)</span></p>
<p>Price using the curve at valuation date <span class="math inline">\(t\)</span>: <span class="math inline">\(P_t=\sum_{i:t_i&gt;\Delta} CF_i\,D_t(\tau_i(t))\)</span></p>
<p>For a book of issues <span class="math inline">\(\mathcal{B}_t\)</span> with weights <span class="math inline">\(w_b\)</span> (we don’t have weights here): <span class="math inline">\(PV_t=\sum_{b\in \mathcal{B}_t} w_b\,P_t(b)\)</span></p>
<div id="92823cf8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> book_pv_cutoff(valuation_date, df_func, cutoff_date):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    total <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    buckets <span class="op">=</span> {}</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> T <span class="kw">in</span> issue_maturities:</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>        pv <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> bond <span class="kw">in</span> issuance_book[T]:</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> bond[<span class="st">"issue_date"</span>] <span class="op">&gt;</span> cutoff_date:</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>            delta <span class="op">=</span> yearfrac(bond[<span class="st">"issue_date"</span>], valuation_date)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> delta <span class="op">&gt;=</span> bond[<span class="st">"times"</span>][<span class="op">-</span><span class="dv">1</span>] <span class="op">-</span> <span class="fl">1e-12</span>:</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>            pv <span class="op">+=</span> price_bond(df_func, bond[<span class="st">"times"</span>], bond[<span class="st">"cfs"</span>], delta)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>        buckets[T] <span class="op">=</span> pv</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>        total <span class="op">+=</span> pv</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> total, buckets</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> shifted_df_func(df_func, shift_func):</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _f(t):</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>        t <span class="op">=</span> np.array(t, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> df_func(t) <span class="op">*</span> np.exp(<span class="op">-</span>shift_func(t) <span class="op">*</span> t)</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> _f</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> key_bump_func(key, bump_bp<span class="op">=</span><span class="fl">1.0</span>):</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>    values <span class="op">=</span> np.zeros(<span class="bu">len</span>(issue_maturities), dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>    key_idx <span class="op">=</span> issue_maturities.index(key)</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>    values[key_idx] <span class="op">=</span> bump_bp <span class="op">/</span> <span class="fl">10000.0</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> shift(t):</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>        t <span class="op">=</span> np.array(t, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.interp(t, issue_maturities, values, left<span class="op">=</span><span class="fl">0.0</span>, right<span class="op">=</span><span class="fl">0.0</span>)</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> shift</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> curve_date_for(d):</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> d <span class="kw">in</span> df_dec.index:</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> d</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> df_dec.index.searchsorted(d, side<span class="op">=</span><span class="st">"right"</span>) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> idx <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_dec.index[idx]</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> book_pv(date, df_func):</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>    total <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>    buckets <span class="op">=</span> {}</span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> T <span class="kw">in</span> issue_maturities:</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>        pv <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> bond <span class="kw">in</span> issuance_book[T]:</span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> bond[<span class="st">"issue_date"</span>] <span class="op">&gt;</span> date:</span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>            delta <span class="op">=</span> yearfrac(bond[<span class="st">"issue_date"</span>], date)</span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> delta <span class="op">&gt;=</span> bond[<span class="st">"times"</span>][<span class="op">-</span><span class="dv">1</span>] <span class="op">-</span> <span class="fl">1e-12</span>:</span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a>            pv <span class="op">+=</span> price_bond(df_func, bond[<span class="st">"times"</span>], bond[<span class="st">"cfs"</span>], delta)</span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>        buckets[T] <span class="op">=</span> pv</span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>        total <span class="op">+=</span> pv</span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> total, buckets</span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>curves_cache <span class="op">=</span> {}</span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_curves_for(date):</span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> date <span class="kw">in</span> curves_cache:</span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> curves_cache[date]</span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> build_curves_for_date(date)</span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> out <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb20-71"><a href="#cb20-71" aria-hidden="true" tabindex="-1"></a>        curves_cache[date] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb20-72"><a href="#cb20-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb20-73"><a href="#cb20-73" aria-hidden="true" tabindex="-1"></a>    _, curves_d, _ <span class="op">=</span> out</span>
<span id="cb20-74"><a href="#cb20-74" aria-hidden="true" tabindex="-1"></a>    curves_cache[date] <span class="op">=</span> curves_d</span>
<span id="cb20-75"><a href="#cb20-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> curves_d</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="4605ef85" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>metrics_rows <span class="op">=</span> []</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> date <span class="kw">in</span> issue_dates:</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    curve_date <span class="op">=</span> curve_date_for(date)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> curve_date <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    curves_d <span class="op">=</span> get_curves_for(curve_date)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> curves_d <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> method, curve <span class="kw">in</span> curves_d.items():</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>        df0 <span class="op">=</span> curve[<span class="st">"df_func"</span>]</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>        pv0, _ <span class="op">=</span> book_pv_cutoff(date, df0, cutoff_date<span class="op">=</span>date)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>        metrics_rows.append({<span class="st">"date"</span>: date, <span class="st">"method"</span>: method, <span class="st">"pv"</span>: pv0})</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>metrics_df <span class="op">=</span> pd.DataFrame(metrics_rows).set_index([<span class="st">"date"</span>, <span class="st">"method"</span>]).sort_index()</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="f934d23c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>methods <span class="op">=</span> [<span class="st">"loglinear"</span>, <span class="st">"pchip"</span>, <span class="st">"nss"</span>, <span class="st">"qp"</span>]</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>pv_total <span class="op">=</span> (</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    metrics_df.reset_index()</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    .pivot(index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span><span class="st">"method"</span>, values<span class="op">=</span><span class="st">"pv"</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    .sort_index()</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>pv_rows <span class="op">=</span> []</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>failed <span class="op">=</span> []</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> date <span class="kw">in</span> issue_dates:</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    curve_date <span class="op">=</span> curve_date_for(date)</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> curve_date <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    curves_d <span class="op">=</span> get_curves_for(curve_date)</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> curves_d <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> method, curve <span class="kw">in</span> curves_d.items():</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>        df_func <span class="op">=</span> curve[<span class="st">"df_func"</span>]</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>        _, buckets <span class="op">=</span> book_pv_cutoff(date, df_func, cutoff_date<span class="op">=</span>date)</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> T <span class="kw">in</span> issue_maturities:</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>            pv_rows.append({<span class="st">"date"</span>: date, <span class="st">"method"</span>: method, <span class="st">"maturity"</span>: T, <span class="st">"pv"</span>: buckets.get(T, <span class="fl">0.0</span>)})</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>pv_df <span class="op">=</span> pd.DataFrame(pv_rows)</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>pv_buckets <span class="op">=</span> pv_df.pivot_table(index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span>[<span class="st">"method"</span>, <span class="st">"maturity"</span>], values<span class="op">=</span><span class="st">"pv"</span>).sort_index()</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Total PV by method (last day):"</span>)</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>display(pv_total)</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Bucket PV (last date)"</span>)</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>last_date <span class="op">=</span> pv_df[<span class="st">"date"</span>].<span class="bu">max</span>()</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>last_bucket <span class="op">=</span> pv_df[pv_df[<span class="st">"date"</span>] <span class="op">==</span> last_date].pivot_table(index<span class="op">=</span><span class="st">"maturity"</span>, columns<span class="op">=</span><span class="st">"method"</span>, values<span class="op">=</span><span class="st">"pv"</span>)</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>display(last_bucket)</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> method <span class="kw">in</span> pv_total.columns:</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>    plt.plot(pv_total.index, pv_total[method], label<span class="op">=</span>method)</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Synthetic Book Total PV (Monthly)"</span>)</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>)</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"PV"</span>)</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>last_bucket.plot(kind<span class="op">=</span><span class="st">"bar"</span>, ax<span class="op">=</span>plt.gca())</span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f"Each bucket PV by Method (</span><span class="sc">{</span>last_date<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Maturity"</span>)</span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"PV"</span>)</span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Total PV by method (last day):</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">method</th>
<th data-quarto-table-cell-role="th">loglinear</th>
<th data-quarto-table-cell-role="th">nss</th>
<th data-quarto-table-cell-role="th">pchip</th>
<th data-quarto-table-cell-role="th">qp</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">1990-01-31</th>
<td>3.999816</td>
<td>3.999349</td>
<td>4.001830</td>
<td>4.004113</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1990-02-28</th>
<td>8.007579</td>
<td>8.006109</td>
<td>8.012242</td>
<td>8.016726</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">1990-03-31</th>
<td>12.003136</td>
<td>12.000914</td>
<td>12.004738</td>
<td>12.017158</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1990-04-30</th>
<td>15.838917</td>
<td>15.837035</td>
<td>15.838465</td>
<td>15.859415</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">1990-05-31</th>
<td>20.350563</td>
<td>20.347476</td>
<td>20.353669</td>
<td>20.375817</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>484.048043</td>
<td>485.413949</td>
<td>485.289343</td>
<td>486.914561</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-10-31</th>
<td>486.071558</td>
<td>486.930897</td>
<td>487.319872</td>
<td>488.950688</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-11-30</th>
<td>487.714383</td>
<td>489.811404</td>
<td>489.252157</td>
<td>491.052541</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-12-31</th>
<td>482.340428</td>
<td>484.351486</td>
<td>483.847004</td>
<td>485.803466</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2026-01-31</th>
<td>481.069937</td>
<td>482.642714</td>
<td>482.367938</td>
<td>484.081282</td>
</tr>
</tbody>
</table>

<p>433 rows × 4 columns</p>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Bucket PV (last date)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">method</th>
<th data-quarto-table-cell-role="th">loglinear</th>
<th data-quarto-table-cell-role="th">nss</th>
<th data-quarto-table-cell-role="th">pchip</th>
<th data-quarto-table-cell-role="th">qp</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">maturity</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>24.258462</td>
<td>24.266940</td>
<td>24.265987</td>
<td>24.267663</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>60.518216</td>
<td>60.565183</td>
<td>60.549000</td>
<td>60.551390</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td>115.921913</td>
<td>116.063170</td>
<td>116.097292</td>
<td>116.098827</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">30</th>
<td>280.371346</td>
<td>281.747421</td>
<td>281.455658</td>
<td>283.163402</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_yield_curve_bond_pricing_and_risk_files/figure-html/cell-17-output-5.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_yield_curve_bond_pricing_and_risk_files/figure-html/cell-17-output-6.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="risk-and-sensitivity-measures-of-bonds" class="level2">
<h2 class="anchored" data-anchor-id="risk-and-sensitivity-measures-of-bonds">15) Risk and sensitivity measures of bonds</h2>
<section id="pv01-dv01" class="level3">
<h3 class="anchored" data-anchor-id="pv01-dv01">15.1 PV01/ DV01</h3>
<p>for measuring the risk of these bonds, we can use the sensitivity of the <strong>price of bond</strong> to a little change in interest rates.</p>
<p>PV01 is the change in PV of the bond when the curve bumps by 1 basis point. DV01 is the value in dollar unit of that which is kind of the same concept</p>
<p><span class="math inline">\(\dfrac{dP}{dy}=-\sum_{i=1}^n CF_i,t_i,D(t_i)\)</span></p>
<p>For approximation, we take <span class="math inline">\(\Delta=0.0001\)</span> (1 basis point move), Parallel-shifted discount factor will be:</p>
<p><span class="math inline">\(D^{up}(t)=\exp(-(z(t)+\Delta)t)\)</span></p>
<p>PV01 will be:</p>
<p><span class="math inline">\(PV01=P_0-P_{up}\)</span></p>
</section>
<section id="convexity" class="level3">
<h3 class="anchored" data-anchor-id="convexity">15.2 Convexity</h3>
<p>convexity is basically the sensitivity of <strong>PV01</strong> to a little change in curve. and it’s the second order partial derivative of price from yield</p>
<p><span class="math inline">\(\dfrac{d^2P}{dy^2}=\sum_{i=1}^n CF_i,t_i^2,D(t_i)\)</span></p>
<p>Using central differences with shift size <span class="math inline">\(\Delta\)</span>:</p>
<p><span class="math inline">\(Conv=\dfrac{P_{down}+P_{up}-2P_0}{P_0\Delta^2}\)</span> where <span class="math inline">\(P_{up}\)</span> uses <span class="math inline">\(+\Delta\)</span> and <span class="math inline">\(P_{down}\)</span> uses <span class="math inline">\(-\Delta\)</span>.</p>
<hr>
</section>
<section id="key-rate-duration-krd" class="level3">
<h3 class="anchored" data-anchor-id="key-rate-duration-krd">15.3 Key Rate Duration (KRD)</h3>
<p>the problem is that we assume that yields parallel shift. but they can twist. if 2Y goes up it doesn’t mean 10Y will go up exactly the same amount. (Duration is a normalized version of PV01)</p>
<p>So we choose key tenors <span class="math inline">\(k_1&lt;k_2&lt;\dots&lt;k_m\)</span>. as our key rates and measure the sensitivity of them while the other tenors in the curve stay the same.</p>
<p>Tent / triangular bump shape</p>
<p>Define localized bump functions <span class="math inline">\(b_j(t)\)</span> such that <span class="math inline">\(b_j(K_j)=1\)</span> and <span class="math inline">\(b_j(t)=0\)</span> outside a neighborhood.</p>
<p>A triangular bump with edges <span class="math inline">\(L_j&lt;R_j\)</span>:</p>
<p><span class="math inline">\(b_j(t)=0\)</span> for <span class="math inline">\(t\le L_j\)</span></p>
<p><span class="math inline">\(b_j(t)=\dfrac{t-L_j}{K_j-L_j}\)</span> for <span class="math inline">\(L_j&lt;t\le K_j\)</span></p>
<p><span class="math inline">\(b_j(t)=\dfrac{R_j-t}{R_j-K_j}\)</span> for <span class="math inline">\(K_j&lt;t\le R_j\)</span></p>
<p><span class="math inline">\(b_j(t)=0\)</span> for <span class="math inline">\(t&gt;R_j\)</span></p>
<p>Bumped zero curve (only around key <span class="math inline">\(k_j\)</span>):</p>
<p><span class="math inline">\(z^{(j)}(t)=z(t)+\Delta b_j(t)\)</span></p>
<p>So bumped discount factors:</p>
<p><span class="math inline">\(D^{(j)}(t)=\exp(-(z(t)+\Delta b_j(t))t)\)</span></p>
<p>Price under the key bump:</p>
<p><span class="math inline">\(P^{(j)}(\Delta)=\sum_{i=1}^n CF_i,D(t_i),e^{-\Delta,b_j(t_i),t_i}\)</span></p>
<p>KRD definition (finite-difference)</p>
<p><span class="math inline">\(KRD_j=\dfrac{P_0-P^{(j)}}{P_0\Delta}\)</span></p>
<hr>
<div id="35b1dafa" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>risk_rows <span class="op">=</span> []</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>krd_rows <span class="op">=</span> []</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (date, method), row <span class="kw">in</span> metrics_df.iterrows():</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    curve_date <span class="op">=</span> curve_date_for(date)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> curve_date <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    curves_d <span class="op">=</span> get_curves_for(curve_date)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> curves_d <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    df_func <span class="op">=</span> curves_d[method][<span class="st">"df_func"</span>]</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    pv0 <span class="op">=</span> row[<span class="st">"pv"</span>]</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    shift_up <span class="op">=</span> shifted_df_func(df_func, <span class="kw">lambda</span> t: np.full_like(np.array(t, dtype<span class="op">=</span><span class="bu">float</span>), <span class="fl">0.0001</span>))</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    shift_dn <span class="op">=</span> shifted_df_func(df_func, <span class="kw">lambda</span> t: np.full_like(np.array(t, dtype<span class="op">=</span><span class="bu">float</span>), <span class="op">-</span><span class="fl">0.0001</span>))</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    pv_up, _ <span class="op">=</span> book_pv(date, shift_up)</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    pv_dn, _ <span class="op">=</span> book_pv(date, shift_dn)</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>    pv01 <span class="op">=</span> (pv_dn <span class="op">-</span> pv_up) <span class="op">/</span> <span class="fl">2.0</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>    convexity <span class="op">=</span> (pv_up <span class="op">+</span> pv_dn <span class="op">-</span> <span class="fl">2.0</span> <span class="op">*</span> pv0) <span class="op">/</span> (pv0 <span class="op">*</span> (<span class="fl">0.0001</span> <span class="op">**</span> <span class="dv">2</span>)) <span class="cf">if</span> pv0 <span class="op">!=</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>    risk_rows.append({</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"date"</span>: date,</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"method"</span>: method,</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pv01"</span>: pv01,</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">"convexity"</span>: convexity,</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k <span class="kw">in</span> issue_maturities:</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>        bump <span class="op">=</span> key_bump_func(k, bump_bp<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>        df_bump <span class="op">=</span> shifted_df_func(df_func, bump)</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>        pv_bump, _ <span class="op">=</span> book_pv(date, df_bump)</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>        krd <span class="op">=</span> (pv0 <span class="op">-</span> pv_bump) <span class="op">/</span> <span class="fl">0.0001</span></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>        krd_rows.append({</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>            <span class="st">"date"</span>: date,</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>            <span class="st">"method"</span>: method,</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>            <span class="st">"key"</span>: k,</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>            <span class="st">"krd"</span>: krd,</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>risk_df <span class="op">=</span> pd.DataFrame(risk_rows).set_index([<span class="st">"date"</span>, <span class="st">"method"</span>]).sort_index()</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>metrics_df <span class="op">=</span> metrics_df.join(risk_df)</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>krd_df <span class="op">=</span> pd.DataFrame(krd_rows).set_index([<span class="st">"date"</span>, <span class="st">"method"</span>, <span class="st">"key"</span>]).sort_index()</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Risk metrics (last date)"</span>)</span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>display(metrics_df[[<span class="st">"pv01"</span>, <span class="st">"convexity"</span>]].tail(<span class="dv">4</span>))</span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"KRD for last date"</span>)</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>display(krd_df.tail(<span class="dv">4</span>))</span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> method <span class="kw">in</span> <span class="bu">sorted</span>(metrics_df.index.get_level_values(<span class="st">"method"</span>).unique()):</span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> metrics_df.xs(method, level<span class="op">=</span><span class="st">"method"</span>)</span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a>    plt.plot(data.index, data[<span class="st">"pv01"</span>], label<span class="op">=</span>method)</span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"PV01 of Synthetic Book"</span>)</span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>)</span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"PV01"</span>)</span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> method <span class="kw">in</span> <span class="bu">sorted</span>(metrics_df.index.get_level_values(<span class="st">"method"</span>).unique()):</span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> metrics_df.xs(method, level<span class="op">=</span><span class="st">"method"</span>)</span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a>    plt.plot(data.index, data[<span class="st">"convexity"</span>], label<span class="op">=</span>method)</span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Convexity of Synthetic Book"</span>)</span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>)</span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Convexity"</span>)</span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb25-72"><a href="#cb25-72" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb25-73"><a href="#cb25-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-74"><a href="#cb25-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-75"><a href="#cb25-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-76"><a href="#cb25-76" aria-hidden="true" tabindex="-1"></a>methods <span class="op">=</span> <span class="bu">sorted</span>(metrics_df.index.get_level_values(<span class="st">"method"</span>).unique())</span>
<span id="cb25-77"><a href="#cb25-77" aria-hidden="true" tabindex="-1"></a>krd_panel <span class="op">=</span> krd_df.reset_index()</span>
<span id="cb25-78"><a href="#cb25-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-79"><a href="#cb25-79" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>), sharex<span class="op">=</span><span class="va">True</span>, sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb25-80"><a href="#cb25-80" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> axes.flatten()</span>
<span id="cb25-81"><a href="#cb25-81" aria-hidden="true" tabindex="-1"></a>fig.subplots_adjust(right<span class="op">=</span><span class="fl">0.88</span>)</span>
<span id="cb25-82"><a href="#cb25-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-83"><a href="#cb25-83" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, method <span class="kw">in</span> <span class="bu">zip</span>(axes, methods, strict<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb25-84"><a href="#cb25-84" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> krd_panel[krd_panel[<span class="st">"method"</span>] <span class="op">==</span> method]</span>
<span id="cb25-85"><a href="#cb25-85" aria-hidden="true" tabindex="-1"></a>    pivot <span class="op">=</span> data.pivot(index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span><span class="st">"key"</span>, values<span class="op">=</span><span class="st">"krd"</span>).reindex(columns<span class="op">=</span>issue_maturities)</span>
<span id="cb25-86"><a href="#cb25-86" aria-hidden="true" tabindex="-1"></a>    im <span class="op">=</span> ax.imshow(pivot.values.T, aspect<span class="op">=</span><span class="st">"auto"</span>, origin<span class="op">=</span><span class="st">"lower"</span>)</span>
<span id="cb25-87"><a href="#cb25-87" aria-hidden="true" tabindex="-1"></a>    ax.set_title(method)</span>
<span id="cb25-88"><a href="#cb25-88" aria-hidden="true" tabindex="-1"></a>    ax.set_yticks(<span class="bu">range</span>(<span class="bu">len</span>(issue_maturities)))</span>
<span id="cb25-89"><a href="#cb25-89" aria-hidden="true" tabindex="-1"></a>    ax.set_yticklabels([<span class="ss">f"</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">Y"</span> <span class="cf">for</span> k <span class="kw">in</span> issue_maturities])</span>
<span id="cb25-90"><a href="#cb25-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-91"><a href="#cb25-91" aria-hidden="true" tabindex="-1"></a>    tick_idx <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="bu">len</span>(pivot.index) <span class="op">-</span> <span class="dv">1</span>, <span class="dv">6</span>).astype(<span class="bu">int</span>)</span>
<span id="cb25-92"><a href="#cb25-92" aria-hidden="true" tabindex="-1"></a>    ax.set_xticks(tick_idx)</span>
<span id="cb25-93"><a href="#cb25-93" aria-hidden="true" tabindex="-1"></a>    ax.set_xticklabels([pivot.index[i].strftime(<span class="st">"%Y"</span>) <span class="cf">for</span> i <span class="kw">in</span> tick_idx])</span>
<span id="cb25-94"><a href="#cb25-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-95"><a href="#cb25-95" aria-hidden="true" tabindex="-1"></a>cax <span class="op">=</span> fig.add_axes([<span class="fl">0.90</span>, <span class="fl">0.15</span>, <span class="fl">0.02</span>, <span class="fl">0.7</span>])</span>
<span id="cb25-96"><a href="#cb25-96" aria-hidden="true" tabindex="-1"></a>fig.colorbar(im, cax<span class="op">=</span>cax, label<span class="op">=</span><span class="st">"KRD"</span>)</span>
<span id="cb25-97"><a href="#cb25-97" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">"KRD Heatmap Across Time"</span>, y<span class="op">=</span><span class="fl">1.02</span>)</span>
<span id="cb25-98"><a href="#cb25-98" aria-hidden="true" tabindex="-1"></a>plt.tight_layout(rect<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">0</span>, <span class="fl">0.88</span>, <span class="dv">1</span>])</span>
<span id="cb25-99"><a href="#cb25-99" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Risk metrics (last date)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">pv01</th>
<th data-quarto-table-cell-role="th">convexity</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">method</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th rowspan="4" data-quarto-table-cell-role="th" data-valign="top">2026-01-31</th>
<th data-quarto-table-cell-role="th">loglinear</th>
<td>0.357311</td>
<td>107.577415</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">nss</th>
<td>0.359623</td>
<td>108.064523</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">pchip</th>
<td>0.358863</td>
<td>107.715321</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">qp</th>
<td>0.362471</td>
<td>108.928968</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>KRD for last date</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">krd</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">method</th>
<th data-quarto-table-cell-role="th">key</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th rowspan="4" data-quarto-table-cell-role="th" data-valign="top">2026-01-31</th>
<th rowspan="4" data-quarto-table-cell-role="th" data-valign="top">qp</th>
<th data-quarto-table-cell-role="th">2</th>
<td>199.706778</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>584.865209</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td>1608.487463</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">30</th>
<td>1104.026025</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_yield_curve_bond_pricing_and_risk_files/figure-html/cell-18-output-5.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_yield_curve_bond_pricing_and_risk_files/figure-html/cell-18-output-6.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_yield_curve_bond_pricing_and_risk_files/figure-html/cell-18-output-7.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="implementing-the-whole-project-on-japan-data-using-quantfinlab" class="level1">
<h1>Implementing the whole project on Japan data using quantfinlab</h1>
<div id="a1824e0d" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> quantfinlab.fixed_income <span class="im">as</span> fi</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> quantfinlab.plots <span class="im">as</span> pl</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> Path(<span class="st">"../data/japan_yield_curve_all.csv"</span>)</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>first_line <span class="op">=</span> Path(path).read_text(encoding<span class="op">=</span><span class="st">"utf-8"</span>, errors<span class="op">=</span><span class="st">"ignore"</span>).splitlines()[<span class="dv">0</span>].strip().lower()</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> first_line.startswith(<span class="st">"interest rate"</span>):</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    raw <span class="op">=</span> pd.read_csv(path, skiprows<span class="op">=</span><span class="dv">1</span>, na_values<span class="op">=</span>[<span class="st">"-"</span>], keep_default_na<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    raw <span class="op">=</span> pd.read_csv(path, na_values<span class="op">=</span>[<span class="st">"-"</span>], keep_default_na<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>raw <span class="op">=</span> raw.rename(columns<span class="op">=</span>{c: <span class="bu">str</span>(c).strip() <span class="cf">for</span> c <span class="kw">in</span> raw.columns})</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> normalize_tenor_name(c):</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> <span class="bu">str</span>(c).strip().upper().replace(<span class="st">" "</span>, <span class="st">""</span>)</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> s.replace(<span class="st">"MONTHS"</span>, <span class="st">"M"</span>).replace(<span class="st">"MONTH"</span>, <span class="st">"M"</span>).replace(<span class="st">"MOS"</span>, <span class="st">"M"</span>).replace(<span class="st">"MO"</span>, <span class="st">"M"</span>)</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> s.replace(<span class="st">"YEARS"</span>, <span class="st">"Y"</span>).replace(<span class="st">"YEAR"</span>, <span class="st">"Y"</span>).replace(<span class="st">"YRS"</span>, <span class="st">"Y"</span>).replace(<span class="st">"YR"</span>, <span class="st">"Y"</span>)</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> s</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>lower_cols <span class="op">=</span> [c.lower() <span class="cf">for</span> c <span class="kw">in</span> raw.columns]</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>date_col <span class="op">=</span> raw.columns[lower_cols.index(<span class="st">"date"</span>)] <span class="cf">if</span> <span class="st">"date"</span> <span class="kw">in</span> lower_cols <span class="cf">else</span> raw.columns[<span class="dv">0</span>]</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>raw <span class="op">=</span> raw.rename(columns<span class="op">=</span>{date_col: <span class="st">"date"</span>})</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>raw[<span class="st">"date"</span>] <span class="op">=</span> pd.to_datetime(raw[<span class="st">"date"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>raw <span class="op">=</span> raw.dropna(subset<span class="op">=</span>[<span class="st">"date"</span>]).sort_values(<span class="st">"date"</span>).set_index(<span class="st">"date"</span>)</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>raw <span class="op">=</span> raw.rename(columns<span class="op">=</span>{c: normalize_tenor_name(c) <span class="cf">for</span> c <span class="kw">in</span> raw.columns})</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>tenor_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> raw.columns <span class="cf">if</span> re.fullmatch(<span class="vs">r"</span><span class="dv">\d</span><span class="op">+</span><span class="kw">(</span><span class="vs">M</span><span class="cf">|</span><span class="vs">Y</span><span class="kw">)</span><span class="vs">"</span>, <span class="bu">str</span>(c))]</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>tenor_cols <span class="op">=</span> <span class="bu">sorted</span>(tenor_cols, key<span class="op">=</span>fi.tenor_to_years)</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>par <span class="op">=</span> raw[tenor_cols].<span class="bu">apply</span>(pd.to_numeric, errors<span class="op">=</span><span class="st">"coerce"</span>).dropna(how<span class="op">=</span><span class="st">"all"</span>).sort_index()</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> np.nanmedian(par.to_numpy(dtype<span class="op">=</span><span class="bu">float</span>)) <span class="op">&gt;</span> <span class="fl">1.0</span>: </span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>    par <span class="op">=</span> par <span class="op">/</span> <span class="fl">100.0</span></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>methods <span class="op">=</span> [<span class="st">"loglinear"</span>, <span class="st">"pchip"</span>, <span class="st">"nss"</span>, <span class="st">"qp"</span>]</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>holdouts <span class="op">=</span> [<span class="st">"2Y"</span>, <span class="st">"7Y"</span>, <span class="st">"20Y"</span>, <span class="st">"30Y"</span>]</span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>keys <span class="op">=</span> [<span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">30</span>]</span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>freq <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>short_end <span class="op">=</span> <span class="st">"continuous"</span></span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>asof <span class="op">=</span> fi.resolve_asof(par.index)</span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>pillars <span class="op">=</span> fi.bootstrap_pillars(par.loc[asof], asof<span class="op">=</span>asof, tenor_cols<span class="op">=</span>tenor_cols, freq<span class="op">=</span>freq, short_end<span class="op">=</span>short_end)</span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a>curves <span class="op">=</span> fi.fit_curves(pillars, methods<span class="op">=</span>methods, freq<span class="op">=</span>freq)</span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a>curve_t_max <span class="op">=</span> <span class="bu">max</span>(<span class="fl">30.0</span>, <span class="bu">float</span>(pillars.T.<span class="bu">max</span>()))</span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a>plot_grid <span class="op">=</span> np.linspace(<span class="bu">max</span>(<span class="dv">1</span> <span class="op">/</span> <span class="dv">12</span>, <span class="bu">float</span>(pillars.T.<span class="bu">min</span>())), <span class="bu">float</span>(pillars.T.<span class="bu">max</span>()), <span class="dv">250</span>)</span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a>par_fit_table <span class="op">=</span> fi.par_curve_table(curves, grid<span class="op">=</span>plot_grid, freq<span class="op">=</span>freq)</span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>zero_table <span class="op">=</span> fi.zero_curve_table(curves, t_min<span class="op">=</span><span class="dv">1</span> <span class="op">/</span> <span class="dv">12</span>, t_max<span class="op">=</span>curve_t_max, points<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a>df_table <span class="op">=</span> fi.discount_curve_table(curves, t_min<span class="op">=</span><span class="dv">1</span> <span class="op">/</span> <span class="dv">12</span>, t_max<span class="op">=</span>curve_t_max, points<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a>fwd_table <span class="op">=</span> fi.forward_curve_table(curves, t_min<span class="op">=</span><span class="dv">1</span> <span class="op">/</span> <span class="dv">12</span>, t_max<span class="op">=</span>curve_t_max, points<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> fi.rmse_backtest(par.tail(<span class="dv">100</span>), methods<span class="op">=</span>methods, holdouts<span class="op">=</span>holdouts, freq<span class="op">=</span>freq, short_end<span class="op">=</span>short_end,</span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a>    tenor_cols<span class="op">=</span>tenor_cols)</span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a>rmse_sorted <span class="op">=</span> fi.sort_rmse_table(rmse, methods<span class="op">=</span>methods)</span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a>month_end <span class="op">=</span> par.resample(<span class="st">"ME"</span>).last().dropna(how<span class="op">=</span><span class="st">"all"</span>)</span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a>book <span class="op">=</span> fi.synthetic_issuance_book(month_end, maturities<span class="op">=</span>keys, freq<span class="op">=</span>freq)</span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a>curves_for_dates <span class="op">=</span> fi.curves_by_valuation_date(month_end.index, par, methods<span class="op">=</span>methods, freq<span class="op">=</span>freq,</span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a>    short_end<span class="op">=</span>short_end, tenor_cols<span class="op">=</span>tenor_cols)</span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a>pv_total, pv_buckets <span class="op">=</span> fi.book_pv_timeseries(book, curves_for_dates)</span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a>risk_df <span class="op">=</span> fi.book_parallel_risk_timeseries(book, curves_for_dates, bump_bp<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a>krd_df <span class="op">=</span> fi.book_krd_timeseries(book, curves_for_dates, keys<span class="op">=</span>keys, bump_bp<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a>metrics <span class="op">=</span> fi.make_book_metrics(pv_total, pv_buckets, risk_df)</span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-78"><a href="#cb28-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-79"><a href="#cb28-79" aria-hidden="true" tabindex="-1"></a>bond, used_tenor <span class="op">=</span> fi.bond_from_par_curve_row(par.loc[asof], maturity_years<span class="op">=</span><span class="dv">10</span>, tenor_cols<span class="op">=</span>tenor_cols, freq<span class="op">=</span>freq)</span>
<span id="cb28-80"><a href="#cb28-80" aria-hidden="true" tabindex="-1"></a>bond_tbl <span class="op">=</span> fi.bond_price_and_risk(bond,curves, bump_bp<span class="op">=</span><span class="fl">1.0</span>, key_tenors<span class="op">=</span>keys).reindex(methods)</span>
<span id="cb28-81"><a href="#cb28-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-82"><a href="#cb28-82" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="bu">len</span>(par.index)</span>
<span id="cb28-83"><a href="#cb28-83" aria-hidden="true" tabindex="-1"></a>sample_dates <span class="op">=</span> [par.index[<span class="dv">0</span>], par.index[n <span class="op">//</span> <span class="dv">3</span>], par.index[(<span class="dv">2</span> <span class="op">*</span> n) <span class="op">//</span> <span class="dv">3</span>], par.index[<span class="op">-</span><span class="dv">1</span>]]</span>
<span id="cb28-84"><a href="#cb28-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-85"><a href="#cb28-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-86"><a href="#cb28-86" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">22</span>, <span class="dv">16</span>), constrained_layout<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb28-87"><a href="#cb28-87" aria-hidden="true" tabindex="-1"></a>gs <span class="op">=</span> fig.add_gridspec(<span class="dv">4</span>, <span class="dv">4</span>)</span>
<span id="cb28-88"><a href="#cb28-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-89"><a href="#cb28-89" aria-hidden="true" tabindex="-1"></a>ax_all <span class="op">=</span> fig.add_subplot(gs[<span class="dv">0</span>, <span class="dv">0</span>])</span>
<span id="cb28-90"><a href="#cb28-90" aria-hidden="true" tabindex="-1"></a>pl.plot_par_yields_history(ax_all, par, title<span class="op">=</span><span class="st">"Par Yields Over Time"</span>)</span>
<span id="cb28-91"><a href="#cb28-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-92"><a href="#cb28-92" aria-hidden="true" tabindex="-1"></a>ax_snap <span class="op">=</span> fig.add_subplot(gs[<span class="dv">0</span>, <span class="dv">1</span>])</span>
<span id="cb28-93"><a href="#cb28-93" aria-hidden="true" tabindex="-1"></a>pl.plot_yield_curve_snapshots(ax_snap, par, tenor_cols<span class="op">=</span>tenor_cols, sample_dates<span class="op">=</span>sample_dates, title<span class="op">=</span><span class="st">"Yield Curve Snapshots"</span>)</span>
<span id="cb28-94"><a href="#cb28-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-95"><a href="#cb28-95" aria-hidden="true" tabindex="-1"></a>ax_par <span class="op">=</span> fig.add_subplot(gs[<span class="dv">0</span>, <span class="dv">2</span>])</span>
<span id="cb28-96"><a href="#cb28-96" aria-hidden="true" tabindex="-1"></a>pl.draw_market_par_points(ax_par, pillars.T, pillars.par)</span>
<span id="cb28-97"><a href="#cb28-97" aria-hidden="true" tabindex="-1"></a>rmse_label_map <span class="op">=</span> {</span>
<span id="cb28-98"><a href="#cb28-98" aria-hidden="true" tabindex="-1"></a>    m: <span class="ss">f"</span><span class="sc">{</span>m<span class="sc">}</span><span class="ss"> (IS </span><span class="sc">{</span>rmse<span class="sc">.</span>loc[m, <span class="st">'rmse'</span>]<span class="sc">:.6f}</span><span class="ss">, OOS </span><span class="sc">{</span>rmse<span class="sc">.</span>loc[m, <span class="st">'rmse_oos'</span>]<span class="sc">:.6f}</span><span class="ss">)"</span> <span class="cf">if</span> m <span class="kw">in</span> rmse.index <span class="cf">else</span> m</span>
<span id="cb28-99"><a href="#cb28-99" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> m <span class="kw">in</span> methods</span>
<span id="cb28-100"><a href="#cb28-100" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-101"><a href="#cb28-101" aria-hidden="true" tabindex="-1"></a>pl.draw_curve_lines(ax_par, par_fit_table, scale<span class="op">=</span><span class="fl">100.0</span>, label_map<span class="op">=</span>rmse_label_map)</span>
<span id="cb28-102"><a href="#cb28-102" aria-hidden="true" tabindex="-1"></a>pl.style_axis(ax_par, title<span class="op">=</span><span class="st">"Par Yield Curve Fit"</span>, xlabel<span class="op">=</span><span class="st">"Maturity (Years)"</span>, ylabel<span class="op">=</span><span class="st">"Par Yield (%)"</span>)</span>
<span id="cb28-103"><a href="#cb28-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-104"><a href="#cb28-104" aria-hidden="true" tabindex="-1"></a>ax_zero <span class="op">=</span> fig.add_subplot(gs[<span class="dv">0</span>, <span class="dv">3</span>])</span>
<span id="cb28-105"><a href="#cb28-105" aria-hidden="true" tabindex="-1"></a>pl.plot_zero_curves(ax_zero, zero_table, title<span class="op">=</span><span class="st">"Zero Curves"</span>)</span>
<span id="cb28-106"><a href="#cb28-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-107"><a href="#cb28-107" aria-hidden="true" tabindex="-1"></a>ax_df <span class="op">=</span> fig.add_subplot(gs[<span class="dv">1</span>, <span class="dv">0</span>])</span>
<span id="cb28-108"><a href="#cb28-108" aria-hidden="true" tabindex="-1"></a>pl.plot_discount_curves(ax_df, df_table, title<span class="op">=</span><span class="st">"Discount Curves"</span>)</span>
<span id="cb28-109"><a href="#cb28-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-110"><a href="#cb28-110" aria-hidden="true" tabindex="-1"></a>ax_fwd <span class="op">=</span> fig.add_subplot(gs[<span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="cb28-111"><a href="#cb28-111" aria-hidden="true" tabindex="-1"></a>pl.plot_forward_curves(ax_fwd, fwd_table, title<span class="op">=</span><span class="st">"Forward Curves"</span>)</span>
<span id="cb28-112"><a href="#cb28-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-113"><a href="#cb28-113" aria-hidden="true" tabindex="-1"></a>ax_total <span class="op">=</span> fig.add_subplot(gs[<span class="dv">1</span>, <span class="dv">2</span>])</span>
<span id="cb28-114"><a href="#cb28-114" aria-hidden="true" tabindex="-1"></a>pl.plot_total_pv(ax_total, metrics.total_pv, title<span class="op">=</span><span class="st">"Synthetic Book Total PV"</span>)</span>
<span id="cb28-115"><a href="#cb28-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-116"><a href="#cb28-116" aria-hidden="true" tabindex="-1"></a>ax_bucket <span class="op">=</span> fig.add_subplot(gs[<span class="dv">1</span>, <span class="dv">3</span>])</span>
<span id="cb28-117"><a href="#cb28-117" aria-hidden="true" tabindex="-1"></a>pl.plot_bucket_pv(ax_bucket, metrics.bucket_pv, title<span class="op">=</span><span class="st">"Bucket PV (Last Date)"</span>)</span>
<span id="cb28-118"><a href="#cb28-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-119"><a href="#cb28-119" aria-hidden="true" tabindex="-1"></a>ax_pv01 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">2</span>, <span class="dv">0</span>])</span>
<span id="cb28-120"><a href="#cb28-120" aria-hidden="true" tabindex="-1"></a>pl.plot_risk_metric(ax_pv01, metrics.risk, metric<span class="op">=</span><span class="st">"pv01"</span>, title<span class="op">=</span><span class="st">"PV01"</span>)</span>
<span id="cb28-121"><a href="#cb28-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-122"><a href="#cb28-122" aria-hidden="true" tabindex="-1"></a>ax_conv <span class="op">=</span> fig.add_subplot(gs[<span class="dv">2</span>, <span class="dv">1</span>])</span>
<span id="cb28-123"><a href="#cb28-123" aria-hidden="true" tabindex="-1"></a>pl.plot_risk_metric(ax_conv, metrics.risk, metric<span class="op">=</span><span class="st">"convexity"</span>, title<span class="op">=</span><span class="st">"Convexity"</span>)</span>
<span id="cb28-124"><a href="#cb28-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-125"><a href="#cb28-125" aria-hidden="true" tabindex="-1"></a>ax_rmse <span class="op">=</span> fig.add_subplot(gs[<span class="dv">2</span>, <span class="dv">2</span>])</span>
<span id="cb28-126"><a href="#cb28-126" aria-hidden="true" tabindex="-1"></a>pl.plot_rmse_bars(ax_rmse, rmse_sorted, title<span class="op">=</span><span class="st">"RMSE (IS/OOS)"</span>)</span>
<span id="cb28-127"><a href="#cb28-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-128"><a href="#cb28-128" aria-hidden="true" tabindex="-1"></a>ax_bond <span class="op">=</span> fig.add_subplot(gs[<span class="dv">2</span>, <span class="dv">3</span>])</span>
<span id="cb28-129"><a href="#cb28-129" aria-hidden="true" tabindex="-1"></a>pl.plot_bond_metric_bar(ax_bond, bond_tbl, metric<span class="op">=</span><span class="st">"pv01"</span>, title<span class="op">=</span><span class="ss">f"Bond PV01 (</span><span class="sc">{</span>used_tenor<span class="sc">}</span><span class="ss"> coupon)"</span>)</span>
<span id="cb28-130"><a href="#cb28-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-131"><a href="#cb28-131" aria-hidden="true" tabindex="-1"></a>krd_axes <span class="op">=</span> [fig.add_subplot(gs[<span class="dv">3</span>, i]) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">4</span>)]</span>
<span id="cb28-132"><a href="#cb28-132" aria-hidden="true" tabindex="-1"></a>ims <span class="op">=</span> []</span>
<span id="cb28-133"><a href="#cb28-133" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, method <span class="kw">in</span> <span class="bu">zip</span>(krd_axes, methods, strict<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb28-134"><a href="#cb28-134" aria-hidden="true" tabindex="-1"></a>    im <span class="op">=</span> pl.plot_krd_heatmap(ax, krd_df, method<span class="op">=</span>method, keys<span class="op">=</span>keys, title<span class="op">=</span><span class="ss">f"KRD - </span><span class="sc">{</span>method<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-135"><a href="#cb28-135" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> im <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb28-136"><a href="#cb28-136" aria-hidden="true" tabindex="-1"></a>        ims.append(im)</span>
<span id="cb28-137"><a href="#cb28-137" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> ims:</span>
<span id="cb28-138"><a href="#cb28-138" aria-hidden="true" tabindex="-1"></a>    fig.colorbar(ims[<span class="dv">0</span>], ax<span class="op">=</span>krd_axes, shrink<span class="op">=</span><span class="fl">0.8</span>, location<span class="op">=</span><span class="st">"right"</span>, label<span class="op">=</span><span class="st">"KRD"</span>)</span>
<span id="cb28-139"><a href="#cb28-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-140"><a href="#cb28-140" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">"Project 01 - Yield Curve, Pricing, and Risk (Japan Data)"</span>, y<span class="op">=</span><span class="fl">1.02</span>)</span>
<span id="cb28-141"><a href="#cb28-141" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb28-142"><a href="#cb28-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-143"><a href="#cb28-143" aria-hidden="true" tabindex="-1"></a>display(bond_tbl)</span>
<span id="cb28-144"><a href="#cb28-144" aria-hidden="true" tabindex="-1"></a>display(rmse_sorted)</span>
<span id="cb28-145"><a href="#cb28-145" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_yield_curve_bond_pricing_and_risk_files/figure-html/cell-19-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">clean_price</th>
<th data-quarto-table-cell-role="th">pv01</th>
<th data-quarto-table-cell-role="th">convexity</th>
<th data-quarto-table-cell-role="th">krd_2Y</th>
<th data-quarto-table-cell-role="th">krd_5Y</th>
<th data-quarto-table-cell-role="th">krd_10Y</th>
<th data-quarto-table-cell-role="th">krd_30Y</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">method</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">loglinear</th>
<td>1.000000</td>
<td>0.000907</td>
<td>87.530846</td>
<td>0.098387</td>
<td>0.421344</td>
<td>8.514938</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">pchip</th>
<td>1.000078</td>
<td>0.000907</td>
<td>87.524809</td>
<td>0.098400</td>
<td>0.421397</td>
<td>8.514987</td>
<td>0.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">nss</th>
<td>0.997714</td>
<td>0.000905</td>
<td>87.497439</td>
<td>0.098420</td>
<td>0.421132</td>
<td>8.491704</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">qp</th>
<td>1.000000</td>
<td>0.000907</td>
<td>87.522921</td>
<td>0.098397</td>
<td>0.421366</td>
<td>8.514131</td>
<td>0.0</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">rmse</th>
<th data-quarto-table-cell-role="th">rmse_oos</th>
<th data-quarto-table-cell-role="th">n_obs</th>
<th data-quarto-table-cell-role="th">n_obs_oos</th>
<th data-quarto-table-cell-role="th">n_dates</th>
<th data-quarto-table-cell-role="th">n_dates_oos</th>
<th data-quarto-table-cell-role="th">n_failed</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">method</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">qp</th>
<td>2.833055e-09</td>
<td>0.000426</td>
<td>1100</td>
<td>400</td>
<td>100</td>
<td>100</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">loglinear</th>
<td>8.669301e-06</td>
<td>0.000515</td>
<td>1100</td>
<td>400</td>
<td>100</td>
<td>100</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">pchip</th>
<td>3.874855e-05</td>
<td>0.000440</td>
<td>1100</td>
<td>400</td>
<td>100</td>
<td>100</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">nss</th>
<td>3.241647e-04</td>
<td>0.000265</td>
<td>1100</td>
<td>400</td>
<td>100</td>
<td>100</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../overview.html" class="pagination-link" aria-label="Overview">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-title">Overview</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../notebooks/02_portfolio_optimization_MV_models.html" class="pagination-link" aria-label="2. Portfolio Optimization with Mean–Variance Models">
        <span class="nav-page-text"><span class="chapter-title">2. Portfolio Optimization with Mean–Variance Models</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>