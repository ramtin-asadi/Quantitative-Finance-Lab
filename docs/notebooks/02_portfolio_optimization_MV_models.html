<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>2. Portfolio Optimization with Mean–Variance Models – Quantitative Finance Lab</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../notebooks/01_yield_curve_bond_pricing_and_risk.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-ed96de9b727972fe78a7b5d16c58bf87.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-2641b481724464e61c86985d8c912b6f.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating fullcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../notebooks/02_portfolio_optimization_MV_models.html"><span class="chapter-title">2. Portfolio Optimization with Mean–Variance Models</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Quantitative Finance Lab</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Home</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../overview.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Overview</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/01_yield_curve_bond_pricing_and_risk.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">1. Fixed income and yield curve construction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/02_portfolio_optimization_MV_models.html" class="sidebar-item-text sidebar-link active"><span class="chapter-title">2. Portfolio Optimization with Mean–Variance Models</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-title">2. Portfolio Optimization with Mean–Variance Models</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>This notebook builds and backtests long-only portfolios under a realistic workflow:</p>
<ol type="1">
<li><strong>Pick a tradable universe</strong> using liquidity (average dollar volume) and “seasoning” (minimum history).</li>
<li>Estimate <strong>expected returns</strong> <span class="math inline">\(\mu_t\)</span> (a simple momentum model).</li>
<li>Estimate <strong>risk</strong> with a covariance matrix <span class="math inline">\(\Sigma_t\)</span> (multiple estimators).</li>
<li>Compute portfolio weights by solving <strong>constrained optimization</strong> problems (min-var, mean–variance, max-Sharpe via frontier grid).</li>
<li>Apply <strong>transaction costs</strong> based on turnover and simulate realistic portfolio wealth over time.</li>
</ol>
<hr>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">1) Introduction</h2>
<p>In this project we have a dataset for all the stocks in Nasdaq from 1970 to 2026. we want to pick 100 stocks from them and see how we can weight them to reach a stable positive return that would be considered a better investment decision than just investing in all the stocks in equal weights.</p>
<p>For comparing the strategies and different models we can use return and risk. we always want higher return and lower risk. lower risk decreases the probability of negative or too negative return and higher return is basiacally what we get on our money. there is a trade off between wanting higher return and lower risk. we can’t minimize risk and reach the highest return. if we want lower risk we have to accept lower return.</p>
<p>In this project we use some of the models for weighting assets so we can reach the best portfolios in the risk-return trade off. we use other models and approaches in future projects</p>
<p>We trade <span class="math inline">\(N\)</span> stocks, indexed by <span class="math inline">\(i \in \{1,\dots,N\}\)</span>, at daily dates <span class="math inline">\(t\)</span>.</p>
<p><strong>Market data</strong> - Close price: <span class="math inline">\(P_{t,i}\)</span> - Volume (shares): <span class="math inline">\(V_{t,i}\)</span> - Dollar volume (we use these to identify the most liquid stocks in each rebalance period): <span class="math inline">\(DV_{t,i} = P_{t,i} V_{t,i}\)</span></p>
<p><strong>Returns</strong> - Simple return: <span class="math inline">\(r_{t,i} = \frac{P_{t,i}}{P_{t-1,i}} - 1\)</span> - Log return: <span class="math inline">\(r_{t,i} = \log(P_{t,i}) - \log(P_{t-1,i})\)</span> (we use simple here)</p>
<p>We stack daily returns into a vector <span class="math inline">\(r_t \in \mathbb{R}^N\)</span> and an estimation matrix <span class="math inline">\(R_t \in \mathbb{R}^{T \times N}\)</span> using the last <span class="math inline">\(T\)</span> days before a rebalance.</p>
<p><strong>Portfolio</strong> - Portfolio weights (held through each period <span class="math inline">\(t\)</span>): <span class="math inline">\(w_t \in \mathbb{R}^N\)</span> - Budget constraint (sum of all the weights should be 1. we don’t use leverage for this project): <span class="math inline">\(\mathbf{1}^\top w_t = 1\)</span></p>
<ul>
<li>Long-only constraint: <span class="math inline">\(w_t \ge 0\)</span></li>
<li>Optional cap (for making models diverse more and don’t overfit on some assets, we define a <span class="math inline">\(w_{\max}\)</span> which is the max weight an asset can get in the portfolio): <span class="math inline">\(w_{t,i} \le w_{\max}\)</span></li>
</ul>
<p><strong>Risk-free rate</strong> is used for calculation of Sharpe Ratio - Annual: <span class="math inline">\(r_f^{(ann)}\)</span> - Daily (compounded): <span class="math inline">\(r_f^{(d)} = (1+r_f^{(ann)})^{1/252} - 1\)</span></p>
<p><strong>Annualization</strong> - If <span class="math inline">\(\mu^{(d)}\)</span> is a daily mean return vector, then <span class="math inline">\(\mu^{(ann)} = 252\,\mu^{(d)}\)</span> - If <span class="math inline">\(\Sigma^{(d)}\)</span> is a daily covariance matrix, then <span class="math inline">\(\Sigma^{(ann)} = 252\,\Sigma^{(d)}\)</span></p>
<hr>
<section id="imports-and-plotting-style" class="level3">
<h3 class="anchored" data-anchor-id="imports-and-plotting-style">Imports and plotting style</h3>
<div id="4521701a" class="cell" data-execution_count="37">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cvxpy <span class="im">as</span> cp</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.dates <span class="im">import</span> DateFormatter</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.optimize <span class="im">import</span> minimize</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.covariance <span class="im">import</span> LedoitWolf, OAS</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> cycler <span class="im">import</span> cycler</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">"#069AF3"</span>,<span class="st">"#FE420F"</span>, <span class="st">"#00008B"</span>, <span class="st">"#008080"</span>, <span class="st">"#800080"</span>,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>          <span class="st">"#7BC8F6"</span>, <span class="st">"#0072B2"</span>,<span class="st">"#04D8B2"</span>, <span class="st">"#CC79A7"</span>, <span class="st">"#FF8072"</span>, <span class="st">"#9614fa"</span>, <span class="st">"#DC143C"</span>]</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"axes.prop_cycle"</span>] <span class="op">=</span> cycler(color<span class="op">=</span>colors)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>plt.rcParams.update({</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"figure.figsize"</span>: (<span class="dv">6</span>, <span class="dv">3</span>),</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"figure.dpi"</span>: <span class="dv">300</span>,</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"savefig.dpi"</span>: <span class="dv">300</span>,</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.grid"</span>: <span class="va">True</span>,</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"grid.alpha"</span>: <span class="fl">0.20</span>,</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.spines.top"</span>: <span class="va">False</span>,</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.spines.right"</span>: <span class="va">False</span>,</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.titlesize"</span>: <span class="dv">10</span>,</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.labelsize"</span>: <span class="dv">12</span>,</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"xtick.labelsize"</span>: <span class="dv">10</span>,</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ytick.labelsize"</span>: <span class="dv">10</span>,</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"legend.fontsize"</span>: <span class="dv">10</span>,</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_color_map(names, palette<span class="op">=</span>colors):</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    names <span class="op">=</span> <span class="bu">list</span>(names)</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {name: palette[i <span class="op">%</span> <span class="bu">len</span>(palette)] <span class="cf">for</span> i, name <span class="kw">in</span> <span class="bu">enumerate</span>(names)}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="initializing-the-parameters-and-data" class="level3">
<h3 class="anchored" data-anchor-id="initializing-the-parameters-and-data">initializing the parameters and data</h3>
<div id="aafe44dd" class="cell" data-execution_count="38">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>rf <span class="op">=</span> <span class="fl">0.04</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>blend <span class="op">=</span> {</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MV (SampleCov)"</span>: <span class="fl">0.15</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MV (LedoitWolf)"</span>: <span class="fl">0.15</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MV (OAS)"</span>: <span class="fl">0.15</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MV (EWMA)"</span>: <span class="fl">0.15</span>,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Ridge MV"</span>: <span class="fl">0.15</span>,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MaxSharpe"</span>: <span class="fl">0.10</span>,                 <span class="co"># keep your SLSQP baseline</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MaxSharpe (FrontierGrid)"</span>: <span class="fl">0.10</span>,  <span class="co"># NEW</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MinVar (SampleCov)"</span>: <span class="fl">0.20</span>,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MinVar (LedoitWolf)"</span>: <span class="fl">0.20</span>,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MinVar (OAS)"</span>: <span class="fl">0.20</span>,</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MinVar (EWMA)"</span>: <span class="fl">0.20</span>,</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>strategy_cov_key <span class="op">=</span> {</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EW"</span>: <span class="st">"LedoitWolf"</span>,</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MinVar (SampleCov)"</span>: <span class="st">"SampleCov"</span>,</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MinVar (LedoitWolf)"</span>: <span class="st">"LedoitWolf"</span>,</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MinVar (OAS)"</span>: <span class="st">"OAS"</span>,</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MinVar (EWMA)"</span>: <span class="st">"EWMA"</span>,</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MV (SampleCov)"</span>: <span class="st">"SampleCov"</span>,</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MV (LedoitWolf)"</span>: <span class="st">"LedoitWolf"</span>,</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MV (OAS)"</span>: <span class="st">"OAS"</span>,</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MV (EWMA)"</span>: <span class="st">"EWMA"</span>,</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Ridge MV"</span>: <span class="st">"LedoitWolf"</span>,</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MaxSharpe"</span>: <span class="st">"LedoitWolf"</span>,                 <span class="co"># baseline SLSQP</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MaxSharpe (FrontierGrid)"</span>: <span class="st">"LedoitWolf"</span>,  <span class="co"># NEW</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>strategy_names <span class="op">=</span> <span class="bu">list</span>(strategy_cov_key.keys())</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>strategy_colors <span class="op">=</span> make_color_map(strategy_names)</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_warn(msg):</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"[WARN] </span><span class="sc">{</span>msg<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="load-data-and-compute-returns" class="level2">
<h2 class="anchored" data-anchor-id="load-data-and-compute-returns">2) Load data and compute returns</h2>
<p>the data used in this project can be downloaded from here (<a href="https://stooq.com/db/h/">Stooq US (nasdaq) daily market data</a>)</p>
<div id="a56c1f01" class="cell" data-execution_count="39">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_parquet(<span class="vs">r"</span><span class="dv">..\d</span><span class="vs">ata</span><span class="ch">\n</span><span class="vs">asdaq_all_close_volume</span><span class="dv">.</span><span class="vs">parquet"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"Date"</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">"Date"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.dropna(subset<span class="op">=</span>[<span class="st">"Date"</span>]).sort_values(<span class="st">"Date"</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>close_map, vol_map <span class="op">=</span> {}, {}</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> df.columns:</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    c <span class="op">=</span> <span class="bu">str</span>(c)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> c <span class="op">==</span> <span class="st">"Date"</span> <span class="kw">or</span> <span class="st">"__"</span> <span class="kw">not</span> <span class="kw">in</span> c:</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    t, f <span class="op">=</span> c.rsplit(<span class="st">"__"</span>, <span class="dv">1</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    f <span class="op">=</span> f.lower()</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> f <span class="op">==</span> <span class="st">"close"</span>:</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>        close_map[t] <span class="op">=</span> c</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> f <span class="op">==</span> <span class="st">"volume"</span>:</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        vol_map[t] <span class="op">=</span> c</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>common <span class="op">=</span> <span class="bu">sorted</span>(<span class="bu">set</span>(close_map).intersection(vol_map))</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>close_prices <span class="op">=</span> df[[close_map[t] <span class="cf">for</span> t <span class="kw">in</span> common]].copy()<span class="op">;</span> close_prices.columns <span class="op">=</span> common</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>volumes <span class="op">=</span> df[[vol_map[t] <span class="cf">for</span> t <span class="kw">in</span> common]].copy()<span class="op">;</span> volumes.columns <span class="op">=</span> common</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>close_prices.index <span class="op">=</span> df[<span class="st">"Date"</span>]</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>volumes.index <span class="op">=</span> df[<span class="st">"Date"</span>]</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>close_prices <span class="op">=</span> close_prices.<span class="bu">apply</span>(pd.to_numeric, errors<span class="op">=</span><span class="st">"coerce"</span>).replace([np.inf, <span class="op">-</span>np.inf], np.nan).astype(np.float32)</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>volumes <span class="op">=</span> volumes.<span class="bu">apply</span>(pd.to_numeric, errors<span class="op">=</span><span class="st">"coerce"</span>).replace([np.inf, <span class="op">-</span>np.inf], np.nan).astype(np.float32)</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>start <span class="op">=</span> pd.Timestamp(<span class="st">"2016-01-01"</span>)</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>close_prices <span class="op">=</span> close_prices.loc[close_prices.index <span class="op">&gt;=</span> start]</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>volumes <span class="op">=</span> volumes.loc[volumes.index <span class="op">&gt;=</span> start]</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>end <span class="op">=</span> close_prices.index.<span class="bu">max</span>()</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>close_prices <span class="op">=</span> close_prices.loc[close_prices.index <span class="op">&lt;=</span> end]</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>volumes <span class="op">=</span> volumes.loc[volumes.index <span class="op">&lt;=</span> end]</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> close_prices.index.intersection(volumes.index)</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>cols <span class="op">=</span> close_prices.columns.intersection(volumes.columns)</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>close_prices <span class="op">=</span> close_prices.loc[idx, cols]</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>volumes <span class="op">=</span> volumes.loc[idx, cols]</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>first_close <span class="op">=</span> close_prices.<span class="bu">apply</span>(pd.Series.first_valid_index)</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>first_vol   <span class="op">=</span> volumes.<span class="bu">apply</span>(pd.Series.first_valid_index)</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>first_date <span class="op">=</span> pd.concat([first_close, first_vol], axis<span class="op">=</span><span class="dv">1</span>).<span class="bu">max</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> close_prices.pct_change(fill_method<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> returns.replace([np.inf, <span class="op">-</span>np.inf], np.nan).astype(np.float32)</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"close_prices:"</span>, close_prices.shape, <span class="st">"volumes:"</span>, volumes.shape, <span class="st">"returns:"</span>, returns.shape)</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Date range:"</span>, returns.index.<span class="bu">min</span>().date(), <span class="st">"to"</span>, returns.index.<span class="bu">max</span>().date())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>close_prices: (2532, 4382) volumes: (2532, 4382) returns: (2532, 4382)
Date range: 2016-01-04 to 2026-01-28</code></pre>
</div>
</div>
</section>
<section id="rebalance-dates" class="level2">
<h2 class="anchored" data-anchor-id="rebalance-dates">3) Rebalance dates</h2>
<p>for optimizing a portfolio we have to use past data (like mu and cov estimation) to optimize the model on past and use the optimal weights in future and expect to get same results as what we got from past. we will never get the same results unless market exactly repeats itself. so we have to test our model out of sample to see the real performance. Also we have to use <strong>rebalancing</strong>. for example if we want to test a model in one year, we can optimize the model on the past 5 years and test it on this year, but in one year markets can change a lot and estimations of model become irrelevant. so we can use rebalancing and for each month of that year, take the past year of that month as our in-sample and test the optimal weights on that month and then go to the next month and repeat this process every month. in this way we include up to date data in our model and update the weights faster and adapt to market regimes faster.</p>
<p>In this project we use monthly rebalancing with 1 year lookback window for each month.</p>
<p>We rebalance at the last available trading day of each period</p>
<div id="6f679a2c" class="cell" data-execution_count="40">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>rebal_dates_raw <span class="op">=</span> (</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    returns.groupby(pd.Grouper(freq<span class="op">=</span><span class="st">"ME"</span>))</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>           .<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.index[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>           .dropna()</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>rebal_dates <span class="op">=</span> pd.DatetimeIndex(rebal_dates_raw.values)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Candidate rebalance dates:"</span>, <span class="bu">len</span>(rebal_dates))</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"First 3:"</span>, [d.date() <span class="cf">for</span> d <span class="kw">in</span> rebal_dates[:<span class="dv">3</span>]])</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Last 3:"</span>, [d.date() <span class="cf">for</span> d <span class="kw">in</span> rebal_dates[<span class="op">-</span><span class="dv">3</span>:]])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Candidate rebalance dates: 121
First 3: [datetime.date(2016, 1, 29), datetime.date(2016, 2, 29), datetime.date(2016, 3, 31)]
Last 3: [datetime.date(2025, 11, 28), datetime.date(2025, 12, 31), datetime.date(2026, 1, 28)]</code></pre>
</div>
</div>
</section>
<section id="liquidity-filtered-stock-selection" class="level2">
<h2 class="anchored" data-anchor-id="liquidity-filtered-stock-selection">4) Liquidity-filtered stock selection</h2>
<p>Right now our dataset contains hundreds of stocks. At each rebalance date <span class="math inline">\(t \in \mathcal{T}\)</span>, we want to include some of the stocks that have the most liquidity and certain data in that date. So we want to build a tradable combination of stocks <span class="math inline">\({U}_t\)</span>.</p>
<section id="minimum-history" class="level3">
<h3 class="anchored" data-anchor-id="minimum-history">4.1 Minimum history</h3>
<p>A ticker is included only if it has at least <span class="math inline">\(D\)</span> valid daily observations before <span class="math inline">\(t\)</span>. The asset must exist long enough that estimates are meaningful.</p>
<p>We set <span class="math inline">\(D\)</span> as 252 days or 1 year</p>
</section>
<section id="average-dollar-volume-adv" class="level3">
<h3 class="anchored" data-anchor-id="average-dollar-volume-adv">4.2 Average Dollar Volume (ADV)</h3>
<p>We define daily dollar volume as Volume multiplied by Prices: <span class="math display">\[
DV_{\tau,i} = P_{\tau,i} V_{\tau,i}
\]</span></p>
<p>Compute average dollar volume over a window of length <span class="math inline">\(L\)</span> (using only <span class="math inline">\(\tau &lt; t\)</span>): <span class="math display">\[
ADV_{t,i} = \frac{1}{L} \sum_{\tau=t-L}^{t-1} DV_{\tau,i}
\]</span></p>
<p>We set <span class="math inline">\(L\)</span> as 1 year to capture the stocks with most <span class="math inline">\(ADV\)</span> in the past year of that month.</p>
</section>
<section id="selection-rule-top-k-liquidity" class="level3">
<h3 class="anchored" data-anchor-id="selection-rule-top-k-liquidity">4.3 Selection rule (Top-K liquidity)</h3>
<p>Let <span class="math inline">\(K\)</span> be the target universe size (We use 100).<br>
We select: <span class="math display">\[
{U}_t = \operatorname{TopK}\big(ADV_{t,i}\big)
\]</span></p>
<p>in this way we don’t have survivorship bias and we only use big stocks of that time, not the stocks that we already know are big now but were not back then.</p>
<div id="49b82947" class="cell" data-execution_count="41">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> select_liquid_universe(dt, close_prices, volumes, top_n, liq_lookback, min_listing_days, min_obs):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> close_prices.index</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> dt <span class="kw">not</span> <span class="kw">in</span> idx:</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [], pd.Series(dtype<span class="op">=</span>np.float32)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    pos <span class="op">=</span> idx.get_loc(dt)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(pos, <span class="bu">slice</span>):</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        pos <span class="op">=</span> pos.stop <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    need <span class="op">=</span> <span class="bu">max</span>(min_listing_days, liq_lookback)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pos <span class="op">&lt;</span> need:</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [], pd.Series(dtype<span class="op">=</span>np.float32)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    cutoff_date <span class="op">=</span> idx[pos <span class="op">-</span> min_listing_days]</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    seasoned <span class="op">=</span> (first_date.notna()) <span class="op">&amp;</span> (first_date <span class="op">&lt;=</span> cutoff_date)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    cols <span class="op">=</span> close_prices.columns[seasoned.reindex(close_prices.columns).fillna(<span class="va">False</span>).values]</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    start <span class="op">=</span> pos <span class="op">-</span> liq_lookback</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    end <span class="op">=</span> pos</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    c <span class="op">=</span> close_prices.iloc[start:end][cols]</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    v <span class="op">=</span> volumes.iloc[start:end][cols]</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    dv <span class="op">=</span> c <span class="op">*</span> v</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    obs_ok <span class="op">=</span> dv.notna().<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>) <span class="op">&gt;=</span> min_obs</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    pos_ok <span class="op">=</span> (dv <span class="op">&gt;</span> <span class="dv">0</span>).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>) <span class="op">&gt;=</span> min_obs</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    selected <span class="op">=</span> dv.columns[obs_ok <span class="op">&amp;</span> pos_ok]</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    adv <span class="op">=</span> dv[selected].mean(axis<span class="op">=</span><span class="dv">0</span>, skipna<span class="op">=</span><span class="va">True</span>).replace([np.inf, <span class="op">-</span>np.inf], np.nan).dropna()</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(adv) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [], pd.Series(dtype<span class="op">=</span>np.float32)</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    top <span class="op">=</span> adv.nlargest(<span class="bu">min</span>(<span class="bu">int</span>(top_n), <span class="bu">len</span>(adv)))</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> top.index.tolist(), top.astype(np.float32)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="expected-return-model-momentum-signal-for-mu_t" class="level2">
<h2 class="anchored" data-anchor-id="expected-return-model-momentum-signal-for-mu_t">5) Expected return model: momentum signal for <span class="math inline">\(\mu_t\)</span></h2>
<p>Min-Var models only try to optimize based on risk (Covariance) but Mean-Var and Max-Sharpe models need an expected-return vector <span class="math inline">\(\mu_t\)</span>. if we use an average of returns in a period, it can be noisy and the model will not generalize based on that. so we need a clear and stable estimation of <span class="math inline">\(\mu\)</span> in each period and rebalance.</p>
<p>We use a simple <strong>momentum model</strong> that is:</p>
<ul>
<li>easy to compute</li>
<li>consistent across universes</li>
<li>uses only past returns</li>
</ul>
<section id="lookback-cumulative-return" class="level3">
<h3 class="anchored" data-anchor-id="lookback-cumulative-return">5.1 Lookback cumulative return</h3>
<p>We pick a momentum lookback length <span class="math inline">\(H\)</span> (like 6 months or 126 trading days) and then Define cumulative simple return for asset <span class="math inline">\(i\)</span>: <span class="math display">\[
m_{t,i} = \prod_{\tau=t-H}^{t-1} (1+r_{\tau,i}) - 1
\]</span></p>
<p>(If you use log returns, you can equivalently use a sum of log returns.)</p>
</section>
<section id="cross-sectional-standardization-z-score" class="level3">
<h3 class="anchored" data-anchor-id="cross-sectional-standardization-z-score">5.2 Cross-sectional standardization (z-score)</h3>
<p>Momentum values are not comparable across time unless we standardize.<br>
We compute a cross-sectional z-score within the selected universe <span class="math inline">\(\mathcal{U}_t\)</span>:</p>
<p>If <span class="math inline">\(\bar{m}_t\)</span> is the mean of <span class="math inline">\(m_{t,i}\)</span> across <span class="math inline">\(i \in \mathcal{U}_t\)</span>, and <span class="math inline">\(s_t\)</span> is the cross-sectional standard deviation. Define: <span class="math display">\[
z_{t,i} = \frac{m_{t,i} - \bar{m}_t}{s_t}
\]</span></p>
<p>This makes <span class="math inline">\(z_{t,i}\)</span> dimensionless and stable across different regimes.</p>
</section>
<section id="mapping-the-signal-to-expected-returns" class="level3">
<h3 class="anchored" data-anchor-id="mapping-the-signal-to-expected-returns">5.3 Mapping the signal to expected returns</h3>
<p>A common simple mapping is: <span class="math display">\[
\mu_{t,i}^{(d)} = \kappa\, z_{t,i}
\]</span></p>
<p>Here <span class="math inline">\(\kappa\)</span> is a scaling constant that controls the magnitude of expected returns.</p>
<p>Two main ways to calculate <span class="math inline">\(\kappa\)</span>:</p>
<p><strong>(A) Target cross-sectional dispersion</strong> Choose a target daily standard deviation of expected returns, call it <span class="math inline">\(\sigma_\mu^{(d)}\)</span>, and set: <span class="math display">\[
\kappa = \frac{\sigma_\mu^{(d)}}{\operatorname{std}(z_t)}
\]</span></p>
<p><strong>(B) Target annual expected-return range</strong> If you want a typical annual spread of, say, <span class="math inline">\(\sigma_\mu^{(ann)}\)</span>, use: <span class="math display">\[
\sigma_\mu^{(d)} = \frac{\sigma_\mu^{(ann)}}{252}
\]</span> then we apply option (A) on <span class="math inline">\(\sigma_\mu^{(d)}\)</span> to get to <span class="math inline">\(\kappa\)</span>.</p>
<p>This model is deliberately simple: it gives the optimizer a stable ranking signal without overfitting.</p>
<div id="6f6b08a3" class="cell" data-execution_count="42">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> momentum_score_from_returns(ret_window, mode<span class="op">=</span><span class="st">"6-1"</span>):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    R <span class="op">=</span> ret_window.replace([np.inf, <span class="op">-</span>np.inf], np.nan).dropna(how<span class="op">=</span><span class="st">"any"</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    T <span class="op">=</span> <span class="bu">len</span>(R)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> T <span class="op">&lt;</span> <span class="dv">80</span>:</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> R.mean().values.astype(np.float64)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mode <span class="op">==</span> <span class="st">"12-1"</span>:</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        lookback, skip <span class="op">=</span> <span class="dv">252</span>, <span class="dv">21</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> mode <span class="op">==</span> <span class="st">"6-1"</span>:</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        lookback, skip <span class="op">=</span> <span class="dv">126</span>, <span class="dv">21</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> mode <span class="op">==</span> <span class="st">"3-0"</span>:</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        lookback, skip <span class="op">=</span> <span class="dv">63</span>, <span class="dv">0</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Unknown momentum mode"</span>)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> T <span class="op">&lt;</span> lookback <span class="op">+</span> skip <span class="op">+</span> <span class="dv">5</span>:</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        lookback <span class="op">=</span> <span class="bu">min</span>(lookback, <span class="bu">max</span>(<span class="dv">63</span>, T <span class="op">-</span> skip <span class="op">-</span> <span class="dv">1</span>))</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    R_use <span class="op">=</span> R.iloc[<span class="op">-</span>(lookback <span class="op">+</span> skip):]</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    R_mom <span class="op">=</span> R_use.iloc[:<span class="op">-</span>skip] <span class="cf">if</span> skip <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> R_use</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ((<span class="fl">1.0</span> <span class="op">+</span> R_mom).prod(axis<span class="op">=</span><span class="dv">0</span>) <span class="op">-</span> <span class="fl">1.0</span>).values.astype(np.float64)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> winsorize_and_zscore(x, p_lo<span class="op">=</span><span class="fl">0.05</span>, p_hi<span class="op">=</span><span class="fl">0.95</span>):</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> np.asarray(x, dtype<span class="op">=</span>np.float64)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    lo, hi <span class="op">=</span> np.quantile(x, [p_lo, p_hi])</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> np.clip(x, lo, hi)</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> x <span class="op">-</span> x.mean()</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">/</span> (x.std() <span class="op">+</span> <span class="fl">1e-12</span>)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> scale_mu_to_target_sharpe(mu_dir, cov_ann, target_sharpe_ann, mu_cap_ann):</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> np.asarray(mu_dir, dtype<span class="op">=</span>np.float64).flatten()</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> np.<span class="bu">all</span>(np.<span class="bu">abs</span>(mu) <span class="op">&lt;</span> <span class="fl">1e-12</span>):</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.zeros_like(mu)</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    A <span class="op">=</span> cov_ann <span class="op">+</span> <span class="fl">1e-8</span> <span class="op">*</span> np.eye(cov_ann.shape[<span class="dv">0</span>])</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> np.linalg.solve(A, mu)</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> np.linalg.LinAlgError:</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> np.linalg.lstsq(A, mu, rcond<span class="op">=</span><span class="va">None</span>)[<span class="dv">0</span>]</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>    q <span class="op">=</span> <span class="bu">float</span>(mu <span class="op">@</span> x)</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">not</span> np.isfinite(q)) <span class="kw">or</span> q <span class="op">&lt;=</span> <span class="fl">1e-18</span>:</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.zeros_like(mu)</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> <span class="bu">float</span>(target_sharpe_ann) <span class="op">/</span> np.sqrt(q)</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.clip(s <span class="op">*</span> mu, <span class="op">-</span>mu_cap_ann, mu_cap_ann)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="covariance-estimation-building-sigma_t" class="level2">
<h2 class="anchored" data-anchor-id="covariance-estimation-building-sigma_t">6) Covariance estimation: building <span class="math inline">\(\Sigma_t\)</span></h2>
<p>Risk is represented by the covariance matrix <span class="math inline">\(\Sigma_t\)</span> of returns for the current set of stocks <span class="math inline">\(\mathcal{S}_t\)</span>.</p>
<p>If <span class="math inline">\(R_t \in \mathbb{R}^{T \times N}\)</span> is the matrix of past returns (columns are assets), in the estimation window <span class="math inline">\([t-T,\,t)\)</span>.</p>
<p>We set <span class="math inline">\(\bar{r}\)</span> as the sample mean vector in the window.the demeaned matrix will be: <span class="math display">\[
\tilde{R}_t = R_t - \mathbf{1}\bar{r}^\top
\]</span></p>
<p><span class="math display">\[
\tilde{R}_t \;=\;
\begin{bmatrix}
r_{t-T,1}-\bar r_1 &amp; r_{t-T,2}-\bar r_2 &amp; \cdots &amp; r_{t-T,N}-\bar r_N\\
r_{t-T+1,1}-\bar r_1 &amp; r_{t-T+1,2}-\bar r_2 &amp; \cdots &amp; r_{t-T+1,N}-\bar r_N\\
\vdots &amp; \vdots &amp; \ddots &amp; \vdots\\
r_{t-1,1}-\bar r_1 &amp; r_{t-1,2}-\bar r_2 &amp; \cdots &amp; r_{t-1,N}-\bar r_N
\end{bmatrix}
\]</span></p>
<section id="sample-covariance" class="level3">
<h3 class="anchored" data-anchor-id="sample-covariance">6.1 Sample covariance</h3>
<p>The classic estimator is: <span class="math display">\[
S_t = \frac{1}{T-1}\tilde{R}_t^\top \tilde{R}_t
\]</span></p>
<p>This is unbiased under ideal assumptions, but <span class="math inline">\(S_t\)</span> can be noisy when <span class="math inline">\(T\)</span> is not much larger than <span class="math inline">\(N\)</span>.</p>
<p><span class="math display">\[
\Sigma =
\begin{bmatrix}
\operatorname{Var}(r_1) &amp; \operatorname{Cov}(r_1,r_2) &amp; \cdots &amp; \operatorname{Cov}(r_1,r_N)\\
\operatorname{Cov}(r_2,r_1) &amp; \operatorname{Var}(r_2) &amp; \cdots &amp; \operatorname{Cov}(r_2,r_N)\\
\vdots &amp; \vdots &amp; \ddots &amp; \vdots\\
\operatorname{Cov}(r_N,r_1) &amp; \operatorname{Cov}(r_N,r_2) &amp; \cdots &amp; \operatorname{Var}(r_N)
\end{bmatrix}
\qquad
\operatorname{Cov}(r_i,r_j)=s_{ij}=\frac{1}{T-1}\sum_{k=1}^{T}\tilde r_{k,i}\tilde r_{k,j}
\]</span></p>
</section>
<section id="diagonal-covariance-no-correlations" class="level3">
<h3 class="anchored" data-anchor-id="diagonal-covariance-no-correlations">6.2 Diagonal covariance (no correlations)</h3>
<p>A “failsafe” stable model sets correlations to zero: <span class="math display">\[
\Sigma_t = \operatorname{diag}(S_t)
\]</span></p>
<p>From <span class="math inline">\(S_t=[s_{ij}]\)</span>, the diagonal-only covariance is</p>
<p><span class="math display">\[
\Sigma_{\text{diag}} =
\begin{bmatrix}
\operatorname{Var}(r_1) &amp; 0 &amp; \cdots &amp; 0\\
0 &amp; \operatorname{Var}(r_2) &amp; \cdots &amp; 0\\
\vdots &amp; \vdots &amp; \ddots &amp; \vdots\\
0 &amp; 0 &amp; \cdots &amp; \operatorname{Var}(r_N)
\end{bmatrix}
\]</span> This reduces estimation error but the cost is ignoring diversification effects.</p>
</section>
<section id="shrinkage-estimators-ledoitwolf-oas-intuition" class="level3">
<h3 class="anchored" data-anchor-id="shrinkage-estimators-ledoitwolf-oas-intuition">6.3 Shrinkage estimators (Ledoit–Wolf / OAS intuition)</h3>
<p>Shrinkage stabilizes covariance by mixing the noisy sample estimate with a structured target: <span class="math display">\[
\Sigma_t = (1-\delta)S_t + \delta F_t
\]</span></p>
<p>Typical target choices are: - scaled identity: <span class="math inline">\(F_t = \bar{\sigma}^2 I\)</span> where <span class="math inline">\(\bar{\sigma}^2\)</span> is average variance - diagonal target: <span class="math inline">\(F_t = \operatorname{diag}(S_t)\)</span></p>
<p>The shrinkage intensity <span class="math inline">\(\delta \in [0,1]\)</span> is chosen automatically by the estimator (Ledoit–Wolf or OAS).<br>
Interpretation: when data is noisy, we can increase <span class="math inline">\(\delta\)</span> to reduce extreme correlations.</p>
</section>
<section id="ewma-covariance-time-decayed-risk" class="level3">
<h3 class="anchored" data-anchor-id="ewma-covariance-time-decayed-risk">6.4 EWMA covariance (time-decayed risk)</h3>
<p>EWMA weights recent returns more, capturing volatility clustering.</p>
<p>we set <span class="math inline">\(\lambda \in (0,1)\)</span> as the decay (example: 0.94).<br>
Define demeaned return vector <span class="math inline">\(\tilde{r}_{t-1} = r_{t-1} - \bar{r}\)</span> and update: <span class="math display">\[
\Sigma_t = \lambda \Sigma_{t-1} + (1-\lambda)\tilde{r}_{t-1}\tilde{r}_{t-1}^\top
\]</span></p>
<p>EWMA is popular because it reacts faster to regime changes than the sample covariance.</p>
<div id="6a7def1b" class="cell" data-execution_count="43">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>ewma_lambda <span class="op">=</span> <span class="fl">0.94</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>jitter, psd_eps <span class="op">=</span> <span class="fl">1e-10</span>, <span class="fl">1e-10</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_psd(sigma, eps<span class="op">=</span><span class="fl">1e-10</span>):</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    sigma <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> (sigma <span class="op">+</span> sigma.T)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    vals, vecs <span class="op">=</span> np.linalg.eigh(sigma)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    vals <span class="op">=</span> np.maximum(vals, eps)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> (vecs <span class="op">*</span> vals) <span class="op">@</span> vecs.T</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fl">0.5</span> <span class="op">*</span> (out <span class="op">+</span> out.T)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ewma_covariance(x, lam<span class="op">=</span><span class="fl">0.94</span>):</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> x <span class="op">-</span> x.mean(axis<span class="op">=</span><span class="dv">0</span>, keepdims<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    T, N <span class="op">=</span> x.shape</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    S <span class="op">=</span> np.zeros((N, N), dtype<span class="op">=</span>np.float64)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> <span class="fl">1.0</span> <span class="op">-</span> lam</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(T):</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>        xt <span class="op">=</span> x[t][:, <span class="va">None</span>]</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>        S <span class="op">=</span> lam <span class="op">*</span> S <span class="op">+</span> a <span class="op">*</span> (xt <span class="op">@</span> xt.T)</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    scale <span class="op">=</span> <span class="fl">1.0</span> <span class="op">-</span> (lam <span class="op">**</span> <span class="bu">max</span>(T, <span class="dv">1</span>))</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> scale <span class="op">&gt;</span> <span class="fl">1e-12</span>:</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>        S <span class="op">=</span> S <span class="op">/</span> scale</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> S</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> estimate_covariance(window):</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> window.values.astype(np.float64)</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    nn <span class="op">=</span> x.shape[<span class="dv">1</span>]</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    cov_daily <span class="op">=</span> {</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">"SampleCov"</span>: np.cov(x, rowvar<span class="op">=</span><span class="va">False</span>, ddof<span class="op">=</span><span class="dv">1</span>).astype(np.float64),</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">"LedoitWolf"</span>: LedoitWolf().fit(x).covariance_.astype(np.float64),</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">"OAS"</span>: OAS().fit(x).covariance_.astype(np.float64),</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">"EWMA"</span>: ewma_covariance(x, lam<span class="op">=</span>ewma_lambda).astype(np.float64),</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> {}</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k, c <span class="kw">in</span> cov_daily.items():</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>        c <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> (c <span class="op">+</span> c.T)</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>        c <span class="op">+=</span> jitter <span class="op">*</span> np.eye(nn)</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>        out[k] <span class="op">=</span> <span class="fl">252.0</span> <span class="op">*</span> make_psd(c, psd_eps)</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> out</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="portfolio-return-and-variance" class="level2">
<h2 class="anchored" data-anchor-id="portfolio-return-and-variance">7) Portfolio return and variance</h2>
<p>Before we optimize anything, we need to know what:</p>
<ol type="1">
<li>expected return vector <span class="math inline">\(\mu\)</span><br>
</li>
<li>covariance matrix <span class="math inline">\(\Sigma\)</span></li>
</ol>
<p>is and we need to understand how they translate into <strong>portfolio return</strong> and <strong>portfolio risk</strong>.</p>
<hr>
<section id="portfolio-weights" class="level3">
<h3 class="anchored" data-anchor-id="portfolio-weights">7.1 Portfolio weights</h3>
<p>We suppose the portfolio weights of all the stocks we picked are <span class="math display">\[
w =
\begin{bmatrix}
w_1\\
w_2\\
\vdots\\
w_N
\end{bmatrix},
\qquad
\mathbf{1}^\top w = 1
\]</span></p>
<ul>
<li><span class="math inline">\(w_i\)</span> is the fraction of capital invested in asset <span class="math inline">\(i\)</span></li>
<li><span class="math inline">\(\mathbf{1}^\top w = 1\)</span> means all the investment which is 1 because we don’t use leverage or short-selling.</li>
<li>for long-only portfolios we also require <span class="math inline">\(w \ge 0\)</span></li>
</ul>
<hr>
</section>
<section id="portfolio-return" class="level3">
<h3 class="anchored" data-anchor-id="portfolio-return">7.2 Portfolio return</h3>
<p>all assets return vector for each period is <span class="math display">\[
r =
\begin{bmatrix}
r_1\\
r_2\\
\vdots\\
r_N
\end{bmatrix}
\]</span></p>
<p>Then the portfolio return is the weighted sum of these returns: <span class="math display">\[
r_p = w^\top r
\]</span></p>
<p>or <span class="math display">\[
r_p =
\begin{bmatrix}
w_1 &amp; w_2 &amp; \cdots &amp; w_N
\end{bmatrix}
\begin{bmatrix}
r_1\\
r_2\\
\vdots\\
r_N
\end{bmatrix}
= \sum_{i=1}^{N} w_i r_i
\]</span></p>
<hr>
</section>
<section id="expected-portfolio-return" class="level3">
<h3 class="anchored" data-anchor-id="expected-portfolio-return">7.3 Expected portfolio return</h3>
<p>This ia what the optimizer targets We define the expected return vector for each period: <span class="math display">\[
r_p=
\begin{bmatrix}
r_{p,1}\\
r_{p,2}\\
\vdots\\
r_{p,T}
\end{bmatrix}=
\begin{bmatrix}
r_{1,1} &amp; r_{1,2} &amp; \cdots &amp; r_{1,N}\\
r_{2,1} &amp; r_{2,2} &amp; \cdots &amp; r_{2,N}\\
\vdots &amp; \vdots &amp; \ddots &amp; \vdots\\
r_{T,1} &amp; r_{T,2} &amp; \cdots &amp; r_{T,N}
\end{bmatrix}
\begin{bmatrix}
w_1\\
w_2\\
\vdots\\
w_N
\end{bmatrix}
\]</span></p>
<p>expectation of <span class="math inline">\(r_p\)</span> is: <span class="math display">\[
\mathbb{E}[r_p] = \mathbb{E}[w^\top r] = w^\top \mathbb{E}[r] = w^\top \mu
\]</span></p>
<p>Expanded: <span class="math display">\[
\mathbb{E}[r_p] = \sum_{i=1}^{N} w_i \mu_i
\]</span></p>
<p>This is what we optimize when we want to maximize the expected return of our portfolio</p>
<hr>
</section>
<section id="portfolio-variance-risk" class="level3">
<h3 class="anchored" data-anchor-id="portfolio-variance-risk">7.4 Portfolio variance (risk)</h3>
<p>Risk in classical mean–variance is measured by <strong>variance</strong>.</p>
<p>The covariance matrix is: <span class="math display">\[
\Sigma=
\begin{bmatrix}
\sigma_{11} &amp; \sigma_{12} &amp; \cdots &amp; \sigma_{1N}\\
\sigma_{21} &amp; \sigma_{22} &amp; \cdots &amp; \sigma_{2N}\\
\vdots &amp; \vdots &amp; \ddots &amp; \vdots\\
\sigma_{N1} &amp; \sigma_{N2} &amp; \cdots &amp; \sigma_{NN}
\end{bmatrix},
\]</span></p>
<p>The portfolio variance is the quadratic form: <span class="math display">\[
\operatorname{Var}(r_p) = \operatorname{Var}(w^\top r) = w^\top \Sigma w
\]</span></p>
<p>Or in expanded form:</p>
<p><span class="math display">\[
w^\top \Sigma w =
\begin{bmatrix}
w_1 &amp; w_2 &amp; \cdots &amp; w_N
\end{bmatrix}
\begin{bmatrix}
\sigma_{11} &amp; \sigma_{12} &amp; \cdots &amp; \sigma_{1N}\\
\sigma_{21} &amp; \sigma_{22} &amp; \cdots &amp; \sigma_{2N}\\
\vdots &amp; \vdots &amp; \ddots &amp; \vdots\\
\sigma_{N1} &amp; \sigma_{N2} &amp; \cdots &amp; \sigma_{NN}
\end{bmatrix}
\begin{bmatrix}
w_1\\
w_2\\
\vdots\\
w_N
\end{bmatrix}=
\sum_{i=1}^{N}\sum_{j=1}^{N} w_i\sigma_{ij}w_j
\]</span></p>
<ul>
<li>The <strong>diagonal terms</strong> <span class="math inline">\(w_i^2 \sigma_{ii}\)</span> are the <strong>individual risk</strong> contributions (variances).</li>
<li>The <strong>off-diagonal terms</strong> <span class="math inline">\(w_i w_j \sigma_{ij}\)</span> capture <strong>correlations</strong> (diversification effects).</li>
</ul>
<hr>
</section>
<section id="portfolio-volatility" class="level3">
<h3 class="anchored" data-anchor-id="portfolio-volatility">7.5 Portfolio volatility</h3>
<p>Often we use volatility as standard deviation instead of variance for analyzing portfolio performance: <span class="math display">\[
\sigma_p = \sqrt{w^\top \Sigma w}
\]</span></p>
<p>Variance is mathematically convenient for optimization; volatility is easier to interpret.</p>
<hr>
</section>
</section>
<section id="build-estimation-cache-at-rebalance-dates" class="level2">
<h2 class="anchored" data-anchor-id="build-estimation-cache-at-rebalance-dates">Build estimation cache at rebalance dates</h2>
<p>For each rebalance date we store: - active tickers (liquidity-selected) - return window - covariance maps - scaled annual excess returns <span class="math inline">\(\mu\)</span></p>
<p>This speeds up the backtest.</p>
<div id="8ad2fa21" class="cell" data-execution_count="44">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>cache <span class="op">=</span> {}</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rebalances_per_year(rebal_dates_index):</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> pd.DatetimeIndex(rebal_dates_index)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(idx) <span class="op">&lt;</span> <span class="dv">2</span>:</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">1.0</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    per_year <span class="op">=</span> pd.Series(<span class="dv">1</span>, index<span class="op">=</span>idx).resample(<span class="st">"YE"</span>).<span class="bu">sum</span>()</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">float</span>(per_year.median())</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> dt <span class="kw">in</span> rebal_dates:</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    pos <span class="op">=</span> returns.index.get_loc(dt)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(pos, <span class="bu">slice</span>):</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        pos <span class="op">=</span> pos.stop <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pos <span class="op">&lt;</span> <span class="dv">252</span>:</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    liquid_tickers, avg_dollar_volume <span class="op">=</span> select_liquid_universe(dt,close_prices, volumes, top_n<span class="op">=</span><span class="dv">100</span>, liq_lookback<span class="op">=</span><span class="dv">252</span>,</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    min_listing_days<span class="op">=</span><span class="dv">252</span>, min_obs<span class="op">=</span><span class="dv">252</span>,)</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(liquid_tickers) <span class="op">&lt;</span> <span class="dv">2</span>:</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    close_for_model <span class="op">=</span> close_prices[liquid_tickers].iloc[pos <span class="op">-</span> <span class="dv">252</span>:pos]</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> close_for_model.shape[<span class="dv">0</span>] <span class="op">&lt;</span> <span class="dv">252</span>:</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    window <span class="op">=</span> close_for_model.pct_change(fill_method<span class="op">=</span><span class="va">None</span>).iloc[<span class="dv">1</span>:]</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    window <span class="op">=</span> window.replace([np.inf, <span class="op">-</span>np.inf], np.nan).dropna(axis<span class="op">=</span><span class="dv">0</span>, how<span class="op">=</span><span class="st">"any"</span>)</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> window.shape[<span class="dv">0</span>] <span class="op">&lt;</span> <span class="dv">251</span> <span class="kw">or</span> window.shape[<span class="dv">1</span>] <span class="op">&lt;</span> <span class="dv">2</span>:</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    active_tickers <span class="op">=</span> window.columns.tolist()</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    window <span class="op">=</span> window.astype(np.float32)</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    cov_ann_map <span class="op">=</span> estimate_covariance(window)</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>    cov_ann <span class="op">=</span> cov_ann_map[<span class="st">"LedoitWolf"</span>]</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>    score <span class="op">=</span> momentum_score_from_returns(window, mode<span class="op">=</span><span class="st">"6-1"</span>)</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> winsorize_and_zscore(score, <span class="fl">0.05</span>, <span class="fl">0.95</span>)</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>    mu_excess_ann <span class="op">=</span> scale_mu_to_target_sharpe(z, cov_ann, <span class="fl">0.80</span>, <span class="fl">0.30</span>)</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>    cache[dt] <span class="op">=</span> {</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">"R"</span>: window,</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">"mu_excess_ann"</span>: mu_excess_ann,</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">"cov_ann_map"</span>: cov_ann_map,</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tickers"</span>: active_tickers,</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>        <span class="st">"avg_dollar_volume"</span>: avg_dollar_volume.reindex(active_tickers).astype(np.float32),</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>rebal_dates <span class="op">=</span> [d <span class="cf">for</span> d <span class="kw">in</span> rebal_dates <span class="cf">if</span> d <span class="kw">in</span> cache]</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(rebal_dates) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"No rebalance dates"</span>)</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>universe_size <span class="op">=</span> pd.Series({dt: <span class="bu">len</span>(cache[dt][<span class="st">"tickers"</span>]) <span class="cf">for</span> dt <span class="kw">in</span> rebal_dates}, name<span class="op">=</span><span class="st">"UniverseSize"</span>)</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Universe size across rebalances: min=</span><span class="sc">{</span>universe_size<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss">, max=</span><span class="sc">{</span>universe_size<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">, mean=</span><span class="sc">{</span>universe_size<span class="sc">.</span>mean()<span class="sc">:.1f}</span><span class="ss">"</span>)</span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>rebal_per_year <span class="op">=</span> rebalances_per_year(rebal_dates)</span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>rf_daily <span class="op">=</span> (<span class="fl">1.0</span> <span class="op">+</span> rf) <span class="op">**</span> (<span class="fl">1.0</span> <span class="op">/</span> <span class="fl">252.0</span>) <span class="op">-</span> <span class="fl">1.0</span></span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Rebalances per year (estimated):"</span>, <span class="bu">round</span>(rebal_per_year, <span class="dv">2</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Universe size across rebalances: min=100, max=100, mean=100.0
Rebalances per year (estimated): 12.0</code></pre>
</div>
</div>
</section>
<section id="optimization-problems-the-math-behind-each-model" class="level2">
<h2 class="anchored" data-anchor-id="optimization-problems-the-math-behind-each-model">8) Optimization problems (the math behind each model)</h2>
<p>At each rebalance date <span class="math inline">\(t\)</span>, we solve for target weights <span class="math inline">\(w_t\)</span> using <span class="math inline">\(\mu_t\)</span> and <span class="math inline">\(\Sigma_t\)</span> for the filtered set of stocks <span class="math inline">\(U_t\)</span>.</p>
<p>constraints are: <span class="math display">\[
\mathbf{1}^\top w_t = 1, \quad w_t \ge 0,\quad w_{t,i} \le w_{\max}
\]</span></p>
<section id="minimum-variance-minvar" class="level3">
<h3 class="anchored" data-anchor-id="minimum-variance-minvar">8.1 Minimum Variance (MinVar)</h3>
<p>MinVar ignores expected returns and finds the lowest-risk portfolio: <span class="math display">\[
\min_{w} \; w^\top \Sigma_t w
\]</span></p>
<p>This is a convex quadratic program (QP) under <span class="math inline">\(\Sigma_t \succeq 0\)</span>.</p>
<div id="cf5b24a9" class="cell" data-execution_count="45">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>cvx_cache <span class="op">=</span> {}</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>ridge_mv_gamma <span class="op">=</span> <span class="fl">12.0</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>cost_bps <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>solver_order <span class="op">=</span> [<span class="st">"OSQP"</span>, <span class="st">"CLARABEL"</span>, <span class="st">"ECOS"</span>, <span class="st">"SCS"</span>]</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>turnover_penalty_bps <span class="op">=</span> <span class="fl">10.0</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>long_only, w_min, w_max <span class="op">=</span> <span class="va">True</span>, <span class="fl">0.0</span>, <span class="fl">0.25</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>ridge <span class="op">=</span> <span class="fl">1e-4</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> safe_normalize_weights(w, w_min, w_max, long_only):</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> np.asarray(w, dtype<span class="op">=</span>np.float64).flatten()</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> long_only:</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>        w <span class="op">=</span> np.maximum(w, <span class="fl">0.0</span>)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> w_min <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        w <span class="op">=</span> np.maximum(w, w_min)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> w_max <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>        w <span class="op">=</span> np.minimum(w, w_max)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> w.<span class="bu">sum</span>()</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">not</span> np.isfinite(s)) <span class="kw">or</span> s <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> w <span class="op">/</span> s</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>):</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> long_only:</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>            w <span class="op">=</span> np.maximum(w, <span class="fl">0.0</span>)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> w_min <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>            w <span class="op">=</span> np.maximum(w, w_min)</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> w_max <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>            w <span class="op">=</span> np.minimum(w, w_max)</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>        s <span class="op">=</span> w.<span class="bu">sum</span>()</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> s <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>        w <span class="op">=</span> w <span class="op">/</span> s</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> w</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> kappa_annual(rebals_per_year_value):</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>    k <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>    k <span class="op">+=</span> cost_bps <span class="op">/</span> <span class="fl">10000.0</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    k <span class="op">+=</span> turnover_penalty_bps <span class="op">/</span> <span class="fl">10000.0</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">float</span>(rebals_per_year_value <span class="op">*</span> k)</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> solve_cvx(prob, var):</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> solver <span class="kw">in</span> solver_order:</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> solver <span class="op">==</span> <span class="st">"OSQP"</span>:</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>                kwargs <span class="op">=</span> {<span class="st">"max_iter"</span>: <span class="dv">8000</span>}</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> solver <span class="kw">in</span> (<span class="st">"ECOS"</span>, <span class="st">"SCS"</span>):</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>                kwargs <span class="op">=</span> {<span class="st">"max_iters"</span>: <span class="dv">10000</span>}</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>                kwargs <span class="op">=</span> {}</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>            prob.solve(solver<span class="op">=</span>solver, warm_start<span class="op">=</span><span class="va">True</span>, <span class="op">**</span>kwargs)</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> var.value <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>                w <span class="op">=</span> np.asarray(var.value, dtype<span class="op">=</span>np.float64).flatten()</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> np.<span class="bu">all</span>(np.isfinite(w)):</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> w</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> blend_weights(w_star, w_prev, eta):</span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>    eta <span class="op">=</span> <span class="bu">float</span>(np.clip(eta, <span class="fl">0.0</span>, <span class="fl">1.0</span>))</span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (<span class="fl">1.0</span> <span class="op">-</span> eta) <span class="op">*</span> np.asarray(w_star, dtype<span class="op">=</span>np.float64) <span class="op">+</span> eta <span class="op">*</span> np.asarray(w_prev, dtype<span class="op">=</span>np.float64)</span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> constraints_feasible(nn, w_min, w_max, long_only):</span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>    w_min_eff <span class="op">=</span> <span class="fl">0.0</span> <span class="cf">if</span> long_only <span class="cf">else</span> (<span class="op">-</span>np.inf <span class="cf">if</span> w_min <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> w_min)</span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>    w_max_eff <span class="op">=</span> np.inf <span class="cf">if</span> w_max <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> w_max</span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> np.isfinite(w_max_eff) <span class="kw">and</span> w_max_eff <span class="op">*</span> nn <span class="op">&lt;</span> <span class="fl">1.0</span> <span class="op">-</span> <span class="fl">1e-9</span>:</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> np.isfinite(w_min_eff) <span class="kw">and</span> w_min_eff <span class="op">*</span> nn <span class="op">&gt;</span> <span class="fl">1.0</span> <span class="op">+</span> <span class="fl">1e-9</span>:</span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">True</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="75a3c49f" class="cell" data-execution_count="46">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_minvar_solver(nn, ridge, kappa):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    key <span class="op">=</span> (<span class="st">"minvar"</span>, nn, ridge, kappa, w_min, w_max, long_only)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> key <span class="kw">in</span> cvx_cache:</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> cvx_cache[key]</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> cp.Variable(nn)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    S <span class="op">=</span> cp.Parameter((nn, nn), symmetric<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    w_prev <span class="op">=</span> cp.Parameter(nn)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    cons <span class="op">=</span> []</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> long_only:</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>        cons.append(w <span class="op">&gt;=</span> <span class="dv">0</span>)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> w_min <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>        cons.append(w <span class="op">&gt;=</span> w_min)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> w_max <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>        cons.append(w <span class="op">&lt;=</span> w_max)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    cons.append(cp.<span class="bu">sum</span>(w) <span class="op">==</span> <span class="dv">1</span>)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    obj <span class="op">=</span> cp.Minimize(cp.quad_form(w, cp.psd_wrap(S)) <span class="op">+</span> kappa <span class="op">*</span> <span class="fl">0.5</span> <span class="op">*</span> cp.norm1(w <span class="op">-</span> w_prev) <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> ridge <span class="op">*</span> cp.sum_squares(w))</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    problem <span class="op">=</span> cp.Problem(obj, cons)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    cvx_cache[key] <span class="op">=</span> (problem, w, S, w_prev)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> problem, w, S, w_prev</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> minvar_weights(cov_ann, w_prev, rpy):</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    nn <span class="op">=</span> cov_ann.shape[<span class="dv">0</span>]</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> constraints_feasible(nn, w_min, w_max, long_only):</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    prob, w_var, S_p, wprev_p <span class="op">=</span> get_minvar_solver(nn, ridge, kappa_annual(rpy))</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    S_p.value <span class="op">=</span> np.asarray(cov_ann, dtype<span class="op">=</span>np.float64)</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    wprev_p.value <span class="op">=</span> np.asarray(w_prev, dtype<span class="op">=</span>np.float64)</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> solve_cvx(prob, w_var)</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span> <span class="cf">if</span> w <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> safe_normalize_weights(w, w_min, w_max, long_only)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="meanvariance-utility-mv" class="level3">
<h3 class="anchored" data-anchor-id="meanvariance-utility-mv">8.2 Mean–Variance Utility (MV)</h3>
<p>In this model we use both return and risk and try to maximize this object with our weights: <span class="math display">\[
\max_{w}\; \mu_t^\top w - \frac{\gamma}{2} w^\top \Sigma_t w
\]</span></p>
<p>where: - <span class="math inline">\(\mu_t^\top w\)</span> is for maximizing the return - <span class="math inline">\(w^\top \Sigma_t w\)</span> is variance. we subtract it so the trade-off between risk and return happen and try to minimize risk for the cost of reducing return - <span class="math inline">\(\gamma &gt; 0\)</span> controls risk aversion. this parameter represents our importance of risk and how much we want to minimize it in respect to return.</p>
</section>
<section id="regularized-meanvariance-ridge-mv" class="level3">
<h3 class="anchored" data-anchor-id="regularized-meanvariance-ridge-mv">8.3 Regularized Mean–Variance (Ridge MV)</h3>
<p>When weights become unstable (high turnover, concentration),we can add an <span class="math inline">\(L_2\)</span> penalty: <span class="math display">\[
\max_{w}\; \mu_t^\top w - \frac{\gamma}{2} w^\top \Sigma_t w - \frac{\eta}{2}\lVert w\rVert_2^2
\]</span></p>
<p>This discourages extreme weight vectors and improves stability. You can interpret ridge as adding a multiple of the identity to risk: <span class="math display">\[
w^\top \Sigma_t w + \frac{\eta}{\gamma}\lVert w\rVert_2^2 = w^\top\left(\Sigma_t + \frac{\eta}{\gamma}I\right)w
\]</span></p>
</section>
<section id="turnover-aware-optimization-penalize-trading" class="level3">
<h3 class="anchored" data-anchor-id="turnover-aware-optimization-penalize-trading">8.4 Turnover-aware optimization (penalize trading)</h3>
<p>If <span class="math inline">\(w_{t^-}\)</span> is the portfolio just before rebalancing, turnover is: <span class="math display">\[
\operatorname{TO}_t = \sum_{i=1}^{N}\lvert w_{t,i} - w_{t^-,i}\rvert
\]</span></p>
<p>It shows us how much weights have changed in rebalancing. the more the weights change, the more unstable the weights get and also the transaction cost would be huge.</p>
<p>A simple way to reduce churn is to penalize turnover in the objective: <span class="math display">\[
\max_{w}\; \mu_t^\top w - \frac{\gamma}{2} w^\top \Sigma_t w - \kappa \operatorname{TO}_t
\]</span></p>
<p>This is convex and works well with CVXPY.</p>
<div id="4befa317" class="cell" data-execution_count="47">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>mv_lambda <span class="op">=</span> <span class="fl">6.0</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_mv_solver(nn, mv_lambda, ridge, kappa):</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    key <span class="op">=</span> (<span class="st">"mv"</span>, nn, mv_lambda, ridge, kappa, w_min, w_max, long_only)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> key <span class="kw">in</span> cvx_cache:</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> cvx_cache[key]</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> cp.Variable(nn)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> cp.Parameter(nn)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    S <span class="op">=</span> cp.Parameter((nn, nn), symmetric<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    w_prev <span class="op">=</span> cp.Parameter(nn)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    cons <span class="op">=</span> []</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> long_only:</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>        cons.append(w <span class="op">&gt;=</span> <span class="dv">0</span>)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> w_min <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>        cons.append(w <span class="op">&gt;=</span> w_min)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> w_max <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>        cons.append(w <span class="op">&lt;=</span> w_max)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    cons.append(cp.<span class="bu">sum</span>(w) <span class="op">==</span> <span class="dv">1</span>)</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    obj <span class="op">=</span> cp.Maximize(mu <span class="op">@</span> w <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> mv_lambda <span class="op">*</span> cp.quad_form(w, cp.psd_wrap(S))</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>                      <span class="op">-</span> kappa <span class="op">*</span> <span class="fl">0.5</span> <span class="op">*</span> cp.norm1(w <span class="op">-</span> w_prev)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>                      <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> ridge <span class="op">*</span> cp.sum_squares(w))</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    prob <span class="op">=</span> cp.Problem(obj, cons)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    cvx_cache[key] <span class="op">=</span> (prob, w, mu, S, w_prev)</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> prob, w, mu, S, w_prev</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_reg_mv_solver(nn, mv_lambda, ridge, kappa, gamma_l2):</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    key <span class="op">=</span> (<span class="st">"ridge_mv"</span>, nn, mv_lambda, ridge, kappa, gamma_l2, w_min, w_max, long_only)</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> key <span class="kw">in</span> cvx_cache:</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> cvx_cache[key]</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> cp.Variable(nn)</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> cp.Parameter(nn)</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>    S <span class="op">=</span> cp.Parameter((nn, nn), symmetric<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>    w_prev <span class="op">=</span> cp.Parameter(nn)</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>    cons <span class="op">=</span> []</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> long_only:</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>        cons.append(w <span class="op">&gt;=</span> <span class="dv">0</span>)</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> w_min <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>        cons.append(w <span class="op">&gt;=</span> w_min)</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> w_max <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>        cons.append(w <span class="op">&lt;=</span> w_max)</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>    cons.append(cp.<span class="bu">sum</span>(w) <span class="op">==</span> <span class="dv">1</span>)</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>    obj <span class="op">=</span> cp.Maximize(mu <span class="op">@</span> w <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> mv_lambda <span class="op">*</span> cp.quad_form(w, cp.psd_wrap(S)) <span class="op">-</span> kappa <span class="op">*</span> <span class="fl">0.5</span> <span class="op">*</span> cp.norm1(w <span class="op">-</span> w_prev) <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> (ridge <span class="op">+</span> gamma_l2) <span class="op">*</span> cp.sum_squares(w))</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>    prob <span class="op">=</span> cp.Problem(obj, cons)</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>    cvx_cache[key] <span class="op">=</span> (prob, w, mu, S, w_prev)</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> prob, w, mu, S, w_prev</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mv_weights(mu_excess_ann, cov_ann, w_prev, rpy):</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>    nn <span class="op">=</span> <span class="bu">len</span>(mu_excess_ann)</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> constraints_feasible(nn, w_min, w_max, long_only):</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>    prob, w_var, mu_p, S_p, wprev_p <span class="op">=</span> get_mv_solver(nn, mv_lambda, ridge, kappa_annual(rpy))</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>    mu_p.value <span class="op">=</span> np.asarray(mu_excess_ann, dtype<span class="op">=</span>np.float64)</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>    S_p.value <span class="op">=</span> np.asarray(cov_ann, dtype<span class="op">=</span>np.float64)</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>    wprev_p.value <span class="op">=</span> np.asarray(w_prev, dtype<span class="op">=</span>np.float64)</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> solve_cvx(prob, w_var)</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span> <span class="cf">if</span> w <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> safe_normalize_weights(w, w_min, w_max, long_only)</span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ridge_mv_weights(mu_excess_ann, cov_ann, w_prev, rpy):</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>    nn <span class="op">=</span> <span class="bu">len</span>(mu_excess_ann)</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> constraints_feasible(nn, w_min, w_max, long_only):</span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>    g2 <span class="op">=</span> ridge_mv_gamma <span class="op">/</span> <span class="bu">max</span>(nn, <span class="dv">1</span>)</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>    prob, w_var, mu_p, S_p, wprev_p <span class="op">=</span> get_reg_mv_solver(nn, mv_lambda, ridge, kappa_annual(rpy), g2)</span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>    mu_p.value <span class="op">=</span> np.asarray(mu_excess_ann, dtype<span class="op">=</span>np.float64)</span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>    S_p.value <span class="op">=</span> np.asarray(cov_ann, dtype<span class="op">=</span>np.float64)</span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>    wprev_p.value <span class="op">=</span> np.asarray(w_prev, dtype<span class="op">=</span>np.float64)</span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> solve_cvx(prob, w_var)</span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span> <span class="cf">if</span> w <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> safe_normalize_weights(w, w_min, w_max, long_only)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="max-sharpe-portfolios" class="level3">
<h3 class="anchored" data-anchor-id="max-sharpe-portfolios">8.5 Max-Sharpe portfolios</h3>
<p>The Sharpe ratio of a portfolio is the excess return on risk ratio of portfolio (comparing to risk free rate) and it’s a main measure for comparing investments: <span class="math display">\[
\operatorname{SR}(w) = \frac{\mu_t^\top w - r_f^{(d)}}{\sqrt{w^\top \Sigma_t w}}
\]</span></p>
<p>Directly maximizing this fraction is not a simple QP and can be unstable. also we use SLSQP from scipy instead of considering convex optimization</p>
</section>
<section id="max-sharpe-with-frontier-grid" class="level3">
<h3 class="anchored" data-anchor-id="max-sharpe-with-frontier-grid">8.6 Max Sharpe with Frontier grid</h3>
<p>We pick a grid of target returns <span class="math inline">\(m\)</span> values and get min variance weights for each <span class="math inline">\(m\)</span> and solve:</p>
<p><span class="math display">\[
\min_{w}\; w^\top \Sigma_t w
\]</span></p>
<p>subject to: <span class="math display">\[
\mu_t^\top w \ge m,\quad \mathbf{1}^\top w = 1,\quad w \ge 0,\quad w \le w_{\max}
\]</span></p>
<p>For each solution <span class="math inline">\(w(m)\)</span> we compute its Sharpe: <span class="math display">\[
\operatorname{SR}(w(m)) = \frac{\mu_t^\top w(m) - r_f^{(d)}}{\sqrt{w(m)^\top \Sigma_t w(m)}}
\]</span></p>
<p>And choose the best: <span class="math display">\[
w^\star = \arg\max_{m} \operatorname{SR}(w(m))
\]</span></p>
<p>This is slow but stable and avoids fragile non-convex solvers.</p>
<div id="be394387" class="cell" data-execution_count="48">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> max_sharpe_weights(mu_excess_ann, cov_ann, w_prev, rpy):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    nn <span class="op">=</span> <span class="bu">len</span>(mu_excess_ann)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> constraints_feasible(nn, w_min, w_max, long_only):</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    bounds <span class="op">=</span> [(<span class="fl">0.0</span> <span class="cf">if</span> long_only <span class="cf">else</span> (<span class="op">-</span><span class="fl">1.0</span> <span class="cf">if</span> w_min <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> w_min), <span class="fl">1.0</span> <span class="cf">if</span> w_max <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> w_max) <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(nn)]</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    x0 <span class="op">=</span> np.ones(nn, dtype<span class="op">=</span>np.float64) <span class="op">/</span> nn</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    kappa <span class="op">=</span> kappa_annual(rpy)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    mu_use <span class="op">=</span> np.asarray(mu_excess_ann, dtype<span class="op">=</span>np.float64)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> neg_obj(w):</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>        w <span class="op">=</span> np.asarray(w, dtype<span class="op">=</span>np.float64)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> np.<span class="bu">any</span>(<span class="op">~</span>np.isfinite(w)):</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fl">1e6</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>        ret <span class="op">=</span> <span class="bu">float</span>(mu_use <span class="op">@</span> w)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>        vol <span class="op">=</span> <span class="bu">float</span>(np.sqrt(w <span class="op">@</span> cov_ann <span class="op">@</span> w))</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> vol <span class="op">&lt;</span> <span class="fl">1e-12</span>:</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fl">1e6</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span>(ret <span class="op">/</span> vol) <span class="op">+</span> kappa <span class="op">*</span> <span class="fl">0.5</span> <span class="op">*</span> np.<span class="bu">sum</span>(np.<span class="bu">abs</span>(w <span class="op">-</span> w_prev)) <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> ridge <span class="op">*</span> np.<span class="bu">sum</span>(w<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> minimize(neg_obj, x0, method<span class="op">=</span><span class="st">"SLSQP"</span>, bounds<span class="op">=</span>bounds,</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>                   constraints<span class="op">=</span>({<span class="st">"type"</span>: <span class="st">"eq"</span>, <span class="st">"fun"</span>: <span class="kw">lambda</span> w: np.<span class="bu">sum</span>(w) <span class="op">-</span> <span class="fl">1.0</span>},),</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>                   options<span class="op">=</span>{<span class="st">"maxiter"</span>: <span class="dv">8000</span>})</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">not</span> result.success) <span class="kw">or</span> np.<span class="bu">any</span>(<span class="op">~</span>np.isfinite(result.x)):</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> safe_normalize_weights(result.x, w_min, w_max, long_only)</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sharpe_from_w(mu_excess_ann, cov_ann, w):</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> np.asarray(w, dtype<span class="op">=</span>np.float64).flatten()</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> <span class="bu">float</span>(np.dot(mu_excess_ann, w))</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    v <span class="op">=</span> <span class="bu">float</span>(np.sqrt(<span class="bu">max</span>(w <span class="op">@</span> cov_ann <span class="op">@</span> w, <span class="fl">1e-18</span>)))</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> r <span class="op">/</span> v <span class="cf">if</span> v <span class="op">&gt;</span> <span class="fl">1e-12</span> <span class="cf">else</span> <span class="op">-</span>np.inf</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_frontier_solver(nn, ridge, kappa):</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>    key <span class="op">=</span> (<span class="st">"frontier"</span>, nn, ridge, kappa, w_min, w_max, long_only)</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> key <span class="kw">in</span> cvx_cache:</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> cvx_cache[key]</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> cp.Variable(nn)</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> cp.Parameter(nn)</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>    S <span class="op">=</span> cp.Parameter((nn, nn), symmetric<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>    w_prev <span class="op">=</span> cp.Parameter(nn)</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>    r_target <span class="op">=</span> cp.Parameter(nonneg<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>    cons <span class="op">=</span> []</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> long_only:</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>        cons.append(w <span class="op">&gt;=</span> <span class="dv">0</span>)</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> w_min <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>        cons.append(w <span class="op">&gt;=</span> w_min)</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> w_max <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>        cons.append(w <span class="op">&lt;=</span> w_max)</span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>    cons.append(cp.<span class="bu">sum</span>(w) <span class="op">==</span> <span class="dv">1</span>)</span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>    cons.append(mu <span class="op">@</span> w <span class="op">&gt;=</span> r_target)</span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>    obj <span class="op">=</span> cp.Minimize(cp.quad_form(w, cp.psd_wrap(S)) <span class="op">+</span> kappa <span class="op">*</span> cp.norm1(w <span class="op">-</span> w_prev) <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> ridge <span class="op">*</span> cp.sum_squares(w))</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>    prob <span class="op">=</span> cp.Problem(obj, cons)</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>    cvx_cache[key] <span class="op">=</span> (prob, w, mu, S, w_prev, r_target)</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> prob, w, mu, S, w_prev, r_target</span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> greedy_max_return_weight(mu, w_max):</span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> np.asarray(mu, dtype<span class="op">=</span>np.float64).flatten()</span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(mu)</span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>    order <span class="op">=</span> np.argsort(mu)[::<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> np.zeros(n, dtype<span class="op">=</span>np.float64)</span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>    cap <span class="op">=</span> np.inf <span class="cf">if</span> w_max <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> <span class="bu">float</span>(w_max)</span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a>    remaining <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> order:</span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> remaining <span class="op">&lt;=</span> <span class="fl">1e-12</span>:</span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a>        add <span class="op">=</span> <span class="bu">min</span>(cap, remaining)</span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a>        w[i] <span class="op">=</span> add</span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a>        remaining <span class="op">-=</span> add</span>
<span id="cb15-76"><a href="#cb15-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> remaining <span class="op">&gt;</span> <span class="fl">1e-6</span>:</span>
<span id="cb15-77"><a href="#cb15-77" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb15-78"><a href="#cb15-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> w</span>
<span id="cb15-79"><a href="#cb15-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-80"><a href="#cb15-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-81"><a href="#cb15-81" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> max_sharpe_frontier_grid_weights(mu_excess_ann, cov_ann, w_prev, rpy, grid_n<span class="op">=</span><span class="dv">20</span>):</span>
<span id="cb15-82"><a href="#cb15-82" aria-hidden="true" tabindex="-1"></a>    nn <span class="op">=</span> <span class="bu">len</span>(mu_excess_ann)</span>
<span id="cb15-83"><a href="#cb15-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> constraints_feasible(nn, w_min, w_max, long_only):</span>
<span id="cb15-84"><a href="#cb15-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb15-85"><a href="#cb15-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-86"><a href="#cb15-86" aria-hidden="true" tabindex="-1"></a>    w_minv <span class="op">=</span> minvar_weights(cov_ann, w_prev, rpy)</span>
<span id="cb15-87"><a href="#cb15-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> w_minv <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb15-88"><a href="#cb15-88" aria-hidden="true" tabindex="-1"></a>        w_minv <span class="op">=</span> np.ones(nn, dtype<span class="op">=</span>np.float64) <span class="op">/</span> nn</span>
<span id="cb15-89"><a href="#cb15-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-90"><a href="#cb15-90" aria-hidden="true" tabindex="-1"></a>    w_maxr <span class="op">=</span> greedy_max_return_weight(mu_excess_ann, w_max)</span>
<span id="cb15-91"><a href="#cb15-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> w_maxr <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb15-92"><a href="#cb15-92" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb15-93"><a href="#cb15-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-94"><a href="#cb15-94" aria-hidden="true" tabindex="-1"></a>    r_lo <span class="op">=</span> <span class="bu">float</span>(np.dot(mu_excess_ann, w_minv))</span>
<span id="cb15-95"><a href="#cb15-95" aria-hidden="true" tabindex="-1"></a>    r_hi <span class="op">=</span> <span class="bu">float</span>(np.dot(mu_excess_ann, w_maxr))</span>
<span id="cb15-96"><a href="#cb15-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> np.isfinite(r_lo) <span class="kw">or</span> <span class="kw">not</span> np.isfinite(r_hi) <span class="kw">or</span> r_hi <span class="op">&lt;=</span> r_lo <span class="op">+</span> <span class="fl">1e-12</span>:</span>
<span id="cb15-97"><a href="#cb15-97" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb15-98"><a href="#cb15-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-99"><a href="#cb15-99" aria-hidden="true" tabindex="-1"></a>    targets <span class="op">=</span> np.linspace(r_lo, r_hi, <span class="bu">int</span>(grid_n))</span>
<span id="cb15-100"><a href="#cb15-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-101"><a href="#cb15-101" aria-hidden="true" tabindex="-1"></a>    prob, w_var, mu_p, S_p, wprev_p, r_p <span class="op">=</span> get_frontier_solver(nn, ridge, kappa_annual(rpy))</span>
<span id="cb15-102"><a href="#cb15-102" aria-hidden="true" tabindex="-1"></a>    mu_p.value <span class="op">=</span> np.asarray(mu_excess_ann, dtype<span class="op">=</span>np.float64)</span>
<span id="cb15-103"><a href="#cb15-103" aria-hidden="true" tabindex="-1"></a>    S_p.value <span class="op">=</span> np.asarray(cov_ann, dtype<span class="op">=</span>np.float64)</span>
<span id="cb15-104"><a href="#cb15-104" aria-hidden="true" tabindex="-1"></a>    wprev_p.value <span class="op">=</span> np.asarray(w_prev, dtype<span class="op">=</span>np.float64)</span>
<span id="cb15-105"><a href="#cb15-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-106"><a href="#cb15-106" aria-hidden="true" tabindex="-1"></a>    best_w, best_s <span class="op">=</span> <span class="va">None</span>, <span class="op">-</span>np.inf</span>
<span id="cb15-107"><a href="#cb15-107" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> rt <span class="kw">in</span> targets:</span>
<span id="cb15-108"><a href="#cb15-108" aria-hidden="true" tabindex="-1"></a>        r_p.value <span class="op">=</span> <span class="bu">float</span>(rt)</span>
<span id="cb15-109"><a href="#cb15-109" aria-hidden="true" tabindex="-1"></a>        w <span class="op">=</span> solve_cvx(prob, w_var)</span>
<span id="cb15-110"><a href="#cb15-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> w <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb15-111"><a href="#cb15-111" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb15-112"><a href="#cb15-112" aria-hidden="true" tabindex="-1"></a>        w <span class="op">=</span> safe_normalize_weights(w, w_min, w_max, long_only)</span>
<span id="cb15-113"><a href="#cb15-113" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> w <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb15-114"><a href="#cb15-114" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb15-115"><a href="#cb15-115" aria-hidden="true" tabindex="-1"></a>        s <span class="op">=</span> sharpe_from_w(mu_excess_ann, cov_ann, w)</span>
<span id="cb15-116"><a href="#cb15-116" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> s <span class="op">&gt;</span> best_s:</span>
<span id="cb15-117"><a href="#cb15-117" aria-hidden="true" tabindex="-1"></a>            best_s, best_w <span class="op">=</span> s, w</span>
<span id="cb15-118"><a href="#cb15-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-119"><a href="#cb15-119" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> best_w</span>
<span id="cb15-120"><a href="#cb15-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-121"><a href="#cb15-121" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="trading-transaction-costs-and-real-market-simulation" class="level2">
<h2 class="anchored" data-anchor-id="trading-transaction-costs-and-real-market-simulation">9) Trading, transaction costs, and real market simulation</h2>
<p>We talked about turnover and how to add it to our optimization problem as a penalty. At a rebalance date, trading changes weights from <span class="math inline">\(w_{t^-}\)</span> to <span class="math inline">\(w_t\)</span>. Turnover: <span class="math display">\[
\operatorname{TO}_t = \sum_{i=1}^{N}\lvert w_{t,i} - w_{t^-,i}\rvert
\]</span></p>
<p>If costs are <span class="math inline">\(c\)</span> in decimal per unit turnover (for example 1 bps means <span class="math inline">\(c=0.001\)</span>), then cost paid is: <span class="math display">\[
C_t = c\,\operatorname{TO}_t\,W_{t-1}
\]</span></p>
<p>which <span class="math inline">\(W_{t-1}\)</span> is the wealth in the last date</p>
<p>Net wealth right after rebalancing becomes: <span class="math display">\[
W_{t-1}^{(net)} = W_{t-1} - C_t
\]</span></p>
<p>Then apply the day-<span class="math inline">\(t\)</span> return: <span class="math display">\[
W_t = W_{t-1}^{(net)}(1 + r_{p,t})
\]</span></p>
<p>This model is simple but captures the key reality: higher turnover causes more costs and reduces long-run performance.</p>
</section>
<section id="backtest-engine" class="level2">
<h2 class="anchored" data-anchor-id="backtest-engine">10) Backtest engine</h2>
<p>Daily drift: <span class="math display">\[
\tilde{w}_{t,i} = \frac{w_{t-1,i}(1+r_{t,i})}{\sum_j w_{t-1,j}(1+r_{t,j})}
\]</span></p>
<p>In each rebalance we: - compute <code>w_pre</code> (drifted weights in active set of selected stocks) - compute <code>w_tar</code> from strategy - blend, normalize, apply costs - analyze performance</p>
</section>
<section id="performance-metrics-what-we-report" class="level2">
<h2 class="anchored" data-anchor-id="performance-metrics-what-we-report">11) Performance metrics (what we report)</h2>
<p>Assume we have daily portfolio returns <span class="math inline">\((r_{p,t})_{t=1}^T\)</span> and wealth series <span class="math inline">\(\{W_t\}\)</span>.</p>
<section id="cagr" class="level3">
<h3 class="anchored" data-anchor-id="cagr">9.1 CAGR</h3>
<p>if <span class="math inline">\(T\)</span> is the number of trading days. The compounded annual growth rate is:</p>
<p><span class="math inline">\(\operatorname{CAGR} = \left(\frac{W_T}{W_0}\right)^{252/T} - 1\)</span></p>
</section>
<section id="annualized-volatility" class="level3">
<h3 class="anchored" data-anchor-id="annualized-volatility">9.2 Annualized volatility</h3>
<p>if <span class="math inline">\(\sigma_d = \operatorname{std}(r_{p,t})\)</span>. Then:</p>
<p><span class="math inline">\(\sigma_{ann} = \sqrt{252}\,\sigma_d\)</span></p>
</section>
<section id="sharpe-ratio" class="level3">
<h3 class="anchored" data-anchor-id="sharpe-ratio">9.3 Sharpe ratio</h3>
<p>We’ve already talked about this. <span class="math inline">\(\bar{r}_p\)</span> is the mean daily portfolio return. Using daily risk-free <span class="math inline">\(r_f^{(d)}\)</span>:</p>
<p><span class="math inline">\(\operatorname{SR} = \frac{\bar{r}_p - r_f^{(d)}}{\sigma_d}\sqrt{252}\)</span></p>
</section>
<section id="drawdown-and-max-drawdown" class="level3">
<h3 class="anchored" data-anchor-id="drawdown-and-max-drawdown">9.4 Drawdown and max drawdown</h3>
<p>Define running peak (the highest point in our wealth):</p>
<p><span class="math inline">\(M_t = \max_{s \le t} W_s\)</span></p>
<p>Drawdown (how much we go down after we hit the peak):</p>
<p><span class="math inline">\(DD_t = 1 - \frac{W_t}{M_t}\)</span></p>
<p>Max drawdown:</p>
<p><span class="math inline">\(\operatorname{MaxDD} = \max_t DD_t\)</span></p>
</section>
<section id="turnover-diagnostics" class="level3">
<h3 class="anchored" data-anchor-id="turnover-diagnostics">9.5 Turnover diagnostics</h3>
<p>Average turnover per rebalance:</p>
<p><span class="math inline">\(\overline{\operatorname{TO}} = \frac{1}{|\mathcal{T}|}\sum_{t \in \mathcal{T}}\operatorname{TO}_t\)</span></p>
<p>Approximate annual turnover if rebalances occur <span class="math inline">\(B\)</span> times per year:</p>
<p><span class="math inline">\(\operatorname{TO}_{ann} \approx B\,\overline{\operatorname{TO}}\)</span></p>
<div id="7a16a2f9" class="cell" data-execution_count="49">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>fixed_fee <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calc_drawdown(series):</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> series <span class="op">/</span> series.cummax() <span class="op">-</span> <span class="fl">1.0</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> backtest_strategy(name, cov_key):</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    all_dates <span class="op">=</span> returns.loc[rebal_dates[<span class="dv">0</span>]:].index</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    rebal_set <span class="op">=</span> <span class="bu">set</span>(rebal_dates)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> pd.Series(dtype<span class="op">=</span>np.float64)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    gross_value, net_value <span class="op">=</span> <span class="fl">1.0</span>, <span class="fl">1.0</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    gross_values, net_values, gross_returns <span class="op">=</span> [], [], []</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    weights_rebal <span class="op">=</span> {}</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    turnover_list, cost_list <span class="op">=</span> [], []</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    fallback_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> dt <span class="kw">in</span> all_dates:</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> dt <span class="kw">in</span> rebal_set:</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>            st <span class="op">=</span> cache[dt]</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>            mu_excess_ann <span class="op">=</span> st[<span class="st">"mu_excess_ann"</span>]</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>            cov_ann <span class="op">=</span> st[<span class="st">"cov_ann_map"</span>][cov_key]</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>            active_tickers <span class="op">=</span> st[<span class="st">"tickers"</span>]</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>            nn <span class="op">=</span> <span class="bu">len</span>(active_tickers)</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> nn <span class="op">&gt;=</span> <span class="dv">2</span>:</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>                w_pre <span class="op">=</span> w.reindex(active_tickers).fillna(<span class="fl">0.0</span>).astype(np.float64)</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>                s <span class="op">=</span> <span class="bu">float</span>(w_pre.<span class="bu">sum</span>())</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>                w_pre <span class="op">=</span> (w_pre <span class="op">/</span> s) <span class="cf">if</span> s <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> pd.Series(np.ones(nn, dtype<span class="op">=</span>np.float64) <span class="op">/</span> nn, index<span class="op">=</span>active_tickers)</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> name <span class="op">==</span> <span class="st">"EW"</span>:</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>                    w_tar <span class="op">=</span> np.ones(nn, dtype<span class="op">=</span>np.float64) <span class="op">/</span> nn</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> name.startswith(<span class="st">"MinVar"</span>):</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>                    w_tar <span class="op">=</span> minvar_weights(cov_ann, w_pre.values, rebal_per_year)</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> name.startswith(<span class="st">"MV"</span>):</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>                    w_tar <span class="op">=</span> mv_weights(mu_excess_ann, cov_ann, w_pre.values, rebal_per_year)</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> name <span class="op">==</span> <span class="st">"Ridge MV"</span>:</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>                    w_tar <span class="op">=</span> ridge_mv_weights(mu_excess_ann, cov_ann, w_pre.values, rebal_per_year)</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> name <span class="op">==</span> <span class="st">"MaxSharpe"</span>:</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>                    w_tar <span class="op">=</span> max_sharpe_weights(mu_excess_ann, cov_ann, w_pre.values, rebal_per_year)</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> name <span class="op">==</span> <span class="st">"MaxSharpe (FrontierGrid)"</span>:</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>                    w_tar <span class="op">=</span> max_sharpe_frontier_grid_weights(mu_excess_ann, cov_ann, w_pre.values, rebal_per_year)</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>                    w_tar <span class="op">=</span> <span class="va">None</span></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> w_tar <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> np.<span class="bu">any</span>(<span class="op">~</span>np.isfinite(w_tar)):</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>                    print_warn(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> failed on </span><span class="sc">{</span>dt<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">, fallback to EW"</span>)</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>                    w_tar <span class="op">=</span> np.ones(nn, dtype<span class="op">=</span>np.float64) <span class="op">/</span> nn</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>                    fallback_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>                w_tar <span class="op">=</span> blend_weights(w_tar, w_pre.values, <span class="bu">float</span>(blend.get(name, <span class="fl">0.0</span>)))</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>                w_tar <span class="op">=</span> safe_normalize_weights(w_tar, w_min, w_max, long_only)</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> w_tar <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>                    print_warn(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> infeasible on </span><span class="sc">{</span>dt<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">, fallback to EW"</span>)</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>                    w_tar <span class="op">=</span> np.ones(nn, dtype<span class="op">=</span>np.float64) <span class="op">/</span> nn</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>                    fallback_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>                delta <span class="op">=</span> w_tar <span class="op">-</span> w_pre.values</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>                turnover <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> np.<span class="bu">sum</span>(np.<span class="bu">abs</span>(delta))</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>                cost_value <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>                cost_rate <span class="op">=</span> <span class="bu">float</span>((cost_bps <span class="op">/</span> <span class="fl">10000.0</span>) <span class="op">*</span> <span class="fl">0.5</span> <span class="op">*</span> np.<span class="bu">sum</span>(np.<span class="bu">abs</span>(delta)))</span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>                cost_value <span class="op">=</span> net_value <span class="op">*</span> cost_rate</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>                net_value <span class="op">=</span> <span class="bu">max</span>(net_value <span class="op">-</span> cost_value, <span class="fl">1e-12</span>)</span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> fixed_fee <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>                    fee <span class="op">=</span> fixed_fee <span class="op">*</span> np.count_nonzero(np.<span class="bu">abs</span>(delta) <span class="op">&gt;</span> <span class="fl">1e-12</span>)</span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>                    net_value <span class="op">=</span> <span class="bu">max</span>(net_value <span class="op">-</span> fee, <span class="fl">1e-12</span>)</span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>                    cost_value <span class="op">+=</span> fee</span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>                turnover_list.append(turnover)</span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>                cost_list.append(cost_value)</span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a>                weights_rebal[dt] <span class="op">=</span> pd.Series(w_tar.astype(np.float32), index<span class="op">=</span>active_tickers)</span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a>                w <span class="op">=</span> pd.Series(w_tar, index<span class="op">=</span>active_tickers, dtype<span class="op">=</span>np.float64)</span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> w.empty:</span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a>            port_ret <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a>            w_close <span class="op">=</span> pd.Series(dtype<span class="op">=</span>np.float64)</span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a>            r_today <span class="op">=</span> returns.loc[dt].reindex(w.index).fillna(<span class="fl">0.0</span>).astype(np.float64)</span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a>            port_ret <span class="op">=</span> <span class="bu">float</span>(np.dot(w.values, r_today.values))</span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-83"><a href="#cb16-83" aria-hidden="true" tabindex="-1"></a>            gross_value <span class="op">*=</span> (<span class="fl">1.0</span> <span class="op">+</span> port_ret)</span>
<span id="cb16-84"><a href="#cb16-84" aria-hidden="true" tabindex="-1"></a>            net_value <span class="op">*=</span> (<span class="fl">1.0</span> <span class="op">+</span> port_ret)</span>
<span id="cb16-85"><a href="#cb16-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-86"><a href="#cb16-86" aria-hidden="true" tabindex="-1"></a>            grossed <span class="op">=</span> w.values <span class="op">*</span> (<span class="fl">1.0</span> <span class="op">+</span> r_today.values)</span>
<span id="cb16-87"><a href="#cb16-87" aria-hidden="true" tabindex="-1"></a>            gs <span class="op">=</span> <span class="bu">float</span>(grossed.<span class="bu">sum</span>())</span>
<span id="cb16-88"><a href="#cb16-88" aria-hidden="true" tabindex="-1"></a>            w_close <span class="op">=</span> pd.Series(grossed <span class="op">/</span> gs, index<span class="op">=</span>w.index, dtype<span class="op">=</span>np.float64) <span class="cf">if</span> gs <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> np.isfinite(gs) <span class="cf">else</span> pd.Series(dtype<span class="op">=</span>np.float64)</span>
<span id="cb16-89"><a href="#cb16-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-90"><a href="#cb16-90" aria-hidden="true" tabindex="-1"></a>        gross_values.append(gross_value)</span>
<span id="cb16-91"><a href="#cb16-91" aria-hidden="true" tabindex="-1"></a>        net_values.append(net_value)</span>
<span id="cb16-92"><a href="#cb16-92" aria-hidden="true" tabindex="-1"></a>        gross_returns.append(port_ret)</span>
<span id="cb16-93"><a href="#cb16-93" aria-hidden="true" tabindex="-1"></a>        w <span class="op">=</span> w_close</span>
<span id="cb16-94"><a href="#cb16-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-95"><a href="#cb16-95" aria-hidden="true" tabindex="-1"></a>    gross_values <span class="op">=</span> pd.Series(gross_values, index<span class="op">=</span>all_dates, name<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_gross"</span>)</span>
<span id="cb16-96"><a href="#cb16-96" aria-hidden="true" tabindex="-1"></a>    net_values <span class="op">=</span> pd.Series(net_values, index<span class="op">=</span>all_dates, name<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_net"</span>)</span>
<span id="cb16-97"><a href="#cb16-97" aria-hidden="true" tabindex="-1"></a>    gross_returns <span class="op">=</span> pd.Series(gross_returns, index<span class="op">=</span>all_dates, name<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_gross_ret"</span>)</span>
<span id="cb16-98"><a href="#cb16-98" aria-hidden="true" tabindex="-1"></a>    net_returns <span class="op">=</span> net_values.pct_change().fillna(<span class="fl">0.0</span>)</span>
<span id="cb16-99"><a href="#cb16-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-100"><a href="#cb16-100" aria-hidden="true" tabindex="-1"></a>    wdf <span class="op">=</span> pd.DataFrame.from_dict(weights_rebal, orient<span class="op">=</span><span class="st">"index"</span>)</span>
<span id="cb16-101"><a href="#cb16-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> wdf.empty:</span>
<span id="cb16-102"><a href="#cb16-102" aria-hidden="true" tabindex="-1"></a>        wdf <span class="op">=</span> wdf.fillna(<span class="fl">0.0</span>)</span>
<span id="cb16-103"><a href="#cb16-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-104"><a href="#cb16-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb16-105"><a href="#cb16-105" aria-hidden="true" tabindex="-1"></a>        <span class="st">"gross_values"</span>: gross_values,</span>
<span id="cb16-106"><a href="#cb16-106" aria-hidden="true" tabindex="-1"></a>        <span class="st">"net_values"</span>: net_values,</span>
<span id="cb16-107"><a href="#cb16-107" aria-hidden="true" tabindex="-1"></a>        <span class="st">"gross_returns"</span>: gross_returns,</span>
<span id="cb16-108"><a href="#cb16-108" aria-hidden="true" tabindex="-1"></a>        <span class="st">"net_returns"</span>: net_returns,</span>
<span id="cb16-109"><a href="#cb16-109" aria-hidden="true" tabindex="-1"></a>        <span class="st">"weights"</span>: wdf,</span>
<span id="cb16-110"><a href="#cb16-110" aria-hidden="true" tabindex="-1"></a>        <span class="st">"turnover"</span>: pd.Series(turnover_list, index<span class="op">=</span>wdf.index) <span class="cf">if</span> <span class="bu">len</span>(wdf) <span class="cf">else</span> pd.Series([], dtype<span class="op">=</span><span class="bu">float</span>),</span>
<span id="cb16-111"><a href="#cb16-111" aria-hidden="true" tabindex="-1"></a>        <span class="st">"costs"</span>: pd.Series(cost_list, index<span class="op">=</span>wdf.index) <span class="cf">if</span> <span class="bu">len</span>(wdf) <span class="cf">else</span> pd.Series([], dtype<span class="op">=</span><span class="bu">float</span>),</span>
<span id="cb16-112"><a href="#cb16-112" aria-hidden="true" tabindex="-1"></a>        <span class="st">"fallbacks"</span>: fallback_count,</span>
<span id="cb16-113"><a href="#cb16-113" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="strategy-dashboards" class="level2">
<h2 class="anchored" data-anchor-id="strategy-dashboards">12) Strategy dashboards</h2>
<p>We report the performance of each model and top weights and top risk contribution (to volatility) at date <span class="math inline">\(t\)</span>: if portfolio variance <span class="math inline">\(\sigma_p^2 = w^T\Sigma w\)</span>, and marginal risk is <span class="math inline">\(m = \Sigma w\)</span>. Contribution to variance: <span class="math inline">\(RC^{var}_i = w_i m_i\)</span>. Contribution to volatility: <span class="math inline">\(RC^{vol}_i = RC^{var}_i / \sigma_p\)</span>.</p>
<div id="10c170cf" class="cell" data-execution_count="50">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> format_date_axis(ax):</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_major_formatter(DateFormatter(<span class="st">"%Y-%m"</span>))</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    ax.figure.autofmt_xdate()</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_strategy_dashboard(name, res, cov_key):</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> res[<span class="st">"net_values"</span>].empty:</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        print_warn(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">: empty results"</span>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">6</span>))</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> axes[<span class="dv">0</span>, <span class="dv">0</span>]</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    ax.plot(res[<span class="st">"net_values"</span>].index, res[<span class="st">"net_values"</span>].values, color<span class="op">=</span>strategy_colors[name])</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> — Net Equity"</span>)</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">"Date"</span>)<span class="op">;</span> ax.set_ylabel(<span class="st">"Growth of $1"</span>)</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    format_date_axis(ax)</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> axes[<span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    dd <span class="op">=</span> calc_drawdown(res[<span class="st">"net_values"</span>])</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    ax.plot(dd.index, dd.values, color<span class="op">=</span>strategy_colors[name])</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> — Net Drawdown"</span>)</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">"Date"</span>)<span class="op">;</span> ax.set_ylabel(<span class="st">"Drawdown"</span>)</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    format_date_axis(ax)</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    wdf <span class="op">=</span> res[<span class="st">"weights"</span>]</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> wdf.empty:</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">0</span>].set_axis_off()</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">1</span>].set_axis_off()</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>    last_dt <span class="op">=</span> wdf.index[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>    w_last <span class="op">=</span> wdf.loc[last_dt].astype(<span class="bu">float</span>)</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>    w_last <span class="op">=</span> w_last[w_last <span class="op">&gt;</span> <span class="dv">0</span>].sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">0</span>]</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>    topw <span class="op">=</span> w_last.head(<span class="dv">10</span>).sort_values()</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>    ax.barh(topw.index, topw.values, color<span class="op">=</span>strategy_colors[name])</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> — Top-10 Weights (</span><span class="sc">{</span>last_dt<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">"Weight"</span>)</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>    cov <span class="op">=</span> cache[last_dt][<span class="st">"cov_ann_map"</span>][cov_key]</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>    tickers <span class="op">=</span> cache[last_dt][<span class="st">"tickers"</span>]</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>    w_vec <span class="op">=</span> wdf.loc[last_dt].reindex(tickers).fillna(<span class="fl">0.0</span>).values.astype(np.float64)</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>    Sigma_w <span class="op">=</span> cov <span class="op">@</span> w_vec</span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>    port_var <span class="op">=</span> <span class="bu">float</span>(w_vec <span class="op">@</span> Sigma_w)</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>    port_vol <span class="op">=</span> np.sqrt(<span class="bu">max</span>(port_var, <span class="fl">1e-18</span>))</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>    rc_var <span class="op">=</span> w_vec <span class="op">*</span> Sigma_w</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>    rc_vol <span class="op">=</span> rc_var <span class="op">/</span> port_vol</span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>    rc <span class="op">=</span> pd.Series(rc_vol, index<span class="op">=</span>tickers)</span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>    top_rc <span class="op">=</span> rc.<span class="bu">abs</span>().sort_values(ascending<span class="op">=</span><span class="va">False</span>).head(<span class="dv">10</span>).index</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>    plot_rc <span class="op">=</span> rc.loc[top_rc].sort_values()</span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>    ax.barh(plot_rc.index, plot_rc.values, color<span class="op">=</span>strategy_colors[name])</span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> — Top-10 Risk Contributions (</span><span class="sc">{</span>last_dt<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">"Contribution to vol"</span>)</span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="running-strategies" class="level2">
<h2 class="anchored" data-anchor-id="running-strategies">13) Running strategies</h2>
<div id="2306e1db" class="cell" data-execution_count="51">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> {}</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>name <span class="op">=</span> <span class="st">"EW"</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>results[name] <span class="op">=</span> backtest_strategy(name, strategy_cov_key[name])</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>plot_strategy_dashboard(name, results[name], strategy_cov_key[name])</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> [<span class="st">"MinVar (SampleCov)"</span>, <span class="st">"MinVar (LedoitWolf)"</span>, <span class="st">"MinVar (OAS)"</span>, <span class="st">"MinVar (EWMA)"</span>]:</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    results[name] <span class="op">=</span> backtest_strategy(name, strategy_cov_key[name])</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    plot_strategy_dashboard(name, results[name], strategy_cov_key[name])</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> [<span class="st">"MV (SampleCov)"</span>, <span class="st">"MV (LedoitWolf)"</span>, <span class="st">"MV (OAS)"</span>, <span class="st">"MV (EWMA)"</span>]:</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    results[name] <span class="op">=</span> backtest_strategy(name, strategy_cov_key[name])</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    plot_strategy_dashboard(name, results[name], strategy_cov_key[name])</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>name <span class="op">=</span> <span class="st">"Ridge MV"</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>results[name] <span class="op">=</span> backtest_strategy(name, strategy_cov_key[name])</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>plot_strategy_dashboard(name, results[name], strategy_cov_key[name])</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>name <span class="op">=</span> <span class="st">"MaxSharpe"</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>results[name] <span class="op">=</span> backtest_strategy(name, strategy_cov_key[name])</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>plot_strategy_dashboard(name, results[name], strategy_cov_key[name])</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>name <span class="op">=</span> <span class="st">"MaxSharpe (FrontierGrid)"</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>results[name] <span class="op">=</span> backtest_strategy(name, strategy_cov_key[name])</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>plot_strategy_dashboard(name, results[name], strategy_cov_key[name])</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>strategy_names <span class="op">=</span> <span class="bu">list</span>(results.keys())</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Computed strategies:"</span>, strategy_names)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_portfolio_optimization_MV_models_files/figure-html/cell-16-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_portfolio_optimization_MV_models_files/figure-html/cell-16-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_portfolio_optimization_MV_models_files/figure-html/cell-16-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_portfolio_optimization_MV_models_files/figure-html/cell-16-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_portfolio_optimization_MV_models_files/figure-html/cell-16-output-5.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_portfolio_optimization_MV_models_files/figure-html/cell-16-output-6.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_portfolio_optimization_MV_models_files/figure-html/cell-16-output-7.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_portfolio_optimization_MV_models_files/figure-html/cell-16-output-8.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_portfolio_optimization_MV_models_files/figure-html/cell-16-output-9.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_portfolio_optimization_MV_models_files/figure-html/cell-16-output-10.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_portfolio_optimization_MV_models_files/figure-html/cell-16-output-11.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_portfolio_optimization_MV_models_files/figure-html/cell-16-output-12.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Computed strategies: ['EW', 'MinVar (SampleCov)', 'MinVar (LedoitWolf)', 'MinVar (OAS)', 'MinVar (EWMA)', 'MV (SampleCov)', 'MV (LedoitWolf)', 'MV (OAS)', 'MV (EWMA)', 'Ridge MV', 'MaxSharpe', 'MaxSharpe (FrontierGrid)']</code></pre>
</div>
</div>
</section>
<section id="summary-tables-and-overall-plots-style-preserved" class="level2">
<h2 class="anchored" data-anchor-id="summary-tables-and-overall-plots-style-preserved">14) summary tables and overall plots (style preserved)</h2>
<section id="trading-diagnostics-turnover-costs-concentration" class="level3">
<h3 class="anchored" data-anchor-id="trading-diagnostics-turnover-costs-concentration">Trading diagnostics (turnover, costs, concentration)</h3>
<p>We compute: - average turnover per rebalance - total turnover - total costs - average HHI and effective number of holdings</p>
<p><span class="math display">\[
HHI_t = \sum_i w_{t,i}^2
\quad,\quad
N_{eff} = \frac{1}{E[HHI]}
\]</span></p>
<div id="f4143377" class="cell" data-execution_count="52">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calc_drawdown(series):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> series <span class="op">/</span> series.cummax() <span class="op">-</span> <span class="fl">1.0</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> performance_metrics(net_returns, net_values):</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    years <span class="op">=</span> <span class="bu">len</span>(net_returns) <span class="op">/</span> <span class="fl">252.0</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    cagr <span class="op">=</span> (net_values.iloc[<span class="op">-</span><span class="dv">1</span>] <span class="op">**</span> (<span class="fl">1.0</span> <span class="op">/</span> years) <span class="op">-</span> <span class="fl">1.0</span>) <span class="cf">if</span> years <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    vol <span class="op">=</span> net_returns.std() <span class="op">*</span> np.sqrt(<span class="fl">252.0</span>)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    excess <span class="op">=</span> net_returns <span class="op">-</span> rf_daily</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    sharpe <span class="op">=</span> (excess.mean() <span class="op">/</span> net_returns.std()) <span class="op">*</span> np.sqrt(<span class="fl">252.0</span>) <span class="cf">if</span> net_returns.std() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    dd <span class="op">=</span> calc_drawdown(net_values)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    max_dd <span class="op">=</span> dd.<span class="bu">min</span>()</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    calmar <span class="op">=</span> cagr <span class="op">/</span> <span class="bu">abs</span>(max_dd) <span class="cf">if</span> max_dd <span class="op">&lt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    downside <span class="op">=</span> net_returns[net_returns <span class="op">&lt;</span> <span class="dv">0</span>]</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    sortino <span class="op">=</span> (excess.mean() <span class="op">/</span> downside.std()) <span class="op">*</span> np.sqrt(<span class="fl">252.0</span>) <span class="cf">if</span> downside.std() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cagr, vol, sharpe, max_dd, calmar, sortino</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>metrics_rows <span class="op">=</span> []</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, res <span class="kw">in</span> results.items():</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    metrics_rows.append([name, <span class="op">*</span>performance_metrics(res[<span class="st">"net_returns"</span>], res[<span class="st">"net_values"</span>])])</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>metrics_df <span class="op">=</span> pd.DataFrame(metrics_rows, columns<span class="op">=</span>[<span class="st">"Strategy"</span>, <span class="st">"CAGR"</span>, <span class="st">"AnnVol"</span>, <span class="st">"Sharpe"</span>, <span class="st">"MaxDD"</span>, <span class="st">"Calmar"</span>, <span class="st">"Sortino"</span>]).set_index(<span class="st">"Strategy"</span>)</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Risk/Return Summary (Net)"</span>)</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>display(metrics_df)</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>trade_rows <span class="op">=</span> []</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, res <span class="kw">in</span> results.items():</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>    turnover, costs, wdf <span class="op">=</span> res[<span class="st">"turnover"</span>], res[<span class="st">"costs"</span>], res[<span class="st">"weights"</span>]</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(wdf) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>        hhi <span class="op">=</span> (wdf <span class="op">**</span> <span class="dv">2</span>).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>        avg_hhi <span class="op">=</span> <span class="bu">float</span>(hhi.mean())</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>        eff_n <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> avg_hhi <span class="cf">if</span> avg_hhi <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>        avg_hhi, eff_n <span class="op">=</span> np.nan, np.nan</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>    trade_rows.append([</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>        name,</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>        <span class="bu">float</span>(turnover.mean()) <span class="cf">if</span> <span class="bu">len</span>(turnover) <span class="cf">else</span> <span class="fl">0.0</span>,</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>        <span class="bu">float</span>(turnover.<span class="bu">sum</span>()) <span class="cf">if</span> <span class="bu">len</span>(turnover) <span class="cf">else</span> <span class="fl">0.0</span>,</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>        <span class="bu">float</span>(costs.<span class="bu">sum</span>()) <span class="cf">if</span> <span class="bu">len</span>(costs) <span class="cf">else</span> <span class="fl">0.0</span>,</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>        <span class="bu">float</span>(costs.<span class="bu">sum</span>() <span class="op">/</span> res[<span class="st">"net_values"</span>].iloc[<span class="op">-</span><span class="dv">1</span>]) <span class="cf">if</span> <span class="bu">len</span>(costs) <span class="cf">else</span> <span class="fl">0.0</span>,</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>        avg_hhi,</span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>        eff_n,</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>trade_df <span class="op">=</span> pd.DataFrame(trade_rows, columns<span class="op">=</span>[<span class="st">"Strategy"</span>, <span class="st">"Avg Turnover"</span>, <span class="st">"Total Turnover"</span>, <span class="st">"Total Costs"</span>, <span class="st">"Cost </span><span class="sc">% F</span><span class="st">inal Value"</span>, <span class="st">"Avg HHI"</span>, <span class="st">"Effective N"</span>]).set_index(<span class="st">"Strategy"</span>)</span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Trading &amp; Stability Summary"</span>)</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>display(trade_df)</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Fallback counts per strategy:"</span>)</span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> strategy_names:</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>results[name][<span class="st">'fallbacks'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_equity_curves(results_dict, key, title):</span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, res <span class="kw">in</span> results_dict.items():</span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>        s <span class="op">=</span> res[key]</span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>        plt.plot(s.index, s.values, label<span class="op">=</span>name, color<span class="op">=</span>strategy_colors[name])</span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a>    plt.title(title)</span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">"Date"</span>)</span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">"Growth of $1"</span>)</span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>    plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a>    format_date_axis(plt.gca())</span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a>plot_equity_curves(results, <span class="st">"gross_values"</span>, <span class="st">"Equity Curves (Gross)"</span>)</span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a>plot_equity_curves(results, <span class="st">"net_values"</span>, <span class="st">"Equity Curves (Net)"</span>)</span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, res <span class="kw">in</span> results.items():</span>
<span id="cb20-71"><a href="#cb20-71" aria-hidden="true" tabindex="-1"></a>    dd <span class="op">=</span> calc_drawdown(res[<span class="st">"net_values"</span>])</span>
<span id="cb20-72"><a href="#cb20-72" aria-hidden="true" tabindex="-1"></a>    plt.plot(dd.index, dd.values, label<span class="op">=</span>name, color<span class="op">=</span>strategy_colors[name])</span>
<span id="cb20-73"><a href="#cb20-73" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Drawdowns (Net)"</span>)</span>
<span id="cb20-74"><a href="#cb20-74" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>)</span>
<span id="cb20-75"><a href="#cb20-75" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Drawdown"</span>)</span>
<span id="cb20-76"><a href="#cb20-76" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb20-77"><a href="#cb20-77" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb20-78"><a href="#cb20-78" aria-hidden="true" tabindex="-1"></a>format_date_axis(plt.gca())</span>
<span id="cb20-79"><a href="#cb20-79" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb20-80"><a href="#cb20-80" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb20-81"><a href="#cb20-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-82"><a href="#cb20-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-83"><a href="#cb20-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-84"><a href="#cb20-84" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb20-85"><a href="#cb20-85" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> s <span class="kw">in</span> metrics_df.index:</span>
<span id="cb20-86"><a href="#cb20-86" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> metrics_df.loc[s, <span class="st">"AnnVol"</span>]</span>
<span id="cb20-87"><a href="#cb20-87" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> metrics_df.loc[s, <span class="st">"CAGR"</span>]</span>
<span id="cb20-88"><a href="#cb20-88" aria-hidden="true" tabindex="-1"></a>    c <span class="op">=</span> strategy_colors[s]</span>
<span id="cb20-89"><a href="#cb20-89" aria-hidden="true" tabindex="-1"></a>    plt.scatter(x, y, color<span class="op">=</span>c, s<span class="op">=</span><span class="dv">60</span>)</span>
<span id="cb20-90"><a href="#cb20-90" aria-hidden="true" tabindex="-1"></a>    plt.annotate(s, (x, y), fontsize<span class="op">=</span><span class="dv">9</span>, alpha<span class="op">=</span><span class="fl">0.9</span>, color<span class="op">=</span>c)</span>
<span id="cb20-91"><a href="#cb20-91" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Realized Risk-Return (Net): CAGR vs Annualized Volatility"</span>)</span>
<span id="cb20-92"><a href="#cb20-92" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Annualized Volatility"</span>)</span>
<span id="cb20-93"><a href="#cb20-93" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"CAGR"</span>)</span>
<span id="cb20-94"><a href="#cb20-94" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb20-95"><a href="#cb20-95" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb20-96"><a href="#cb20-96" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb20-97"><a href="#cb20-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-98"><a href="#cb20-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-99"><a href="#cb20-99" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb20-100"><a href="#cb20-100" aria-hidden="true" tabindex="-1"></a>sh <span class="op">=</span> metrics_df[<span class="st">"Sharpe"</span>].sort_values()</span>
<span id="cb20-101"><a href="#cb20-101" aria-hidden="true" tabindex="-1"></a>sh_colors <span class="op">=</span> [strategy_colors[s] <span class="cf">for</span> s <span class="kw">in</span> sh.index]</span>
<span id="cb20-102"><a href="#cb20-102" aria-hidden="true" tabindex="-1"></a>sh.plot(kind<span class="op">=</span><span class="st">"barh"</span>, color<span class="op">=</span>sh_colors)</span>
<span id="cb20-103"><a href="#cb20-103" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Realized Sharpe (Net)"</span>)</span>
<span id="cb20-104"><a href="#cb20-104" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Sharpe"</span>)</span>
<span id="cb20-105"><a href="#cb20-105" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb20-106"><a href="#cb20-106" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb20-107"><a href="#cb20-107" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb20-108"><a href="#cb20-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-109"><a href="#cb20-109" aria-hidden="true" tabindex="-1"></a>ret_mat <span class="op">=</span> pd.concat({k: v[<span class="st">"net_returns"</span>] <span class="cf">for</span> k, v <span class="kw">in</span> results.items()}, axis<span class="op">=</span><span class="dv">1</span>).dropna(how<span class="op">=</span><span class="st">"any"</span>)</span>
<span id="cb20-110"><a href="#cb20-110" aria-hidden="true" tabindex="-1"></a>corr <span class="op">=</span> ret_mat.corr()</span>
<span id="cb20-111"><a href="#cb20-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-112"><a href="#cb20-112" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">8</span>))</span>
<span id="cb20-113"><a href="#cb20-113" aria-hidden="true" tabindex="-1"></a>im <span class="op">=</span> plt.imshow(corr.values, aspect<span class="op">=</span><span class="st">"auto"</span>)</span>
<span id="cb20-114"><a href="#cb20-114" aria-hidden="true" tabindex="-1"></a>plt.colorbar(im, fraction<span class="op">=</span><span class="fl">0.046</span>, pad<span class="op">=</span><span class="fl">0.04</span>)</span>
<span id="cb20-115"><a href="#cb20-115" aria-hidden="true" tabindex="-1"></a>plt.xticks(<span class="bu">range</span>(<span class="bu">len</span>(corr.columns)), corr.columns, rotation<span class="op">=</span><span class="dv">90</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb20-116"><a href="#cb20-116" aria-hidden="true" tabindex="-1"></a>plt.yticks(<span class="bu">range</span>(<span class="bu">len</span>(corr.index)), corr.index, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb20-117"><a href="#cb20-117" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Correlation of Strategy Net Returns"</span>)</span>
<span id="cb20-118"><a href="#cb20-118" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb20-119"><a href="#cb20-119" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Risk/Return Summary (Net)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">CAGR</th>
<th data-quarto-table-cell-role="th">AnnVol</th>
<th data-quarto-table-cell-role="th">Sharpe</th>
<th data-quarto-table-cell-role="th">MaxDD</th>
<th data-quarto-table-cell-role="th">Calmar</th>
<th data-quarto-table-cell-role="th">Sortino</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Strategy</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">EW</th>
<td>0.146453</td>
<td>0.253005</td>
<td>0.511901</td>
<td>-0.460750</td>
<td>0.317857</td>
<td>0.672864</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">MinVar (SampleCov)</th>
<td>0.153991</td>
<td>0.160920</td>
<td>0.725942</td>
<td>-0.300514</td>
<td>0.512424</td>
<td>0.889201</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">MinVar (LedoitWolf)</th>
<td>0.130693</td>
<td>0.161293</td>
<td>0.598409</td>
<td>-0.297730</td>
<td>0.438966</td>
<td>0.730984</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">MinVar (OAS)</th>
<td>0.132298</td>
<td>0.161460</td>
<td>0.606626</td>
<td>-0.297890</td>
<td>0.444118</td>
<td>0.742014</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">MinVar (EWMA)</th>
<td>0.166994</td>
<td>0.154277</td>
<td>0.823995</td>
<td>-0.288007</td>
<td>0.579826</td>
<td>1.034746</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">MV (SampleCov)</th>
<td>0.170766</td>
<td>0.170585</td>
<td>0.779640</td>
<td>-0.261325</td>
<td>0.653462</td>
<td>1.008728</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">MV (LedoitWolf)</th>
<td>0.160197</td>
<td>0.172680</td>
<td>0.720231</td>
<td>-0.260224</td>
<td>0.615611</td>
<td>0.923250</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">MV (OAS)</th>
<td>0.168002</td>
<td>0.171487</td>
<td>0.762955</td>
<td>-0.261363</td>
<td>0.642792</td>
<td>0.979051</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">MV (EWMA)</th>
<td>0.185129</td>
<td>0.172926</td>
<td>0.844145</td>
<td>-0.253481</td>
<td>0.730344</td>
<td>1.071225</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Ridge MV</th>
<td>0.157800</td>
<td>0.171445</td>
<td>0.712393</td>
<td>-0.256076</td>
<td>0.616224</td>
<td>0.908904</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">MaxSharpe</th>
<td>0.213863</td>
<td>0.290424</td>
<td>0.681396</td>
<td>-0.458022</td>
<td>0.466928</td>
<td>0.877095</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">MaxSharpe (FrontierGrid)</th>
<td>0.271910</td>
<td>0.315597</td>
<td>0.799863</td>
<td>-0.463704</td>
<td>0.586387</td>
<td>1.044933</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Trading &amp; Stability Summary</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Avg Turnover</th>
<th data-quarto-table-cell-role="th">Total Turnover</th>
<th data-quarto-table-cell-role="th">Total Costs</th>
<th data-quarto-table-cell-role="th">Cost % Final Value</th>
<th data-quarto-table-cell-role="th">Avg HHI</th>
<th data-quarto-table-cell-role="th">Effective N</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Strategy</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">EW</th>
<td>0.048705</td>
<td>5.308806</td>
<td>0.010946</td>
<td>0.003211</td>
<td>0.010000</td>
<td>100.000004</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">MinVar (SampleCov)</th>
<td>0.024229</td>
<td>2.640967</td>
<td>0.004906</td>
<td>0.001357</td>
<td>0.098816</td>
<td>10.119779</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">MinVar (LedoitWolf)</th>
<td>0.030512</td>
<td>3.325809</td>
<td>0.006660</td>
<td>0.002212</td>
<td>0.060997</td>
<td>16.394131</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">MinVar (OAS)</th>
<td>0.030349</td>
<td>3.308053</td>
<td>0.006694</td>
<td>0.002196</td>
<td>0.075948</td>
<td>13.166957</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">MinVar (EWMA)</th>
<td>0.080659</td>
<td>8.791883</td>
<td>0.019071</td>
<td>0.004771</td>
<td>0.103168</td>
<td>9.692920</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">MV (SampleCov)</th>
<td>0.130850</td>
<td>14.262650</td>
<td>0.034118</td>
<td>0.008292</td>
<td>0.111507</td>
<td>8.968033</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">MV (LedoitWolf)</th>
<td>0.133851</td>
<td>14.589796</td>
<td>0.032932</td>
<td>0.008682</td>
<td>0.081683</td>
<td>12.242522</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">MV (OAS)</th>
<td>0.131115</td>
<td>14.291580</td>
<td>0.033921</td>
<td>0.008421</td>
<td>0.090959</td>
<td>10.993921</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">MV (EWMA)</th>
<td>0.295051</td>
<td>32.160563</td>
<td>0.084430</td>
<td>0.018393</td>
<td>0.114862</td>
<td>8.706068</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Ridge MV</th>
<td>0.125177</td>
<td>13.644327</td>
<td>0.030492</td>
<td>0.008189</td>
<td>0.064969</td>
<td>15.392010</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">MaxSharpe</th>
<td>0.391773</td>
<td>42.703308</td>
<td>0.119849</td>
<td>0.021059</td>
<td>0.137056</td>
<td>7.296314</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">MaxSharpe (FrontierGrid)</th>
<td>0.336119</td>
<td>36.637021</td>
<td>0.129177</td>
<td>0.014927</td>
<td>0.151004</td>
<td>6.622350</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Fallback counts per strategy:
EW: 0
MinVar (SampleCov): 0
MinVar (LedoitWolf): 0
MinVar (OAS): 0
MinVar (EWMA): 0
MV (SampleCov): 0
MV (LedoitWolf): 0
MV (OAS): 0
MV (EWMA): 0
Ridge MV: 0
MaxSharpe: 0
MaxSharpe (FrontierGrid): 0</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_portfolio_optimization_MV_models_files/figure-html/cell-17-output-6.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_portfolio_optimization_MV_models_files/figure-html/cell-17-output-7.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_portfolio_optimization_MV_models_files/figure-html/cell-17-output-8.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_portfolio_optimization_MV_models_files/figure-html/cell-17-output-9.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_portfolio_optimization_MV_models_files/figure-html/cell-17-output-10.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_portfolio_optimization_MV_models_files/figure-html/cell-17-output-11.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="implementation-on-hong-kong-stock-market-with-quantfinlab" class="level2">
<h2 class="anchored" data-anchor-id="implementation-on-hong-kong-stock-market-with-quantfinlab">implementation on Hong Kong stock market with quantfinlab</h2>
<div id="225c0c82" class="cell" data-execution_count="53">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> quantfinlab.portfolio <span class="im">as</span> pf</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> quantfinlab.plots <span class="im">as</span> pl</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> quantfinlab <span class="im">import</span> PortfolioState</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>rf_annual <span class="op">=</span> <span class="fl">0.04</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>rf_daily <span class="op">=</span> (<span class="fl">1.0</span> <span class="op">+</span> rf_annual) <span class="op">**</span> (<span class="fl">1.0</span> <span class="op">/</span> <span class="fl">252.0</span>) <span class="op">-</span> <span class="fl">1.0</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>raw <span class="op">=</span> pd.read_csv(<span class="st">"../data/hkex_selected_close_volume.csv"</span>, header<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">1</span>], low_memory<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>raw.columns <span class="op">=</span> pd.MultiIndex.from_tuples([(<span class="bu">str</span>(a).strip(), <span class="bu">str</span>(b).strip()) <span class="cf">for</span> a, b <span class="kw">in</span> raw.columns])</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>date_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> raw.columns <span class="cf">if</span> c[<span class="dv">0</span>].lower() <span class="op">==</span> <span class="st">"date"</span>]</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>close_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> raw.columns <span class="cf">if</span> c[<span class="dv">1</span>].lower() <span class="op">==</span> <span class="st">"close"</span>]</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>volume_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> raw.columns <span class="cf">if</span> c[<span class="dv">1</span>].lower() <span class="op">==</span> <span class="st">"volume"</span>]</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>dates <span class="op">=</span> pd.to_datetime(raw[date_cols[<span class="dv">0</span>]], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>close_prices <span class="op">=</span> raw.loc[:, close_cols].copy()</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>volumes <span class="op">=</span> raw.loc[:, volume_cols].copy()</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>close_prices.columns <span class="op">=</span> [<span class="bu">str</span>(c[<span class="dv">0</span>]).strip() <span class="cf">for</span> c <span class="kw">in</span> close_cols]</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>volumes.columns <span class="op">=</span> [<span class="bu">str</span>(c[<span class="dv">0</span>]).strip() <span class="cf">for</span> c <span class="kw">in</span> volume_cols]</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> close_prices.columns.duplicated().<span class="bu">any</span>():</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>    close_prices <span class="op">=</span> close_prices.T.groupby(level<span class="op">=</span><span class="dv">0</span>).last().T</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> volumes.columns.duplicated().<span class="bu">any</span>():</span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>    volumes <span class="op">=</span> volumes.T.groupby(level<span class="op">=</span><span class="dv">0</span>).last().T</span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>close_prices.index <span class="op">=</span> dates</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>volumes.index <span class="op">=</span> dates</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>close_prices <span class="op">=</span> (</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>    close_prices.<span class="bu">apply</span>(pd.to_numeric, errors<span class="op">=</span><span class="st">"coerce"</span>).replace([np.inf, <span class="op">-</span>np.inf], np.nan)</span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>    .astype(np.float32))</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>volumes <span class="op">=</span> (</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>    volumes.<span class="bu">apply</span>(pd.to_numeric, errors<span class="op">=</span><span class="st">"coerce"</span>).replace([np.inf, <span class="op">-</span>np.inf], np.nan)</span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>    .astype(np.float32))</span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>close_prices <span class="op">=</span> close_prices.where(close_prices <span class="op">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>volumes <span class="op">=</span> volumes.where(volumes <span class="op">&gt;=</span> <span class="dv">0</span>)</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>close_prices <span class="op">=</span> close_prices[<span class="op">~</span>close_prices.index.isna()].sort_index()</span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>volumes <span class="op">=</span> volumes[<span class="op">~</span>volumes.index.isna()].sort_index()</span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> close_prices.index.has_duplicates:</span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>    close_prices <span class="op">=</span> close_prices[<span class="op">~</span>close_prices.index.duplicated(keep<span class="op">=</span><span class="st">"last"</span>)]</span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> volumes.index.has_duplicates:</span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a>    volumes <span class="op">=</span> volumes[<span class="op">~</span>volumes.index.duplicated(keep<span class="op">=</span><span class="st">"last"</span>)]</span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a>start <span class="op">=</span> pd.Timestamp(<span class="st">"2016-01-01"</span>)</span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a>close_prices <span class="op">=</span> close_prices.loc[close_prices.index <span class="op">&gt;=</span> start]</span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a>volumes <span class="op">=</span> volumes.loc[volumes.index <span class="op">&gt;=</span> start]</span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> close_prices.index.intersection(volumes.index)</span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a>cols <span class="op">=</span> close_prices.columns.intersection(volumes.columns)</span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a>close_prices <span class="op">=</span> close_prices.loc[idx, cols]</span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a>volumes <span class="op">=</span> volumes.loc[idx, cols]</span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a>valid_cols <span class="op">=</span> close_prices.notna().<span class="bu">any</span>(axis<span class="op">=</span><span class="dv">0</span>) <span class="op">&amp;</span> volumes.notna().<span class="bu">any</span>(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a>close_prices <span class="op">=</span> close_prices.loc[:, valid_cols]</span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a>volumes <span class="op">=</span> volumes.loc[:, valid_cols]</span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a>prices <span class="op">=</span> close_prices.copy()</span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"close_prices:"</span>, close_prices.shape, <span class="st">"| volumes:"</span>, volumes.shape)</span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Date range:"</span>, close_prices.index.<span class="bu">min</span>().date(), <span class="st">"to"</span>, close_prices.index.<span class="bu">max</span>().date())</span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-80"><a href="#cb24-80" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> pf.prices_to_returns(prices)</span>
<span id="cb24-81"><a href="#cb24-81" aria-hidden="true" tabindex="-1"></a>rebal_dates <span class="op">=</span> pf.make_rebalance_dates(returns.index, freq<span class="op">=</span><span class="st">"ME"</span>, min_history_days<span class="op">=</span><span class="dv">252</span>)</span>
<span id="cb24-82"><a href="#cb24-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-83"><a href="#cb24-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-84"><a href="#cb24-84" aria-hidden="true" tabindex="-1"></a>cache: <span class="bu">dict</span>[pd.Timestamp, PortfolioState] <span class="op">=</span> {}</span>
<span id="cb24-85"><a href="#cb24-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-86"><a href="#cb24-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-87"><a href="#cb24-87" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_state(dt: pd.Timestamp) <span class="op">-&gt;</span> PortfolioState <span class="op">|</span> <span class="va">None</span>:</span>
<span id="cb24-88"><a href="#cb24-88" aria-hidden="true" tabindex="-1"></a>    tickers, avg_dv <span class="op">=</span> pf.select_liquid_universe(dt, close_prices<span class="op">=</span>prices, volumes<span class="op">=</span>volumes, top_n<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb24-89"><a href="#cb24-89" aria-hidden="true" tabindex="-1"></a>                                                liq_lookback<span class="op">=</span><span class="dv">252</span>, min_listing_days<span class="op">=</span><span class="dv">252</span>,min_obs<span class="op">=</span><span class="dv">252</span>,)</span>
<span id="cb24-90"><a href="#cb24-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> dt <span class="kw">not</span> <span class="kw">in</span> prices.index:</span>
<span id="cb24-91"><a href="#cb24-91" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb24-92"><a href="#cb24-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-93"><a href="#cb24-93" aria-hidden="true" tabindex="-1"></a>    pos <span class="op">=</span> prices.index.get_loc(dt)</span>
<span id="cb24-94"><a href="#cb24-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(pos, <span class="bu">slice</span>):</span>
<span id="cb24-95"><a href="#cb24-95" aria-hidden="true" tabindex="-1"></a>        pos <span class="op">=</span> pos.stop <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb24-96"><a href="#cb24-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-97"><a href="#cb24-97" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pos <span class="op">&lt;</span> <span class="dv">252</span>:</span>
<span id="cb24-98"><a href="#cb24-98" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb24-99"><a href="#cb24-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-100"><a href="#cb24-100" aria-hidden="true" tabindex="-1"></a>    close_for_model <span class="op">=</span> prices.iloc[pos <span class="op">-</span> <span class="dv">252</span> : pos][tickers]</span>
<span id="cb24-101"><a href="#cb24-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> close_for_model.shape[<span class="dv">0</span>] <span class="op">&lt;</span> <span class="dv">252</span>:</span>
<span id="cb24-102"><a href="#cb24-102" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb24-103"><a href="#cb24-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-104"><a href="#cb24-104" aria-hidden="true" tabindex="-1"></a>    window <span class="op">=</span> close_for_model.pct_change(fill_method<span class="op">=</span><span class="va">None</span>).iloc[<span class="dv">1</span>:]</span>
<span id="cb24-105"><a href="#cb24-105" aria-hidden="true" tabindex="-1"></a>    window <span class="op">=</span> window.replace([np.inf, <span class="op">-</span>np.inf], np.nan).dropna(axis<span class="op">=</span><span class="dv">0</span>, how<span class="op">=</span><span class="st">"any"</span>)</span>
<span id="cb24-106"><a href="#cb24-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-107"><a href="#cb24-107" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> window.shape[<span class="dv">0</span>] <span class="op">&lt;</span> <span class="dv">251</span> <span class="kw">or</span> window.shape[<span class="dv">1</span>] <span class="op">&lt;</span> <span class="dv">2</span>:</span>
<span id="cb24-108"><a href="#cb24-108" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb24-109"><a href="#cb24-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-110"><a href="#cb24-110" aria-hidden="true" tabindex="-1"></a>    mu_excess_ann <span class="op">=</span> pf.mu_momentum(window, mode<span class="op">=</span><span class="st">"6-1"</span>, rf<span class="op">=</span>rf_annual, </span>
<span id="cb24-111"><a href="#cb24-111" aria-hidden="true" tabindex="-1"></a>                                   target_sharpe<span class="op">=</span><span class="fl">0.80</span>, mu_cap<span class="op">=</span><span class="fl">0.30</span>, winsor<span class="op">=</span><span class="fl">0.05</span>, </span>
<span id="cb24-112"><a href="#cb24-112" aria-hidden="true" tabindex="-1"></a>                                   zscore<span class="op">=</span><span class="va">True</span>,return_series<span class="op">=</span><span class="va">True</span>,)</span>
<span id="cb24-113"><a href="#cb24-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-114"><a href="#cb24-114" aria-hidden="true" tabindex="-1"></a>    cov_ann_map <span class="op">=</span> {</span>
<span id="cb24-115"><a href="#cb24-115" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sample"</span>: pf.cov_estimate(window, method<span class="op">=</span><span class="st">"samplecov"</span>, psd<span class="op">=</span><span class="va">True</span>, ridge<span class="op">=</span><span class="fl">1e-10</span>),</span>
<span id="cb24-116"><a href="#cb24-116" aria-hidden="true" tabindex="-1"></a>        <span class="st">"lw"</span>: pf.cov_estimate(window, method<span class="op">=</span><span class="st">"ledoitwolf"</span>, psd<span class="op">=</span><span class="va">True</span>, ridge<span class="op">=</span><span class="fl">1e-10</span>),</span>
<span id="cb24-117"><a href="#cb24-117" aria-hidden="true" tabindex="-1"></a>        <span class="st">"oas"</span>: pf.cov_estimate(window, method<span class="op">=</span><span class="st">"oas"</span>, psd<span class="op">=</span><span class="va">True</span>, ridge<span class="op">=</span><span class="fl">1e-10</span>),</span>
<span id="cb24-118"><a href="#cb24-118" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ewma"</span>: pf.cov_estimate(window, method<span class="op">=</span><span class="st">"ewma"</span>, ewma_lambda<span class="op">=</span><span class="fl">0.94</span>, psd<span class="op">=</span><span class="va">True</span>, ridge<span class="op">=</span><span class="fl">1e-10</span>)</span>
<span id="cb24-119"><a href="#cb24-119" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb24-120"><a href="#cb24-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-121"><a href="#cb24-121" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> PortfolioState(</span>
<span id="cb24-122"><a href="#cb24-122" aria-hidden="true" tabindex="-1"></a>        tickers<span class="op">=</span><span class="bu">list</span>(window.columns),</span>
<span id="cb24-123"><a href="#cb24-123" aria-hidden="true" tabindex="-1"></a>        mu_excess_ann<span class="op">=</span>mu_excess_ann.reindex(window.columns).astype(<span class="bu">float</span>),</span>
<span id="cb24-124"><a href="#cb24-124" aria-hidden="true" tabindex="-1"></a>        cov_ann_map<span class="op">=</span>cov_ann_map,</span>
<span id="cb24-125"><a href="#cb24-125" aria-hidden="true" tabindex="-1"></a>        avg_dollar_volume<span class="op">=</span>avg_dv.reindex(window.columns).astype(<span class="bu">float</span>))</span>
<span id="cb24-126"><a href="#cb24-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-127"><a href="#cb24-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-128"><a href="#cb24-128" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> dt <span class="kw">in</span> rebal_dates:</span>
<span id="cb24-129"><a href="#cb24-129" aria-hidden="true" tabindex="-1"></a>    st <span class="op">=</span> build_state(pd.Timestamp(dt))</span>
<span id="cb24-130"><a href="#cb24-130" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> st <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb24-131"><a href="#cb24-131" aria-hidden="true" tabindex="-1"></a>        cache[pd.Timestamp(dt)] <span class="op">=</span> st</span>
<span id="cb24-132"><a href="#cb24-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-133"><a href="#cb24-133" aria-hidden="true" tabindex="-1"></a>rebal_dates <span class="op">=</span> [pd.Timestamp(d) <span class="cf">for</span> d <span class="kw">in</span> rebal_dates <span class="cf">if</span> pd.Timestamp(d) <span class="kw">in</span> cache]</span>
<span id="cb24-134"><a href="#cb24-134" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(rebal_dates) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb24-135"><a href="#cb24-135" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"No valid rebalance dates after state construction."</span>)</span>
<span id="cb24-136"><a href="#cb24-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-137"><a href="#cb24-137" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"usable rebalance dates: </span><span class="sc">{</span><span class="bu">len</span>(rebal_dates)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-138"><a href="#cb24-138" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"avg universe size: </span><span class="sc">{</span>np<span class="sc">.</span>mean([<span class="bu">len</span>(cache[d].tickers) <span class="cf">for</span> d <span class="kw">in</span> rebal_dates])<span class="sc">:.1f}</span><span class="ss">"</span>)</span>
<span id="cb24-139"><a href="#cb24-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-140"><a href="#cb24-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-141"><a href="#cb24-141" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ew(dt, st, w_prev):</span>
<span id="cb24-142"><a href="#cb24-142" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pf.weights_equal(st[<span class="st">"tickers"</span>], w_min<span class="op">=</span><span class="fl">0.0</span>, w_max<span class="op">=</span><span class="fl">0.20</span>, long_only<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-143"><a href="#cb24-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-144"><a href="#cb24-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-145"><a href="#cb24-145" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_minvar(cov_key: <span class="bu">str</span>):</span>
<span id="cb24-146"><a href="#cb24-146" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _fn(dt, st, w_prev):</span>
<span id="cb24-147"><a href="#cb24-147" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pf.weights_minvar(</span>
<span id="cb24-148"><a href="#cb24-148" aria-hidden="true" tabindex="-1"></a>            cov_ann<span class="op">=</span>st[<span class="st">"cov_ann_map"</span>][cov_key], w_prev<span class="op">=</span>w_prev,</span>
<span id="cb24-149"><a href="#cb24-149" aria-hidden="true" tabindex="-1"></a>            w_min<span class="op">=</span><span class="fl">0.0</span>, w_max<span class="op">=</span><span class="fl">0.25</span>, long_only<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb24-150"><a href="#cb24-150" aria-hidden="true" tabindex="-1"></a>            turnover_penalty_bps<span class="op">=</span><span class="fl">10.0</span>,solver_order<span class="op">=</span>[<span class="st">"osqp"</span>, <span class="st">"ecos"</span>, <span class="st">"scs"</span>])</span>
<span id="cb24-151"><a href="#cb24-151" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> _fn</span>
<span id="cb24-152"><a href="#cb24-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-153"><a href="#cb24-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-154"><a href="#cb24-154" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_mv(cov_key: <span class="bu">str</span>):</span>
<span id="cb24-155"><a href="#cb24-155" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _fn(dt, st, w_prev):</span>
<span id="cb24-156"><a href="#cb24-156" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pf.weights_mv(</span>
<span id="cb24-157"><a href="#cb24-157" aria-hidden="true" tabindex="-1"></a>            mu_excess_ann<span class="op">=</span>st[<span class="st">"mu_excess_ann"</span>].values,</span>
<span id="cb24-158"><a href="#cb24-158" aria-hidden="true" tabindex="-1"></a>            cov_ann<span class="op">=</span>st[<span class="st">"cov_ann_map"</span>][cov_key], w_prev<span class="op">=</span>w_prev,</span>
<span id="cb24-159"><a href="#cb24-159" aria-hidden="true" tabindex="-1"></a>            mv_lambda<span class="op">=</span><span class="fl">4.0</span>, kappa_target_annual<span class="op">=</span><span class="fl">0.20</span>, w_min<span class="op">=</span><span class="fl">0.0</span>,</span>
<span id="cb24-160"><a href="#cb24-160" aria-hidden="true" tabindex="-1"></a>            w_max<span class="op">=</span><span class="fl">0.25</span>, long_only<span class="op">=</span><span class="va">True</span>, turnover_penalty_bps<span class="op">=</span><span class="fl">10.0</span>,</span>
<span id="cb24-161"><a href="#cb24-161" aria-hidden="true" tabindex="-1"></a>            solver_order<span class="op">=</span>[<span class="st">"osqp"</span>, <span class="st">"ecos"</span>, <span class="st">"scs"</span>])</span>
<span id="cb24-162"><a href="#cb24-162" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> _fn</span>
<span id="cb24-163"><a href="#cb24-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-164"><a href="#cb24-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-165"><a href="#cb24-165" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ridge_mv_lw(dt, st, w_prev):</span>
<span id="cb24-166"><a href="#cb24-166" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pf.weights_ridge_mv(</span>
<span id="cb24-167"><a href="#cb24-167" aria-hidden="true" tabindex="-1"></a>        mu_excess_ann<span class="op">=</span>st[<span class="st">"mu_excess_ann"</span>].values,</span>
<span id="cb24-168"><a href="#cb24-168" aria-hidden="true" tabindex="-1"></a>        cov_ann<span class="op">=</span>st[<span class="st">"cov_ann_map"</span>][<span class="st">"lw"</span>], w_prev<span class="op">=</span>w_prev,</span>
<span id="cb24-169"><a href="#cb24-169" aria-hidden="true" tabindex="-1"></a>        ridge<span class="op">=</span><span class="fl">1e-4</span>, mv_lambda<span class="op">=</span><span class="fl">6.0</span>, kappa_target_annual<span class="op">=</span><span class="fl">0.30</span>,</span>
<span id="cb24-170"><a href="#cb24-170" aria-hidden="true" tabindex="-1"></a>        w_min<span class="op">=</span><span class="fl">0.0</span>, w_max<span class="op">=</span><span class="fl">0.25</span>, long_only<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb24-171"><a href="#cb24-171" aria-hidden="true" tabindex="-1"></a>        turnover_penalty_bps<span class="op">=</span><span class="fl">10.0</span>,</span>
<span id="cb24-172"><a href="#cb24-172" aria-hidden="true" tabindex="-1"></a>        solver_order<span class="op">=</span>[<span class="st">"osqp"</span>, <span class="st">"ecos"</span>, <span class="st">"scs"</span>])</span>
<span id="cb24-173"><a href="#cb24-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-174"><a href="#cb24-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-175"><a href="#cb24-175" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> maxsharpe_slsqp_lw(dt, st, w_prev):</span>
<span id="cb24-176"><a href="#cb24-176" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pf.weights_maxsharpe_slsqp(</span>
<span id="cb24-177"><a href="#cb24-177" aria-hidden="true" tabindex="-1"></a>        mu_excess_ann<span class="op">=</span>st[<span class="st">"mu_excess_ann"</span>].values,</span>
<span id="cb24-178"><a href="#cb24-178" aria-hidden="true" tabindex="-1"></a>        cov_ann<span class="op">=</span>st[<span class="st">"cov_ann_map"</span>][<span class="st">"lw"</span>], w_prev<span class="op">=</span>w_prev,</span>
<span id="cb24-179"><a href="#cb24-179" aria-hidden="true" tabindex="-1"></a>        w_min<span class="op">=</span><span class="fl">0.0</span>, w_max<span class="op">=</span><span class="fl">0.25</span>, long_only<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb24-180"><a href="#cb24-180" aria-hidden="true" tabindex="-1"></a>        turnover_penalty_bps<span class="op">=</span><span class="fl">10.0</span>, kappa_target_annual<span class="op">=</span><span class="fl">0.30</span>)</span>
<span id="cb24-181"><a href="#cb24-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-182"><a href="#cb24-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-183"><a href="#cb24-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-184"><a href="#cb24-184" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> maxsharpe_frontier_lw(dt, st, w_prev):</span>
<span id="cb24-185"><a href="#cb24-185" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pf.weights_maxsharpe_frontier_grid(</span>
<span id="cb24-186"><a href="#cb24-186" aria-hidden="true" tabindex="-1"></a>        mu_excess_ann<span class="op">=</span>st[<span class="st">"mu_excess_ann"</span>].values,</span>
<span id="cb24-187"><a href="#cb24-187" aria-hidden="true" tabindex="-1"></a>        cov_ann<span class="op">=</span>st[<span class="st">"cov_ann_map"</span>][<span class="st">"lw"</span>], w_prev<span class="op">=</span>w_prev,</span>
<span id="cb24-188"><a href="#cb24-188" aria-hidden="true" tabindex="-1"></a>        grid_n<span class="op">=</span><span class="dv">25</span>, w_min<span class="op">=</span><span class="fl">0.0</span>, w_max<span class="op">=</span><span class="fl">0.25</span>, long_only<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb24-189"><a href="#cb24-189" aria-hidden="true" tabindex="-1"></a>        turnover_penalty_bps<span class="op">=</span><span class="fl">10.0</span>,solver_order<span class="op">=</span>[<span class="st">"osqp"</span>, <span class="st">"ecos"</span>, <span class="st">"scs"</span>])</span>
<span id="cb24-190"><a href="#cb24-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-191"><a href="#cb24-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-192"><a href="#cb24-192" aria-hidden="true" tabindex="-1"></a>strategy_fns <span class="op">=</span> {</span>
<span id="cb24-193"><a href="#cb24-193" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ew"</span>: ew,</span>
<span id="cb24-194"><a href="#cb24-194" aria-hidden="true" tabindex="-1"></a>    <span class="st">"minvar_sample"</span>: make_minvar(<span class="st">"sample"</span>),</span>
<span id="cb24-195"><a href="#cb24-195" aria-hidden="true" tabindex="-1"></a>    <span class="st">"minvar_lw"</span>: make_minvar(<span class="st">"lw"</span>),</span>
<span id="cb24-196"><a href="#cb24-196" aria-hidden="true" tabindex="-1"></a>    <span class="st">"minvar_oas"</span>: make_minvar(<span class="st">"oas"</span>),</span>
<span id="cb24-197"><a href="#cb24-197" aria-hidden="true" tabindex="-1"></a>    <span class="st">"minvar_ewma"</span>: make_minvar(<span class="st">"ewma"</span>),</span>
<span id="cb24-198"><a href="#cb24-198" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mv_sample"</span>: make_mv(<span class="st">"sample"</span>),</span>
<span id="cb24-199"><a href="#cb24-199" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mv_lw"</span>: make_mv(<span class="st">"lw"</span>),</span>
<span id="cb24-200"><a href="#cb24-200" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mv_oas"</span>: make_mv(<span class="st">"oas"</span>),</span>
<span id="cb24-201"><a href="#cb24-201" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mv_ewma"</span>: make_mv(<span class="st">"ewma"</span>),</span>
<span id="cb24-202"><a href="#cb24-202" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ridge_mv"</span>: ridge_mv_lw,</span>
<span id="cb24-203"><a href="#cb24-203" aria-hidden="true" tabindex="-1"></a>    <span class="st">"maxsharpe_slsqp"</span>: maxsharpe_slsqp_lw,</span>
<span id="cb24-204"><a href="#cb24-204" aria-hidden="true" tabindex="-1"></a>    <span class="st">"maxsharpe_frontier"</span>: maxsharpe_frontier_lw,</span>
<span id="cb24-205"><a href="#cb24-205" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-206"><a href="#cb24-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-207"><a href="#cb24-207" aria-hidden="true" tabindex="-1"></a>cov_key_for_rc <span class="op">=</span> {</span>
<span id="cb24-208"><a href="#cb24-208" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ew"</span>: <span class="st">"lw"</span>,</span>
<span id="cb24-209"><a href="#cb24-209" aria-hidden="true" tabindex="-1"></a>    <span class="st">"minvar_sample"</span>: <span class="st">"sample"</span>,</span>
<span id="cb24-210"><a href="#cb24-210" aria-hidden="true" tabindex="-1"></a>    <span class="st">"minvar_lw"</span>: <span class="st">"lw"</span>,</span>
<span id="cb24-211"><a href="#cb24-211" aria-hidden="true" tabindex="-1"></a>    <span class="st">"minvar_oas"</span>: <span class="st">"oas"</span>,</span>
<span id="cb24-212"><a href="#cb24-212" aria-hidden="true" tabindex="-1"></a>    <span class="st">"minvar_ewma"</span>: <span class="st">"ewma"</span>,</span>
<span id="cb24-213"><a href="#cb24-213" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mv_sample"</span>: <span class="st">"sample"</span>,</span>
<span id="cb24-214"><a href="#cb24-214" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mv_lw"</span>: <span class="st">"lw"</span>,</span>
<span id="cb24-215"><a href="#cb24-215" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mv_oas"</span>: <span class="st">"oas"</span>,</span>
<span id="cb24-216"><a href="#cb24-216" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mv_ewma"</span>: <span class="st">"ewma"</span>,</span>
<span id="cb24-217"><a href="#cb24-217" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ridge_mv"</span>: <span class="st">"lw"</span>,</span>
<span id="cb24-218"><a href="#cb24-218" aria-hidden="true" tabindex="-1"></a>    <span class="st">"maxsharpe_slsqp"</span>: <span class="st">"lw"</span>,</span>
<span id="cb24-219"><a href="#cb24-219" aria-hidden="true" tabindex="-1"></a>    <span class="st">"maxsharpe_frontier"</span>: <span class="st">"lw"</span>,</span>
<span id="cb24-220"><a href="#cb24-220" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-221"><a href="#cb24-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-222"><a href="#cb24-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-223"><a href="#cb24-223" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> {</span>
<span id="cb24-224"><a href="#cb24-224" aria-hidden="true" tabindex="-1"></a>    name: pf.backtest(</span>
<span id="cb24-225"><a href="#cb24-225" aria-hidden="true" tabindex="-1"></a>        returns<span class="op">=</span>returns, rebal_dates<span class="op">=</span>rebal_dates,</span>
<span id="cb24-226"><a href="#cb24-226" aria-hidden="true" tabindex="-1"></a>        cache<span class="op">=</span>cache, weight_fn<span class="op">=</span>fn,</span>
<span id="cb24-227"><a href="#cb24-227" aria-hidden="true" tabindex="-1"></a>        cost_bps<span class="op">=</span><span class="fl">10.0</span>,rf_daily<span class="op">=</span>rf_daily)</span>
<span id="cb24-228"><a href="#cb24-228" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, fn <span class="kw">in</span> strategy_fns.items()}</span>
<span id="cb24-229"><a href="#cb24-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-230"><a href="#cb24-230" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"computed strategies: </span><span class="sc">{</span><span class="bu">len</span>(results)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-231"><a href="#cb24-231" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">sorted</span>(results.keys()))</span>
<span id="cb24-232"><a href="#cb24-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-233"><a href="#cb24-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-234"><a href="#cb24-234" aria-hidden="true" tabindex="-1"></a>best_name, sharpes <span class="op">=</span> pf.best_strategy_by_sharpe(results, rf_daily<span class="op">=</span>rf_daily, annualization<span class="op">=</span><span class="fl">252.0</span>)</span>
<span id="cb24-235"><a href="#cb24-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-236"><a href="#cb24-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-237"><a href="#cb24-237" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> pl.make_color_map(results.keys(), pl.LAB_COLORS)</span>
<span id="cb24-238"><a href="#cb24-238" aria-hidden="true" tabindex="-1"></a>best_color <span class="op">=</span> colors[best_name]</span>
<span id="cb24-239"><a href="#cb24-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-240"><a href="#cb24-240" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">4</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">26</span>))</span>
<span id="cb24-241"><a href="#cb24-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-242"><a href="#cb24-242" aria-hidden="true" tabindex="-1"></a>pl.plot_net_equity(axes[<span class="dv">0</span>, <span class="dv">0</span>], results[best_name], name<span class="op">=</span>best_name, color<span class="op">=</span>best_color)</span>
<span id="cb24-243"><a href="#cb24-243" aria-hidden="true" tabindex="-1"></a>pl.plot_drawdown(axes[<span class="dv">0</span>, <span class="dv">1</span>], results[best_name], name<span class="op">=</span>best_name, color<span class="op">=</span>best_color)</span>
<span id="cb24-244"><a href="#cb24-244" aria-hidden="true" tabindex="-1"></a>pl.plot_top_weights(axes[<span class="dv">1</span>, <span class="dv">0</span>], results[best_name], name<span class="op">=</span>best_name, color<span class="op">=</span>best_color, k<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb24-245"><a href="#cb24-245" aria-hidden="true" tabindex="-1"></a>pl.plot_top_risk_contrib(</span>
<span id="cb24-246"><a href="#cb24-246" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>, <span class="dv">1</span>],</span>
<span id="cb24-247"><a href="#cb24-247" aria-hidden="true" tabindex="-1"></a>    results[best_name],</span>
<span id="cb24-248"><a href="#cb24-248" aria-hidden="true" tabindex="-1"></a>    cache,</span>
<span id="cb24-249"><a href="#cb24-249" aria-hidden="true" tabindex="-1"></a>    cov_key<span class="op">=</span>cov_key_for_rc[best_name],</span>
<span id="cb24-250"><a href="#cb24-250" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span>best_name,</span>
<span id="cb24-251"><a href="#cb24-251" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span>best_color,</span>
<span id="cb24-252"><a href="#cb24-252" aria-hidden="true" tabindex="-1"></a>    k<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb24-253"><a href="#cb24-253" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-254"><a href="#cb24-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-255"><a href="#cb24-255" aria-hidden="true" tabindex="-1"></a>pl.plot_net_equity_compare(axes[<span class="dv">2</span>, <span class="dv">0</span>], results, colors<span class="op">=</span>colors, title<span class="op">=</span><span class="st">"Net Equity (Comparison)"</span>)</span>
<span id="cb24-256"><a href="#cb24-256" aria-hidden="true" tabindex="-1"></a>pl.plot_drawdown_compare(axes[<span class="dv">2</span>, <span class="dv">1</span>], results, colors<span class="op">=</span>colors, title<span class="op">=</span><span class="st">"Drawdown (Comparison)"</span>)</span>
<span id="cb24-257"><a href="#cb24-257" aria-hidden="true" tabindex="-1"></a>pl.plot_risk_return_scatter(</span>
<span id="cb24-258"><a href="#cb24-258" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">3</span>, <span class="dv">0</span>],</span>
<span id="cb24-259"><a href="#cb24-259" aria-hidden="true" tabindex="-1"></a>    results,</span>
<span id="cb24-260"><a href="#cb24-260" aria-hidden="true" tabindex="-1"></a>    rf_daily<span class="op">=</span>rf_daily,</span>
<span id="cb24-261"><a href="#cb24-261" aria-hidden="true" tabindex="-1"></a>    annualization<span class="op">=</span><span class="fl">252.0</span>,</span>
<span id="cb24-262"><a href="#cb24-262" aria-hidden="true" tabindex="-1"></a>    colors<span class="op">=</span>colors,</span>
<span id="cb24-263"><a href="#cb24-263" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Realized Risk-Return (Net)"</span>,</span>
<span id="cb24-264"><a href="#cb24-264" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-265"><a href="#cb24-265" aria-hidden="true" tabindex="-1"></a>pl.plot_sharpe_compare(</span>
<span id="cb24-266"><a href="#cb24-266" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">3</span>, <span class="dv">1</span>],</span>
<span id="cb24-267"><a href="#cb24-267" aria-hidden="true" tabindex="-1"></a>    results,</span>
<span id="cb24-268"><a href="#cb24-268" aria-hidden="true" tabindex="-1"></a>    rf_daily<span class="op">=</span>rf_daily,</span>
<span id="cb24-269"><a href="#cb24-269" aria-hidden="true" tabindex="-1"></a>    annualization<span class="op">=</span><span class="fl">252.0</span>,</span>
<span id="cb24-270"><a href="#cb24-270" aria-hidden="true" tabindex="-1"></a>    colors<span class="op">=</span>colors,</span>
<span id="cb24-271"><a href="#cb24-271" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Realized Sharpe (Net)"</span>,</span>
<span id="cb24-272"><a href="#cb24-272" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-273"><a href="#cb24-273" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">"Project 02 - Portfolio optimization with MeanVar, MinVar and MaxSharpe models (Hong Kong stock market Data)"</span>, y<span class="op">=</span><span class="fl">1.02</span>)</span>
<span id="cb24-274"><a href="#cb24-274" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb24-275"><a href="#cb24-275" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb24-276"><a href="#cb24-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-277"><a href="#cb24-277" aria-hidden="true" tabindex="-1"></a>metrics_df, trade_df <span class="op">=</span> pf.summarize_results(results, rf_daily<span class="op">=</span>rf_daily, annualization<span class="op">=</span><span class="fl">252.0</span>)</span>
<span id="cb24-278"><a href="#cb24-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-279"><a href="#cb24-279" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Risk/Return Summary (Net)"</span>)</span>
<span id="cb24-280"><a href="#cb24-280" aria-hidden="true" tabindex="-1"></a>display(metrics_df)</span>
<span id="cb24-281"><a href="#cb24-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-282"><a href="#cb24-282" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Trading &amp; Stability Summary"</span>)</span>
<span id="cb24-283"><a href="#cb24-283" aria-hidden="true" tabindex="-1"></a>display(trade_df)</span>
<span id="cb24-284"><a href="#cb24-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-285"><a href="#cb24-285" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"best sharpe: </span><span class="sc">{</span>best_name<span class="sc">}</span><span class="ss"> | sharpe: </span><span class="sc">{</span>sharpes[best_name]<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>close_prices: (2478, 290) | volumes: (2478, 290)
Date range: 2016-01-04 to 2026-01-28
usable rebalance dates: 109
avg universe size: 100.0
computed strategies: 12
['ew', 'maxsharpe_frontier', 'maxsharpe_slsqp', 'minvar_ewma', 'minvar_lw', 'minvar_oas', 'minvar_sample', 'mv_ewma', 'mv_lw', 'mv_oas', 'mv_sample', 'ridge_mv']</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_portfolio_optimization_MV_models_files/figure-html/cell-18-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Risk/Return Summary (Net)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">CAGR</th>
<th data-quarto-table-cell-role="th">AnnVol</th>
<th data-quarto-table-cell-role="th">Sharpe</th>
<th data-quarto-table-cell-role="th">MaxDD</th>
<th data-quarto-table-cell-role="th">Calmar</th>
<th data-quarto-table-cell-role="th">Sortino</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Strategy</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">ew</th>
<td>0.076280</td>
<td>0.213572</td>
<td>0.269004</td>
<td>-0.400074</td>
<td>0.190664</td>
<td>0.366343</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">maxsharpe_frontier</th>
<td>0.173174</td>
<td>0.253011</td>
<td>0.602840</td>
<td>-0.396645</td>
<td>0.436597</td>
<td>0.763618</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">maxsharpe_slsqp</th>
<td>0.137410</td>
<td>0.243979</td>
<td>0.490898</td>
<td>-0.399129</td>
<td>0.344275</td>
<td>0.657423</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">minvar_ewma</th>
<td>0.080919</td>
<td>0.132465</td>
<td>0.356138</td>
<td>-0.270858</td>
<td>0.298753</td>
<td>0.445874</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">minvar_lw</th>
<td>0.067458</td>
<td>0.126572</td>
<td>0.267248</td>
<td>-0.320084</td>
<td>0.210751</td>
<td>0.343290</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">minvar_oas</th>
<td>0.068393</td>
<td>0.126131</td>
<td>0.274732</td>
<td>-0.320297</td>
<td>0.213530</td>
<td>0.352852</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">minvar_sample</th>
<td>0.070466</td>
<td>0.125965</td>
<td>0.290240</td>
<td>-0.315555</td>
<td>0.223307</td>
<td>0.373151</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">mv_ewma</th>
<td>0.047504</td>
<td>0.155153</td>
<td>0.125856</td>
<td>-0.432365</td>
<td>0.109869</td>
<td>0.166299</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mv_lw</th>
<td>0.059472</td>
<td>0.174422</td>
<td>0.195321</td>
<td>-0.350070</td>
<td>0.169886</td>
<td>0.265576</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">mv_oas</th>
<td>0.059888</td>
<td>0.172727</td>
<td>0.197770</td>
<td>-0.349493</td>
<td>0.171358</td>
<td>0.268584</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mv_sample</th>
<td>0.055860</td>
<td>0.169960</td>
<td>0.175636</td>
<td>-0.351519</td>
<td>0.158910</td>
<td>0.238167</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ridge_mv</th>
<td>0.058862</td>
<td>0.176880</td>
<td>0.191773</td>
<td>-0.343360</td>
<td>0.171428</td>
<td>0.261115</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Trading &amp; Stability Summary</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Avg Turnover</th>
<th data-quarto-table-cell-role="th">Total Turnover</th>
<th data-quarto-table-cell-role="th">Total Costs</th>
<th data-quarto-table-cell-role="th">Cost % Final Value</th>
<th data-quarto-table-cell-role="th">Avg HHI</th>
<th data-quarto-table-cell-role="th">Effective N</th>
<th data-quarto-table-cell-role="th">Fallbacks</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Strategy</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">ew</th>
<td>0.042396</td>
<td>4.621129</td>
<td>0.006054</td>
<td>0.003173</td>
<td>0.010000</td>
<td>100.000000</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">maxsharpe_frontier</th>
<td>0.461996</td>
<td>50.357586</td>
<td>0.127701</td>
<td>0.031370</td>
<td>0.151092</td>
<td>6.618471</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">maxsharpe_slsqp</th>
<td>0.068841</td>
<td>7.503668</td>
<td>0.011999</td>
<td>0.003870</td>
<td>0.130483</td>
<td>7.663833</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">minvar_ewma</th>
<td>0.441603</td>
<td>48.134699</td>
<td>0.067150</td>
<td>0.033886</td>
<td>0.137801</td>
<td>7.256842</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">minvar_lw</th>
<td>0.106463</td>
<td>11.604440</td>
<td>0.014779</td>
<td>0.008326</td>
<td>0.094543</td>
<td>10.577203</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">minvar_oas</th>
<td>0.108628</td>
<td>11.840467</td>
<td>0.015143</td>
<td>0.008466</td>
<td>0.108075</td>
<td>9.252864</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">minvar_sample</th>
<td>0.115967</td>
<td>12.640403</td>
<td>0.016355</td>
<td>0.008989</td>
<td>0.130010</td>
<td>7.691693</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">mv_ewma</th>
<td>0.020636</td>
<td>2.249277</td>
<td>0.002477</td>
<td>0.001648</td>
<td>0.056364</td>
<td>17.741750</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mv_lw</th>
<td>0.005375</td>
<td>0.585831</td>
<td>0.000751</td>
<td>0.000452</td>
<td>0.031996</td>
<td>31.254348</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">mv_oas</th>
<td>0.005633</td>
<td>0.613968</td>
<td>0.000785</td>
<td>0.000471</td>
<td>0.033847</td>
<td>29.544465</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mv_sample</th>
<td>0.005587</td>
<td>0.608993</td>
<td>0.000757</td>
<td>0.000469</td>
<td>0.035177</td>
<td>28.427916</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ridge_mv</th>
<td>0.003899</td>
<td>0.425024</td>
<td>0.000549</td>
<td>0.000332</td>
<td>0.030416</td>
<td>32.877851</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>best sharpe: maxsharpe_frontier | sharpe: 0.6028</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../notebooks/01_yield_curve_bond_pricing_and_risk.html" class="pagination-link" aria-label="1. Fixed income and yield curve construction">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-title">1. Fixed income and yield curve construction</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->




</body></html>